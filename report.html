<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports | Palm Aegis</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="stylesheet" href="css/report.css">
    <link rel="icon" href="images/logo1.png" type="image/png" sizes="32x32">
    <link rel="shortcut icon" href="images/logo1.png">
    <meta name="theme-color" content="#2e7d32">
    <style>
        :root {
            --primary-color: #2e7d32;
            --secondary-color: #4caf50;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --info-color: #2196f3;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --text-color: #333333;
            --text-light: #666666;
            --text-lighter: #888888;
            --bg-color: #c8f0c8;
            --card-bg: #ffffff;
            --border-color: #e0e0e0;
            --border-radius: 12px;
            --transition-speed: 0.3s;
            --shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 4px 20px rgba(0, 0, 0, 0.12);
            --gradient: linear-gradient(135deg, #2e7d32, #4caf50);
            --invoice-gradient: linear-gradient(135deg, #ff9800, #ff5722);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #c8f0c8;
            color: #333;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 1.5rem;
            overflow-y: auto;
            transition: margin-left var(--transition-speed);
        }

        /* Header */
        .top-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
        }

        .header-left h1 {
            font-size: 1.5rem;
            color: var(--primary-color);
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .view-toggle {
            display: flex;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 25px;
            overflow: hidden;
        }

        .view-btn {
            padding: 0.6rem 1.2rem;
            background: transparent;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-light);
            transition: all 0.3s;
        }

        .view-btn.active {
            background: var(--gradient);
            color: white;
        }

        .report-btn {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
            box-shadow: var(--shadow);
        }

        .report-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .report-btn.invoice {
            background: var(--invoice-gradient);
        }

        .filter-btn {
            background: white;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            padding: 0.7rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            background: rgba(46, 125, 50, 0.1);
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 2rem;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* No Data Message */
        .no-data {
            text-align: center;
            padding: 3rem;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: none;
        }

        .no-data i {
            font-size: 3rem;
            color: var(--secondary-color);
            margin-bottom: 1rem;
        }

        .no-data h3 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .no-data p {
            color: var(--text-light);
        }

        /* Data Tables */
        .data-tables {
            display: none;
        }

        .data-tables.active {
            display: block;
        }

        .table-container {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            overflow-x: auto;
        }

        .table-container h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .table-container h3 i {
            color: var(--secondary-color);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: rgba(46, 125, 50, 0.1);
            color: var(--primary-color);
            font-weight: 600;
            padding: 1rem;
            text-align: left;
            border-bottom: 2px solid var(--border-color);
        }

        .data-table td {
            padding: 0.8rem 1rem;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        .data-table tr:hover {
            background: rgba(46, 125, 50, 0.05);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .status-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            display: inline-block;
        }

        .status-healthy {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-infected {
            background: #ffebee;
            color: #e53935;
        }

        .status-warning {
            background: #fff3e0;
            color: #f57c00;
        }

        .image-preview {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .image-preview:hover {
            transform: scale(1.5);
            box-shadow: var(--shadow-hover);
            z-index: 10;
            position: relative;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            transition: all 0.3s;
        }

        .view-action {
            background: #e3f2fd;
            color: #1976d2;
        }

        .edit-action {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .delete-action {
            background: #ffebee;
            color: #e53935;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* Reports Grid */
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .report-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .report-title {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .report-date {
            color: var(--text-lighter);
            font-size: 0.9rem;
            margin-top: 0.3rem;
        }

        .health-score {
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .report-content {
            flex: 1;
            margin-bottom: 1.5rem;
        }

        .report-field {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.8rem;
            padding-bottom: 0.8rem;
            border-bottom: 1px dashed var(--border-color);
        }

        .report-field:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .field-label {
            color: var(--text-light);
            font-weight: 500;
        }

        .field-value {
            color: var(--text-color);
            text-align: right;
            max-width: 60%;
        }

        .report-actions {
            display: flex;
            gap: 0.8rem;
        }

        .report-actions button {
            flex: 1;
            padding: 0.7rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }

        .report-actions .view-btn {
            background: rgba(46, 125, 50, 0.1);
            color: var(--primary-color);
        }

        .report-actions .view-btn:hover {
            background: rgba(46, 125, 50, 0.2);
        }

        .report-actions .download-btn {
            background: var(--gradient);
            color: white;
        }

        .report-actions .download-btn:hover {
            opacity: 0.9;
        }

        /* Filter Modal */
        .filter-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1002;
            align-items: center;
            justify-content: center;
        }

        .filter-modal.active {
            display: flex;
        }

        .filter-content {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow-hover);
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .filter-header h3 {
            color: var(--primary-color);
        }

        .close-filter {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--text-light);
        }

        .filter-group {
            margin-bottom: 1.5rem;
        }

        .filter-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
        }

        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
        }

        .filter-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        /* Export Options Modal */
        .export-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1003;
            align-items: center;
            justify-content: center;
        }

        .export-modal.active {
            display: flex;
        }

        .export-content {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 400px;
            box-shadow: var(--shadow-hover);
        }

        .export-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .export-option {
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .export-option:hover {
            border-color: var(--primary-color);
            background: rgba(46, 125, 50, 0.05);
        }

        .export-option i {
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .export-option h4 {
            margin-bottom: 0.2rem;
            color: var(--primary-color);
        }

        .export-option p {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        /* View/Edit Modal */
        .view-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .view-modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .view-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #2e7d32;
        }

        .view-modal-title {
            color: #2e7d32;
            margin: 0;
            font-size: 1.5rem;
        }

        .close-view-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            transition: color 0.3s;
        }

        .close-view-modal:hover {
            color: #e53935;
        }

        .view-modal-body {
            line-height: 1.6;
        }

        .view-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .view-modal-btn {
            padding: 10px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .view-modal-btn.close {
            background: #f5f5f5;
            color: #333;
        }

        .view-modal-btn.close:hover {
            background: #e0e0e0;
        }

        .view-modal-btn.edit {
            background: #2e7d32;
            color: white;
            display: none;
        }

        .view-modal-btn.edit:hover {
            background: #4caf50;
        }

        /* Modal Data Grid */
        .modal-data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .modal-data-item {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 6px;
        }

        .modal-data-label {
            color: #666;
            font-size: 0.9rem;
            font-weight: 600;
            display: block;
            margin-bottom: 5px;
        }

        .modal-data-value {
            font-size: 1.1rem;
            color: #333;
        }

        .modal-images-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 8px;
        }

        .modal-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #ddd;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .modal-image:hover {
            transform: scale(1.05);
            border-color: #2e7d32;
        }

        .modal-detection-list {
            margin: 0;
            padding-left: 20px;
        }

        .modal-detection-item {
            margin-bottom: 5px;
        }

        .modal-id-badge {
            background: #e8f5e9;
            padding: 10px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 0.9rem;
            color: #2e7d32;
            font-family: monospace;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 260px;
                z-index: 1001;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .sidebar-toggle {
                display: none !important;
            }

            .mobile-menu-btn {
                display: flex !important;
                margin-right: 10px;
            }

            .main-content {
                margin-left: 0;
            }

            .dashboard-container {
                flex-direction: column;
            }

            .main-content {
                width: 100%;
            }

            .search-box {
                width: 200px;
            }

            .header-actions {
                flex-direction: column;
                width: 100%;
                gap: 0.8rem;
            }

            .view-toggle {
                width: 100%;
                justify-content: center;
            }

            .report-btn, .filter-btn {
                width: 100%;
                justify-content: center;
            }

            .top-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .data-table {
                font-size: 0.9rem;
            }

            .data-table th,
            .data-table td {
                padding: 0.6rem;
            }

            .reports-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
                gap: 0.3rem;
            }

            .action-btn {
                padding: 0.3rem 0.6rem;
                font-size: 0.8rem;
            }

            .view-modal-content {
                padding: 20px;
                margin: 10px;
            }

            .modal-data-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <div id="sidebarPlaceholder"></div>
        <script src="js/sidebar-loader.js"></script>

        <main class="main-content">
            <header class="top-header">
                <div class="header-left">
                    <h1><i class="fas fa-chart-bar"></i> Farm Reports</h1>
                </div>
                <div class="header-actions">
                    <div class="view-toggle">
                        <button class="view-btn active" id="viewCardsBtn">
                            <i class="fas fa-th-large"></i> Cards
                        </button>
                        <button class="view-btn" id="viewTablesBtn">
                            <i class="fas fa-table"></i> Tables
                        </button>
                    </div>
                    <button class="filter-btn" id="filterBtn">
                        <i class="fas fa-filter"></i> Filter
                    </button>
                    <button class="report-btn" id="downloadAllBtn">
                        <i class="fas fa-download"></i> Download PDF
                    </button>
                </div>
            </header>

            <div class="loading" id="loadingState">
                <div class="loading-spinner"></div>
                <p>Loading farm reports...</p>
            </div>

            <section id="reportsSection" style="display: none;">
                <h2 style="margin-bottom: 1.5rem; color: var(--primary-color);">
                    <i class="fas fa-file-alt"></i> Recent Assessments
                </h2>
                <div class="reports-grid" id="reportsGrid">
                    <!-- Reports will be loaded here -->
                </div>
            </section>

            <div class="data-tables" id="dataTablesSection">
                <div class="table-container">
                    <h3><i class="fas fa-clipboard-check"></i> Assessment Records</h3>
                    <div class="table-responsive">
                        <table class="data-table" id="assessmentsTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Disease</th>
                                    <th>Health Status</th>
                                    <th>Detection Count</th>
                                    <th>Image</th>
                                    <th>Location</th>
                                    <th>Treatment</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="assessmentsTableBody">
                                <!-- Assessment data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="table-container">
                    <h3><i class="fas fa-tractor"></i> Farm Records</h3>
                    <div class="table-responsive">
                        <table class="data-table" id="farmsTable">
                            <thead>
                                <tr>
                                    <th>Farm Name</th>
                                    <th>Location</th>
                                    <th>Area</th>
                                    <th>Crops</th>
                                    <th>Soil Type</th>
                                    <th>Status</th>
                                    <th>Images</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="farmsTableBody">
                                <!-- Farm data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="no-data" id="noDataMessage" style="display: none;">
                <i class="fas fa-inbox"></i>
                <h3>No Reports Found</h3>
                <p>Start by adding assessments to your farms to generate reports.</p>
                <button class="report-btn" style="margin-top: 1rem;" onclick="window.location.href='assessment.html'">
                    <i class="fas fa-plus"></i> Create Assessment
                </button>
            </div>
        </main>
    </div>

    <!-- Filter Modal -->
    <div class="filter-modal" id="filterModal">
        <div class="filter-content">
            <div class="filter-header">
                <h3><i class="fas fa-filter"></i> Filter Reports</h3>
                <button class="close-filter" id="closeFilter">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="filter-group">
                <label for="dateFilter">Date Range</label>
                <select id="dateFilter">
                    <option value="all">All Time</option>
                    <option value="week">Last 7 Days</option>
                    <option value="month">Last 30 Days</option>
                    <option value="quarter">Last 3 Months</option>
                    <option value="year">Last Year</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="healthFilter">Health Status</label>
                <select id="healthFilter">
                    <option value="all">All Status</option>
                    <option value="Healthy">Healthy</option>
                    <option value="Infected">Infected</option>
                    <option value="Warning">Warning</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="diseaseFilter">Disease Type</label>
                <select id="diseaseFilter">
                    <option value="all">All Diseases</option>
                    <!-- Disease options will be loaded here -->
                </select>
            </div>
            <div class="filter-actions">
                <button class="filter-btn" id="clearFilters">
                    Clear Filters
                </button>
                <button class="report-btn" id="applyFilters">
                    Apply Filters
                </button>
            </div>
        </div>
    </div>

    <!-- Export Options Modal -->
    <div class="export-modal" id="exportModal">
        <div class="export-content">
            <div class="filter-header">
                <h3><i class="fas fa-download"></i> Export Options</h3>
                <button class="close-filter" id="closeExport">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="export-options">
                <div class="export-option" onclick="downloadSinglePDF()">
                    <i class="fas fa-file-pdf"></i>
                    <div>
                        <h4>Current View PDF</h4>
                        <p>Export filtered data as PDF</p>
                    </div>
                </div>
                <div class="export-option" onclick="downloadAllPDF()">
                    <i class="fas fa-file-archive"></i>
                    <div>
                        <h4>Complete Report PDF</h4>
                        <p>All farms and assessments</p>
                    </div>
                </div>
            </div>
            <div class="filter-actions">
                <button class="filter-btn" id="closeExportBtn">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- View/Edit Modal -->
    <div class="view-modal" id="viewModal">
        <div class="view-modal-content">
            <div class="view-modal-header">
                <h2 class="view-modal-title" id="modalTitle">Details</h2>
                <button class="close-view-modal" id="closeViewModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="view-modal-body" id="modalContent">
                <!-- Modal content will be loaded here -->
            </div>
            <div class="view-modal-footer">
                <button class="view-modal-btn close" id="closeModalBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js';
    import { getFirestore, collection, query, where, getDocs, doc, getDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAf-wtZpl8wVjCymdLlC-YGlv7xn0yEMMU",
        authDomain: "palmaegis-setup.firebaseapp.com",
        projectId: "palmaegis-setup",
        storageBucket: "palmaegis-setup.firebasestorage.app",
        messagingSenderId: "445887502374",
        appId: "1:445887502374:web:a5f6ecaa90b88447626ee7"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Global variables
    let currentUser = null;
    let allFarms = [];
    let allAssessments = [];
    let filteredAssessments = [];
    let currentModalData = null;

    // DOM elements - moved to global scope
    let loadingState, reportsSection, reportsGrid, noDataMessage, dataTablesSection;
    let assessmentsTableBody, farmsTableBody, filterModal, exportModal, viewModal;
    let modalTitle, modalContent, editModalBtn, closeViewModal, closeModalBtn;
    let filterBtn, closeFilter, closeExport, closeExportBtn, applyFilters;
    let clearFilters, dateFilter, healthFilter, diseaseFilter, downloadAllBtn;
    let invoiceReportBtn, viewCardsBtn, viewTablesBtn;

    // Check authentication state
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            console.log('User is signed in:', user.email);
            currentUser = user;

            try {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    window.userData = userData;
                    updateUserProfile(user, userData);
                } else {
                    updateUserProfile(user, {});
                }

                // Initialize DOM elements AFTER they're loaded
                initializeDOMElements();
                
                // Load report data
                loadFarmReports();
            } catch (error) {
                console.error('Error loading user data:', error);
                updateUserProfile(user, {});
                showError("Failed to load user data. Please try again.");
            }
        } else {
            console.log('User is not signed in');
            window.location.href = 'signin.html';
        }
    });

    function initializeDOMElements() {
        // Initialize DOM elements
        loadingState = document.getElementById('loadingState');
        reportsSection = document.getElementById('reportsSection');
        reportsGrid = document.getElementById('reportsGrid');
        noDataMessage = document.getElementById('noDataMessage');
        dataTablesSection = document.getElementById('dataTablesSection');
        assessmentsTableBody = document.getElementById('assessmentsTableBody');
        farmsTableBody = document.getElementById('farmsTableBody');
        filterModal = document.getElementById('filterModal');
        exportModal = document.getElementById('exportModal');
        viewModal = document.getElementById('viewModal');
        modalTitle = document.getElementById('modalTitle');
        modalContent = document.getElementById('modalContent');
        editModalBtn = document.getElementById('editModalBtn');
        closeViewModal = document.getElementById('closeViewModal');
        closeModalBtn = document.getElementById('closeModalBtn');
        filterBtn = document.getElementById('filterBtn');
        closeFilter = document.getElementById('closeFilter');
        closeExport = document.getElementById('closeExport');
        closeExportBtn = document.getElementById('closeExportBtn');
        applyFilters = document.getElementById('applyFilters');
        clearFilters = document.getElementById('clearFilters');
        dateFilter = document.getElementById('dateFilter');
        healthFilter = document.getElementById('healthFilter');
        diseaseFilter = document.getElementById('diseaseFilter');
        downloadAllBtn = document.getElementById('downloadAllBtn');
        invoiceReportBtn = document.getElementById('invoiceReportBtn');
        viewCardsBtn = document.getElementById('viewCardsBtn');
        viewTablesBtn = document.getElementById('viewTablesBtn');

        // Setup event listeners
        setupEventListeners();
    }

    function updateUserProfile(user, userData) {
        const userNameElement = document.querySelector('.user-name');
        const userRoleElement = document.querySelector('.user-role');

        const displayName = userData.firstName && userData.lastName
            ? `${userData.firstName} ${userData.lastName}`
            : userData.username
                ? userData.username
                : userData.displayName || user.displayName || user.email.split('@')[0] || 'User';

        if (userNameElement) userNameElement.textContent = displayName;
        if (userRoleElement) userRoleElement.textContent = userData.bio || 'Farmer';

        // set avatar(s) safely
        const avatarSrc = userData.imageBase64 || userData.picture || userData.photoURL || 'images/user-avatar.jpg';
        const avatars = document.querySelectorAll('.user-avatar');
        avatars.forEach(img => {
            if (img) {
                img.src = avatarSrc;
                img.onerror = () => { img.src = 'images/default-avatar.png'; };
            }
        });

        // store for later in case sidebar is loaded after profile
        window.userData = userData;
    }

    // Set up event listeners
    function setupEventListeners() {
        // View toggle
        if (viewCardsBtn) {
            viewCardsBtn.addEventListener('click', () => {
                viewCardsBtn.classList.add('active');
                viewTablesBtn.classList.remove('active');
                reportsSection.style.display = 'block';
                dataTablesSection.style.display = 'none';
            });
        }

        if (viewTablesBtn) {
            viewTablesBtn.addEventListener('click', () => {
                viewTablesBtn.classList.add('active');
                viewCardsBtn.classList.remove('active');
                reportsSection.style.display = 'none';
                dataTablesSection.style.display = 'block';
            });
        }

        // Filter modal
        if (filterBtn) {
            filterBtn.addEventListener('click', () => {
                filterModal.style.display = 'flex';
                filterModal.classList.add('active');
            });
        }

        if (closeFilter) {
            closeFilter.addEventListener('click', () => {
                filterModal.style.display = 'none';
                filterModal.classList.remove('active');
            });
        }

        if (applyFilters) {
            applyFilters.addEventListener('click', () => {
                applyFilter();
                filterModal.style.display = 'none';
                filterModal.classList.remove('active');
            });
        }

        if (clearFilters) {
            clearFilters.addEventListener('click', () => {
                dateFilter.value = 'all';
                healthFilter.value = 'all';
                diseaseFilter.value = 'all';
                applyFilter();
            });
        }

        // Export/Download buttons
        if (downloadAllBtn) {
            downloadAllBtn.addEventListener('click', () => {
                exportModal.style.display = 'flex';
                exportModal.classList.add('active');
            });
        }

        if (invoiceReportBtn) {
            invoiceReportBtn.addEventListener('click', generateInvoiceReport);
        }

        // Export modal
        if (closeExport) {
            closeExport.addEventListener('click', () => {
                exportModal.style.display = 'none';
                exportModal.classList.remove('active');
            });
        }

        if (closeExportBtn) {
            closeExportBtn.addEventListener('click', () => {
                exportModal.style.display = 'none';
                exportModal.classList.remove('active');
            });
        }

        // View modal
        if (closeViewModal) {
            closeViewModal.addEventListener('click', closeViewModalFunc);
        }
        
        if (closeModalBtn) {
            closeModalBtn.addEventListener('click', closeViewModalFunc);
        }

        // Close modals when clicking outside
        if (filterModal) {
            filterModal.addEventListener('click', (e) => {
                if (e.target === filterModal) {
                    filterModal.style.display = 'none';
                    filterModal.classList.remove('active');
                }
            });
        }

        if (exportModal) {
            exportModal.addEventListener('click', (e) => {
                if (e.target === exportModal) {
                    exportModal.style.display = 'none';
                    exportModal.classList.remove('active');
                }
            });
        }

        if (viewModal) {
            viewModal.addEventListener('click', (e) => {
                if (e.target === viewModal) {
                    closeViewModalFunc();
                }
            });
        }

        // Edit button in modal
        if (editModalBtn) {
            editModalBtn.addEventListener('click', () => {
                if (currentModalData && currentModalData.type === 'assessment') {
                    editAssessment(currentModalData.id);
                } else if (currentModalData && currentModalData.type === 'farm') {
                    editFarm(currentModalData.id);
                }
            });
        }

        // Logout functionality
        document.addEventListener('click', function (e) {
            if (e.target.id === 'logoutBtn') {
                e.preventDefault();
                signOut(auth).then(() => {
                    window.location.href = 'signin.html';
                }).catch((error) => {
                    console.error('Logout error:', error);
                });
            }
        });
    }

    // Show error message
    function showError(message) {
        if (loadingState) {
            loadingState.innerHTML = `
                <div style="color: #e53935;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <h3>Error Loading Reports</h3>
                    <p>${message}</p>
                    <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Try Again
                    </button>
                </div>
            `;
        }
    }

    // Load farm reports from Firebase
    async function loadFarmReports() {
        try {
            // Load farms
            const farmsQuery = query(
                collection(db, "farms"),
                where("userId", "==", currentUser.uid)
            );
            
            const farmsSnapshot = await getDocs(farmsQuery);
            allFarms = [];
            farmsSnapshot.forEach(doc => {
                const data = doc.data();
                allFarms.push({
                    id: doc.id,
                    ...data,
                    createdAt: data.createdAt?.toDate() || new Date()
                });
            });

            console.log(`Loaded ${allFarms.length} farms`);

            // Load assessments
            const assessmentsQuery = query(
                collection(db, "assessments"),
                where("userId", "==", currentUser.uid)
            );
            
            const assessmentsSnapshot = await getDocs(assessmentsQuery);
            allAssessments = [];
            assessmentsSnapshot.forEach(doc => {
                const data = doc.data();
                allAssessments.push({
                    id: doc.id,
                    ...data,
                    date: data.date || data.timestamp?.toDate() || new Date(),
                    timestamp: data.timestamp?.toDate() || new Date()
                });
            });

            console.log(`Loaded ${allAssessments.length} assessments`);

            // Populate disease filter
            populateDiseaseFilter();

            // Apply initial filters
            applyFilter();

            // Hide loading state
            if (loadingState) {
                loadingState.style.display = 'none';
            }

        } catch (error) {
            console.error('Error loading farm reports:', error);
            showError(error.message);
        }
    }

    function populateDiseaseFilter() {
        if (!diseaseFilter) return;
        
        const diseases = [...new Set(allAssessments.map(a => a.disease).filter(d => d))];
        diseaseFilter.innerHTML = '<option value="all">All Diseases</option>';
        diseases.forEach(disease => {
            const option = document.createElement('option');
            option.value = disease;
            option.textContent = disease;
            diseaseFilter.appendChild(option);
        });
    }

    function applyFilter() {
        const dateRange = dateFilter ? dateFilter.value : 'all';
        const healthStatus = healthFilter ? healthFilter.value : 'all';
        const diseaseType = diseaseFilter ? diseaseFilter.value : 'all';

        filteredAssessments = allAssessments.filter(assessment => {
            // Filter by date range
            if (dateRange !== 'all') {
                const now = new Date();
                const assessmentDate = assessment.timestamp;
                let cutoffDate = new Date();

                switch (dateRange) {
                    case 'week':
                        cutoffDate.setDate(now.getDate() - 7);
                        break;
                    case 'month':
                        cutoffDate.setDate(now.getDate() - 30);
                        break;
                    case 'quarter':
                        cutoffDate.setDate(now.getDate() - 90);
                        break;
                    case 'year':
                        cutoffDate.setFullYear(now.getFullYear() - 1);
                        break;
                }

                if (assessmentDate < cutoffDate) {
                    return false;
                }
            }

            // Filter by health status
            if (healthStatus !== 'all' && assessment.healthStatus !== healthStatus) {
                return false;
            }

            // Filter by disease type
            if (diseaseType !== 'all' && assessment.disease !== diseaseType) {
                return false;
            }

            return true;
        });

        // Sort by date (newest first)
        filteredAssessments.sort((a, b) => b.timestamp - a.timestamp);

        updateUI();
    }

    function updateUI() {
        if (filteredAssessments.length === 0 && allFarms.length === 0) {
            if (reportsSection) reportsSection.style.display = 'none';
            if (dataTablesSection) dataTablesSection.style.display = 'none';
            if (noDataMessage) noDataMessage.style.display = 'block';
            return;
        }
        
        if (reportsSection) reportsSection.style.display = 'block';
        if (dataTablesSection) dataTablesSection.style.display = 'block';
        if (noDataMessage) noDataMessage.style.display = 'none';

        // Update reports grid
        updateReportsGrid();

        // Update tables
        updateTables();
    }

    function updateReportsGrid() {
        if (!reportsGrid) return;
        
        reportsGrid.innerHTML = '';

        filteredAssessments.slice(0, 6).forEach(assessment => {
            const card = createReportCard(assessment);
            reportsGrid.appendChild(card);
        });
    }

    function createReportCard(assessment) {
        const card = document.createElement('div');
        card.className = 'report-card';

        const date = new Date(assessment.date).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });

        const healthStatus = assessment.healthStatus || 'Healthy';
        let statusClass = 'status-healthy';
        if (healthStatus === 'Infected') statusClass = 'status-infected';
        else if (healthStatus === 'Warning') statusClass = 'status-warning';

        card.innerHTML = `
            <div class="report-header">
                <div>
                    <div class="report-title">${date}</div>
                    <div class="report-date">${assessment.time || ''}</div>
                </div>
                <div class="health-score ${statusClass}">
                    ${healthStatus}
                </div>
            </div>
            <div class="report-content">
                <div class="report-field">
                    <span class="field-label">Disease:</span>
                    <span class="field-value">${assessment.disease || 'None detected'}</span>
                </div>
                <div class="report-field">
                    <span class="field-label">Detection Count:</span>
                    <span class="field-value">${assessment.detectionCount || 0}</span>
                </div>
                <div class="report-field">
                    <span class="field-label">Confidence:</span>
                    <span class="field-value">${assessment.confidenceThreshold ? Math.round(assessment.confidenceThreshold * 100) + '%' : 'N/A'}</span>
                </div>
                <div class="report-field">
                    <span class="field-label">Location:</span>
                    <span class="field-value">${assessment.location || 'Not specified'}</span>
                </div>
                <div class="report-field">
                    <span class="field-label">Treatment:</span>
                    <span class="field-value">${assessment.treatment ? 'Recommended' : 'None'}</span>
                </div>
            </div>
            <div class="report-actions">
                <button class="view-btn" onclick="window.viewAssessment('${assessment.id}')">
                    <i class="fas fa-eye"></i> View
                </button>
                <button class="download-btn" onclick="window.downloadSingleAssessment('${assessment.id}')">
                    <i class="fas fa-download"></i> PDF
                </button>
            </div>
        `;

        return card;
    }

    // ==================== TABLE UPDATE FUNCTIONS ====================
function updateTables() {
    // Update assessments table
    if (assessmentsTableBody) {
        assessmentsTableBody.innerHTML = '';
        
        filteredAssessments.forEach(assessment => {
            const row = document.createElement('tr');
            
            // Format date
            let displayDate = 'N/A';
            try {
                if (assessment.date) {
                    const dateObj = assessment.date.toDate ? assessment.date.toDate() : new Date(assessment.date);
                    displayDate = dateObj.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                }
            } catch (e) {
                console.error('Error formatting date:', e);
            }
            
            // Get disease name - use assessment.disease or fallback
            const diseaseName = assessment.disease || assessment.Name_Disease || 'None detected';
            
            // Get health status
            const healthStatus = assessment.Health_Status || assessment.healthStatus || 'Unknown';
            let statusClass = 'status-healthy';
            if (healthStatus === 'Infected' || healthStatus === 'Not Healthy') statusClass = 'status-infected';
            else if (healthStatus === 'Warning' || healthStatus === 'At Risk') statusClass = 'status-warning';
            
            // Get detection count
            const detectionCount = assessment.Detection_Count || assessment.detectionCount || 0;
            
            // Get location
            const location = assessment.Location || assessment.location || 'Not specified';
            
            // Get treatment
            const treatment = assessment.Treatment || assessment.treatment || 'None';
            
            // Get image - check multiple possible fields
            let imageUrl = '';
            if (assessment.Image) {
                imageUrl = assessment.Image;
            } else if (assessment.image) {
                imageUrl = assessment.image;
            } else if (assessment.images && Array.isArray(assessment.images) && assessment.images.length > 0) {
                imageUrl = assessment.images[0];
            }
            
            // Build table row HTML
            row.innerHTML = `
                <td>
                    <div>${displayDate}</div>
                    ${assessment.time ? `<small style="color: var(--text-lighter);">${assessment.time}</small>` : ''}
                </td>
                <td>${diseaseName}</td>
                <td><span class="status-badge ${statusClass}">${healthStatus}</span></td>
                <td>${detectionCount}</td>
                <td>
                    ${imageUrl ? 
                        `<img src="${imageUrl}" alt="Assessment" class="image-preview" onclick="window.viewImage('${imageUrl}')">` : 
                        '<span style="color: var(--text-lighter);">No image</span>'
                    }
                </td>
                <td>${location}</td>
                <td>${treatment}</td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn view-action" onclick="window.viewAssessment('${assessment.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn delete-action" onclick="window.deleteAssessment('${assessment.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            
            assessmentsTableBody.appendChild(row);
        });
    }

    // Update farms table (keep as is)
    if (farmsTableBody) {
        farmsTableBody.innerHTML = '';
        
        allFarms.forEach(farm => {
            const row = document.createElement('tr');
            
            // Get images if available
            let imagesHtml = '<span style="color: var(--text-lighter);">No images</span>';
            if (farm.images && Array.isArray(farm.images) && farm.images.length > 0) {
                imagesHtml = farm.images.slice(0, 3).map((img, index) => 
                    `<img src="${img}" alt="Farm ${index+1}" class="image-preview" onclick="window.viewImage('${img}')">`
                ).join(' ');
                if (farm.images.length > 3) {
                    imagesHtml += ` <span style="color: var(--text-lighter);">+${farm.images.length - 3} more</span>`;
                }
            }

            row.innerHTML = `
                <td><strong>${farm.name || 'Unnamed Farm'}</strong></td>
                <td>${farm.location || 'Not specified'}</td>
                <td>${farm.area || 'N/A'}</td>
                <td>${farm.crops || 'Oil Palm'}</td>
                <td>${farm.soilType || 'Not specified'}</td>
                <td><span class="status-badge ${farm.status === 'Active' ? 'status-healthy' : 'status-warning'}">${farm.status || 'Active'}</span></td>
                <td>${imagesHtml}</td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn view-action" onclick="window.viewFarm('${farm.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn delete-action" onclick="window.deleteFarm('${farm.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            
            farmsTableBody.appendChild(row);
        });
    }
}

// ==================== REPORT CARD FIX ====================
function createReportCard(assessment) {
    const card = document.createElement('div');
    card.className = 'report-card';

    // Format date
    let displayDate = 'N/A';
    try {
        if (assessment.date) {
            const dateObj = assessment.date.toDate ? assessment.date.toDate() : new Date(assessment.date);
            displayDate = dateObj.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
    } catch (e) {
        console.error('Error formatting date:', e);
    }

    // Get disease name
    const diseaseName = assessment.disease || assessment.Name_Disease || 'None detected';
    
    // Get health status
    const healthStatus = assessment.Health_Status || assessment.healthStatus || 'Unknown';
    let statusClass = 'status-healthy';
    if (healthStatus === 'Infected' || healthStatus === 'Not Healthy') statusClass = 'status-infected';
    else if (healthStatus === 'Warning' || healthStatus === 'At Risk') statusClass = 'status-warning';
    
    // Get other fields
    const detectionCount = assessment.Detection_Count || assessment.detectionCount || 0;
    const location = assessment.Location || assessment.location || 'Not specified';
    const treatment = assessment.Treatment || assessment.treatment || 'None';
    const confidence = assessment.confidenceThreshold ? Math.round(assessment.confidenceThreshold * 100) + '%' : 'N/A';

    card.innerHTML = `
        <div class="report-header">
            <div>
                <div class="report-title">${displayDate}</div>
                ${assessment.time ? `<div class="report-date">${assessment.time}</div>` : ''}
            </div>
            <div class="health-score ${statusClass}">
                ${healthStatus}
            </div>
        </div>
        <div class="report-content">
            <div class="report-field">
                <span class="field-label">Disease:</span>
                <span class="field-value">${diseaseName}</span>
            </div>
            <div class="report-field">
                <span class="field-label">Detection Count:</span>
                <span class="field-value">${detectionCount}</span>
            </div>
            <div class="report-field">
                <span class="field-label">Confidence:</span>
                <span class="field-value">${confidence}</span>
            </div>
            <div class="report-field">
                <span class="field-label">Location:</span>
                <span class="field-value">${location}</span>
            </div>
            <div class="report-field">
                <span class="field-label">Treatment:</span>
                <span class="field-value">${treatment !== 'None' ? 'Recommended' : 'None'}</span>
            </div>
        </div>
        <div class="report-actions">
            <button class="view-btn" onclick="window.viewAssessment('${assessment.id}')">
                <i class="fas fa-eye"></i> View
            </button>
            <button class="download-btn" onclick="window.downloadSingleAssessment('${assessment.id}')">
                <i class="fas fa-download"></i> PDF
            </button>
        </div>
    `;

    return card;
}

// ==================== MODAL DISPLAY FIX ====================
function showAssessmentModal(assessment, isEditMode = false) {
    // Format date
    let displayDate = 'N/A';
    try {
        if (assessment.date) {
            const dateObj = assessment.date.toDate ? assessment.date.toDate() : new Date(assessment.date);
            displayDate = dateObj.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
    } catch (e) {
        console.error('Error formatting date:', e);
    }
    
    // Get disease name
    const diseaseName = assessment.disease || assessment.Name_Disease || 'None detected';
    
    // Get health status
    const healthStatus = assessment.Health_Status || assessment.healthStatus || 'Unknown';
    let statusClass = 'status-healthy';
    if (healthStatus === 'Infected' || healthStatus === 'Not Healthy') statusClass = 'status-infected';
    else if (healthStatus === 'Warning' || healthStatus === 'At Risk') statusClass = 'status-warning';
    
    // Get other fields
    const detectionCount = assessment.Detection_Count || assessment.detectionCount || 0;
    const location = assessment.Location || assessment.location || 'Not specified';
    const treatment = assessment.Treatment || assessment.treatment || 'None';
    const confidence = assessment.confidenceThreshold ? Math.round(assessment.confidenceThreshold * 100) + '%' : 'N/A';
    
    // Get image
    let imageUrl = '';
    if (assessment.Image) {
        imageUrl = assessment.Image;
    } else if (assessment.image) {
        imageUrl = assessment.image;
    } else if (assessment.images && Array.isArray(assessment.images) && assessment.images.length > 0) {
        imageUrl = assessment.images[0];
    }
    
    // Build modal HTML
    let imageHtml = '';
    if (imageUrl) {
        imageHtml = `
            <div style="margin:15px 0;">
                <strong class="modal-data-label">Image:</strong>
                <img src="${imageUrl}" alt="Assessment" class="modal-image" onclick="window.viewImage('${imageUrl}')">
            </div>
        `;
    }
    
    let detectionsHtml = '';
    if (assessment.detections && Array.isArray(assessment.detections) && assessment.detections.length > 0) {
        detectionsHtml = `
            <div style="margin:15px 0;">
                <strong class="modal-data-label">Detections:</strong>
                <ul class="modal-detection-list">
                    ${assessment.detections.map((det, index) => `
                        <li class="modal-detection-item">${index + 1}. ${det.disease || 'Unknown'}: ${det.confidence ? Math.round(det.confidence * 100) : 0}% confidence</li>
                    `).join('')}
                </ul>
            </div>
        `;
    }
    
    const html = `
        <div class="modal-data-grid">
            <div class="modal-data-item">
                <span class="modal-data-label">Date</span>
                <span class="modal-data-value">${displayDate}</span>
            </div>
            <div class="modal-data-item">
                <span class="modal-data-label">Time</span>
                <span class="modal-data-value">${assessment.time || 'N/A'}</span>
            </div>
            <div class="modal-data-item">
                <span class="modal-data-label">Disease</span>
                <span class="modal-data-value">${diseaseName}</span>
            </div>
            <div class="modal-data-item">
                <span class="modal-data-label">Health Status</span>
                <span class="modal-data-value">
                    <span class="status-badge ${statusClass}">${healthStatus}</span>
                </span>
            </div>
            <div class="modal-data-item">
                <span class="modal-data-label">Detection Count</span>
                <span class="modal-data-value">${detectionCount}</span>
            </div>
            <div class="modal-data-item">
                <span class="modal-data-label">Confidence</span>
                <span class="modal-data-value">${confidence}</span>
            </div>
        </div>
        
        <div class="modal-data-item">
            <span class="modal-data-label">Location</span>
            <span class="modal-data-value">${location}</span>
        </div>
        
        <div class="modal-data-item">
            <span class="modal-data-label">Treatment</span>
            <div class="modal-data-value" style="white-space: pre-wrap;">${treatment}</div>
        </div>
        
        ${imageHtml}
        ${detectionsHtml}
        
        <div class="modal-id-badge">
            <strong>Assessment ID:</strong> ${assessment.id || 'N/A'}
        </div>
    `;

    if (modalTitle) modalTitle.textContent = 'Assessment Details';
    if (modalContent) modalContent.innerHTML = html;
    if (editModalBtn) editModalBtn.style.display = 'inline-block';
    if (viewModal) viewModal.style.display = 'flex';
}

    function showFarmModal(farm, isEditMode = false) {
        let imagesHtml = '';
        if (farm.images && Array.isArray(farm.images) && farm.images.length > 0) {
            imagesHtml = `
                <div style="margin:15px 0;">
                    <strong class="modal-data-label">Images (${farm.images.length}):</strong>
                    <div class="modal-images-container">
                        ${farm.images.slice(0, 4).map((img, index) => `
                            <img src="${img}" alt="Farm Image ${index + 1}" class="modal-image" onclick="window.viewImage('${img}')">
                        `).join('')}
                        ${farm.images.length > 4 ? `
                            <div style="width:80px; height:80px; background:#f0f0f0; border-radius:6px; display:flex; align-items:center; justify-content:center; border:1px dashed #ccc;">
                                <span style="color:#666; font-size:0.9rem;">+${farm.images.length - 4}</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        const createdAt = farm.createdAt ? new Date(farm.createdAt).toLocaleDateString() : 'N/A';
        const statusClass = farm.status === 'Active' ? 'status-healthy' : 'status-warning';

        const html = `
            <div class="modal-data-grid">
                <div class="modal-data-item">
                    <span class="modal-data-label">Farm Name</span>
                    <span class="modal-data-value">${farm.name || 'Unnamed Farm'}</span>
                </div>
                <div class="modal-data-item">
                    <span class="modal-data-label">Location</span>
                    <span class="modal-data-value">${farm.location || 'Not specified'}</span>
                </div>
                <div class="modal-data-item">
                    <span class="modal-data-label">Area</span>
                    <span class="modal-data-value">${farm.area || 'N/A'}</span>
                </div>
                <div class="modal-data-item">
                    <span class="modal-data-label">Crops</span>
                    <span class="modal-data-value">${farm.crops || 'Oil Palm'}</span>
                </div>
                <div class="modal-data-item">
                    <span class="modal-data-label">Soil Type</span>
                    <span class="modal-data-value">${farm.soilType || 'Not specified'}</span>
                </div>
                <div class="modal-data-item">
                    <span class="modal-data-label">Status</span>
                    <span class="modal-data-value">
                        <span class="status-badge ${statusClass}">${farm.status || 'Active'}</span>
                    </span>
                </div>
            </div>
            
            <div class="modal-data-item">
                <span class="modal-data-label">Created</span>
                <span class="modal-data-value">${createdAt}</span>
            </div>
            
            ${imagesHtml}
            
            <div class="modal-id-badge">
                <strong>Farm ID:</strong> ${farm.id || 'N/A'}
            </div>
        `;

        if (modalTitle) modalTitle.textContent = 'Farm Details';
        if (modalContent) modalContent.innerHTML = html;
        if (editModalBtn) editModalBtn.style.display = 'inline-block';
        if (viewModal) viewModal.style.display = 'flex';
    }

    // Helper function to check if a page exists
    function checkPageExists(url, successCallback, fallbackCallback) {
        fetch(url, { method: 'HEAD' })
            .then(response => {
                if (response.ok) {
                    successCallback();
                } else {
                    fallbackCallback();
                }
            })
            .catch(() => {
                fallbackCallback();
            });
    }

    // ==================== DELETE FUNCTIONS ====================
    window.deleteAssessment = async function(assessmentId) {
        if (confirm('Are you sure you want to delete this assessment?')) {
            try {
                await deleteDoc(doc(db, "assessments", assessmentId));
                
                // Remove from local arrays
                const index = allAssessments.findIndex(a => a.id === assessmentId);
                if (index !== -1) {
                    allAssessments.splice(index, 1);
                }
                
                const filteredIndex = filteredAssessments.findIndex(a => a.id === assessmentId);
                if (filteredIndex !== -1) {
                    filteredAssessments.splice(filteredIndex, 1);
                }
                
                // Update UI
                updateUI();
                alert('Assessment deleted successfully!');
            } catch (error) {
                console.error('Error deleting assessment:', error);
                alert('Failed to delete assessment. Please try again.');
            }
        }
    }

    window.deleteFarm = async function(farmId) {
        if (confirm('Are you sure you want to delete this farm? This will also delete all associated assessments.')) {
            try {
                // Delete farm
                await deleteDoc(doc(db, "farms", farmId));
                
                // Delete associated assessments
                const assessmentsQuery = query(
                    collection(db, "assessments"),
                    where("farmId", "==", farmId)
                );
                const assessmentsSnapshot = await getDocs(assessmentsQuery);
                
                const deletePromises = assessmentsSnapshot.docs.map(doc => deleteDoc(doc.ref));
                await Promise.all(deletePromises);
                
                // Remove from local arrays
                allFarms = allFarms.filter(f => f.id !== farmId);
                allAssessments = allAssessments.filter(a => a.farmId !== farmId);
                filteredAssessments = filteredAssessments.filter(a => a.farmId !== farmId);
                
                // Update UI
                updateUI();
                alert('Farm and associated assessments deleted successfully!');
            } catch (error) {
                console.error('Error deleting farm:', error);
                alert('Failed to delete farm. Please try again.');
            }
        }
    }

    // ==================== PDF FUNCTIONS ====================
    window.downloadSingleAssessment = function(assessmentId) {
        const assessment = filteredAssessments.find(a => a.id === assessmentId);
        if (assessment) {
            generateSingleAssessmentPDF(assessment);
        }
    }

    window.downloadSinglePDF = function() {
        if (filteredAssessments.length === 0) {
            alert('No reports available to download.');
            return;
        }
        generateCurrentViewPDF();
        if (exportModal) {
            exportModal.style.display = 'none';
            exportModal.classList.remove('active');
        }
    }

    window.downloadAllPDF = function() {
        if (allAssessments.length === 0 && allFarms.length === 0) {
            alert('No data available to download.');
            return;
        }
        generateCompleteReportPDF();
        if (exportModal) {
            exportModal.style.display = 'none';
            exportModal.classList.remove('active');
        }
    }

        async function generateSingleAssessmentPDF(assessment) {
            try {
                if (typeof window.jspdf === 'undefined') {
                    throw new Error('jsPDF library not loaded.');
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const pageWidth = doc.internal.pageSize.width;
                const margin = 20;
                const contentWidth = pageWidth - (2 * margin);
                let yOffset = 20;

                // Header
                doc.setFontSize(20);
                doc.setTextColor(46, 125, 50);
                doc.text('Palm Aegis - Assessment Report', pageWidth / 2, yOffset, { align: 'center' });
                yOffset += 10;

                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                doc.text(`Generated on: ${new Date().toLocaleDateString()}`, pageWidth / 2, yOffset, { align: 'center' });
                yOffset += 15;

                // Assessment Details Box
                doc.setFillColor(46, 125, 50, 10);
                doc.rect(margin, yOffset, contentWidth, 80, 'F');
                
                yOffset += 10;
                doc.setFontSize(16);
                doc.setTextColor(46, 125, 50);
                doc.text('Assessment Details', margin + 10, yOffset);
                yOffset += 15;

                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                
                const details = [
                    ['Date:', new Date(assessment.date).toLocaleDateString()],
                    ['Time:', assessment.time || 'N/A'],
                    ['Disease:', assessment.disease || 'None detected'],
                    ['Health Status:', assessment.healthStatus || 'Healthy'],
                    ['Detection Count:', String(assessment.detectionCount || 0)],
                    ['Confidence:', assessment.confidenceThreshold ? Math.round(assessment.confidenceThreshold * 100) + '%' : 'N/A'],
                    ['Location:', assessment.location || 'Not specified'],
                    ['Treatment:', assessment.treatment || 'None'],
                    ['User:', assessment.userName || currentUser?.email || 'N/A']
                ];

                details.forEach(([label, value]) => {
                    doc.text(label, margin + 15, yOffset);
                    doc.text(String(value), margin + 60, yOffset);
                    yOffset += 7;
                });

                yOffset += 20;

                // Detections Section
                if (assessment.detections && assessment.detections.length > 0) {
                    doc.setFontSize(14);
                    doc.setTextColor(46, 125, 50);
                    doc.text('Detected Issues', margin, yOffset);
                    yOffset += 10;

                    doc.setFontSize(11);
                    assessment.detections.forEach((det, index) => {
                        const detectionText = `${index + 1}. ${det.disease || 'Unknown'}: ${det.confidence ? Math.round(det.confidence * 100) : 0}% confidence`;
                        doc.text(detectionText, margin + 5, yOffset);
                        yOffset += 6;
                    });
                    yOffset += 10;
                }

                // Recommendations
                if (assessment.treatment) {
                    doc.setFontSize(14);
                    doc.setTextColor(46, 125, 50);
                    doc.text('Treatment Recommendations', margin, yOffset);
                    yOffset += 10;

                    doc.setFontSize(11);
                    const lines = doc.splitTextToSize(assessment.treatment, contentWidth);
                    lines.forEach(line => {
                        doc.text(line, margin + 5, yOffset);
                        yOffset += 6;
                    });
                    yOffset += 10;
                }

                // Footer
                const finalY = doc.internal.pageSize.height - 10;
                doc.setFontSize(10);
                doc.setTextColor(150, 150, 150);
                doc.text('Generated by Palm Aegis - Detection Disease System', pageWidth / 2, finalY, { align: 'center' });

                // Save the PDF
                const fileName = `Assessment-${assessment.id || 'report'}-${new Date().toISOString().slice(0,10)}.pdf`;
                doc.save(fileName);

            } catch (error) {
                console.error('Error generating PDF:', error);
                alert(`Failed to generate PDF: ${error.message}`);
            }
        }

        function generateCurrentViewPDF() {
            try {
                if (typeof window.jspdf === 'undefined') {
                    throw new Error('jsPDF library not loaded.');
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const pageWidth = doc.internal.pageSize.width;
                const margin = 20;
                let yOffset = 20;

                // Header
                doc.setFontSize(20);
                doc.setTextColor(46, 125, 50);
                doc.text('Palm Aegis - Current View Report', pageWidth / 2, yOffset, { align: 'center' });
                yOffset += 10;

                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                doc.text(`Filtered Results (${filteredAssessments.length} assessments)`, pageWidth / 2, yOffset, { align: 'center' });
                doc.text(`Generated: ${new Date().toLocaleDateString()}`, pageWidth / 2, yOffset + 7, { align: 'center' });
                yOffset += 20;

                // Assessment Table
                const tableData = filteredAssessments.map(assessment => [
                    new Date(assessment.date).toLocaleDateString('short'),
                    assessment.disease || 'None',
                    assessment.healthStatus || 'Healthy',
                    assessment.detectionCount || 0,
                    assessment.location || 'N/A',
                    assessment.treatment ? 'Yes' : 'No'
                ]);

                doc.autoTable({
                    startY: yOffset,
                    head: [['Date', 'Disease', 'Status', 'Count', 'Location', 'Treatment']],
                    body: tableData,
                    margin: { left: margin, right: margin },
                    headStyles: { fillColor: [46, 125, 50], textColor: [255, 255, 255] },
                    alternateRowStyles: { fillColor: [240, 255, 240] },
                    styles: { fontSize: 9, cellPadding: 3 }
                });

                yOffset = doc.lastAutoTable.finalY + 10;

                // Health Summary
                const healthyCount = filteredAssessments.filter(a => a.healthStatus === 'Healthy').length;
                const infectedCount = filteredAssessments.filter(a => a.healthStatus === 'Infected').length;
                const warningCount = filteredAssessments.filter(a => a.healthStatus === 'Warning').length;

                doc.setFontSize(14);
                doc.setTextColor(46, 125, 50);
                doc.text('Health Summary', margin, yOffset);
                yOffset += 10;

                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                doc.text(`Total Assessments: ${filteredAssessments.length}`, margin, yOffset);
                yOffset += 6;
                doc.text(`Healthy: ${healthyCount}`, margin, yOffset);
                yOffset += 6;
                doc.text(`Infected: ${infectedCount}`, margin, yOffset);
                yOffset += 6;
                doc.text(`Warning: ${warningCount}`, margin, yOffset);

                // Footer
                const finalY = doc.internal.pageSize.height - 10;
                doc.setFontSize(10);
                doc.setTextColor(150, 150, 150);
                doc.text('Generated by Palm Aegis - Smart Palm Farming System', pageWidth / 2, finalY, { align: 'center' });

                // Save the PDF
                const fileName = `Palm-Aegis-Current-View-${new Date().toISOString().slice(0,10)}.pdf`;
                doc.save(fileName);

            } catch (error) {
                console.error('Error generating PDF:', error);
                alert(`Failed to generate PDF: ${error.message}`);
            }
        }

        function generateCompleteReportPDF() {
            try {
                if (typeof window.jspdf === 'undefined') {
                    throw new Error('jsPDF library not loaded.');
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const pageWidth = doc.internal.pageSize.width;
                const margin = 20;
                let yOffset = 20;

                // Header
                doc.setFontSize(24);
                doc.setTextColor(46, 125, 50);
                doc.text('PALM AEGIS', pageWidth / 2, yOffset, { align: 'center' });
                
                doc.setFontSize(14);
                doc.setTextColor(100, 100, 100);
                doc.text('Complete Farm Report', pageWidth / 2, yOffset + 10, { align: 'center' });
                
                doc.setFontSize(12);
                doc.text(`Generated: ${new Date().toLocaleDateString()}`, pageWidth / 2, yOffset + 18, { align: 'center' });
                yOffset += 30;

                // User Info
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                doc.text(`User: ${window.userData?.firstName || ''} ${window.userData?.lastName || ''}`, margin, yOffset);
                doc.text(`Email: ${currentUser?.email || 'N/A'}`, pageWidth / 2, yOffset);
                yOffset += 15;

                // Farms Section
                if (allFarms.length > 0) {
                    doc.setFontSize(16);
                    doc.setTextColor(46, 125, 50);
                    doc.text('Farm Records', margin, yOffset);
                    yOffset += 10;

                    allFarms.forEach((farm, index) => {
                        if (yOffset > 250) {
                            doc.addPage();
                            yOffset = 20;
                        }

                        doc.setFontSize(12);
                        doc.setTextColor(46, 125, 50);
                        doc.text(`${index + 1}. ${farm.name || 'Unnamed Farm'}`, margin, yOffset);
                        yOffset += 7;

                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                        const details = [
                            `Location: ${farm.location || 'N/A'}`,
                            `Area: ${farm.area || 'N/A'}`,
                            `Crops: ${farm.crops || 'Oil Palm'}`,
                            `Soil Type: ${farm.soilType || 'N/A'}`,
                            `Status: ${farm.status || 'Active'}`,
                            `Created: ${farm.createdAt ? new Date(farm.createdAt).toLocaleDateString() : 'N/A'}`
                        ];

                        details.forEach(detail => {
                            doc.text(detail, margin + 5, yOffset);
                            yOffset += 5;
                        });

                        yOffset += 10;
                    });

                    yOffset += 10;
                }

                // Assessments Section
                if (allAssessments.length > 0) {
                    if (yOffset > 220) {
                        doc.addPage();
                        yOffset = 20;
                    }

                    doc.setFontSize(16);
                    doc.setTextColor(46, 125, 50);
                    doc.text('All Assessments', margin, yOffset);
                    yOffset += 10;

                    const tableData = allAssessments.map(assessment => [
                        new Date(assessment.date).toLocaleDateString('short'),
                        assessment.disease || 'None',
                        assessment.healthStatus || 'Healthy',
                        assessment.detectionCount || 0,
                        assessment.location || 'N/A'
                    ]);

                    doc.autoTable({
                        startY: yOffset,
                        head: [['Date', 'Disease', 'Status', 'Count', 'Location']],
                        body: tableData,
                        margin: { left: margin, right: margin },
                        headStyles: { fillColor: [46, 125, 50], textColor: [255, 255, 255] },
                        alternateRowStyles: { fillColor: [240, 255, 240] },
                        styles: { fontSize: 8, cellPadding: 2 }
                    });

                    yOffset = doc.lastAutoTable.finalY + 10;
                }

                // Statistics
                const totalAssessments = allAssessments.length;
                const totalFarms = allFarms.length;
                const infectedCount = allAssessments.filter(a => a.healthStatus === 'Infected').length;
                const healthyCount = allAssessments.filter(a => a.healthStatus === 'Healthy').length;

                doc.setFontSize(14);
                doc.setTextColor(46, 125, 50);
                doc.text('Overall Statistics', margin, yOffset);
                yOffset += 10;

                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                doc.text(`Total Farms: ${totalFarms}`, margin, yOffset);
                yOffset += 6;
                doc.text(`Total Assessments: ${totalAssessments}`, margin, yOffset);
                yOffset += 6;
                doc.text(`Healthy Plants: ${healthyCount}`, margin, yOffset);
                yOffset += 6;
                doc.text(`Infected Plants: ${infectedCount}`, margin, yOffset);
                yOffset += 6;
                
                const infectionRate = totalAssessments > 0 ? ((infectedCount / totalAssessments) * 100).toFixed(1) : 0;
                doc.text(`Infection Rate: ${infectionRate}%`, margin, yOffset);

                // Footer
                const finalY = doc.internal.pageSize.height - 20;
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text('--- End of Complete Report ---', pageWidth / 2, finalY - 10, { align: 'center' });
                doc.text('Generated by Palm Aegis - Smart Palm Farming System', pageWidth / 2, finalY, { align: 'center' });

                // Save the PDF
                const fileName = `Palm-Aegis-Complete-Report-${new Date().toISOString().slice(0,10)}.pdf`;
                doc.save(fileName);

            } catch (error) {
                console.error('Error generating PDF:', error);
                alert(`Failed to generate PDF: ${error.message}`);
            }
        }

        // ==================== INVOICE REPORT FUNCTION ====================
        async function generateInvoiceReport() {
            if (filteredAssessments.length === 0 && allFarms.length === 0) {
                alert('No data available for invoice report.');
                return;
            }

            const confirmed = confirm('Generate comprehensive invoice report with all data?');
            if (!confirmed) return;

            try {
                if (typeof window.jspdf === 'undefined') {
                    throw new Error('jsPDF library not loaded.');
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const pageWidth = doc.internal.pageSize.width;
                const margin = 20;
                const contentWidth = pageWidth - (2 * margin);
                let yOffset = 20;

                // Company Header
                doc.setFontSize(24);
                doc.setTextColor(46, 125, 50);
                doc.text('PALM AEGIS', pageWidth / 2, yOffset, { align: 'center' });
                
                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                doc.text('Smart Palm Farming System', pageWidth / 2, yOffset + 7, { align: 'center' });
                doc.text('INVOICE REPORT', pageWidth / 2, yOffset + 15, { align: 'center' });
                
                yOffset += 30;

                // User Information
                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                doc.text('User Information:', margin, yOffset);
                yOffset += 7;
                
                doc.text(`Name: ${window.userData?.firstName || ''} ${window.userData?.lastName || ''}`, margin + 5, yOffset);
                doc.text(`Email: ${currentUser?.email || 'N/A'}`, margin + 80, yOffset);
                yOffset += 7;
                doc.text(`Date: ${new Date().toLocaleDateString()}`, margin + 5, yOffset);
                doc.text(`Time: ${new Date().toLocaleTimeString()}`, margin + 80, yOffset);
                yOffset += 15;

                // Summary Statistics
                doc.setFillColor(46, 125, 50, 10);
                doc.rect(margin, yOffset, contentWidth, 25, 'F');
                
                doc.setFontSize(12);
                doc.setTextColor(46, 125, 50);
                doc.text('Report Summary', margin + 10, yOffset + 8);
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                
                const totalFarms = allFarms.length;
                const totalAssessments = allAssessments.length;
                const infectedCount = allAssessments.filter(a => a.healthStatus === 'Infected').length;
                const healthyCount = allAssessments.filter(a => a.healthStatus === 'Healthy').length;
                const warningCount = allAssessments.filter(a => a.healthStatus === 'Warning').length;

                doc.text(`Total Farms: ${totalFarms}`, margin + 10, yOffset + 18);
                doc.text(`Total Assessments: ${totalAssessments}`, margin + 60, yOffset + 18);
                doc.text(`Healthy: ${healthyCount}`, margin + 120, yOffset + 18);
                
                doc.text(`Infected: ${infectedCount}`, margin + 10, yOffset + 28);
                doc.text(`Warning: ${warningCount}`, margin + 60, yOffset + 28);
                
                yOffset += 40;

                // Farm Records Section
                if (allFarms.length > 0) {
                    doc.setFontSize(14);
                    doc.setTextColor(46, 125, 50);
                    doc.text('Farm Records', margin, yOffset);
                    yOffset += 10;

                    allFarms.forEach((farm, index) => {
                        if (yOffset > 250) {
                            doc.addPage();
                            yOffset = 20;
                        }

                        // Farm header
                        doc.setFontSize(11);
                        doc.setTextColor(46, 125, 50);
                        doc.text(`Farm ${index + 1}: ${farm.name || 'Unnamed Farm'}`, margin, yOffset);
                        yOffset += 7;

                        // Farm details
                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                        
                        const details = [
                            ['Location:', farm.location || 'Not specified'],
                            ['Area:', farm.area || 'N/A'],
                            ['Crops:', farm.crops || 'Oil Palm'],
                            ['Soil Type:', farm.soilType || 'Not specified'],
                            ['Status:', farm.status || 'Active'],
                            ['Created:', farm.createdAt ? new Date(farm.createdAt).toLocaleDateString() : 'N/A']
                        ];

                        details.forEach(([label, value]) => {
                            doc.text(`${label} ${value}`, margin + 5, yOffset);
                            yOffset += 5;
                        });

                        yOffset += 5;
                    });

                    yOffset += 10;
                }

                // Assessment Records Section
                if (filteredAssessments.length > 0) {
                    if (yOffset > 220) {
                        doc.addPage();
                        yOffset = 20;
                    }

                    doc.setFontSize(14);
                    doc.setTextColor(46, 125, 50);
                    doc.text('Assessment Records', margin, yOffset);
                    yOffset += 10;

                    // Create a table for assessments
                    const headers = ['Date', 'Disease', 'Status', 'Count', 'Location'];
                    const data = filteredAssessments.map(assessment => [
                        new Date(assessment.date).toLocaleDateString('short'),
                        assessment.disease || 'None',
                        assessment.healthStatus || 'Healthy',
                        assessment.detectionCount || '0',
                        assessment.location || 'N/A'
                    ]);

                    // Draw table
                    doc.autoTable({
                        startY: yOffset,
                        head: [headers],
                        body: data,
                        margin: { left: margin },
                        headStyles: { fillColor: [46, 125, 50], textColor: [255, 255, 255] },
                        alternateRowStyles: { fillColor: [240, 255, 240] },
                        styles: { fontSize: 9, cellPadding: 3 }
                    });

                    yOffset = doc.lastAutoTable.finalY + 10;
                }

                // Health Analysis Section
                if (yOffset > 200) {
                    doc.addPage();
                    yOffset = 20;
                }

                doc.setFontSize(14);
                doc.setTextColor(46, 125, 50);
                doc.text('Health Analysis', margin, yOffset);
                yOffset += 10;

                const healthyPercentage = totalAssessments > 0 ? (healthyCount / totalAssessments * 100).toFixed(1) : 0;
                const infectedPercentage = totalAssessments > 0 ? (infectedCount / totalAssessments * 100).toFixed(1) : 0;
                const warningPercentage = totalAssessments > 0 ? (warningCount / totalAssessments * 100).toFixed(1) : 0;

                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                
                doc.text('Health Status Distribution:', margin, yOffset);
                yOffset += 7;
                doc.text(` Healthy: ${healthyCount} (${healthyPercentage}%)`, margin + 10, yOffset);
                yOffset += 6;
                doc.text(` Infected: ${infectedCount} (${infectedPercentage}%)`, margin + 10, yOffset);
                yOffset += 6;
                doc.text(` Warning: ${warningCount} (${warningPercentage}%)`, margin + 10, yOffset);
                yOffset += 15;

                // Treatment Recommendations
                if (filteredAssessments.some(a => a.treatment)) {
                    const treatments = filteredAssessments.filter(a => a.treatment);
                    
                    doc.setFontSize(14);
                    doc.setTextColor(46, 125, 50);
                    doc.text('Treatment Recommendations', margin, yOffset);
                    yOffset += 10;

                    doc.setFontSize(11);
                    doc.setTextColor(0, 0, 0);

                    treatments.forEach((assessment, index) => {
                        if (yOffset > 250) {
                            doc.addPage();
                            yOffset = 20;
                        }

                        doc.text(`${index + 1}. ${assessment.disease || 'Unknown Disease'}`, margin, yOffset);
                        yOffset += 6;
                        doc.text(`   Treatment: ${assessment.treatment}`, margin + 5, yOffset);
                        yOffset += 6;
                        doc.text(`   Date: ${new Date(assessment.date).toLocaleDateString()}`, margin + 5, yOffset);
                        yOffset += 10;
                    });
                }

                // Footer with totals
                const finalY = doc.internal.pageSize.height - 20;
                
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text('--- End of Report ---', pageWidth / 2, finalY - 10, { align: 'center' });
                
                doc.setFontSize(9);
                doc.text(`Report generated by Palm Aegis on ${new Date().toLocaleString()}`, pageWidth / 2, finalY, { align: 'center' });
                doc.text('For inquiries contact: support@palmaegis.com | www.palmaegis.com', pageWidth / 2, finalY + 5, { align: 'center' });

                // Save the PDF
                const fileName = `Palm-Aegis-Invoice-Report-${new Date().toISOString().slice(0,10)}.pdf`;
                doc.save(fileName);

            } catch (error) {
                console.error('Error generating invoice report:', error);
                alert(`Failed to generate invoice report: ${error.message}`);
            }
        }
    </script>
</body>
</html>