<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - Palm Aegis</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="../images/logo1.png" type="image/png" sizes="32x32">
  <link rel="shortcut icon" href="images/logo1.png">
  <meta name="theme-color" content="#2e7d32">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="../admin/js/admin.js"></script>
  
  <style>
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }
    .stats-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
  </style>
</head>

<body class="bg-gray-50 font-[Inter] flex min-h-screen">

  <!-- Sidebar Container -->
  <div id="sidebar-container"></div>
  <script>
    // Load sidebar and initialize everything
    document.addEventListener('DOMContentLoaded', function() {
      // Load sidebar
      fetch('sidebaradmin.html')
        .then(response => response.text())
        .then(data => {
          document.getElementById('sidebar-container').innerHTML = data;
          
          // Highlight current page in sidebar
          const currentPage = window.location.pathname.split('/').pop();
          const navLinks = document.querySelectorAll('aside nav a');
          navLinks.forEach(link => {
            const linkPage = link.getAttribute('href');
            if (linkPage === currentPage) {
              link.classList.add('bg-green-600');
              link.classList.remove('hover:bg-green-600');
            }
          });
          
          // Now adjust main content after sidebar loads
          adjustMainContent();
          
          // Listen for sidebar toggle events
          window.addEventListener('sidebarToggled', adjustMainContent);
        })
        .catch(error => console.error('Error loading sidebar:', error));
        
      // Initialize Firebase and load users
      initializeFirebase();
    });

    // Function to adjust main content based on sidebar state
    function adjustMainContent() {
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.querySelector('.main-content');
      
      if (sidebar && mainContent) {
        // Give a small delay to ensure DOM is updated
        setTimeout(() => {
          if (sidebar.classList.contains('sidebar-collapsed')) {
            mainContent.style.marginLeft = '80px';
            mainContent.style.width = 'calc(100% - 80px)';
          } else {
            mainContent.style.marginLeft = '256px';
            mainContent.style.width = 'calc(100% - 256px)';
          }
        }, 50);
      }
    }

    // Adjust on window resize
    window.addEventListener('resize', function() {
      setTimeout(adjustMainContent, 100);
    });
  </script>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Header -->
    <header class="flex justify-between items-center mb-8">
      <div>
        <h1 class="text-3xl font-bold text-gray-800">Dashboard Overview</h1>
        <p class="text-gray-500">Monitor your palm disease detection platform</p>
      </div>
      <div class="flex items-center space-x-6">
        <!-- <div class="relative">
          <i class="fas fa-bell text-gray-700 text-lg"></i>
          <span id="notification-count" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs w-4 h-4 rounded-full flex items-center justify-center">0</span>
        </div> -->
        <div id="current-date" class="text-gray-600 text-sm"></div>
      </div>
    </header>

    <!-- Stats Section -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
      <div class="bg-white rounded-xl shadow p-6 flex items-center justify-between">
        <div>
          <h3 id="active-users-count" class="text-3xl font-bold text-green-700">0</h3>
          <p class="text-gray-500">Active Users</p>
        </div>
        <i class="fas fa-user-check text-3xl text-green-600"></i>
      </div>

      <div class="bg-white rounded-xl shadow p-6 flex items-center justify-between">
        <div>
          <h3 id="total-users-count" class="text-3xl font-bold text-green-700">0</h3>
          <p class="text-gray-500">Total Users</p>
        </div>
        <i class="fas fa-users text-3xl text-green-600"></i>
      </div>

      <div class="bg-white rounded-xl shadow p-6 flex items-center justify-between">
        <div>
          <h3 id="new-users-count" class="text-3xl font-bold text-green-700">0</h3>
          <p class="text-gray-500">New Registrations</p>
        </div>
        <i class="fas fa-user-plus text-3xl text-green-600"></i>
      </div>

      <div class="bg-white rounded-xl shadow p-6 flex items-center justify-between">
        <div>
          <h3 id="total-detections" class="text-3xl font-bold text-green-700">2</h3>
          <p class="text-gray-500">Total Disease</p>
        </div>
        <i class="fas fa-microscope text-3xl text-green-600"></i>
      </div>
    </section>

   <!-- Active Users -->
<section class="bg-white rounded-xl shadow p-6 mb-10">
  <div class="flex justify-between items-center mb-6">
    <div>
      <h3 class="text-xl font-semibold text-gray-800">Active Users</h3>
      <p class="text-sm text-gray-500 mt-1">Users who logged in within the last 24 hours</p>
    </div>
    <button onclick="showActiveUsersList()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-md transition flex items-center">
      <i class="fas fa-sync-alt mr-2"></i> Refresh
    </button>
  </div>
  
  <div id="active-users-list" class="overflow-x-auto">
    <!-- Loading State -->
    <div id="active-users-loading" class="text-center py-8">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 mb-4"></div>
      <p class="text-gray-500">Loading active users...</p>
    </div>
    
    <!-- Users Table (will be populated by JavaScript) -->
    <table id="active-users-table" class="min-w-full divide-y divide-gray-200 hidden">
      <thead>
        <tr class="bg-gray-50">
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Login</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
        </tr>
      </thead>
      <tbody id="active-users-body" class="bg-white divide-y divide-gray-200">
        <!-- Users will be inserted here by JavaScript -->
      </tbody>
    </table>
    
    <!-- Empty State -->
    <div id="active-users-empty" class="text-center py-10 hidden">
      <i class="fas fa-users text-4xl text-gray-300 mb-4"></i>
      <p class="text-gray-500 text-lg mb-2">No active users</p>
      <p class="text-gray-400 text-sm">Users who log in will appear here</p>
    </div>
    
    <!-- Error State -->
    <div id="active-users-error" class="text-center py-10 hidden">
      <i class="fas fa-exclamation-triangle text-4xl text-red-300 mb-4"></i>
      <p class="text-gray-500 text-lg mb-2">Failed to load users</p>
      <button onclick="showActiveUsersList()" class="mt-4 bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-md transition">
        Try Again
      </button>
    </div>
  </div>
  
  <!-- User Stats -->
  <div id="active-users-stats" class="mt-6 pt-6 border-t border-gray-100 hidden">
    <div class="flex items-center justify-between text-sm text-gray-500">
      <span>Showing <span id="showing-count" class="font-semibold">0</span> of <span id="total-active-count" class="font-semibold">0</span> active users</span>
      <span class="flex items-center">
        <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
        <span id="online-now" class="font-medium mr-1">0</span>online now
      </span>
    </div>
  </div>
</section>

    <!-- User Activity Bar Chart -->
    <section class="bg-white rounded-xl shadow p-6 mb-10">
      <div class="flex justify-between items-center mb-6">
        <div>
          <h3 class="text-xl font-semibold text-gray-800">User Activity Timeline</h3>
          <p class="text-sm text-gray-500 mt-1">User logins over the past 7 days</p>
        </div>
        <div class="flex space-x-2">
          <button onclick="loadUserActivityChart('7days')" class="bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded-md text-sm transition">
            7 Days
          </button>
          <button onclick="loadUserActivityChart('30days')" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded-md text-sm transition">
            30 Days
          </button>
        </div>
      </div>
      
      <div class="chart-container">
        <canvas id="userActivityChart"></canvas>
      </div>
      
      <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="stats-card rounded-lg p-4">
          <div class="flex items-center">
            <div class="bg-white bg-opacity-20 p-2 rounded-lg mr-3">
              <i class="fas fa-chart-line text-white"></i>
            </div>
            <div>
              <p class="text-sm opacity-90">Peak Activity</p>
              <p id="peak-activity-day" class="text-xl font-bold">Monday</p>
            </div>
          </div>
        </div>
        
        <div class="stats-card rounded-lg p-4">
          <div class="flex items-center">
            <div class="bg-white bg-opacity-20 p-2 rounded-lg mr-3">
              <i class="fas fa-users text-white"></i>
            </div>
            <div>
              <p class="text-sm opacity-90">Avg Daily Logins</p>
              <p id="avg-daily-logins" class="text-xl font-bold">24</p>
            </div>
          </div>
        </div>
        
        <div class="stats-card rounded-lg p-4">
          <div class="flex items-center">
            <div class="bg-white bg-opacity-20 p-2 rounded-lg mr-3">
              <i class="fas fa-arrow-up text-white"></i>
            </div>
            <div>
              <p class="text-sm opacity-90">Growth This Week</p>
              <p id="growth-percentage" class="text-xl font-bold">+12%</p>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    document.getElementById("current-date").innerText = new Date().toLocaleDateString();
    
    // User Activity Chart
    let userActivityChart = null;
    
    // Function to initialize and load the user activity chart
    async function loadUserActivityChart(timeRange = '7days') {
      try {
        // Get user data from Firestore
        const usersSnapshot = await db.collection('users').get();
        const now = new Date();
        const days = timeRange === '7days' ? 7 : 30;
        
        // Initialize data array for the chart
        const labels = [];
        const data = [];
        
        // Generate labels for the past N days
        for (let i = days - 1; i >= 0; i--) {
          const date = new Date(now);
          date.setDate(date.getDate() - i);
          const label = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
          labels.push(label);
          data.push(0); // Initialize with 0 logins
        }
        
        // Count logins per day
        usersSnapshot.forEach(doc => {
          const userData = doc.data();
          if (userData.lastLogin && userData.lastLogin.toDate) {
            const loginDate = userData.lastLogin.toDate();
            const daysAgo = Math.floor((now - loginDate) / (1000 * 60 * 60 * 24));
            
            if (daysAgo < days) {
              const index = days - 1 - daysAgo;
              if (index >= 0 && index < data.length) {
                data[index]++;
              }
            }
          }
        });
        
        // Calculate statistics
        const totalLogins = data.reduce((sum, count) => sum + count, 0);
        const avgDailyLogins = Math.round(totalLogins / days);
        const maxLogins = Math.max(...data);
        const maxIndex = data.indexOf(maxLogins);
        const peakDay = labels[maxIndex];
        
        // Calculate growth percentage (compare last 3 days with previous 3 days)
        let growthPercentage = 0;
        if (data.length >= 6) {
          const recent = data.slice(-3).reduce((a, b) => a + b, 0);
          const previous = data.slice(-6, -3).reduce((a, b) => a + b, 0);
          if (previous > 0) {
            growthPercentage = Math.round(((recent - previous) / previous) * 100);
          }
        }
        
        // Update stats cards
        document.getElementById('peak-activity-day').textContent = peakDay;
        document.getElementById('avg-daily-logins').textContent = avgDailyLogins;
        document.getElementById('growth-percentage').textContent = growthPercentage > 0 ? `+${growthPercentage}%` : `${growthPercentage}%`;
        
        // Create or update the chart
        const ctx = document.getElementById('userActivityChart').getContext('2d');
        
        if (userActivityChart) {
          userActivityChart.destroy();
        }
        
        userActivityChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'User Logins',
              data: data,
              backgroundColor: 'rgba(34, 197, 94, 0.7)',
              borderColor: 'rgba(34, 197, 94, 1)',
              borderWidth: 1,
              borderRadius: 6,
              hoverBackgroundColor: 'rgba(34, 197, 94, 0.9)'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: '#fff',
                bodyColor: '#fff',
                borderColor: 'rgba(34, 197, 94, 0.5)',
                borderWidth: 1,
                callbacks: {
                  label: function(context) {
                    const value = context.raw;
                    return `${value} user${value !== 1 ? 's' : ''} logged in`;
                  }
                }
              }
            },
            scales: {
              x: {
                grid: {
                  display: false
                },
                ticks: {
                  color: '#6b7280',
                  maxRotation: 45
                }
              },
              y: {
                beginAtZero: true,
                grid: {
                  color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                  color: '#6b7280',
                  precision: 0
                },
                title: {
                  display: true,
                  text: 'Number of Logins',
                  color: '#6b7280'
                }
              }
            },
            interaction: {
              intersect: false,
              mode: 'index'
            }
          }
        });
        
      } catch (error) {
        console.error('Error loading user activity chart:', error);
        // Show error state
        document.getElementById('userActivityChart').parentElement.innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-exclamation-triangle text-4xl text-red-300 mb-4"></i>
            <p class="text-gray-500 text-lg mb-2">Failed to load activity data</p>
            <button onclick="loadUserActivityChart('7days')" class="mt-4 bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-md transition">
              Try Again
            </button>
          </div>
        `;
      }
    }
    
    // Load the chart when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Small delay to ensure Firebase is initialized
      setTimeout(() => {
        if (typeof db !== 'undefined') {
          loadUserActivityChart('7days');
        }
      }, 1000);
    });
    
    // Function to refresh the chart
    window.refreshActivityChart = function() {
      loadUserActivityChart('7days');
    };
    
    // Make the function available globally
    window.loadUserActivityChart = loadUserActivityChart;
    
  </script>
</body>
</html>