<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farm Disease Treatment Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2e7d32;
            --primary-light: #4caf50;
            --primary-dark: #1b5e20;
            --secondary: #ff9800;
            --light: #f5f5f5;
            --dark: #333;
            --gray: #757575;
            --light-gray: #e0e0e0;
            --white: #ffffff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --radius: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f8f9fa;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 1rem 0;
            box-shadow: var(--shadow);
        }

        header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-size: 1.8rem;
            font-weight: 600;
        }

        nav ul {
            display: flex;
            list-style: none;
        }

        nav ul li {
            margin-left: 1.5rem;
        }

        nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: opacity 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        nav ul li a:hover {
            opacity: 0.9;
        }

        .admin-container {
            padding: 2rem 0;
        }

        .admin-section {
            background: var(--white);
            border-radius: var(--radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
        }

        .admin-section h2 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .admin-section h2 i {
            color: var(--secondary);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--light-gray);
            border-radius: var(--radius);
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.2);
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        .image-options {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .image-option {
            flex: 1;
            border: 2px solid var(--light-gray);
            border-radius: var(--radius);
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-option.active {
            border-color: var(--primary);
            background-color: rgba(46, 125, 50, 0.05);
        }

        .image-option i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: var(--gray);
        }

        .image-option.active i {
            color: var(--primary);
        }

        .image-preview {
            margin-top: 1rem;
            text-align: center;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-danger {
            background-color: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background-color: #d32f2f;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            box-shadow: var(--shadow);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .admin-table th, .admin-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--light-gray);
        }

        .admin-table th {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
        }

        .admin-table tr:last-child td {
            border-bottom: none;
        }

        .admin-table tr:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }

        .admin-table img {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .actions {
            display: flex;
            gap: 0.5rem;
        }

        .message {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }

        .error {
            background-color: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }

        .warning {
            background-color: #fff3e0;
            color: #ef6c00;
            border-left: 4px solid #ff9800;
        }

        .debug-info {
            background-color: #e3f2fd;
            color: #1565c0;
            padding: 1rem;
            border-radius: var(--radius);
            margin: 1rem 0;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .upload-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .upload-progress {
            width: 100%;
            height: 6px;
            background-color: var(--light-gray);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .upload-progress-bar {
            height: 100%;
            background-color: var(--primary);
            width: 0%;
            transition: width 0.3s;
        }

        footer {
            background-color: var(--dark);
            color: white;
            text-align: center;
            padding: 1.5rem 0;
            margin-top: 2rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--light-gray);
        }

        .plant-part-badge {
            background-color: var(--primary-light);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            header .container {
                flex-direction: column;
                gap: 1rem;
            }
            
            nav ul {
                justify-content: center;
            }
            
            .image-options {
                flex-direction: column;
            }
            
            .admin-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
      <!-- Sidebar Container -->
  <div id="sidebar-container"></div>
  <script>
    // Load sidebar and initialize everything
    document.addEventListener('DOMContentLoaded', function() {
      // Load sidebar
      fetch('sidebaradmin.html')
        .then(response => response.text())
        .then(data => {
          document.getElementById('sidebar-container').innerHTML = data;
          
          // Highlight current page in sidebar
          const currentPage = window.location.pathname.split('/').pop();
          const navLinks = document.querySelectorAll('aside nav a');
          navLinks.forEach(link => {
            const linkPage = link.getAttribute('href');
            if (linkPage === currentPage) {
              link.classList.add('bg-green-600');
              link.classList.remove('hover:bg-green-600');
            }
          });
          
          // Now adjust main content after sidebar loads
          adjustMainContent();
          
          // Listen for sidebar toggle events
          window.addEventListener('sidebarToggled', adjustMainContent);
        })
        .catch(error => console.error('Error loading sidebar:', error));
        
      // Initialize Firebase and load users
      initializeFirebase();
    });

    // Function to adjust main content based on sidebar state
    function adjustMainContent() {
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.querySelector('.main-content');
      
      if (sidebar && mainContent) {
        // Give a small delay to ensure DOM is updated
        setTimeout(() => {
          if (sidebar.classList.contains('sidebar-collapsed')) {
            mainContent.style.marginLeft = '80px';
            mainContent.style.width = 'calc(100% - 80px)';
          } else {
            mainContent.style.marginLeft = '256px';
            mainContent.style.width = 'calc(100% - 256px)';
          }
        }, 50);
      }
    }

    // Adjust on window resize
    window.addEventListener('resize', function() {
      setTimeout(adjustMainContent, 100);
    });
  </script>
    <header>
        <div class="container">
            <h1></i>Palm Aegis Treatment Admin</h1>
            <nav>
                <ul>
                    <li><a href="admindashboard.html"><i class="fas fa-home"></i> Home</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="admin-container container">
        <section class="admin-section">
            <h2><i class="fas fa-plus-circle"></i> Add New Treatment</h2>
            
            <!-- Debug Info -->
            <div id="debugInfo" class="debug-info" style="display: none;">
                <strong>Debug Information:</strong>
                <div id="debugContent"></div>
            </div>
            
            <form id="treatmentForm">
                <div class="form-group">
                    <label for="name">Disease Name</label>
                    <input type="text" id="name" class="form-control" placeholder="Enter disease name" required>
                </div>
                
                <div class="form-group">
                    <label for="plantPart">Plant Part</label>
                    <select id="plantPart" class="form-control" required>
                        <option value="">Select Plant Part</option>
                        <option value="Leaves">Leaves</option>
                        <option value="Fruits">Fruits</option>
                        <option value="Stems">Stems</option>
                        <option value="Roots">Roots</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Image</label>
                    <div class="image-options">
                        <div class="image-option active" id="urlOption">
                            <i class="fas fa-link"></i>
                            <p>Use URL</p>
                        </div>
                        <div class="image-option" id="uploadOption">
                            <i class="fas fa-upload"></i>
                            <p>Upload Image</p>
                        </div>
                    </div>
                    
                    <div id="urlInput" class="form-group">
                        <input type="url" id="image" class="form-control" placeholder="Enter image URL" required>
                    </div>
                    
                    <div id="uploadInput" class="form-group" style="display: none;">
                        <input type="file" id="imageUpload" class="form-control" accept="image/*">
                        <div class="image-preview" id="uploadPreview"></div>
                        <div class="upload-progress" id="uploadProgress" style="display: none;">
                            <div class="upload-progress-bar" id="uploadProgressBar"></div>
                        </div>
                        <div class="upload-status" id="uploadStatus"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="symptoms">Symptoms</label>
                    <textarea id="symptoms" class="form-control" placeholder="Describe the symptoms of the disease" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" class="form-control" placeholder="Provide a detailed description of the disease" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="treatment">Treatment (one per line)</label>
                    <textarea id="treatment" class="form-control" placeholder="Enter treatment methods, one per line" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="prevention">Prevention (one per line)</label>
                    <textarea id="prevention" class="form-control" placeholder="Enter prevention methods, one per line" required></textarea>
                </div>
                
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <i class="fas fa-save"></i> Add Treatment
                </button>
                <div id="formMessage"></div>
            </form>
        </section>

        <section class="admin-section">
            <h2><i class="fas fa-tasks"></i> Manage Treatments</h2>
            <div id="adminTreatmentContainer">
                <!-- Treatments will be loaded here dynamically -->
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2023 Farm Disease Treatment System. All rights reserved.</p>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAf-wtZpl8wVjCymdLlC-YGlv7xn0yEMMU",
            authDomain: "palmaegis-setup.firebaseapp.com",
            projectId: "palmaegis-setup",
            storageBucket: "palmaegis-setup.firebasestorage.app",
            messagingSenderId: "445887502374",
            appId: "1:445887502374:web:a5f6ecaa90b88447626ee7"
        };

        // Initialize Firebase
        let db;
        
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            showDebugInfo("Firebase initialization failed: " + error.message);
        }

        // DOM elements
        const treatmentForm = document.getElementById('treatmentForm');
        const adminTreatmentContainer = document.getElementById('adminTreatmentContainer');
        const formMessage = document.getElementById('formMessage');
        const urlOption = document.getElementById('urlOption');
        const uploadOption = document.getElementById('uploadOption');
        const urlInput = document.getElementById('urlInput');
        const uploadInput = document.getElementById('uploadInput');
        const imageUpload = document.getElementById('imageUpload');
        const uploadPreview = document.getElementById('uploadPreview');
        const uploadProgress = document.getElementById('uploadProgress');
        const uploadProgressBar = document.getElementById('uploadProgressBar');
        const uploadStatus = document.getElementById('uploadStatus');
        const submitBtn = document.getElementById('submitBtn');
        const debugInfo = document.getElementById('debugInfo');
        const debugContent = document.getElementById('debugContent');

        // Image upload state
        let selectedImageFile = null;
        let imageMode = 'url'; // 'url' or 'upload'

        // Base64 conversion function
        function imageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded, initializing...");
            checkFirebaseConnection();
            loadTreatments();
            setupEventListeners();
        });

        // Check Firebase connection
        function checkFirebaseConnection() {
            if (!db) {
                showDebugInfo("Firestore not initialized. Please check your Firebase configuration.");
                return;
            }
            
            // Test Firestore connection
            db.collection('treatments').limit(1).get()
                .then(() => {
                    console.log("Firestore connection successful");
                    showDebugInfo("Firestore connection: OK");
                })
                .catch(error => {
                    console.error("Firestore connection failed:", error);
                    showDebugInfo("Firestore connection failed: " + error.message + ". Please make sure Firestore is enabled in your Firebase project.");
                });
        }

        // Show debug information
        function showDebugInfo(message) {
            debugInfo.style.display = 'block';
            debugContent.innerHTML = message;
        }

        // Set up event listeners
        function setupEventListeners() {
            // Form submission
            treatmentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log("Form submitted");
                addTreatment();
            });

            // Image option selection
            urlOption.addEventListener('click', function() {
                setImageMode('url');
            });

            uploadOption.addEventListener('click', function() {
                setImageMode('upload');
            });

            // Image upload preview
            imageUpload.addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    selectedImageFile = e.target.files[0];
                    console.log("Image selected:", selectedImageFile.name);
                    
                    // Validate file type
                    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
                    if (!validTypes.includes(selectedImageFile.type)) {
                        showMessage('Please select a valid image file (JPEG, PNG, GIF, WebP)', 'error');
                        imageUpload.value = '';
                        selectedImageFile = null;
                        uploadPreview.innerHTML = '';
                        return;
                    }
                    
                    // Validate file size (max 2MB for Base64)
                    if (selectedImageFile.size > 2 * 1024 * 1024) {
                        showMessage('Image size should be less than 2MB for optimal performance', 'error');
                        imageUpload.value = '';
                        selectedImageFile = null;
                        uploadPreview.innerHTML = '';
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        uploadPreview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                    };
                    reader.readAsDataURL(selectedImageFile);
                }
            });
        }

        // Set image input mode
        function setImageMode(mode) {
            imageMode = mode;
            console.log("Image mode set to:", mode);
            
            if (mode === 'url') {
                urlOption.classList.add('active');
                uploadOption.classList.remove('active');
                urlInput.style.display = 'block';
                uploadInput.style.display = 'none';
                document.getElementById('image').required = true;
                imageUpload.required = false;
            } else {
                urlOption.classList.remove('active');
                uploadOption.classList.add('active');
                urlInput.style.display = 'none';
                uploadInput.style.display = 'block';
                document.getElementById('image').required = false;
                imageUpload.required = true;
            }
        }

        // Process image upload (using Base64)
        function processImageUpload(file) {
            console.log("Processing image upload...");
            return new Promise((resolve, reject) => {
                // Show upload progress
                uploadProgress.style.display = 'block';
                uploadStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing image...';
                
                // Simulate progress for better UX
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 10;
                    uploadProgressBar.style.width = progress + '%';
                    if (progress >= 90) {
                        clearInterval(progressInterval);
                    }
                }, 100);

                imageToBase64(file)
                    .then((base64Data) => {
                        clearInterval(progressInterval);
                        uploadProgressBar.style.width = '100%';
                        setTimeout(() => {
                            uploadProgress.style.display = 'none';
                            uploadStatus.innerHTML = '<i class="fas fa-check-circle" style="color: #4CAF50;"></i> Image processed successfully';
                        }, 500);
                        resolve(base64Data);
                    })
                    .catch((error) => {
                        clearInterval(progressInterval);
                        uploadProgress.style.display = 'none';
                        uploadStatus.innerHTML = '<i class="fas fa-times-circle" style="color: #f44336;"></i> Image processing failed';
                        reject(error);
                    });
            });
        }

        // Add new treatment to Firebase
        async function addTreatment() {
            if (!db) {
                showMessage('Firebase not initialized. Please check console for errors.', 'error');
                return;
            }

            // Disable submit button to prevent multiple submissions
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding Treatment...';

            const name = document.getElementById('name').value;
            const plantPart = document.getElementById('plantPart').value;
            const symptoms = document.getElementById('symptoms').value;
            const description = document.getElementById('description').value;
            const treatment = document.getElementById('treatment').value.split('\n').filter(item => item.trim() !== '');
            const prevention = document.getElementById('prevention').value.split('\n').filter(item => item.trim() !== '');
            
            console.log("Form data:", { name, plantPart, symptoms, description, treatment, prevention });
            
            let imageUrl = '';
            
            try {
                if (imageMode === 'url') {
                    imageUrl = document.getElementById('image').value;
                    console.log("Using image URL:", imageUrl);
                    
                    // Validate URL format
                    if (!isValidUrl(imageUrl)) {
                        showMessage('Please enter a valid image URL', 'error');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-save"></i> Add Treatment';
                        return;
                    }
                    
                    // Proceed to save treatment with URL
                    saveTreatmentToFirestore(name, plantPart, imageUrl, symptoms, description, treatment, prevention);
                    
                } else {
                    // Upload mode
                    if (!selectedImageFile) {
                        showMessage('Please select an image to upload', 'error');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-save"></i> Add Treatment';
                        return;
                    }
                    
                    showMessage('Processing image...', 'warning');
                    console.log("Starting image processing...");
                    
                    try {
                        // Process image to Base64
                        imageUrl = await processImageUpload(selectedImageFile);
                        console.log("Image processed to Base64 successfully");
                        
                        // Now save the treatment with Base64 data
                        saveTreatmentToFirestore(name, plantPart, imageUrl, symptoms, description, treatment, prevention);
                        
                    } catch (uploadError) {
                        console.error("Image processing failed:", uploadError);
                        showMessage('Image processing failed: ' + uploadError.message, 'error');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-save"></i> Add Treatment';
                        return;
                    }
                }
                
            } catch (error) {
                console.error("Error in addTreatment:", error);
                showMessage('Error: ' + error.message, 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Add Treatment';
            }
        }

        // Save treatment data to Firestore
        function saveTreatmentToFirestore(name, plantPart, imageUrl, symptoms, description, treatment, prevention) {
            console.log("Saving to Firestore...");
            const treatmentData = {
                name,
                plantPart,
                image: imageUrl,
                symptoms,
                description,
                treatment,
                prevention,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            console.log("Treatment data to save:", treatmentData);

            db.collection('treatments').add(treatmentData)
            .then((docRef) => {
                console.log("Document written with ID: ", docRef.id);
                showMessage('Treatment added successfully!', 'success');
                treatmentForm.reset();
                uploadPreview.innerHTML = '';
                uploadStatus.innerHTML = '';
                selectedImageFile = null;
                setImageMode('url'); // Reset to URL mode
                loadTreatments(); // Reload the list
            })
            .catch((error) => {
                console.error("Error adding document: ", error);
                showMessage('Error adding treatment: ' + error.message, 'error');
                showDebugInfo("Firestore error: " + error.message);
            })
            .finally(() => {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Add Treatment';
            });
        }

        // Simple URL validation
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        // Load treatments from Firebase
        function loadTreatments() {
            if (!db) {
                adminTreatmentContainer.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Firebase not initialized. Please check console.</p></div>';
                return;
            }

            adminTreatmentContainer.innerHTML = '<div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>Loading treatments...</p></div>';
            
            db.collection('treatments').orderBy('createdAt', 'desc').get()
            .then((querySnapshot) => {
                console.log("Loaded", querySnapshot.size, "treatments");
                
                if (querySnapshot.empty) {
                    adminTreatmentContainer.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>No treatments found. Add your first treatment above.</p></div>';
                    return;
                }
                
                let html = `
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Name</th>
                                <th>Plant Part</th>
                                <th>Symptoms</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    html += `
                        <tr>
                            <td><img src="${data.image}" alt="${data.name}" onerror="this.src='https://via.placeholder.com/80x60?text=No+Image'"></td>
                            <td>${data.name}</td>
                            <td><span class="plant-part-badge">${data.plantPart}</span></td>
                            <td>${data.symptoms.substring(0, 100)}${data.symptoms.length > 100 ? '...' : ''}</td>
                            <td class="actions">
                                <button class="btn btn-danger btn-sm" onclick="deleteTreatment('${doc.id}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                `;
                
                adminTreatmentContainer.innerHTML = html;
            })
            .catch((error) => {
                console.error("Error getting documents: ", error);
                adminTreatmentContainer.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Error loading treatments. Please check if Firestore is enabled.</p></div>';
                showDebugInfo("Load error: " + error.message);
            });
        }

        // Delete treatment from Firebase
        function deleteTreatment(id) {
            if (confirm('Are you sure you want to delete this treatment?')) {
                db.collection('treatments').doc(id).delete()
                .then(() => {
                    console.log("Document successfully deleted!");
                    showMessage('Treatment deleted successfully!', 'success');
                    loadTreatments(); // Reload the list
                })
                .catch((error) => {
                    console.error("Error removing document: ", error);
                    showMessage('Error deleting treatment: ' + error.message, 'error');
                    showDebugInfo("Delete error: " + error.message);
                });
            }
        }

        // Show message
        function showMessage(message, type) {
            formMessage.innerHTML = `<div class="message ${type}"><i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'}"></i> ${message}</div>`;
            setTimeout(() => {
                formMessage.innerHTML = '';
            }, 5000);
        }
    </script>
</body>
</html>