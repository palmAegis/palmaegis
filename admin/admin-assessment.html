<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Assessment Dashboard</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #2c3e50 0%, #4a6491 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        h1 {
            font-size: 28px;
            font-weight: 600;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-icon {
            font-size: 32px;
        }
        
        .auth-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        #user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #user-email {
            font-weight: 500;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 15px;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-logout {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-logout:hover {
            background-color: #c0392b;
        }
        
        .login-form {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            margin: 50px auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .login-form h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        .form-control:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .dashboard {
            display: none;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card h3 {
            font-size: 14px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        
        .search-box {
            position: relative;
            width: 300px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #7f8c8d;
        }
        
        .filters {
            display: flex;
            gap: 15px;
        }
        
        select {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: white;
            font-size: 15px;
        }
        
        .table-container {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background-color: #2c3e50;
            color: white;
        }
        
        th {
            padding: 18px 15px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 14px;
            letter-spacing: 0.5px;
        }
        
        tbody tr {
            border-bottom: 1px solid #f1f1f1;
            transition: background-color 0.2s;
        }
        
        tbody tr:hover {
            background-color: #f9f9f9;
        }
        
        td {
            padding: 16px 15px;
        }
        
        .status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-completed {
            background-color: #d5f4e6;
            color: #27ae60;
        }
        
        .status-pending {
            background-color: #fff4e6;
            color: #f39c12;
        }
        
        .status-in-progress {
            background-color: #e3f2fd;
            color: #3498db;
        }
        
        .action-btns {
            display: flex;
            gap: 8px;
        }
        
        .btn-action {
            padding: 6px 12px;
            font-size: 13px;
            border-radius: 4px;
        }
        
        .btn-view {
            background-color: #3498db;
            color: white;
        }
        
        .btn-edit {
            background-color: #2ecc71;
            color: white;
        }
        
        .btn-delete {
            background-color: #e74c3c;
            color: white;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 14px;
            margin-top: 30px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #7f8c8d;
        }
        
        .error {
            background-color: #ffeaea;
            color: #e74c3c;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }
        
        .empty-state i {
            font-size: 60px;
            margin-bottom: 20px;
            color: #ddd;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            
            .search-box {
                width: 100%;
            }
            
            .filters {
                width: 100%;
                justify-content: space-between;
            }
            
            th, td {
                padding: 12px 10px;
                font-size: 14px;
            }
            
            .action-btns {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Form (Initially Visible) -->
        <div id="login-section" class="login-form">
            <h2>Admin Login</h2>
            <div id="login-error" class="error" style="display: none;">
                Invalid email or password. Please try again.
            </div>
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" class="form-control" placeholder="admin@example.com" value="admin@example.com">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter your password" value="admin123">
            </div>
            <button id="login-btn" class="btn btn-primary" style="width: 100%;">Login as Admin</button>
            <div style="margin-top: 20px; font-size: 14px; color: #7f8c8d; text-align: center;">
                <p>Use any email/password for demo (Firebase Auth is in test mode)</p>
            </div>
        </div>
        
        <!-- Dashboard (Initially Hidden) -->
        <div id="dashboard" class="dashboard">
            <header>
                <div class="header-top">
                    <div class="logo">
                        <div class="logo-icon">üìä</div>
                        <h1>Assessment Dashboard</h1>
                    </div>
                    <div class="auth-section">
                        <div id="user-info">
                            <span id="user-email">admin@example.com</span>
                            <button id="logout-btn" class="btn btn-logout">Logout</button>
                        </div>
                    </div>
                </div>
                <p>Manage and monitor all assessment data from Firebase</p>
            </header>
            
            <!-- Statistics Cards -->
            <div class="stats-container">
                <div class="stat-card">
                    <h3>Total Assessments</h3>
                    <div id="total-assessments" class="stat-value">0</div>
                </div>
                <div class="stat-card">
                    <h3>Completed</h3>
                    <div id="completed-assessments" class="stat-value">0</div>
                </div>
                <div class="stat-card">
                    <h3>In Progress</h3>
                    <div id="inprogress-assessments" class="stat-value">0</div>
                </div>
                <div class="stat-card">
                    <h3>Average Score</h3>
                    <div id="average-score" class="stat-value">0</div>
                </div>
            </div>
            
            <!-- Controls -->
            <div class="controls">
                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="search-input" placeholder="Search assessments...">
                </div>
                <div class="filters">
                    <select id="status-filter">
                        <option value="all">All Status</option>
                        <option value="completed">Completed</option>
                        <option value="pending">Pending</option>
                        <option value="in-progress">In Progress</option>
                    </select>
                    <select id="sort-by">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="score-high">Score: High to Low</option>
                        <option value="score-low">Score: Low to High</option>
                    </select>
                </div>
            </div>
            
            <!-- Data Table -->
            <div class="table-container">
                <div id="loading" class="loading">Loading assessment data from Firebase...</div>
                <div id="error-message" class="error" style="display: none;">
                    Error loading data. Please check your connection and try again.
                </div>
                <div id="empty-state" class="empty-state" style="display: none;">
                    <div>üì≠</div>
                    <h3>No assessments found</h3>
                    <p>There are no assessments in the database yet.</p>
                </div>
                
                <table id="assessments-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Title</th>
                            <th>User</th>
                            <th>Status</th>
                            <th>Score</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="assessments-body">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <div class="footer">
                <p>Assessment Dashboard ‚Ä¢ Data loaded from Firebase Firestore</p>
                <p>Collection: <strong>assessments</strong> | Project: <strong>palmaegis-setup</strong></p>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAf-wtZpl8wVjCymdLlC-YGlv7xn0yEMMU",
            authDomain: "palmaegis-setup.firebaseapp.com",
            projectId: "palmaegis-setup",
            storageBucket: "palmaegis-setup.appspot.com",
            messagingSenderId: "445887502374",
            appId: "1:445887502374:web:a5f6ecaa90b88447626ee7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // DOM elements
        const loginSection = document.getElementById('login-section');
        const dashboard = document.getElementById('dashboard');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const loginError = document.getElementById('login-error');
        const assessmentsBody = document.getElementById('assessments-body');
        const loadingElement = document.getElementById('loading');
        const errorMessage = document.getElementById('error-message');
        const emptyState = document.getElementById('empty-state');
        const assessmentsTable = document.getElementById('assessments-table');
        const searchInput = document.getElementById('search-input');
        const statusFilter = document.getElementById('status-filter');
        const sortBy = document.getElementById('sort-by');
        const totalAssessmentsEl = document.getElementById('total-assessments');
        const completedAssessmentsEl = document.getElementById('completed-assessments');
        const inprogressAssessmentsEl = document.getElementById('inprogress-assessments');
        const averageScoreEl = document.getElementById('average-score');
        
        // Assessment data storage
        let allAssessments = [];
        let filteredAssessments = [];
        
        // Login function
        loginBtn.addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                loginError.textContent = "Please enter both email and password";
                loginError.style.display = 'block';
                return;
            }
            
            try {
                // Firebase authentication
                await auth.signInWithEmailAndPassword(email, password);
                // Success - handled by auth state listener
            } catch (error) {
                console.error("Login error:", error);
                loginError.textContent = error.message || "Login failed. Please try again.";
                loginError.style.display = 'block';
            }
        });
        
        // Logout function
        logoutBtn.addEventListener('click', () => {
            auth.signOut();
        });
        
        // Authentication state listener
        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in
                document.getElementById('user-email').textContent = user.email;
                loginSection.style.display = 'none';
                dashboard.style.display = 'block';
                loginError.style.display = 'none';
                
                // Load assessment data
                loadAssessments();
            } else {
                // User is signed out
                dashboard.style.display = 'none';
                loginSection.style.display = 'block';
                allAssessments = [];
                filteredAssessments = [];
            }
        });
        
        // Load assessments from Firestore
        async function loadAssessments() {
            try {
                loadingElement.style.display = 'block';
                errorMessage.style.display = 'none';
                emptyState.style.display = 'none';
                assessmentsTable.style.display = 'none';
                
                // Get assessments collection from Firestore
                const querySnapshot = await db.collection('assessments').get();
                
                allAssessments = [];
                querySnapshot.forEach(doc => {
                    const assessment = doc.data();
                    assessment.id = doc.id;
                    assessment.firestoreId = doc.id;
                    allAssessments.push(assessment);
                });
                
                // If no assessments exist, create some sample data for demonstration
                if (allAssessments.length === 0) {
                    console.log("No assessments found, creating sample data for demo");
                    await createSampleAssessments();
                    // Reload after creating sample data
                    return loadAssessments();
                }
                
                updateDashboard();
                
            } catch (error) {
                console.error("Error loading assessments:", error);
                loadingElement.style.display = 'none';
                errorMessage.style.display = 'block';
                assessmentsTable.style.display = 'none';
            }
        }
        
        // Create sample assessments for demonstration
        async function createSampleAssessments() {
            const sampleAssessments = [
                {
                    title: "JavaScript Fundamentals Assessment",
                    userId: "user_001",
                    userName: "Alex Johnson",
                    status: "completed",
                    score: 85,
                    totalQuestions: 20,
                    date: new Date(2023, 9, 15).toISOString(),
                    topics: ["Variables", "Functions", "Loops"]
                },
                {
                    title: "React.js Proficiency Test",
                    userId: "user_002",
                    userName: "Maria Garcia",
                    status: "in-progress",
                    score: 60,
                    totalQuestions: 15,
                    date: new Date(2023, 9, 18).toISOString(),
                    topics: ["Components", "State", "Hooks"]
                },
                {
                    title: "Database Design Exam",
                    userId: "user_003", 
                    userName: "David Chen",
                    status: "pending",
                    score: 0,
                    totalQuestions: 25,
                    date: new Date(2023, 9, 10).toISOString(),
                    topics: ["Normalization", "SQL", "Indexes"]
                },
                {
                    title: "UI/UX Principles Quiz",
                    userId: "user_004",
                    userName: "Sarah Williams",
                    status: "completed",
                    score: 92,
                    totalQuestions: 18,
                    date: new Date(2023, 9, 20).toISOString(),
                    topics: ["Wireframing", "Color Theory", "Typography"]
                },
                {
                    title: "Cloud Architecture Assessment",
                    userId: "user_005",
                    userName: "James Wilson",
                    status: "completed",
                    score: 78,
                    totalQuestions: 22,
                    date: new Date(2023, 9, 12).toISOString(),
                    topics: ["AWS", "Microservices", "Scalability"]
                }
            ];
            
            // Add sample assessments to Firestore
            for (const assessment of sampleAssessments) {
                await db.collection('assessments').add(assessment);
            }
            
            console.log("Sample assessments created");
        }
        
        // Update dashboard with assessment data
        function updateDashboard() {
            // Apply filters and sorting
            filterAndSortAssessments();
            
            // Update statistics
            updateStatistics();
            
            // Render table
            renderAssessmentsTable();
            
            // Hide loading, show table
            loadingElement.style.display = 'none';
            
            if (filteredAssessments.length === 0) {
                emptyState.style.display = 'block';
                assessmentsTable.style.display = 'none';
            } else {
                emptyState.style.display = 'none';
                assessmentsTable.style.display = 'table';
            }
        }
        
        // Filter and sort assessments based on user selection
        function filterAndSortAssessments() {
            // Start with all assessments
            filteredAssessments = [...allAssessments];
            
            // Apply search filter
            const searchTerm = searchInput.value.toLowerCase();
            if (searchTerm) {
                filteredAssessments = filteredAssessments.filter(assessment => 
                    assessment.title.toLowerCase().includes(searchTerm) ||
                    assessment.userName.toLowerCase().includes(searchTerm) ||
                    assessment.id.toLowerCase().includes(searchTerm)
                );
            }
            
            // Apply status filter
            const statusFilterValue = statusFilter.value;
            if (statusFilterValue !== 'all') {
                filteredAssessments = filteredAssessments.filter(assessment => 
                    assessment.status === statusFilterValue
                );
            }
            
            // Apply sorting
            const sortByValue = sortBy.value;
            filteredAssessments.sort((a, b) => {
                switch(sortByValue) {
                    case 'newest':
                        return new Date(b.date) - new Date(a.date);
                    case 'oldest':
                        return new Date(a.date) - new Date(b.date);
                    case 'score-high':
                        return b.score - a.score;
                    case 'score-low':
                        return a.score - b.score;
                    default:
                        return 0;
                }
            });
        }
        
        // Update statistics cards
        function updateStatistics() {
            const total = allAssessments.length;
            const completed = allAssessments.filter(a => a.status === 'completed').length;
            const inProgress = allAssessments.filter(a => a.status === 'in-progress').length;
            
            // Calculate average score (only for completed assessments)
            const completedScores = allAssessments
                .filter(a => a.status === 'completed' && a.score)
                .map(a => a.score);
            const averageScore = completedScores.length > 0 
                ? Math.round(completedScores.reduce((sum, score) => sum + score, 0) / completedScores.length)
                : 0;
            
            totalAssessmentsEl.textContent = total;
            completedAssessmentsEl.textContent = completed;
            inprogressAssessmentsEl.textContent = inProgress;
            averageScoreEl.textContent = averageScore;
        }
        
        // Render assessments table
        function renderAssessmentsTable() {
            assessmentsBody.innerHTML = '';
            
            filteredAssessments.forEach(assessment => {
                const row = document.createElement('tr');
                
                // Format date
                const date = new Date(assessment.date);
                const formattedDate = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                // Determine status class and text
                let statusClass = '';
                let statusText = assessment.status || 'pending';
                
                if (statusText === 'completed') {
                    statusClass = 'status-completed';
                } else if (statusText === 'in-progress') {
                    statusClass = 'status-in-progress';
                } else {
                    statusClass = 'status-pending';
                }
                
                // Format score display
                const scoreDisplay = assessment.status === 'completed' 
                    ? `${assessment.score}%` 
                    : assessment.status === 'in-progress' 
                        ? `${assessment.score}% (in progress)` 
                        : 'Not taken';
                
                row.innerHTML = `
                    <td>${assessment.id || assessment.firestoreId.substring(0, 8)}</td>
                    <td><strong>${assessment.title || 'Untitled Assessment'}</strong></td>
                    <td>${assessment.userName || assessment.userId || 'Unknown User'}</td>
                    <td><span class="status ${statusClass}">${statusText}</span></td>
                    <td>${scoreDisplay}</td>
                    <td>${formattedDate}</td>
                    <td>
                        <div class="action-btns">
                            <button class="btn btn-action btn-view" onclick="viewAssessment('${assessment.firestoreId}')">View</button>
                            <button class="btn btn-action btn-edit" onclick="editAssessment('${assessment.firestoreId}')">Edit</button>
                            <button class="btn btn-action btn-delete" onclick="deleteAssessment('${assessment.firestoreId}')">Delete</button>
                        </div>
                    </td>
                `;
                
                assessmentsBody.appendChild(row);
            });
        }
        
        // View assessment details
        function viewAssessment(id) {
            const assessment = allAssessments.find(a => a.firestoreId === id);
            if (assessment) {
                alert(`Assessment Details:\n\nTitle: ${assessment.title}\nUser: ${assessment.userName}\nStatus: ${assessment.status}\nScore: ${assessment.score}%\nDate: ${new Date(assessment.date).toLocaleDateString()}\nID: ${id}`);
            }
        }
        
        // Edit assessment
        function editAssessment(id) {
            alert(`Edit functionality would open for assessment ID: ${id}\n\nIn a real application, this would open a form to edit the assessment details.`);
        }
        
        // Delete assessment with confirmation
        async function deleteAssessment(id) {
            if (confirm('Are you sure you want to delete this assessment? This action cannot be undone.')) {
                try {
                    await db.collection('assessments').doc(id).delete();
                    alert('Assessment deleted successfully!');
                    // Reload data after deletion
                    loadAssessments();
                } catch (error) {
                    console.error("Error deleting assessment:", error);
                    alert('Error deleting assessment. Please try again.');
                }
            }
        }
        
        // Event listeners for filters and search
        searchInput.addEventListener('input', updateDashboard);
        statusFilter.addEventListener('change', updateDashboard);
        sortBy.addEventListener('change', updateDashboard);
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            // Try auto-login for demo purposes
            // In a real app, you would check for existing session
            console.log("Assessment Dashboard initialized");
            console.log("Firebase project: palmaegis-setup");
            console.log("Collection: assessments");
        });
    </script>
</body>
</html>