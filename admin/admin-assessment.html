<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Assessments</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    
    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background-color: #1a2b3c;
            color: white;
            padding: 20px 0;
            box-shadow: 3px 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .logo {
            text-align: center;
            padding: 20px 10px;
            border-bottom: 1px solid #2a3b4c;
            margin-bottom: 20px;
        }
        
        .logo h2 {
            font-size: 1.5rem;
            color: #4dabf7;
        }
        
        .nav-links {
            list-style: none;
        }
        
        .nav-links li {
            padding: 15px 25px;
            transition: all 0.3s;
        }
        
        .nav-links li:hover {
            background-color: #2a3b4c;
            cursor: pointer;
        }
        
        .nav-links li.active {
            background-color: #2a3b4c;
            border-left: 4px solid #4dabf7;
        }
        
        .nav-links li i {
            margin-right: 10px;
        }
        
        /* Main Content Styles */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e1e5eb;
        }
        
        .header h1 {
            color: #1a2b3c;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-info span {
            margin-right: 15px;
            font-weight: 500;
        }
        
        .btn-logout {
            padding: 8px 16px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn-logout:hover {
            background-color: #c0392b;
        }
        
        /* Stats Cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-info h3 {
            font-size: 0.9rem;
            color: #7b8a8b;
            margin-bottom: 5px;
        }
        
        .stat-info .value {
            font-size: 2rem;
            font-weight: 700;
            color: #1a2b3c;
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }
        
        .total-assessments {
            background-color: rgba(77, 171, 247, 0.2);
            color: #4dabf7;
        }
        
        .average-score {
            background-color: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }
        
        .pending-reviews {
            background-color: rgba(241, 196, 15, 0.2);
            color: #f1c40f;
        }
        
        .completed {
            background-color: rgba(155, 89, 182, 0.2);
            color: #9b59b6;
        }
        
        /* Controls Section */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .search-box {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 300px;
            font-size: 1rem;
        }
        
        .filters {
            display: flex;
            gap: 10px;
        }
        
        .filter-select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
        }
        
        /* Table Styles */
        .table-container {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background-color: #f8f9fa;
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status.pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status.completed {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status.reviewed {
            background-color: #cce5ff;
            color: #004085;
        }
        
        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
            font-size: 0.8rem;
        }
        
        .view-btn {
            background-color: #4dabf7;
            color: white;
        }
        
        .edit-btn {
            background-color: #ffc107;
            color: #212529;
        }
        
        .delete-btn {
            background-color: #e74c3c;
            color: white;
        }
        
        /* Charts Section */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .chart-title {
            margin-bottom: 15px;
            color: #1a2b3c;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #7b8a8b;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-primary {
            padding: 10px 20px;
            background-color: #4dabf7;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .btn-secondary {
            padding: 10px 20px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        /* Loading Indicator */
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #7b8a8b;
        }
        
        .loading:after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        
        /* Responsive Adjustments */
        @media (max-width: 992px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .nav-links {
                display: flex;
                justify-content: space-around;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .search-box {
                width: 100%;
            }
            
            .nav-links {
                flex-wrap: wrap;
            }
            
            .stats-container {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 576px) {
            .stats-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="logo">
                <h2>Palmaegis Admin</h2>
            </div>
            <ul class="nav-links">
                <li class="active"><i>üìä</i> Assessments</li>
                <li><i>üë•</i> Users</li>
                <li><i>üìà</i> Analytics</li>
                <li><i>‚öôÔ∏è</i> Settings</li>
            </ul>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <h1>Assessment Management</h1>
                <div class="user-info">
                    <span id="adminName">Admin User</span>
                    <button class="btn-logout" id="btnLogout">Logout</button>
                </div>
            </div>
            
            <!-- Stats Cards -->
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-info">
                        <h3>Total Assessments</h3>
                        <div class="value" id="totalAssessments">0</div>
                    </div>
                    <div class="stat-icon total-assessments">üìã</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-info">
                        <h3>Average Score</h3>
                        <div class="value" id="averageScore">0.0</div>
                    </div>
                    <div class="stat-icon average-score">‚≠ê</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-info">
                        <h3>Pending Review</h3>
                        <div class="value" id="pendingReviews">0</div>
                    </div>
                    <div class="stat-icon pending-reviews">‚è≥</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-info">
                        <h3>Completed</h3>
                        <div class="value" id="completedAssessments">0</div>
                    </div>
                    <div class="stat-icon completed">‚úÖ</div>
                </div>
            </div>
            
            <!-- Controls -->
            <div class="controls">
                <input type="text" class="search-box" id="searchBox" placeholder="Search assessments...">
                <div class="filters">
                    <select class="filter-select" id="filterStatus">
                        <option value="all">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="completed">Completed</option>
                        <option value="reviewed">Reviewed</option>
                    </select>
                    <select class="filter-select" id="filterDate">
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                    </select>
                    <button class="btn-primary" id="btnAddAssessment">+ Add Assessment</button>
                </div>
            </div>
            
            <!-- Assessments Table -->
            <div class="table-container">
                <table id="assessmentsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>User</th>
                            <th>Assessment</th>
                            <th>Score</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="7" class="loading">Loading assessments data</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Charts Section -->
            <div class="charts-container">
                <div class="chart-card">
                    <h3 class="chart-title">Scores Distribution</h3>
                    <canvas id="scoreChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">Assessments by Status</h3>
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Assessment Detail Modal -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Assessment Details</h2>
                <button class="close-modal" id="closeDetailModal">&times;</button>
            </div>
            <div id="assessmentDetails">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Assessment Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Assessment</h2>
                <button class="close-modal" id="closeEditModal">&times;</button>
            </div>
            <form id="assessmentForm">
                <div class="form-group">
                    <label for="userId">User ID</label>
                    <input type="text" id="userId" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="userName">User Name</label>
                    <input type="text" id="userName" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="assessmentName">Assessment Name</label>
                    <input type="text" id="assessmentName" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="score">Score (%)</label>
                    <input type="number" id="score" class="form-control" min="0" max="100" step="0.1" required>
                </div>
                
                <div class="form-group">
                    <label for="status">Status</label>
                    <select id="status" class="form-control" required>
                        <option value="pending">Pending</option>
                        <option value="completed">Completed</option>
                        <option value="reviewed">Reviewed</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="date">Date</label>
                    <input type="date" id="date" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="notes">Notes</label>
                    <textarea id="notes" class="form-control" rows="4"></textarea>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" id="cancelEdit">Cancel</button>
                    <button type="submit" class="btn-primary" id="saveAssessment">Save Assessment</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAf-wtZpl8wVjCymdLlC-YGlv7xn0yEMMU",
            authDomain: "palmaegis-setup.firebaseapp.com",
            projectId: "palmaegis-setup",
            storageBucket: "palmaegis-setup.appspot.com",
            messagingSenderId: "445887502374",
            appId: "1:445887502374:web:a5f6ecaa90b88447626ee7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // DOM Elements
        const tableBody = document.getElementById('tableBody');
        const totalAssessmentsEl = document.getElementById('totalAssessments');
        const averageScoreEl = document.getElementById('averageScore');
        const pendingReviewsEl = document.getElementById('pendingReviews');
        const completedAssessmentsEl = document.getElementById('completedAssessments');
        const searchBox = document.getElementById('searchBox');
        const filterStatus = document.getElementById('filterStatus');
        const filterDate = document.getElementById('filterDate');
        const btnAddAssessment = document.getElementById('btnAddAssessment');
        const btnLogout = document.getElementById('btnLogout');
        const detailModal = document.getElementById('detailModal');
        const editModal = document.getElementById('editModal');
        const closeDetailModal = document.getElementById('closeDetailModal');
        const closeEditModal = document.getElementById('closeEditModal');
        const cancelEdit = document.getElementById('cancelEdit');
        const assessmentForm = document.getElementById('assessmentForm');
        const modalTitle = document.getElementById('modalTitle');
        
        // Chart instances
        let scoreChart, statusChart;
        
        // Assessment data
        let assessments = [];
        let filteredAssessments = [];
        let currentAssessmentId = null;
        
        // Initialize the dashboard
        function initDashboard() {
            // Check if user is authenticated
            auth.onAuthStateChanged(user => {
                if (user) {
                    document.getElementById('adminName').textContent = user.displayName || user.email;
                    loadAssessments();
                } else {
                    // Redirect to login page if not authenticated
                    window.location.href = 'login.html';
                }
            });
            
            // Set up event listeners
            setupEventListeners();
            
            // Initialize charts
            initCharts();
        }
        
        // Set up all event listeners
        function setupEventListeners() {
            // Search and filter
            searchBox.addEventListener('input', filterAssessments);
            filterStatus.addEventListener('change', filterAssessments);
            filterDate.addEventListener('change', filterAssessments);
            
            // Buttons
            btnAddAssessment.addEventListener('click', () => openEditModal());
            btnLogout.addEventListener('click', logout);
            
            // Modal controls
            closeDetailModal.addEventListener('click', () => detailModal.style.display = 'none');
            closeEditModal.addEventListener('click', () => editModal.style.display = 'none');
            cancelEdit.addEventListener('click', () => editModal.style.display = 'none');
            
            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === detailModal) detailModal.style.display = 'none';
                if (e.target === editModal) editModal.style.display = 'none';
            });
            
            // Form submission
            assessmentForm.addEventListener('submit', saveAssessment);
        }
        
        // Load assessments from Firestore
        function loadAssessments() {
            tableBody.innerHTML = '<tr><td colspan="7" class="loading">Loading assessments data</td></tr>';
            
            db.collection('assessments').orderBy('date', 'desc').get()
                .then(querySnapshot => {
                    assessments = [];
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        assessments.push({
                            id: doc.id,
                            ...data,
                            // Ensure date is in proper format
                            date: data.date ? new Date(data.date.seconds * 1000).toISOString().split('T')[0] : 'N/A'
                        });
                    });
                    
                    renderAssessments();
                    updateStats();
                    updateCharts();
                })
                .catch(error => {
                    console.error("Error loading assessments: ", error);
                    tableBody.innerHTML = `<tr><td colspan="7">Error loading data. Please try again.</td></tr>`;
                });
        }
        
        // Render assessments to the table
        function renderAssessments() {
            if (filteredAssessments.length === 0) {
                filteredAssessments = [...assessments];
            }
            
            if (filteredAssessments.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7">No assessments found.</td></tr>';
                return;
            }
            
            tableBody.innerHTML = '';
            
            filteredAssessments.forEach(assessment => {
                const row = document.createElement('tr');
                
                // Format the date for display
                const displayDate = assessment.date !== 'N/A' 
                    ? new Date(assessment.date).toLocaleDateString() 
                    : 'N/A';
                
                // Determine status class
                let statusClass = '';
                if (assessment.status === 'pending') statusClass = 'pending';
                if (assessment.status === 'completed') statusClass = 'completed';
                if (assessment.status === 'reviewed') statusClass = 'reviewed';
                
                row.innerHTML = `
                    <td>${assessment.id.substring(0, 8)}...</td>
                    <td>${assessment.userName || 'Unknown User'}</td>
                    <td>${assessment.assessmentName || 'Unnamed Assessment'}</td>
                    <td>${assessment.score !== undefined ? assessment.score.toFixed(1) : 'N/A'}%</td>
                    <td><span class="status ${statusClass}">${assessment.status || 'pending'}</span></td>
                    <td>${displayDate}</td>
                    <td>
                        <button class="action-btn view-btn" data-id="${assessment.id}">View</button>
                        <button class="action-btn edit-btn" data-id="${assessment.id}">Edit</button>
                        <button class="action-btn delete-btn" data-id="${assessment.id}">Delete</button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Add event listeners to action buttons
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', (e) => viewAssessment(e.target.dataset.id));
            });
            
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => openEditModal(e.target.dataset.id));
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => deleteAssessment(e.target.dataset.id));
            });
        }
        
        // Filter assessments based on search and filter criteria
        function filterAssessments() {
            const searchTerm = searchBox.value.toLowerCase();
            const statusFilter = filterStatus.value;
            const dateFilter = filterDate.value;
            
            filteredAssessments = assessments.filter(assessment => {
                // Search filter
                const matchesSearch = searchTerm === '' || 
                    (assessment.userName && assessment.userName.toLowerCase().includes(searchTerm)) ||
                    (assessment.assessmentName && assessment.assessmentName.toLowerCase().includes(searchTerm)) ||
                    (assessment.id && assessment.id.toLowerCase().includes(searchTerm));
                
                // Status filter
                const matchesStatus = statusFilter === 'all' || assessment.status === statusFilter;
                
                // Date filter
                let matchesDate = true;
                if (dateFilter !== 'all' && assessment.date !== 'N/A') {
                    const assessmentDate = new Date(assessment.date);
                    const today = new Date();
                    
                    if (dateFilter === 'today') {
                        matchesDate = assessmentDate.toDateString() === today.toDateString();
                    } else if (dateFilter === 'week') {
                        const weekAgo = new Date();
                        weekAgo.setDate(today.getDate() - 7);
                        matchesDate = assessmentDate >= weekAgo;
                    } else if (dateFilter === 'month') {
                        const monthAgo = new Date();
                        monthAgo.setMonth(today.getMonth() - 1);
                        matchesDate = assessmentDate >= monthAgo;
                    }
                }
                
                return matchesSearch && matchesStatus && matchesDate;
            });
            
            renderAssessments();
            updateStats(true); // Update stats for filtered data
        }
        
        // Update statistics cards
        function updateStats(forFiltered = false) {
            const dataToUse = forFiltered ? filteredAssessments : assessments;
            
            // Total assessments
            totalAssessmentsEl.textContent = dataToUse.length;
            
            // Average score
            const scores = dataToUse
                .map(a => a.score)
                .filter(score => typeof score === 'number');
            
            const average = scores.length > 0 
                ? (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1)
                : 0;
            averageScoreEl.textContent = average;
            
            // Pending reviews
            const pending = dataToUse.filter(a => a.status === 'pending').length;
            pendingReviewsEl.textContent = pending;
            
            // Completed assessments
            const completed = dataToUse.filter(a => a.status === 'completed' || a.status === 'reviewed').length;
            completedAssessmentsEl.textContent = completed;
        }
        
        // Initialize charts
        function initCharts() {
            const scoreCtx = document.getElementById('scoreChart').getContext('2d');
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            
            // Scores distribution chart
            scoreChart = new Chart(scoreCtx, {
                type: 'bar',
                data: {
                    labels: ['0-20', '21-40', '41-60', '61-80', '81-100'],
                    datasets: [{
                        label: 'Number of Assessments',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: 'rgba(77, 171, 247, 0.7)',
                        borderColor: 'rgba(77, 171, 247, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
            
            // Status distribution chart
            statusChart = new Chart(statusCtx, {
                type: 'pie',
                data: {
                    labels: ['Pending', 'Completed', 'Reviewed'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [
                            'rgba(241, 196, 15, 0.7)',
                            'rgba(46, 204, 113, 0.7)',
                            'rgba(77, 171, 247, 0.7)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }
        
        // Update charts with assessment data
        function updateCharts() {
            // Update score distribution
            const scoreRanges = [0, 0, 0, 0, 0];
            assessments.forEach(assessment => {
                if (typeof assessment.score === 'number') {
                    if (assessment.score <= 20) scoreRanges[0]++;
                    else if (assessment.score <= 40) scoreRanges[1]++;
                    else if (assessment.score <= 60) scoreRanges[2]++;
                    else if (assessment.score <= 80) scoreRanges[3]++;
                    else scoreRanges[4]++;
                }
            });
            
            scoreChart.data.datasets[0].data = scoreRanges;
            scoreChart.update();
            
            // Update status distribution
            const pendingCount = assessments.filter(a => a.status === 'pending').length;
            const completedCount = assessments.filter(a => a.status === 'completed').length;
            const reviewedCount = assessments.filter(a => a.status === 'reviewed').length;
            
            statusChart.data.datasets[0].data = [pendingCount, completedCount, reviewedCount];
            statusChart.update();
        }
        
        // View assessment details
        function viewAssessment(id) {
            const assessment = assessments.find(a => a.id === id);
            if (!assessment) return;
            
            const detailsEl = document.getElementById('assessmentDetails');
            detailsEl.innerHTML = `
                <div class="form-group">
                    <label><strong>Assessment ID:</strong></label>
                    <p>${assessment.id}</p>
                </div>
                <div class="form-group">
                    <label><strong>User:</strong></label>
                    <p>${assessment.userName} (${assessment.userId})</p>
                </div>
                <div class="form-group">
                    <label><strong>Assessment Name:</strong></label>
                    <p>${assessment.assessmentName}</p>
                </div>
                <div class="form-group">
                    <label><strong>Score:</strong></label>
                    <p>${assessment.score !== undefined ? assessment.score.toFixed(1) : 'N/A'}%</p>
                </div>
                <div class="form-group">
                    <label><strong>Status:</strong></label>
                    <p><span class="status ${assessment.status}">${assessment.status}</span></p>
                </div>
                <div class="form-group">
                    <label><strong>Date:</strong></label>
                    <p>${assessment.date !== 'N/A' ? new Date(assessment.date).toLocaleDateString() : 'N/A'}</p>
                </div>
                <div class="form-group">
                    <label><strong>Notes:</strong></label>
                    <p>${assessment.notes || 'No notes available.'}</p>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" id="closeDetailsBtn">Close</button>
                </div>
            `;
            
            // Add event listener to close button inside modal
            document.getElementById('closeDetailsBtn').addEventListener('click', () => {
                detailModal.style.display = 'none';
            });
            
            detailModal.style.display = 'flex';
        }
        
        // Open the edit modal (for add or edit)
        function openEditModal(id = null) {
            currentAssessmentId = id;
            
            if (id) {
                // Edit existing assessment
                modalTitle.textContent = 'Edit Assessment';
                const assessment = assessments.find(a => a.id === id);
                
                if (assessment) {
                    document.getElementById('userId').value = assessment.userId || '';
                    document.getElementById('userName').value = assessment.userName || '';
                    document.getElementById('assessmentName').value = assessment.assessmentName || '';
                    document.getElementById('score').value = assessment.score || '';
                    document.getElementById('status').value = assessment.status || 'pending';
                    document.getElementById('date').value = assessment.date || new Date().toISOString().split('T')[0];
                    document.getElementById('notes').value = assessment.notes || '';
                }
            } else {
                // Add new assessment
                modalTitle.textContent = 'Add Assessment';
                document.getElementById('assessmentForm').reset();
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
            }
            
            editModal.style.display = 'flex';
        }
        
        // Save assessment (add or update)
        function saveAssessment(e) {
            e.preventDefault();
            
            const assessmentData = {
                userId: document.getElementById('userId').value,
                userName: document.getElementById('userName').value,
                assessmentName: document.getElementById('assessmentName').value,
                score: parseFloat(document.getElementById('score').value),
                status: document.getElementById('status').value,
                date: document.getElementById('date').value,
                notes: document.getElementById('notes').value,
                lastUpdated: new Date().toISOString()
            };
            
            // Validate data
            if (!assessmentData.userId || !assessmentData.userName || !assessmentData.assessmentName) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (currentAssessmentId) {
                // Update existing assessment
                db.collection('assessments').doc(currentAssessmentId).update(assessmentData)
                    .then(() => {
                        alert('Assessment updated successfully!');
                        editModal.style.display = 'none';
                        loadAssessments();
                    })
                    .catch(error => {
                        console.error("Error updating assessment: ", error);
                        alert('Error updating assessment. Please try again.');
                    });
            } else {
                // Add new assessment
                db.collection('assessments').add(assessmentData)
                    .then(() => {
                        alert('Assessment added successfully!');
                        editModal.style.display = 'none';
                        loadAssessments();
                    })
                    .catch(error => {
                        console.error("Error adding assessment: ", error);
                        alert('Error adding assessment. Please try again.');
                    });
            }
        }
        
        // Delete assessment
        function deleteAssessment(id) {
            if (!confirm('Are you sure you want to delete this assessment?')) return;
            
            db.collection('assessments').doc(id).delete()
                .then(() => {
                    alert('Assessment deleted successfully!');
                    loadAssessments();
                })
                .catch(error => {
                    console.error("Error deleting assessment: ", error);
                    alert('Error deleting assessment. Please try again.');
                });
        }
        
        // Logout function
        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            }).catch(error => {
                console.error("Error signing out: ", error);
            });
        }
        
        // Initialize the dashboard when page loads
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>