<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Assessment | PalmAegis</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    :root {
      --primary: #2e8b57;
      --dark: #1e272e;
      --light: #f5f6fa;
      --card: #ffffff;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: var(--light);
      color: #333;
    }

    header {
      background: var(--dark);
      color: #fff;
      padding: 16px 24px;
      font-size: 20px;
      font-weight: 600;
    }

    .container {
      padding: 24px;
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1200px;
    }

    thead {
      background: var(--primary);
      color: #fff;
    }

    th, td {
      padding: 14px 12px;
      text-align: center;
      font-size: 14px;
      border-bottom: 1px solid #eee;
    }

    tbody tr:hover {
      background: #f1f8f5;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .healthy { background: #2ecc71; color: #fff; }
    .unhealthy { background: #e74c3c; color: #fff; }
    .pending { background: #f1c40f; color: #000; }
    .completed { background: #3498db; color: #fff; }

    button {
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      margin: 2px;
      color: #fff;
    }

    .btn-view { background: #2980b9; }
    .btn-treat { background: #f39c12; }
    .btn-complete { background: #27ae60; }
    .btn-delete { background: #c0392b; }

    .empty {
      text-align: center;
      padding: 40px;
      color: #777;
    }
  </style>
</head>
<body>

<header>
  <i class="fa-solid fa-seedling"></i> PalmAegis â€“ Assessment Management
</header>

<div class="container">
  <div class="card">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Date & Time</th>
          <th>Location</th>
          <th>Disease</th>
          <th>Detections</th>
          <th>Health</th>
          <th>Treatment</th>
          <th>Next Assessment</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="assessmentTable">
        <tr><td colspan="9" class="empty">Loading data...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAf-wtZpl8wVjCymdLlC-YGlv7xn0yEMMU",
    authDomain: "palmaegis-setup.firebaseapp.com",
    projectId: "palmaegis-setup",
    storageBucket: "palmaegis-setup.firebasestorage.app",
    messagingSenderId: "445887502374",
    appId: "1:445887502374:web:a5f6ecaa90b88447626ee7"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const table = document.getElementById('assessmentTable');

  db.collection('assessments').onSnapshot(snapshot => {
    table.innerHTML = '';

    if (snapshot.empty) {
      table.innerHTML = `<tr><td colspan="9" class="empty">No assessment records found</td></tr>`;
      return;
    }

    snapshot.forEach(doc => {
      const d = doc.data();

      const healthClass = d.healthStatus === 'Healthy' ? 'healthy' : 'unhealthy';
      const treatmentClass = d.treatmentStatus === 'Completed' ? 'completed' : 'pending';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${doc.id}</td>
        <td>${d.dateTime || '-'}</td>
        <td>${d.location || '-'}</td>
        <td>${d.disease || d.diseaseDetected || '-'}</td>
        <td>${d.detections || '-'}</td>
        <td><span class="badge ${healthClass}">${d.healthStatus || 'Unknown'}</span></td>
        <td><span class="badge ${treatmentClass}">${d.treatmentStatus || 'Pending'}</span></td>
        <td>${d.nextAssessment || '-'}</td>
        <td>
          <button class="btn-view" onclick="viewRec('${doc.id}')"><i class="fa fa-eye"></i></button>
          <button class="btn-treat" onclick="setTreatment('${doc.id}')"><i class="fa fa-syringe"></i></button>
          <button class="btn-complete" onclick="setComplete('${doc.id}')"><i class="fa fa-check"></i></button>
          <button class="btn-delete" onclick="delRec('${doc.id}')"><i class="fa fa-trash"></i></button>
        </td>
      `;
      table.appendChild(tr);
    });
  });

  // ===== View Assessment (Modal Version) =====
async function viewRec(assessmentId) {
  try {
    const doc = await db.collection('assessments').doc(assessmentId).get();
    if (!doc.exists) return alert('Assessment not found');

    const assessment = doc.data();

    // handle date
    let formattedDateTime = 'N/A';
    if (assessment.dateTime) {
      formattedDateTime = assessment.dateTime;
    } else if (assessment.createdAt?.toDate) {
      formattedDateTime = assessment.createdAt.toDate().toLocaleString();
    }

    // disease tags
    let diseaseTags = 'None detected';
    if (assessment.disease && assessment.disease !== 'No disease detected') {
      diseaseTags = assessment.disease.split(',').map(d =>
        `<span class="badge" style="background:#e74c3c">${d.trim()}</span>`
      ).join(' ');
    }

    // detections
    let detectionDetails = '<p>No detection data available</p>';
    if (Array.isArray(assessment.detections) && assessment.detections.length) {
      detectionDetails = assessment.detections.map(det => {
        const conf = Math.round((det.confidence || 0) * 100);
        return `
          <div style="border-left:4px solid #2e8b57;padding:10px;margin-bottom:10px">
            <strong>${det.class || 'Unknown'}</strong><br>
            Model: ${det.model || '-'}<br>
            Confidence: ${conf}%
          </div>`;
      }).join('');
    }

    document.getElementById('modalBody').innerHTML = `
      <h3>Assessment Details</h3>
      <p><strong>ID:</strong> ${assessmentId}</p>
      <p><strong>Date:</strong> ${formattedDateTime}</p>
      <p><strong>Location:</strong> ${assessment.location || '-'}</p>
      <p><strong>Diseases:</strong> ${diseaseTags}</p>
      <p><strong>Health:</strong> ${assessment.healthStatus || '-'}</p>
      <p><strong>Treatment:</strong> ${assessment.treatmentStatus || '-'}</p>
      <hr>
      <h4>Detections</h4>
      ${detectionDetails}
    `;

    document.getElementById('detailModal').style.display = 'flex';
  } catch (err) {
    console.error(err);
    alert('Failed to load assessment');
  }
}

  function setTreatment(id) {
    db.collection('assessments').doc(id).update({ treatmentStatus: 'In Treatment' });
  }

  function setComplete(id) {
    db.collection('assessments').doc(id).update({
      treatmentStatus: 'Completed',
      healthStatus: 'Healthy'
    });
  }

  function delRec(id) {
    if (confirm('Delete this assessment?')) {
      db.collection('assessments').doc(id).delete();
    }
  }
</script>

</body>
</html>
