<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Disease Assessment Dashboard</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #2c3e50 0%, #4a6491 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        h1 {
            font-size: 28px;
            font-weight: 600;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-icon {
            font-size: 32px;
        }
        
        .auth-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        #user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #user-email {
            font-weight: 500;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 15px;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-logout {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-logout:hover {
            background-color: #c0392b;
        }
        
        .login-form {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            margin: 50px auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .login-form h2 {
            margin-bottom: 20px;
            color: #2c3e50;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        .form-control:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .dashboard {
            display: none;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card h3 {
            font-size: 14px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        
        .search-box {
            position: relative;
            width: 300px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #7f8c8d;
        }
        
        .filters {
            display: flex;
            gap: 15px;
        }
        
        select {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: white;
            font-size: 15px;
        }
        
        .table-container {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background-color: #2c3e50;
            color: white;
        }
        
        th {
            padding: 18px 15px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 14px;
            letter-spacing: 0.5px;
        }
        
        tbody tr {
            border-bottom: 1px solid #f1f1f1;
            transition: background-color 0.2s;
        }
        
        tbody tr:hover {
            background-color: #f9f9f9;
        }
        
        td {
            padding: 16px 15px;
        }
        
        .status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-good {
            background-color: #d5f4e6;
            color: #27ae60;
        }
        
        .status-fair {
            background-color: #fff4e6;
            color: #f39c12;
        }
        
        .status-poor {
            background-color: #ffeaea;
            color: #e74c3c;
        }
        
        .status-critical {
            background-color: #2c3e50;
            color: white;
        }
        
        .health-status {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .health-excellent {
            background-color: #d5f4e6;
            color: #27ae60;
        }
        
        .health-good {
            background-color: #d5e8f4;
            color: #2980b9;
        }
        
        .health-fair {
            background-color: #fff4e6;
            color: #f39c12;
        }
        
        .health-poor {
            background-color: #ffeaea;
            color: #e74c3c;
        }
        
        .action-btns {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn-action {
            padding: 6px 12px;
            font-size: 13px;
            border-radius: 4px;
        }
        
        .btn-view {
            background-color: #3498db;
            color: white;
        }
        
        .btn-edit {
            background-color: #2ecc71;
            color: white;
        }
        
        .btn-delete {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-treatment {
            background-color: #9b59b6;
            color: white;
        }
        
        .treatment-cell {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 14px;
            margin-top: 30px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #7f8c8d;
        }
        
        .error {
            background-color: #ffeaea;
            color: #e74c3c;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }
        
        .empty-state i {
            font-size: 60px;
            margin-bottom: 20px;
            color: #ddd;
        }
        
        .disease-type {
            display: inline-block;
            padding: 4px 8px;
            background-color: #e8f4fc;
            border-radius: 4px;
            font-size: 12px;
            color: #3498db;
            margin: 2px;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            
            .search-box {
                width: 100%;
            }
            
            .filters {
                width: 100%;
                justify-content: space-between;
            }
            
            th, td {
                padding: 12px 10px;
                font-size: 14px;
            }
            
            .action-btns {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Form (Initially Visible) -->
        <div id="login-section" class="login-form">
            <h2>Admin Login</h2>
            <div id="login-error" class="error" style="display: none;">
                Invalid email or password. Please try again.
            </div>
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" class="form-control" placeholder="admin@example.com" value="admin@example.com">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter your password" value="admin123">
            </div>
            <button id="login-btn" class="btn btn-primary" style="width: 100%;">Login as Admin</button>
            <div style="margin-top: 20px; font-size: 14px; color: #7f8c8d; text-align: center;">
                <p>Use any email/password for demo (Firebase Auth is in test mode)</p>
            </div>
        </div>
        
        <!-- Dashboard (Initially Hidden) -->
        <div id="dashboard" class="dashboard">
            <header>
                <div class="header-top">
                    <div class="logo">
                        <div class="logo-icon">üè•</div>
                        <h1>Disease Assessment Dashboard</h1>
                    </div>
                    <div class="auth-section">
                        <div id="user-info">
                            <span id="user-email">admin@example.com</span>
                            <button id="logout-btn" class="btn btn-logout">Logout</button>
                        </div>
                    </div>
                </div>
                <p>Monitor and manage disease assessment data from Firebase</p>
            </header>
            
            <!-- Statistics Cards -->
            <div class="stats-container">
                <div class="stat-card">
                    <h3>Total Assessments</h3>
                    <div id="total-assessments" class="stat-value">0</div>
                </div>
                <div class="stat-card">
                    <h3>Critical Cases</h3>
                    <div id="critical-cases" class="stat-value">0</div>
                </div>
                <div class="stat-card">
                    <h3>Avg. Health Status</h3>
                    <div id="avg-health-status" class="stat-value">0</div>
                </div>
                <div class="stat-card">
                    <h3>Patients Treated</h3>
                    <div id="treated-patients" class="stat-value">0</div>
                </div>
            </div>
            
            <!-- Controls -->
            <div class="controls">
                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="search-input" placeholder="Search disease, patient, or treatment...">
                </div>
                <div class="filters">
                    <select id="status-filter">
                        <option value="all">All Status</option>
                        <option value="good">Good</option>
                        <option value="fair">Fair</option>
                        <option value="poor">Poor</option>
                        <option value="critical">Critical</option>
                    </select>
                    <select id="health-filter">
                        <option value="all">All Health Status</option>
                        <option value="excellent">Excellent</option>
                        <option value="good">Good</option>
                        <option value="fair">Fair</option>
                        <option value="poor">Poor</option>
                    </select>
                    <select id="sort-by">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="health-high">Health: High to Low</option>
                        <option value="health-low">Health: Low to High</option>
                    </select>
                </div>
            </div>
            
            <!-- Data Table -->
            <div class="table-container">
                <div id="loading" class="loading">Loading disease assessment data from Firebase...</div>
                <div id="error-message" class="error" style="display: none;">
                    Error loading data. Please check your connection and try again.
                </div>
                <div id="empty-state" class="empty-state" style="display: none;">
                    <div>üè•</div>
                    <h3>No disease assessments found</h3>
                    <p>There are no disease assessments in the database yet.</p>
                </div>
                
                <table id="assessments-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Disease Name</th>
                            <th>Patient</th>
                            <th>Status</th>
                            <th>Health Status</th>
                            <th>Treatment</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="assessments-body">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <div class="footer">
                <p>Disease Assessment Dashboard ‚Ä¢ Data loaded from Firebase Firestore</p>
                <p>Collection: <strong>assessments</strong> | Project: <strong>palmaegis-setup</strong></p>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAf-wtZpl8wVjCymdLlC-YGlv7xn0yEMMU",
            authDomain: "palmaegis-setup.firebaseapp.com",
            projectId: "palmaegis-setup",
            storageBucket: "palmaegis-setup.appspot.com",
            messagingSenderId: "445887502374",
            appId: "1:445887502374:web:a5f6ecaa90b88447626ee7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // DOM elements
        const loginSection = document.getElementById('login-section');
        const dashboard = document.getElementById('dashboard');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const loginError = document.getElementById('login-error');
        const assessmentsBody = document.getElementById('assessments-body');
        const loadingElement = document.getElementById('loading');
        const errorMessage = document.getElementById('error-message');
        const emptyState = document.getElementById('empty-state');
        const assessmentsTable = document.getElementById('assessments-table');
        const searchInput = document.getElementById('search-input');
        const statusFilter = document.getElementById('status-filter');
        const healthFilter = document.getElementById('health-filter');
        const sortBy = document.getElementById('sort-by');
        const totalAssessmentsEl = document.getElementById('total-assessments');
        const criticalCasesEl = document.getElementById('critical-cases');
        const avgHealthStatusEl = document.getElementById('avg-health-status');
        const treatedPatientsEl = document.getElementById('treated-patients');
        
        // Assessment data storage
        let allAssessments = [];
        let filteredAssessments = [];
        
        // Login function
        loginBtn.addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                loginError.textContent = "Please enter both email and password";
                loginError.style.display = 'block';
                return;
            }
            
            try {
                // Firebase authentication
                await auth.signInWithEmailAndPassword(email, password);
                // Success - handled by auth state listener
            } catch (error) {
                console.error("Login error:", error);
                loginError.textContent = error.message || "Login failed. Please try again.";
                loginError.style.display = 'block';
            }
        });
        
        // Logout function
        logoutBtn.addEventListener('click', () => {
            auth.signOut();
        });
        
        // Authentication state listener
        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in
                document.getElementById('user-email').textContent = user.email;
                loginSection.style.display = 'none';
                dashboard.style.display = 'block';
                loginError.style.display = 'none';
                
                // Load assessment data
                loadAssessments();
            } else {
                // User is signed out
                dashboard.style.display = 'none';
                loginSection.style.display = 'block';
                allAssessments = [];
                filteredAssessments = [];
            }
        });
        
        // Load assessments from Firestore
        async function loadAssessments() {
            try {
                loadingElement.style.display = 'block';
                errorMessage.style.display = 'none';
                emptyState.style.display = 'none';
                assessmentsTable.style.display = 'none';
                
                // Get assessments collection from Firestore
                const querySnapshot = await db.collection('assessments').get();
                
                allAssessments = [];
                querySnapshot.forEach(doc => {
                    const assessment = doc.data();
                    assessment.id = doc.id;
                    assessment.firestoreId = doc.id;
                    allAssessments.push(assessment);
                });
                
                // If no assessments exist, create some sample data for demonstration
                if (allAssessments.length === 0) {
                    console.log("No assessments found, creating sample data for demo");
                    await createSampleDiseaseAssessments();
                    // Reload after creating sample data
                    return loadAssessments();
                }
                
                updateDashboard();
                
            } catch (error) {
                console.error("Error loading assessments:", error);
                loadingElement.style.display = 'none';
                errorMessage.style.display = 'block';
                assessmentsTable.style.display = 'none';
            }
        }
        
        // Create sample disease assessments for demonstration
        async function createSampleDiseaseAssessments() {
            const sampleAssessments = [
                {
                    diseaseName: "Diabetes Type 2",
                    patientId: "P001",
                    patientName: "John Smith",
                    age: 52,
                    gender: "Male",
                    status: "fair",
                    healthStatus: 65,
                    treatment: "Metformin 500mg twice daily, Dietary control, Regular exercise",
                    date: new Date(2023, 9, 15).toISOString(),
                    symptoms: ["Increased thirst", "Frequent urination", "Fatigue"],
                    doctor: "Dr. Sarah Johnson"
                },
                {
                    diseaseName: "Hypertension",
                    patientId: "P002",
                    patientName: "Maria Garcia",
                    age: 48,
                    gender: "Female",
                    status: "good",
                    healthStatus: 82,
                    treatment: "Lisinopril 10mg daily, Low sodium diet, Stress management",
                    date: new Date(2023, 9, 18).toISOString(),
                    symptoms: ["Headaches", "Dizziness", "Shortness of breath"],
                    doctor: "Dr. Robert Chen"
                },
                {
                    diseaseName: "COVID-19",
                    patientId: "P003", 
                    patientName: "David Wilson",
                    age: 35,
                    gender: "Male",
                    status: "critical",
                    healthStatus: 40,
                    treatment: "Remdesivir IV, Dexamethasone, Oxygen therapy, Monitoring",
                    date: new Date(2023, 9, 10).toISOString(),
                    symptoms: ["Fever", "Cough", "Loss of taste", "Difficulty breathing"],
                    doctor: "Dr. Amanda Lee"
                },
                {
                    diseaseName: "Asthma",
                    patientId: "P004",
                    patientName: "Sarah Williams",
                    age: 29,
                    gender: "Female",
                    status: "good",
                    healthStatus: 78,
                    treatment: "Albuterol inhaler as needed, Fluticasone daily, Avoid triggers",
                    date: new Date(2023, 9, 20).toISOString(),
                    symptoms: ["Wheezing", "Chest tightness", "Shortness of breath"],
                    doctor: "Dr. Michael Brown"
                },
                {
                    diseaseName: "Coronary Artery Disease",
                    patientId: "P005",
                    patientName: "James Wilson",
                    age: 65,
                    gender: "Male",
                    status: "poor",
                    healthStatus: 55,
                    treatment: "Atorvastatin 40mg daily, Aspirin 81mg daily, Cardiac rehabilitation",
                    date: new Date(2023, 9, 12).toISOString(),
                    symptoms: ["Chest pain", "Fatigue", "Shortness of breath"],
                    doctor: "Dr. Susan Miller"
                },
                {
                    diseaseName: "Rheumatoid Arthritis",
                    patientId: "P006",
                    patientName: "Linda Martinez",
                    age: 58,
                    gender: "Female",
                    status: "fair",
                    healthStatus: 60,
                    treatment: "Methotrexate weekly, Physical therapy, NSAIDs for pain",
                    date: new Date(2023, 9, 22).toISOString(),
                    symptoms: ["Joint pain", "Swelling", "Morning stiffness"],
                    doctor: "Dr. Thomas Wilson"
                },
                {
                    diseaseName: "Chronic Kidney Disease",
                    patientId: "P007",
                    patientName: "Robert Johnson",
                    age: 70,
                    gender: "Male",
                    status: "critical",
                    healthStatus: 35,
                    treatment: "Dialysis three times weekly, Erythropoietin injections, Fluid restriction",
                    date: new Date(2023, 9, 5).toISOString(),
                    symptoms: ["Fatigue", "Swelling", "Nausea", "Reduced urine output"],
                    doctor: "Dr. Jennifer Davis"
                }
            ];
            
            // Add sample assessments to Firestore
            for (const assessment of sampleAssessments) {
                await db.collection('assessments').add(assessment);
            }
            
            console.log("Sample disease assessments created");
        }
        
        // Update dashboard with assessment data
        function updateDashboard() {
            // Apply filters and sorting
            filterAndSortAssessments();
            
            // Update statistics
            updateStatistics();
            
            // Render table
            renderAssessmentsTable();
            
            // Hide loading, show table
            loadingElement.style.display = 'none';
            
            if (filteredAssessments.length === 0) {
                emptyState.style.display = 'block';
                assessmentsTable.style.display = 'none';
            } else {
                emptyState.style.display = 'none';
                assessmentsTable.style.display = 'table';
            }
        }
        
        // Filter and sort assessments based on user selection
        function filterAndSortAssessments() {
            // Start with all assessments
            filteredAssessments = [...allAssessments];
            
            // Apply search filter
            const searchTerm = searchInput.value.toLowerCase();
            if (searchTerm) {
                filteredAssessments = filteredAssessments.filter(assessment => 
                    assessment.diseaseName.toLowerCase().includes(searchTerm) ||
                    assessment.patientName.toLowerCase().includes(searchTerm) ||
                    (assessment.treatment && assessment.treatment.toLowerCase().includes(searchTerm)) ||
                    (assessment.doctor && assessment.doctor.toLowerCase().includes(searchTerm))
                );
            }
            
            // Apply status filter
            const statusFilterValue = statusFilter.value;
            if (statusFilterValue !== 'all') {
                filteredAssessments = filteredAssessments.filter(assessment => 
                    assessment.status === statusFilterValue
                );
            }
            
            // Apply health status filter
            const healthFilterValue = healthFilter.value;
            if (healthFilterValue !== 'all') {
                filteredAssessments = filteredAssessments.filter(assessment => {
                    const healthStatus = assessment.healthStatus;
                    if (healthFilterValue === 'excellent') return healthStatus >= 80;
                    if (healthFilterValue === 'good') return healthStatus >= 65 && healthStatus < 80;
                    if (healthFilterValue === 'fair') return healthStatus >= 50 && healthStatus < 65;
                    if (healthFilterValue === 'poor') return healthStatus < 50;
                    return true;
                });
            }
            
            // Apply sorting
            const sortByValue = sortBy.value;
            filteredAssessments.sort((a, b) => {
                switch(sortByValue) {
                    case 'newest':
                        return new Date(b.date) - new Date(a.date);
                    case 'oldest':
                        return new Date(a.date) - new Date(b.date);
                    case 'health-high':
                        return b.healthStatus - a.healthStatus;
                    case 'health-low':
                        return a.healthStatus - b.healthStatus;
                    default:
                        return 0;
                }
            });
        }
        
        // Update statistics cards
        function updateStatistics() {
            const total = allAssessments.length;
            const critical = allAssessments.filter(a => a.status === 'critical').length;
            const treated = allAssessments.filter(a => a.treatment && a.treatment.trim() !== '').length;
            
            // Calculate average health status
            const totalHealth = allAssessments.reduce((sum, a) => sum + (a.healthStatus || 0), 0);
            const avgHealth = total > 0 ? Math.round(totalHealth / total) : 0;
            
            totalAssessmentsEl.textContent = total;
            criticalCasesEl.textContent = critical;
            avgHealthStatusEl.textContent = avgHealth;
            treatedPatientsEl.textContent = treated;
        }
        
        // Get health status class based on score
        function getHealthStatusClass(healthScore) {
            if (healthScore >= 80) return 'health-excellent';
            if (healthScore >= 65) return 'health-good';
            if (healthScore >= 50) return 'health-fair';
            return 'health-poor';
        }
        
        // Get health status text based on score
        function getHealthStatusText(healthScore) {
            if (healthScore >= 80) return 'Excellent';
            if (healthScore >= 65) return 'Good';
            if (healthScore >= 50) return 'Fair';
            return 'Poor';
        }
        
        // Render assessments table
        function renderAssessmentsTable() {
            assessmentsBody.innerHTML = '';
            
            filteredAssessments.forEach(assessment => {
                const row = document.createElement('tr');
                
                // Format date
                const date = new Date(assessment.date);
                const formattedDate = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                // Determine status class and text
                let statusClass = '';
                let statusText = assessment.status || 'pending';
                
                if (statusText === 'good') {
                    statusClass = 'status-good';
                } else if (statusText === 'fair') {
                    statusClass = 'status-fair';
                } else if (statusText === 'poor') {
                    statusClass = 'status-poor';
                } else if (statusText === 'critical') {
                    statusClass = 'status-critical';
                }
                
                // Get health status class and text
                const healthScore = assessment.healthStatus || 0;
                const healthClass = getHealthStatusClass(healthScore);
                const healthText = getHealthStatusText(healthScore);
                
                // Format treatment (truncate if too long)
                let treatmentText = assessment.treatment || 'No treatment assigned';
                if (treatmentText.length > 60) {
                    treatmentText = treatmentText.substring(0, 57) + '...';
                }
                
                row.innerHTML = `
                    <td>${assessment.patientId || assessment.firestoreId.substring(0, 8)}</td>
                    <td><strong>${assessment.disease || 'Unknown Disease'}</strong></td>
                    <td><span class="status ${statusClass}">${statusText}</span></td>
                    <td><span class="health-status ${healthClass}">${healthText} (${healthScore})</span></td>
                    <td class="treatment-cell" title="${assessment.treatment || ''}">${treatmentText}</td>
                    <td>${formattedDate}</td>
                    <td>
                        <div class="action-btns">
                            <button class="btn btn-action btn-view" onclick="viewAssessment('${assessment.firestoreId}')">View</button>
                            <button class="btn btn-action btn-edit" onclick="editAssessment('${assessment.firestoreId}')">Edit</button>
                            <button class="btn btn-action btn-treatment" onclick="viewTreatment('${assessment.firestoreId}')">Treatment</button>
                            <button class="btn btn-action btn-delete" onclick="deleteAssessment('${assessment.firestoreId}')">Delete</button>
                        </div>
                    </td>
                `;
                
                assessmentsBody.appendChild(row);
            });
        }
        
        // View assessment details
        function viewAssessment(id) {
            const assessment = allAssessments.find(a => a.firestoreId === id);
            if (assessment) {
                const symptoms = assessment.symptoms ? assessment.symptoms.join(', ') : 'Not specified';
                alert(`Disease Assessment Details:\n\nDisease: ${assessment.diseaseName}\nPatient: ${assessment.patientName} (Age: ${assessment.age || 'N/A'}, Gender: ${assessment.gender || 'N/A'})\nStatus: ${assessment.status}\nHealth Status: ${assessment.healthStatus} (${getHealthStatusText(assessment.healthStatus)})\nSymptoms: ${symptoms}\nTreatment: ${assessment.treatment || 'Not assigned'}\nDoctor: ${assessment.doctor || 'Not assigned'}\nDate: ${new Date(assessment.date).toLocaleDateString()}\nID: ${id}`);
            }
        }
        
        // View treatment details
        function viewTreatment(id) {
            const assessment = allAssessments.find(a => a.firestoreId === id);
            if (assessment) {
                alert(`Treatment Plan for ${assessment.patientName}:\n\nDisease: ${assessment.diseaseName}\n\nCurrent Treatment:\n${assessment.treatment || 'No treatment assigned'}\n\nPrescribed by: ${assessment.doctor || 'Not specified'}`);
            }
        }
        
        // Edit assessment
        function editAssessment(id) {
            const assessment = allAssessments.find(a => a.firestoreId === id);
            if (assessment) {
                const newTreatment = prompt(`Edit treatment for ${assessment.patientName} (${assessment.diseaseName}):`, assessment.treatment || '');
                if (newTreatment !== null) {
                    // Update in Firebase
                    updateTreatment(id, newTreatment);
                }
            }
        }
        
        // Update treatment in Firebase
        async function updateTreatment(id, newTreatment) {
            try {
                await db.collection('assessments').doc(id).update({
                    treatment: newTreatment,
                    lastUpdated: new Date().toISOString()
                });
                
                alert('Treatment updated successfully!');
                // Reload data
                loadAssessments();
            } catch (error) {
                console.error("Error updating treatment:", error);
                alert('Error updating treatment. Please try again.');
            }
        }
        
        // Delete assessment with confirmation
        async function deleteAssessment(id) {
            if (confirm('Are you sure you want to delete this disease assessment? This action cannot be undone.')) {
                try {
                    await db.collection('assessments').doc(id).delete();
                    alert('Disease assessment deleted successfully!');
                    // Reload data after deletion
                    loadAssessments();
                } catch (error) {
                    console.error("Error deleting assessment:", error);
                    alert('Error deleting assessment. Please try again.');
                }
            }
        }
        
        // Event listeners for filters and search
        searchInput.addEventListener('input', updateDashboard);
        statusFilter.addEventListener('change', updateDashboard);
        healthFilter.addEventListener('change', updateDashboard);
        sortBy.addEventListener('change', updateDashboard);
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Disease Assessment Dashboard initialized");
            console.log("Firebase project: palmaegis-setup");
            console.log("Collection: assessments");
        });
    </script>
</body>
</html>