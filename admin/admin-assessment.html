<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Palm Aegis</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/homepage.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="icon" href="images/logo1.png" type="image/png" sizes="32x32">
    <link rel="shortcut icon" href="images/logo1.png">
    <meta name="theme-color" content="#2e7d32">
    
    <!-- Add DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
    
    <style>
    /* Admin Dashboard Styles */
    .dashboard-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 15px;
        transition: transform 0.3s;
    }

    .stat-card:hover {
        transform: translateY(-5px);
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
    }

    .stat-icon.total { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .stat-icon.healthy { background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%); }
    .stat-icon.disease { background: linear-gradient(135deg, #f44336 0%, #FF9800 100%); }
    .stat-icon.users { background: linear-gradient(135deg, #2196F3 0%, #03A9F4 100%); }

    .stat-content h3 {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin: 0 0 5px 0;
    }

    .stat-content .count {
        font-size: 28px;
        font-weight: 700;
        margin: 0;
        color: #333;
    }

    .stat-content .trend {
        font-size: 12px;
        margin-top: 5px;
    }

    .trend.positive { color: #4CAF50; }
    .trend.negative { color: #f44336; }

    .dashboard-controls {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .filter-label {
        font-size: 12px;
        color: #666;
        font-weight: 600;
    }

    .filter-select, .filter-input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        min-width: 180px;
    }

    .filter-select:focus, .filter-input:focus {
        outline: none;
        border-color: #4CAF50;
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
    }

    .refresh-btn, .export-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        background: #4CAF50;
        color: white;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background 0.3s;
    }

    .refresh-btn:hover, .export-btn:hover {
        background: #45a049;
    }

    .export-btn {
        background: #2196F3;
    }

    .export-btn:hover {
        background: #1976D2;
    }

    .data-table-container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    /* DataTable custom styles */
    table.dataTable {
        border-collapse: collapse !important;
        width: 100% !important;
    }

    table.dataTable thead th {
        background: #f8f9fa;
        border-bottom: 2px solid #dee2e6 !important;
        font-weight: 600;
        color: #333;
        padding: 12px 10px !important;
    }

    table.dataTable tbody td {
        padding: 12px 10px !important;
        border-bottom: 1px solid #eee !important;
        vertical-align: middle;
    }

    table.dataTable tbody tr:hover {
        background-color: #f8f9fa !important;
    }

    .status-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        display: inline-block;
    }

    .status-healthy {
        background: #d4edda;
        color: #155724;
    }

    .status-disease {
        background: #f8d7da;
        color: #721c24;
    }

    .disease-tag {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        margin: 2px;
    }

    .disease-ganoderma {
        background: #e8f5e9;
        color: #2e7d32;
        border: 1px solid #c8e6c9;
    }

    .disease-blackspot {
        background: #ffebee;
        color: #c62828;
        border: 1px solid #ffcdd2;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .user-avatar-small {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
    }

    .action-buttons {
        display: flex;
        gap: 8px;
    }

    .action-btn {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 4px;
        background: #f8f9fa;
        color: #666;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
    }

    .action-btn:hover {
        background: #e9ecef;
        color: #333;
    }

    .action-btn.view { color: #2196F3; }
    .action-btn.edit { color: #4CAF50; }
    .action-btn.delete { color: #f44336; }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: white;
        border-radius: 10px;
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-header {
        padding: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        font-size: 20px;
        font-weight: 600;
        color: #333;
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #666;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
    }

    .modal-close:hover {
        background: #f8f9fa;
        color: #333;
    }

    .modal-body {
        padding: 20px;
    }

    .modal-section {
        margin-bottom: 25px;
    }

    .modal-section-title {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 2px solid #4CAF50;
        display: inline-block;
    }

    .modal-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
    }

    .modal-info-item {
        margin-bottom: 15px;
    }

    .modal-info-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 5px;
    }

    .modal-info-value {
        font-size: 15px;
        color: #333;
        font-weight: 500;
    }

    .image-preview-container {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        background: #f8f9fa;
        text-align: center;
    }

    .assessment-image {
        max-width: 100%;
        max-height: 300px;
        border-radius: 4px;
    }

    .detections-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }

    .detection-item {
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 13px;
    }

    .detection-class {
        font-weight: 600;
        color: #333;
    }

    .detection-confidence {
        color: #666;
        font-size: 11px;
        margin-left: 5px;
    }

    .treatment-text {
        background: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 15px;
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 13px;
        line-height: 1.5;
        max-height: 200px;
        overflow-y: auto;
    }

    /* Chart Container */
    .chart-container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .chart-title {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
    }

    .chart-wrapper {
        height: 300px;
        position: relative;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .dashboard-stats {
            grid-template-columns: 1fr;
        }
        
        .dashboard-controls {
            flex-direction: column;
            align-items: stretch;
        }
        
        .filter-group {
            width: 100%;
        }
        
        .filter-select, .filter-input {
            width: 100%;
        }
        
        .data-table-container {
            padding: 10px;
            overflow-x: auto;
        }
        
        .modal-content {
            width: 95%;
        }
        
        .modal-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 480px) {
        .stat-card {
            padding: 15px;
        }
        
        .stat-icon {
            width: 50px;
            height: 50px;
            font-size: 20px;
        }
        
        .stat-content .count {
            font-size: 24px;
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .action-btn {
            width: 100%;
        }
    }
</style>
</head>
<body>
    <div class="dashboard-container">
        <div id="sidebarPlaceholder"></div>
        <script src="js/sidebar-loader.js"></script>

        <main class="main-content">
            <div class="top-header">
                <div class="header-left">
                    <h1><i class="fas fa-chart-line"></i> Admin Dashboard</h1>
                </div>
            </div>

            <div class="container">
                <!-- Statistics Cards -->
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-icon total">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="stat-content">
                            <h3>Total Assessments</h3>
                            <p class="count" id="totalAssessments">0</p>
                            <p class="trend positive" id="assessmentsTrend">
                                <i class="fas fa-arrow-up"></i> Loading...
                            </p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon healthy">
                            <i class="fas fa-leaf"></i>
                        </div>
                        <div class="stat-content">
                            <h3>Healthy Plants</h3>
                            <p class="count" id="healthyPlants">0</p>
                            <p class="trend positive" id="healthyTrend">
                                <i class="fas fa-arrow-up"></i> Loading...
                            </p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon disease">
                            <i class="fas fa-bug"></i>
                        </div>
                        <div class="stat-content">
                            <h3>Disease Cases</h3>
                            <p class="count" id="diseaseCases">0</p>
                            <p class="trend negative" id="diseaseTrend">
                                <i class="fas fa-arrow-up"></i> Loading...
                            </p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon users">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-content">
                            <h3>Active Users</h3>
                            <p class="count" id="activeUsers">0</p>
                            <p class="trend positive" id="usersTrend">
                                <i class="fas fa-arrow-up"></i> Loading...
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="dashboard-controls">
                    <div class="filter-group">
                        <label class="filter-label">Filter by Status</label>
                        <select class="filter-select" id="statusFilter">
                            <option value="">All Status</option>
                            <option value="Healthy">Healthy</option>
                            <option value="Not Healthy">Not Healthy</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Filter by Disease</label>
                        <select class="filter-select" id="diseaseFilter">
                            <option value="">All Diseases</option>
                            <option value="ganoderma">Ganoderma</option>
                            <option value="blackspot">Blackspot</option>
                            <option value="healthy">No Disease</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Date Range</label>
                        <input type="date" class="filter-input" id="dateFrom">
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">to</label>
                        <input type="date" class="filter-input" id="dateTo">
                    </div>
                    
                    <button class="refresh-btn" onclick="loadAssessments()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    
                    <button class="export-btn" onclick="exportData()">
                        <i class="fas fa-download"></i> Export Data
                    </button>
                </div>

                <!-- Assessments Table -->
                <div class="data-table-container">
                    <table id="assessmentsTable" class="display responsive" style="width:100%">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Date & Time</th>
                                <th>User</th>
                                <th>Location</th>
                                <th>Disease</th>
                                <th>Status</th>
                                <th>Detections</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Assessment Detail Modal -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Assessment Details</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-grid">
                    <div class="modal-section">
                        <h3 class="modal-section-title">Basic Information</h3>
                        <div class="modal-info-item">
                            <div class="modal-info-label">Assessment ID</div>
                            <div class="modal-info-value" id="modalId"></div>
                        </div>
                        <div class="modal-info-item">
                            <div class="modal-info-label">Date & Time</div>
                            <div class="modal-info-value" id="modalDateTime"></div>
                        </div>
                        <div class="modal-info-item">
                            <div class="modal-info-label">Location</div>
                            <div class="modal-info-value" id="modalLocation"></div>
                        </div>
                        <div class="modal-info-item">
                            <div class="modal-info-label">Health Status</div>
                            <div id="modalHealthStatus"></div>
                        </div>
                    </div>
                    
                    <div class="modal-section">
                        <h3 class="modal-section-title">User Information</h3>
                        <div class="modal-info-item">
                            <div class="modal-info-label">User Name</div>
                            <div class="modal-info-value" id="modalUserName"></div>
                        </div>
                        <div class="modal-info-item">
                            <div class="modal-info-label">User Email</div>
                            <div class="modal-info-value" id="modalUserEmail"></div>
                        </div>
                    </div>
                    
                    <div class="modal-section">
                        <h3 class="modal-section-title">Disease Information</h3>
                        <div class="modal-info-item">
                            <div class="modal-info-label">Detected Disease</div>
                            <div class="modal-info-value" id="modalDisease"></div>
                        </div>
                        <div class="modal-info-item">
                            <div class="modal-info-label">Detection Count</div>
                            <div class="modal-info-value" id="modalDetectionCount"></div>
                        </div>
                        <div class="modal-info-item">
                            <div class="modal-info-label">Confidence Threshold</div>
                            <div class="modal-info-value" id="modalConfidence"></div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-section">
                    <h3 class="modal-section-title">Detections</h3>
                    <div class="detections-list" id="modalDetectionsList">
                        <!-- Detections will be populated here -->
                    </div>
                </div>
                
                <div class="modal-section">
                    <h3 class="modal-section-title">Captured Image</h3>
                    <div class="image-preview-container">
                        <img id="modalImage" class="assessment-image" src="" alt="Assessment Image">
                    </div>
                </div>
                
                <div class="modal-section">
                    <h3 class="modal-section-title">Treatment Recommendations</h3>
                    <div class="treatment-text" id="modalTreatment"></div>
                </div>
                
                <div class="modal-section">
                    <h3 class="modal-section-title">Next Assessment</h3>
                    <div class="modal-info-value" id="modalNextAssessment"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add required libraries -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js'; 
    import { getFirestore, collection, getDocs, query, orderBy, where } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAf-wtZpl8wVjCymdLlC-YGlv7xn0yEMMU",
        authDomain: "palmaegis-setup.firebaseapp.com",
        projectId: "palmaegis-setup",
        storageBucket: "palmaegis-setup.firebasestorage.app",
        messagingSenderId: "445887502374",
        appId: "1:445887502374:web:a5f6ecaa90b88447626ee7"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Global variables
    let currentUser = null;
    let userData = null;
    let dataTable = null;
    let allAssessments = [];
    let allUsers = [];

    // Check authentication and authorization
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            console.log('User is signed in:', user.email);
            currentUser = user;
            
            try {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    userData = userDoc.data();
                    
                    // Check if user is admin
                    if (userData.role !== 'admin') {
                        alert('Access denied. Admin privileges required.');
                        window.location.href = 'index.html';
                        return;
                    }
                    
                    updateUserProfile(user, userData);
                    initializeDashboard();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        } else {
            window.location.href = 'signin.html';
        }
    });

    function updateUserProfile(user, userData) {
        const userNameElement = document.querySelector('.user-name');
        const userRoleElement = document.querySelector('.user-role');
        
        if (userNameElement) {
            userNameElement.textContent = userData.firstName && userData.lastName 
                ? `${userData.firstName} ${userData.lastName}`
                : user.email.split('@')[0];
        }
        
        if (userRoleElement) {
            userRoleElement.textContent = 'Admin';
        }
        
        updateProfilePicture(userData);
    }

    function updateProfilePicture(userData) {
        const avatarElements = document.querySelectorAll('.user-avatar');
        let imageSource = 'images/user-avatar.jpg';
        
        if (userData.imageBase64 && userData.imageBase64.trim() !== '') {
            imageSource = userData.imageBase64.trim();
        } else if (userData.picture && userData.picture.trim() !== '') {
            imageSource = userData.picture.trim();
        } else if (userData.photoURL && userData.photoURL.trim() !== '') {
            imageSource = userData.photoURL.trim();
        }

        avatarElements.forEach(img => {
            img.src = imageSource;
            img.alt = 'Admin Avatar';
            img.onerror = function() {
                this.src = 'images/user-avatar.jpg';
            };
        });
    }

    // Initialize dashboard
    async function initializeDashboard() {
        await loadAllUsers();
        await loadAssessments();
        initializeDataTable();
        initializeFilters();
    }

    // Load all users
    async function loadAllUsers() {
        try {
            const usersSnapshot = await getDocs(collection(db, "users"));
            allUsers = [];
            usersSnapshot.forEach(doc => {
                allUsers.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            console.log('Loaded users:', allUsers.length);
        } catch (error) {
            console.error('Error loading users:', error);
        }
    }

    // Load assessments from Firebase
    async function loadAssessments() {
        try {
            const assessmentsRef = collection(db, "assessments");
            const q = query(assessmentsRef, orderBy("timestamp", "desc"));
            const querySnapshot = await getDocs(q);
            
            allAssessments = [];
            querySnapshot.forEach(doc => {
                const data = doc.data();
                allAssessments.push({
                    id: doc.id,
                    ...data
                });
            });

            console.log('Loaded assessments:', allAssessments.length);
            updateStatistics();
            
            if (dataTable) {
                updateDataTable();
            }
            
        } catch (error) {
            console.error('Error loading assessments:', error);
            alert('Error loading data: ' + error.message);
        }
    }

    // Update statistics
    function updateStatistics() {
        const total = allAssessments.length;
        const healthy = allAssessments.filter(a => a.healthStatus === 'Healthy').length;
        const disease = allAssessments.filter(a => a.healthStatus === 'Not Healthy').length;
        const uniqueUsers = [...new Set(allAssessments.map(a => a.userId))].length;

        document.getElementById('totalAssessments').textContent = total;
        document.getElementById('healthyPlants').textContent = healthy;
        document.getElementById('diseaseCases').textContent = disease;
        document.getElementById('activeUsers').textContent = uniqueUsers;

        // Calculate trends (simplified - could be improved with historical data)
        document.getElementById('assessmentsTrend').innerHTML = 
            `<i class="fas fa-arrow-up"></i> ${total} total records`;
        document.getElementById('healthyTrend').innerHTML = 
            `<i class="fas fa-check-circle"></i> ${healthy} healthy`;
        document.getElementById('diseaseTrend').innerHTML = 
            `<i class="fas fa-exclamation-triangle"></i> ${disease} infected`;
        document.getElementById('usersTrend').innerHTML = 
            `<i class="fas fa-users"></i> ${uniqueUsers} users`;
    }

    // Initialize DataTable
    function initializeDataTable() {
        dataTable = $('#assessmentsTable').DataTable({
            data: allAssessments,
            columns: [
                {
                    data: 'assessmentId',
                    render: function(data, type, row) {
                        return `<span style="font-family: monospace; font-size: 12px;">${data}</span>`;
                    }
                },
                {
                    data: null,
                    render: function(data, type, row) {
                        const date = new Date(data.timestamp?.toDate?.() || data.createdAt || Date.now());
                        return `
                            <div>
                                <div style="font-weight: 600;">${date.toLocaleDateString()}</div>
                                <div style="font-size: 12px; color: #666;">${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                            </div>
                        `;
                    }
                },
                {
                    data: null,
                    render: function(data, type, row) {
                        const user = allUsers.find(u => u.id === data.userId);
                        return `
                            <div class="user-info">
                                <img src="${user?.imageBase64 || user?.picture || user?.photoURL || 'images/user-avatar.jpg'}" 
                                     class="user-avatar-small"
                                     onerror="this.src='images/user-avatar.jpg'">
                                <div>
                                    <div style="font-weight: 600;">${data.userName || user?.email?.split('@')[0] || 'Unknown'}</div>
                                    <div style="font-size: 11px; color: #666;">${data.userEmail || user?.email || ''}</div>
                                </div>
                            </div>
                        `;
                    }
                },
                {
                    data: 'location',
                    render: function(data, type, row) {
                        return `<span title="${data}">${data.length > 30 ? data.substring(0, 30) + '...' : data}</span>`;
                    }
                },
                {
                    data: 'disease',
                    render: function(data, type, row) {
                        if (!data || data === 'No disease detected') {
                            return `<span class="disease-tag" style="background: #e8f5e9; color: #2e7d32;">Healthy</span>`;
                        }
                        
                        const diseases = data.split(',').map(d => d.trim());
                        return diseases.map(disease => {
                            let tagClass = 'disease-tag';
                            if (disease.toLowerCase().includes('ganoderma')) {
                                tagClass += ' disease-ganoderma';
                            } else if (disease.toLowerCase().includes('blackspot')) {
                                tagClass += ' disease-blackspot';
                            }
                            return `<span class="${tagClass}">${disease}</span>`;
                        }).join(' ');
                    }
                },
                {
                    data: 'healthStatus',
                    render: function(data, type, row) {
                        const statusClass = data === 'Healthy' ? 'status-healthy' : 'status-disease';
                        return `<span class="status-badge ${statusClass}">${data}</span>`;
                    }
                },
                {
                    data: 'detectionCount',
                    render: function(data, type, row) {
                        return `<span style="font-weight: 600; color: ${data > 0 ? '#c62828' : '#2e7d32'}">${data}</span>`;
                    }
                },
                {
                    data: null,
                    render: function(data, type, row) {
                        return `
                            <div class="action-buttons">
                                <button class="action-btn view" onclick="viewAssessment('${row.id}')" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="action-btn delete" onclick="deleteAssessment('${row.id}', '${row.assessmentId}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                    },
                    orderable: false
                }
            ],
            responsive: true,
            pageLength: 10,
            lengthMenu: [10, 25, 50, 100],
            order: [[1, 'desc']],
            language: {
                search: "Search:",
                lengthMenu: "Show _MENU_ entries",
                info: "Showing _START_ to _END_ of _TOTAL_ entries",
                paginate: {
                    first: "First",
                    last: "Last",
                    next: "Next",
                    previous: "Previous"
                }
            }
        });
    }

    // Update DataTable with filtered data
    function updateDataTable() {
        const filteredData = filterAssessments();
        dataTable.clear();
        dataTable.rows.add(filteredData);
        dataTable.draw();
    }

    // Filter assessments based on selected filters
    function filterAssessments() {
        let filtered = [...allAssessments];
        
        const statusFilter = document.getElementById('statusFilter').value;
        const diseaseFilter = document.getElementById('diseaseFilter').value;
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        
        if (statusFilter) {
            filtered = filtered.filter(a => a.healthStatus === statusFilter);
        }
        
        if (diseaseFilter) {
            if (diseaseFilter === 'healthy') {
                filtered = filtered.filter(a => !a.disease || a.disease === 'No disease detected');
            } else {
                filtered = filtered.filter(a => a.disease && a.disease.toLowerCase().includes(diseaseFilter));
            }
        }
        
        if (dateFrom) {
            const fromDate = new Date(dateFrom);
            filtered = filtered.filter(a => {
                const assessmentDate = new Date(a.timestamp?.toDate?.() || a.createdAt || Date.now());
                return assessmentDate >= fromDate;
            });
        }
        
        if (dateTo) {
            const toDate = new Date(dateTo);
            toDate.setHours(23, 59, 59, 999);
            filtered = filtered.filter(a => {
                const assessmentDate = new Date(a.timestamp?.toDate?.() || a.createdAt || Date.now());
                return assessmentDate <= toDate;
            });
        }
        
        return filtered;
    }

    // Initialize filters
    function initializeFilters() {
        document.getElementById('statusFilter').addEventListener('change', updateDataTable);
        document.getElementById('diseaseFilter').addEventListener('change', updateDataTable);
        document.getElementById('dateFrom').addEventListener('change', updateDataTable);
        document.getElementById('dateTo').addEventListener('change', updateDataTable);
        
        // Set default dates (last 30 days)
        const today = new Date();
        const lastMonth = new Date();
        lastMonth.setDate(today.getDate() - 30);
        
        document.getElementById('dateFrom').value = lastMonth.toISOString().split('T')[0];
        document.getElementById('dateTo').value = today.toISOString().split('T')[0];
    }

    // View assessment details
    function viewAssessment(assessmentId) {
        const assessment = allAssessments.find(a => a.id === assessmentId);
        if (!assessment) return;
        
        // Fill modal with data
        document.getElementById('modalId').textContent = assessment.assessmentId;
        
        const date = new Date(assessment.timestamp?.toDate?.() || assessment.createdAt || Date.now());
        document.getElementById('modalDateTime').textContent = 
            `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
        
        document.getElementById('modalLocation').textContent = assessment.location;
        
        // Health status
        const statusClass = assessment.healthStatus === 'Healthy' ? 'status-healthy' : 'status-disease';
        document.getElementById('modalHealthStatus').innerHTML = 
            `<span class="status-badge ${statusClass}">${assessment.healthStatus}</span>`;
        
        // User info
        const user = allUsers.find(u => u.id === assessment.userId);
        document.getElementById('modalUserName').textContent = 
            assessment.userName || user?.email?.split('@')[0] || 'Unknown';
        document.getElementById('modalUserEmail').textContent = 
            assessment.userEmail || user?.email || 'N/A';
        
        // Disease info
        document.getElementById('modalDisease').textContent = 
            assessment.disease || 'No disease detected';
        document.getElementById('modalDetectionCount').textContent = 
            assessment.detectionCount || 0;
        document.getElementById('modalConfidence').textContent = 
            `${Math.round((assessment.confidenceThreshold || 0.5) * 100)}%`;
        
        // Detections list
        const detectionsList = document.getElementById('modalDetectionsList');
        if (assessment.detections && assessment.detections.length > 0) {
            detectionsList.innerHTML = assessment.detections.map(det => `
                <div class="detection-item">
                    <span class="detection-class">${det.class} (${det.model})</span>
                    <span class="detection-confidence">${Math.round(det.confidence * 100)}% confidence</span>
                </div>
            `).join('');
        } else {
            detectionsList.innerHTML = '<div class="detection-item">No detections found</div>';
        }
        
        // Image
        document.getElementById('modalImage').src = assessment.image || '';
        
        // Treatment
        document.getElementById('modalTreatment').textContent = 
            assessment.treatment || 'No treatment recommendations available.';
        
        // Next assessment
        document.getElementById('modalNextAssessment').textContent = 
            assessment.nextAssessment || 'Not scheduled';
        
        // Show modal
        document.getElementById('detailModal').style.display = 'flex';
    }

    // Close modal
    function closeModal() {
        document.getElementById('detailModal').style.display = 'none';
    }

// Then the delete function becomes simpler:
async function deleteAssessment(assessmentId, assessmentDisplayId) {
    if (!confirm(`Are you sure you want to delete assessment ${assessmentDisplayId}?`)) {
        return;
    }

    try {
        await deleteDoc(doc(db, "assessments", assessmentId));
        alert('Assessment deleted successfully!');
        await loadAssessments(); // Reload data
    } catch (error) {
        console.error('Error deleting assessment:', error);
        alert('Error deleting assessment: ' + error.message);
    }
}

    // Export data
    function exportData() {
        // Trigger DataTables export
        if (dataTable) {
            dataTable.button('.buttons-excel').trigger();
        }
    }

    // Add logout functionality
    document.addEventListener('DOMContentLoaded', function() {
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function(e) {
                e.preventDefault();
                signOut(auth).then(() => {
                    window.location.href = 'signin.html';
                });
            });
        }
    });

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('detailModal');
        if (event.target === modal) {
            closeModal();
        }
    };

    // Make functions globally available
    window.viewAssessment = viewAssessment;
    window.closeModal = closeModal;
    window.deleteAssessment = deleteAssessment;
    window.loadAssessments = loadAssessments;
    window.exportData = exportData;
</script>
</body>
</html>