<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PalmAegis — Admin Users</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --muted:#7b8596;
      --accent:	#097969;
      --danger:#ff5c6c;
      --glass: rgba(43,140,255,0.08);
      --shadow: 0 8px 20px rgba(22,27,34,0.06);
      font-family: "Inter",system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: linear-gradient(180deg,#f6f8fb 0%,#eef4ff 100%);
      color:#19202b;
      padding:28px;
    }

    .container{
      max-width:1200px;
      margin:0 auto;
    }

    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:16px;
      margin-bottom:18px;
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .logo{
      width:48px;height:48px;border-radius:12px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;box-shadow:var(--shadow);
    }
    h1{font-size:20px;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    .card{
      background:var(--card);border-radius:12px;padding:18px;box-shadow:var(--shadow);
    }

    .topbar{
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:14px;
      justify-content:space-between;
    }

    .controls{display:flex;gap:12px;align-items:center}
    .search input{
      padding:10px 12px;border-radius:10px;border:1px solid #e6ecff;background:#fbfdff;min-width:220px;outline:none;
    }
    button.btn{
      padding:10px 14px;border-radius:10px;border:0;cursor:pointer;background:var(--accent);color:#fff;font-weight:600;box-shadow:0 6px 18px rgba(43,140,255,0.18);
    }
    button.ghost{background:transparent;color:var(--accent);border:1px solid var(--glass);padding:8px 12px}
    button.danger{background:var(--danger);color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer;}

    /* Table */
    .table-wrap{overflow:auto;border-radius:10px;}
    table{
      width:100%;border-collapse:collapse;font-size:14px;
    }
    thead tr{background:linear-gradient(90deg,#f7fbff,#ffffff)}
    thead th{padding:12px 14px;text-align:left;color:#6b7280;font-weight:600;font-size:13px;white-space:nowrap}
    tbody td{padding:12px 14px;border-top:1px solid #f1f4fa;background:transparent;vertical-align:middle}
    tbody tr:hover td{background:rgba(43,140,255,0.03)}

    .pill{font-size:12px;padding:6px 8px;border-radius:999px;display:inline-block}
    .role-admin{background:rgba(255,210,85,0.15);color:#b57f00}
    .role-user{background:rgba(43,140,255,0.08);color:var(--accent)}

    .action-btns button{margin-right:6px}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(9,14,25,0.45);display:none;align-items:center;justify-content:center;z-index:80;padding:20px}
    .modal{background:var(--card);padding:18px;border-radius:12px;max-width:520px;width:100%;box-shadow:var(--shadow);transform:translateY(6px)}
    .modal h3{margin:0 0 8px 0}
    .form-row{display:flex;gap:10px;margin-bottom:10px}
    .form-row .col{flex:1}
    .form-row input, .form-row select{
      width:100%;padding:10px;border-radius:8px;border:1px solid #eef2ff;background:#fbfdff;outline:none
    }
    .modal-footer{display:flex;gap:10px;justify-content:flex-end;margin-top:8px}

    /* Loading state */
    .loading{display:flex;justify-content:center;align-items:center;padding:40px;color:var(--muted)}
    .loading i{margin-right:10px}

    /* small screens */
    @media (max-width:680px){
      .form-row{flex-direction:column}
      thead th:nth-child(1),tbody td:nth-child(1){display:none}
    }

    /* tiny helper */
    .muted{color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <img src="../images/logo.png" alt="Palm Aegis Logo" class="w-24 mb-3">
        <div>
          <h1>PalmAegis — User Management</h1>
          <p class="lead">Manage users</p>
        </div>
      </div>

      <div>
        <!-- Add User Button -->
        <button class="btn" id="btnAddUser"><i class="fa-solid fa-user-plus"></i>&nbsp;Add User</button>
        
        <!-- Back to Dashboard Button -->
        <a href="admindashboard.html">
          <button class="btn" id="btnBackToDashboard" style="margin-left: 10px;">
            <i class=""></i>&nbsp;Back to Dashboard
          </button>
        </a>
      </div>
    </header>

    <section class="card">
      <div class="topbar">
        <div class="controls">
          <div class="search">
            <input type="search" id="searchInput" placeholder="Search first name or email..." />
          </div>
          <div class="muted" id="resultCount">—</div>
        </div>

        <div>
          <button class="ghost" id="refreshBtn"><i class="fa-solid fa-arrows-rotate"></i>&nbsp; Refresh</button>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:60px">ID</th>
              <th>First Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Created</th>
              <th style="width:160px">Actions</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <!-- rows injected here -->
            <tr id="loadingRow">
              <td colspan="6" class="loading">
                <i class="fa-solid fa-spinner fa-spin"></i> Loading users...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <p class="muted" style="margin-top:12px">Note: This admin UI uses Cloud Firestore collection: <strong>users</strong>.</p>
  </div>

  <!-- Modal (Add / Edit) -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-hidden="true">
    <div class="modal" role="document">
      <h3 id="modalTitle">Add user</h3>
      <div>
        <div class="form-row">
          <div class="col">
            <label class="muted">First name</label>
            <input id="inputFirstName" type="text" placeholder="e.g. Ahmad" />
          </div>
          <div class="col">
            <label class="muted">Email</label>
            <input id="inputEmail" type="email" placeholder="e.g. hazim@example.com" />
          </div>
        </div>
        <div class="form-row">
          <div class="col">
            <label class="muted">Role</label>
            <select id="inputRole">
              <option value="user">user</option>
              <option value="admin">admin</option>
            </select>
          </div>
          <div class="col">
            <label class="muted">Created at (read-only)</label>
            <input id="inputCreatedAt" disabled placeholder="auto" />
          </div>
        </div>

        <div class="modal-footer">
          <button class="ghost" id="cancelModal">Cancel</button>
          <button class="btn" id="saveUserBtn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    // ==== Firebase Configuration ====
    const firebaseConfig = {
      apiKey: "AIzaSyAf-wtZpl8wVjCymdLlC-YGlv7xn0yEMMU",
      authDomain: "palmaegis-setup.firebaseapp.com",
      projectId: "palmaegis-setup",
      storageBucket: "palmaegis-setup.appspot.com",
      messagingSenderId: "445887502374",
      appId: "1:445887502374:web:a5f6ecaa90b88447626ee7"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // DOM elements
    const usersTableBody = document.getElementById('usersTableBody');
    const searchInput = document.getElementById('searchInput');
    const resultCount = document.getElementById('resultCount');
    const refreshBtn = document.getElementById('refreshBtn');
    const btnAddUser = document.getElementById('btnAddUser');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalTitle = document.getElementById('modalTitle');
    const inputFirstName = document.getElementById('inputFirstName');
    const inputEmail = document.getElementById('inputEmail');
    const inputRole = document.getElementById('inputRole');
    const inputCreatedAt = document.getElementById('inputCreatedAt');
    const cancelModal = document.getElementById('cancelModal');
    const saveUserBtn = document.getElementById('saveUserBtn');

    // Global variables
    let users = [];
    let currentEditingUserId = null;

    // Format date for display
    function formatDate(timestamp) {
      if (!timestamp) return '—';
      
      let date;
      if (timestamp.toDate) {
        date = timestamp.toDate();
      } else if (timestamp instanceof Date) {
        date = timestamp;
      } else {
        date = new Date(timestamp);
      }
      
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    // Load all users from Firestore
    async function loadUsers() {
      try {
        // Show loading state
        usersTableBody.innerHTML = `
          <tr id="loadingRow">
            <td colspan="6" class="loading">
              <i class="fa-solid fa-spinner fa-spin"></i> Loading users...
            </td>
          </tr>
        `;

        const querySnapshot = await db.collection('users').get();
        users = [];
        
        querySnapshot.forEach((doc) => {
          const userData = doc.data();
          users.push({
            id: doc.id,
            ...userData
          });
        });

        // Sort users by creation date (newest first)
        users.sort((a, b) => {
          const dateA = a.createdAt ? (a.createdAt.toDate ? a.createdAt.toDate() : new Date(a.createdAt)) : new Date(0);
          const dateB = b.createdAt ? (b.createdAt.toDate ? b.createdAt.toDate() : new Date(b.createdAt)) : new Date(0);
          return dateB - dateA;
        });

        renderUsers(users);
        updateResultCount(users.length);
      } catch (error) {
        console.error('Error loading users:', error);
        usersTableBody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; color: var(--danger); padding: 20px;">
              <i class="fa-solid fa-triangle-exclamation"></i> Error loading users: ${error.message}
            </td>
          </tr>
        `;
        updateResultCount(0);
      }
    }

    // Render users to the table
    function renderUsers(usersToRender) {
      if (usersToRender.length === 0) {
        usersTableBody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; color: var(--muted); padding: 20px;">
              <i class="fa-solid fa-user-slash"></i> No users found
            </td>
          </tr>
        `;
        return;
      }

      usersTableBody.innerHTML = usersToRender.map(user => `
        <tr>
          <td class="muted">${user.id.substring(0, 6)}...</td>
          <td>${user.firstName || '—'}</td>
          <td>${user.email || '—'}</td>
          <td>
            <span class="pill ${user.role === 'admin' ? 'role-admin' : 'role-user'}">
              ${user.role || 'user'}
            </span>
          </td>
          <td class="muted">${formatDate(user.createdAt)}</td>
          <td class="action-btns">
            <button class="ghost edit-user" data-userid="${user.id}">
              <i class="fa-solid fa-pen"></i>
            </button>
            <button class="danger delete-user" data-userid="${user.id}">
              <i class="fa-solid fa-trash"></i>
            </button>
          </td>
        </tr>
      `).join('');

      // Add event listeners to edit and delete buttons
      document.querySelectorAll('.edit-user').forEach(button => {
        button.addEventListener('click', (e) => {
          const userId = e.currentTarget.getAttribute('data-userid');
          editUser(userId);
        });
      });

      document.querySelectorAll('.delete-user').forEach(button => {
        button.addEventListener('click', (e) => {
          const userId = e.currentTarget.getAttribute('data-userid');
          deleteUser(userId);
        });
      });
    }

    // Update result count display
    function updateResultCount(count) {
      resultCount.textContent = `${count} user${count !== 1 ? 's' : ''}`;
    }

    // Filter users based on search input
    function filterUsers() {
      const searchTerm = searchInput.value.toLowerCase().trim();
      
      if (!searchTerm) {
        renderUsers(users);
        updateResultCount(users.length);
        return;
      }
      
      const filteredUsers = users.filter(user => 
        (user.firstName && user.firstName.toLowerCase().includes(searchTerm)) ||
        (user.email && user.email.toLowerCase().includes(searchTerm))
      );
      
      renderUsers(filteredUsers);
      updateResultCount(filteredUsers.length);
    }

    // Open modal for adding a new user
    function openAddUserModal() {
      modalTitle.textContent = 'Add User';
      inputFirstName.value = '';
      inputEmail.value = '';
      inputRole.value = 'user';
      inputCreatedAt.value = '';
      currentEditingUserId = null;
      modalBackdrop.style.display = 'flex';
    }

    // Open modal for editing an existing user
    async function editUser(userId) {
      const user = users.find(u => u.id === userId);
      
      if (!user) {
        alert('User not found');
        return;
      }
      
      modalTitle.textContent = 'Edit User';
      inputFirstName.value = user.firstName || '';
      inputEmail.value = user.email || '';
      inputRole.value = user.role || 'user';
      inputCreatedAt.value = formatDate(user.createdAt);
      currentEditingUserId = userId;
      modalBackdrop.style.display = 'flex';
    }

    // Save user (add new or update existing)
    async function saveUser() {
      const firstName = inputFirstName.value.trim();
      const email = inputEmail.value.trim();
      const role = inputRole.value;
      
      // Basic validation
      if (!firstName || !email) {
        alert('Please fill in all required fields');
        return;
      }
      
      if (!validateEmail(email)) {
        alert('Please enter a valid email address');
        return;
      }
      
      try {
        if (currentEditingUserId) {
          // Update existing user
          await db.collection('users').doc(currentEditingUserId).update({
            firstName,
            email,
            role,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        } else {
          // Add new user
          await db.collection('users').add({
            firstName,
            email,
            role,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
        
        // Close modal and refresh user list
        modalBackdrop.style.display = 'none';
        await loadUsers();
      } catch (error) {
        console.error('Error saving user:', error);
        alert('Error saving user: ' + error.message);
      }
    }

    // Delete user with confirmation
    async function deleteUser(userId) {
      const user = users.find(u => u.id === userId);
      
      if (!user) {
        alert('User not found');
        return;
      }
      
      if (!confirm(`Are you sure you want to delete user "${user.firstName || user.email}"?`)) {
        return;
      }
      
      try {
        await db.collection('users').doc(userId).delete();
        await loadUsers();
      } catch (error) {
        console.error('Error deleting user:', error);
        alert('Error deleting user: ' + error.message);
      }
    }

    // Email validation helper
    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Load users on page load
      loadUsers();
      
      // Search functionality
      searchInput.addEventListener('input', filterUsers);
      
      // Refresh button
      refreshBtn.addEventListener('click', loadUsers);
      
      // Add user button
      btnAddUser.addEventListener('click', openAddUserModal);
      
      // Modal controls
      cancelModal.addEventListener('click', () => {
        modalBackdrop.style.display = 'none';
      });
      
      saveUserBtn.addEventListener('click', saveUser);
      
      // Close modal when clicking outside
      modalBackdrop.addEventListener('click', (e) => {
        if (e.target === modalBackdrop) {
          modalBackdrop.style.display = 'none';
        }
      });
    });
  </script>
</body>
</html>