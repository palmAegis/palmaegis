<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reports - Palm Aegis Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="../images/logo1.png" type="image/png" sizes="32x32">
  <link rel="shortcut icon" href="images/logo1.png">
  <meta name="theme-color" content="#2e7d32">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Export Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  
  <style>
    /* Custom notification styles */
    .notification-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      max-width: 400px;
    }
    
    .notification {
      background: white;
      border-radius: 10px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      padding: 16px;
      margin-bottom: 12px;
      display: flex;
      align-items: flex-start;
      border-left: 4px solid;
      transform: translateX(100%);
      opacity: 0;
      transition: all 0.3s ease;
    }
    
    .notification.show {
      transform: translateX(0);
      opacity: 1;
    }
    
    .notification.hide {
      transform: translateX(100%);
      opacity: 0;
    }
    
    .notification.success {
      border-left-color: #10B981;
    }
    
    .notification.warning {
      border-left-color: #F59E0B;
    }
    
    .notification.error {
      border-left-color: #EF4444;
    }
    
    .notification.info {
      border-left-color: #3B82F6;
    }
    
    .notification-icon {
      margin-right: 12px;
      font-size: 20px;
      margin-top: 2px;
    }
    
    .notification.success .notification-icon {
      color: #10B981;
    }
    
    .notification.warning .notification-icon {
      color: #F59E0B;
    }
    
    .notification.error .notification-icon {
      color: #EF4444;
    }
    
    .notification.info .notification-icon {
      color: #3B82F6;
    }
    
    .notification-content {
      flex: 1;
    }
    
    .notification-title {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 14px;
    }
    
    .notification-message {
      font-size: 13px;
      color: #6B7280;
      line-height: 1.4;
    }
    
    .notification-close {
      background: none;
      border: none;
      color: #9CA3AF;
      cursor: pointer;
      font-size: 14px;
      margin-left: 8px;
      padding: 0;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .notification-close:hover {
      color: #4B5563;
    }
    
    .progress-bar {
      height: 3px;
      width: 100%;
      background: #E5E7EB;
      border-radius: 2px;
      margin-top: 8px;
      overflow: hidden;
    }
    
    .progress-bar-fill {
      height: 100%;
      width: 100%;
      transition: width 0.1s linear;
    }
    
    .notification.success .progress-bar-fill {
      background: #10B981;
    }
    
    .notification.warning .progress-bar-fill {
      background: #F59E0B;
    }
    
    .notification.error .progress-bar-fill {
      background: #EF4444;
    }
    
    .notification.info .progress-bar-fill {
      background: #3B82F6;
    }
  </style>
</head>
  <body class="bg-gray-50 font-[Inter] flex min-h-screen">
    <!-- Notification Container -->
    <div class="notification-container" id="notification-container"></div>

  <!-- Sidebar Container -->
    <div id="sidebar-container"></div>
    <script>
      // Load sidebar and initialize everything
      document.addEventListener('DOMContentLoaded', function() {
        // Load sidebar
        fetch('sidebaradmin.html')
          .then(response => response.text())
          .then(data => {
            document.getElementById('sidebar-container').innerHTML = data;
            
            // Highlight current page in sidebar
            const currentPage = window.location.pathname.split('/').pop();
            const navLinks = document.querySelectorAll('aside nav a');
            navLinks.forEach(link => {
              const linkPage = link.getAttribute('href');
              if (linkPage === currentPage) {
                link.classList.add('bg-green-600');
                link.classList.remove('hover:bg-green-600');
              }
            });
            
            // Now adjust main content after sidebar loads
            adjustMainContent();
            
            // Listen for sidebar toggle events
            window.addEventListener('sidebarToggled', adjustMainContent);
          })
          .catch(error => console.error('Error loading sidebar:', error));
          
        // Initialize Firebase and load users
        initializeFirebase();
      });

      // Function to adjust main content based on sidebar state
      function adjustMainContent() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.querySelector('.main-content');
        
        if (sidebar && mainContent) {
          // Give a small delay to ensure DOM is updated
          setTimeout(() => {
            if (sidebar.classList.contains('sidebar-collapsed')) {
              mainContent.style.marginLeft = '80px';
              mainContent.style.width = 'calc(100% - 80px)';
            } else {
              mainContent.style.marginLeft = '256px';
              mainContent.style.width = 'calc(100% - 256px)';
            }
          }, 50);
        }
      }

      // Adjust on window resize
      window.addEventListener('resize', function() {
        setTimeout(adjustMainContent, 100);
      });
    </script>
  <!-- Main Content -->
  <main class="main-content">
    <!-- Header -->
    <header class="flex justify-between items-center mb-8">
      <div>
        <h1 class="text-3xl font-bold text-gray-800">Reports & Data Export</h1>
        <p class="text-gray-500">View and export all system data</p>
      </div>
      <div class="flex items-center space-x-4">
        <div id="current-date" class="text-gray-600 text-sm"></div>
      </div>
    </header>

    <!-- Data Collection Cards -->
    <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <div class="bg-white rounded-xl shadow p-6">
        <div class="flex justify-between items-start">
          <div>
            <h3 class="text-2xl font-bold text-green-700" id="users-count">0</h3>
            <p class="text-gray-500">Users</p>
          </div>
          <i class="fas fa-users text-2xl text-green-600"></i>
        </div>
        <button onclick="exportCollection('users')" class="mt-4 w-full bg-green-600 hover:bg-green-500 text-white py-2 px-4 rounded-lg transition flex items-center justify-center">
          <i class="fas fa-download mr-2"></i> Export
        </button>
        <p class="text-xs text-gray-500 mt-2">Excludes: profile pictures</p>
      </div>

      <div class="bg-white rounded-xl shadow p-6">
        <div class="flex justify-between items-start">
          <div>
            <h3 class="text-2xl font-bold text-blue-700" id="scans-count">0</h3>
            <p class="text-gray-500">Scans</p>
          </div>
          <i class="fas fa-camera text-2xl text-blue-600"></i>
        </div>
        <button onclick="exportCollection('assessments')" class="mt-4 w-full bg-blue-600 hover:bg-blue-500 text-white py-2 px-4 rounded-lg transition flex items-center justify-center">
          <i class="fas fa-download mr-2"></i> Export
        </button>
        <p class="text-xs text-gray-500 mt-2">All data included</p>
      </div>

      <div class="bg-white rounded-xl shadow p-6">
        <div class="flex justify-between items-start">
          <div>
            <h3 class="text-2xl font-bold text-purple-700" id="tree-health-count">0</h3>
            <p class="text-gray-500">Tree Health</p>
          </div>
          <i class="fas fa-leaf text-2xl text-purple-600"></i>
        </div>
        <button onclick="exportCollection('treeHealthReports')" class="mt-4 w-full bg-purple-600 hover:bg-purple-500 text-white py-2 px-4 rounded-lg transition flex items-center justify-center">
          <i class="fas fa-download mr-2"></i> Export
        </button>
        <p class="text-xs text-gray-500 mt-2">Excludes: userID</p>
      </div>

      <div class="bg-white rounded-xl shadow p-6">
        <div class="flex justify-between items-start">
          <div>
            <h3 class="text-2xl font-bold text-orange-700" id="farm-data-count">0</h3>
            <p class="text-gray-500">Farm Data</p>
          </div>
          <i class="fas fa-tractor text-2xl text-orange-600"></i>
        </div>
        <button onclick="exportCollection('farmData')" class="mt-4 w-full bg-orange-600 hover:bg-orange-500 text-white py-2 px-4 rounded-lg transition flex items-center justify-center">
          <i class="fas fa-download mr-2"></i> Export
        </button>
        <p class="text-xs text-gray-500 mt-2">Excludes: userID</p>
      </div>
    </section>

    <!-- Export Options -->
    <section class="bg-white rounded-xl shadow p-6 mb-8">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Bulk Export Options</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="border border-gray-200 rounded-lg p-4">
          <h4 class="font-medium text-gray-700 mb-2">Export All Data</h4>
          <p class="text-sm text-gray-500 mb-4">Download complete system data as a ZIP file containing all collections</p>
          <button onclick="exportAllData()" class="w-full bg-green-600 hover:bg-green-500 text-white py-2 px-4 rounded-lg transition flex items-center justify-center">
            <i class="fas fa-file-archive mr-2"></i> Export All as ZIP
          </button>
        </div>
        
        <div class="border border-gray-200 rounded-lg p-4">
          <h4 class="font-medium text-gray-700 mb-2">Custom Report</h4>
          <p class="text-sm text-gray-500 mb-4">Generate a custom PDF report with selected data and analytics</p>
          <button onclick="generateCustomReport()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 px-4 rounded-lg transition flex items-center justify-center">
            <i class="fas fa-file-pdf mr-2"></i> Generate PDF Report
          </button>
        </div>
      </div>
    </section>

    <!-- Data Preview Section -->
    <section class="bg-white rounded-xl shadow p-6 mb-8">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-semibold text-gray-800">Data Preview</h3>
        <div class="flex space-x-2">
          <select id="collection-select" class="p-2 border border-gray-300 rounded-lg">
            <option value="users">Users</option>
            <option value="scans">Scans</option>
            <option value="treeHealthReports">Tree Health</option>
            <option value="farmData">Farm Data</option>
            <option value="treatments">Treatments</option>
          </select>
          <button onclick="loadCollectionPreview()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg transition">
            <i class="fas fa-sync-alt mr-2"></i> Load
          </button>
        </div>
      </div>
      
      <div class="overflow-x-auto">
        <table class="w-full text-sm text-left text-gray-700">
          <thead class="text-xs text-gray-700 uppercase bg-gray-50">
            <tr id="preview-table-headers">
              <!-- Headers will be populated dynamically -->
            </tr>
          </thead>
          <tbody id="preview-table-body">
            <tr>
              <td colspan="10" class="px-4 py-8 text-center text-gray-500">
                <i class="fas fa-database text-2xl mb-2"></i>
                <p>Select a collection and click Load to preview data</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="mt-4 flex justify-between items-center">
        <div class="text-sm text-gray-500" id="preview-table-info">No data loaded</div>
        <div class="flex space-x-2" id="preview-pagination-controls">
          <!-- Pagination will be added dynamically -->
        </div>
      </div>
    </section>

    <!-- System Statistics -->
    <section class="bg-white rounded-xl shadow p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">System Statistics</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="bg-gray-50 p-4 rounded-lg">
          <div class="text-sm text-gray-500">Total Collections</div>
          <div class="text-2xl font-bold text-gray-800" id="total-collections">5</div>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg">
          <div class="text-sm text-gray-500">Total Records</div>
          <div class="text-2xl font-bold text-gray-800" id="total-records">0</div>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg">
          <div class="text-sm text-gray-500">Last Updated</div>
          <div class="text-2xl font-bold text-gray-800" id="last-updated">-</div>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg">
          <div class="text-sm text-gray-500">Database Size</div>
          <div class="text-2xl font-bold text-gray-800" id="db-size">-</div>
        </div>
      </div>
      
      <div class="chart-container">
        <canvas id="data-distribution-chart" height="100"></canvas>
      </div>
    </section>
  </main>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAf-wtZpl8wVjCymdLlC-YGlv7xn0yEMMU",
      authDomain: "palmaegis-setup.firebaseapp.com",
      projectId: "palmaegis-setup",
      storageBucket: "palmaegis-setup.firebasestorage.app",
      messagingSenderId: "445887502374",
      appId: "1:445887502374:web:a5f6ecaa90b88447626ee7"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Global variables
    let allData = {
      users: [],
      scans: [],
      treeHealthReports: [],
      farmData: [],
      treatments: []
    };

    // Field exclusion configuration
    const excludedFields = {
      users: ['profilePicture', 'image', 'photo', 'picture', 'avatar', 'base64'],
      treeHealthReports: ['userId', 'userID', 'user_id'],
      treatments: ['image', 'images', 'picture', 'photo'],
      farmData: ['userId', 'userID', 'user_id']
    };

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById("current-date").innerText = new Date().toLocaleDateString();
      loadAllData();
    });

    // Custom notification system
    function showNotification(type, title, message, duration = 5000) {
      const container = document.getElementById('notification-container');
      const notificationId = 'notification-' + Date.now();
      
      // Icons for different notification types
      const icons = {
        success: 'fas fa-check-circle',
        warning: 'fas fa-exclamation-triangle',
        error: 'fas fa-times-circle',
        info: 'fas fa-info-circle'
      };
      
      const notification = document.createElement('div');
      notification.id = notificationId;
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <div class="notification-icon">
          <i class="${icons[type]}"></i>
        </div>
        <div class="notification-content">
          <div class="notification-title">${title}</div>
          <div class="notification-message">${message}</div>
          <div class="progress-bar">
            <div class="progress-bar-fill" id="progress-${notificationId}"></div>
          </div>
        </div>
        <button class="notification-close" onclick="closeNotification('${notificationId}')">
          <i class="fas fa-times"></i>
        </button>
      `;
      
      container.appendChild(notification);
      
      // Trigger animation
      setTimeout(() => {
        notification.classList.add('show');
        
        // Start progress bar animation
        const progressBar = document.getElementById(`progress-${notificationId}`);
        if (progressBar) {
          progressBar.style.width = '0%';
          progressBar.style.transition = `width ${duration}ms linear`;
          setTimeout(() => {
            progressBar.style.width = '100%';
          }, 10);
        }
      }, 10);
      
      // Auto-close after duration
      const timeoutId = setTimeout(() => {
        closeNotification(notificationId);
      }, duration);
      
      // Store timeout ID for manual close
      notification.dataset.timeoutId = timeoutId;
    }
    
    function closeNotification(notificationId) {
      const notification = document.getElementById(notificationId);
      if (!notification) return;
      
      // Clear the auto-close timeout
      clearTimeout(notification.dataset.timeoutId);
      
      // Trigger hide animation
      notification.classList.remove('show');
      notification.classList.add('hide');
      
      // Remove from DOM after animation completes
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    }

    // Load all data from Firebase collections
    async function loadAllData() {
      try {
        // Show loading notification
        showNotification('info', 'Loading Data', 'Fetching all data from the database...');
        
        // Load users
        const usersSnapshot = await db.collection('users').get();
        allData.users = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        document.getElementById('users-count').textContent = allData.users.length;

        // Load scans
        const scansSnapshot = await db.collection('assessments').get();
        allData.scans = scansSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        document.getElementById('scans-count').textContent = allData.scans.length;

        // Load tree health reports
        const treeHealthSnapshot = await db.collection('treeHealthReports').get();
        allData.treeHealthReports = treeHealthSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        document.getElementById('tree-health-count').textContent = allData.treeHealthReports.length;

        // Load farm data
        const farmDataSnapshot = await db.collection('farms').get();
        allData.farmData = farmDataSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        document.getElementById('farm-data-count').textContent = allData.farmData.length;

        // Load treatments
        const treatmentsSnapshot = await db.collection('treatments').get();
        allData.treatments = treatmentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Update statistics
        updateStatistics();
        
        // Show success notification
        showNotification('success', 'Data Loaded', 'All data has been successfully loaded from the database.');
        
        console.log('All data loaded successfully');
      } catch (error) {
        console.error('Error loading data:', error);
        showNotification('error', 'Data Load Error', 'Failed to load data from the database. Please try again.');
      }
    }

    // Filter data by removing excluded fields
    function filterData(collectionName, data) {
      const fieldsToExclude = excludedFields[collectionName] || [];
      
      return data.map(item => {
        const filteredItem = { ...item };
        
        fieldsToExclude.forEach(field => {
          // Check for exact field name and case variations
          const fieldVariations = [
            field,
            field.toLowerCase(),
            field.toUpperCase(),
            field.charAt(0).toUpperCase() + field.slice(1)
          ];
          
          fieldVariations.forEach(fieldVar => {
            if (filteredItem.hasOwnProperty(fieldVar)) {
              delete filteredItem[fieldVar];
            }
          });
          
          // Also check for fields that contain the excluded term (for base64 images)
          Object.keys(filteredItem).forEach(key => {
            if (fieldsToExclude.some(excluded => 
              key.toLowerCase().includes(excluded.toLowerCase()))) {
              delete filteredItem[key];
            }
          });
        });
        
        return filteredItem;
      });
    }

    // Update statistics
    function updateStatistics() {
      const totalRecords = Object.values(allData).reduce((sum, collection) => sum + collection.length, 0);
      document.getElementById('total-records').textContent = totalRecords;
      document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
      
      // Update chart
      updateDataDistributionChart();
    }

    // Update data distribution chart
    function updateDataDistributionChart() {
      const ctx = document.getElementById('data-distribution-chart').getContext('2d');
      
      const collections = Object.keys(allData);
      const counts = collections.map(collection => allData[collection].length);
      
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: collections.map(name => name.charAt(0).toUpperCase() + name.slice(1)),
          datasets: [{
            label: 'Record Count',
            data: counts,
            backgroundColor: [
              '#10B981',
              '#3B82F6',
              '#8B5CF6',
              '#F59E0B',
              '#EF4444'
            ],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: false
            },
            title: {
              display: true,
              text: 'Data Distribution by Collection'
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    // Load collection preview
    function loadCollectionPreview() {
      const collectionName = document.getElementById('collection-select').value;
      const data = allData[collectionName];
      
      if (!data || data.length === 0) {
        document.getElementById('preview-table-body').innerHTML = `
          <tr>
            <td colspan="10" class="px-4 py-8 text-center text-gray-500">
              <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
              <p>No data available for this collection</p>
            </td>
          </tr>
        `;
        document.getElementById('preview-table-info').textContent = 'No data available';
        document.getElementById('preview-pagination-controls').innerHTML = '';
        return;
      }
      
      // Filter data for preview (remove excluded fields)
      const filteredData = filterData(collectionName, data);
      
      // Get all unique keys from the filtered data
      const allKeys = [...new Set(filteredData.flatMap(item => Object.keys(item)))];
      
      // Create table headers
      const headersHtml = allKeys.map(key => 
        `<th class="px-4 py-3">${formatHeader(key)}</th>`
      ).join('');
      
      document.getElementById('preview-table-headers').innerHTML = headersHtml;
      
      // Create table rows (show first 10 records)
      const previewData = filteredData.slice(0, 10);
      const rowsHtml = previewData.map(item => {
        const cellsHtml = allKeys.map(key => {
          let value = item[key];
          
          // Format special values
          if (value && typeof value === 'object') {
            if (value.toDate) {
              value = value.toDate().toLocaleDateString();
            } else if (Array.isArray(value)) {
              value = value.join(', ');
            } else {
              value = JSON.stringify(value);
            }
          }
          
          // Truncate long values
          if (typeof value === 'string' && value.length > 50) {
            value = value.substring(0, 50) + '...';
          }
          
          return `<td class="px-4 py-3 border-t">${value || '-'}</td>`;
        }).join('');
        
        return `<tr>${cellsHtml}</tr>`;
      }).join('');
      
      document.getElementById('preview-table-body').innerHTML = rowsHtml;
      document.getElementById('preview-table-info').textContent = `Showing ${previewData.length} of ${data.length} records (filtered)`;
      
      // Add pagination if needed
      if (data.length > 10) {
        document.getElementById('preview-pagination-controls').innerHTML = `
          <button class="px-3 py-1 border rounded-lg bg-green-600 text-white">1</button>
          <span class="px-2">...</span>
          <button class="px-3 py-1 border rounded-lg hover:bg-gray-50">View All (${data.length})</button>
        `;
      } else {
        document.getElementById('preview-pagination-controls').innerHTML = '';
      }
    }

    // Format header for display
    function formatHeader(key) {
      return key
        .replace(/([A-Z])/g, ' $1')
        .replace(/^./, str => str.toUpperCase())
        .replace('Id', 'ID');
    }

    // Export a specific collection
    function exportCollection(collectionName) {
      const data = allData[collectionName];
      if (!data || data.length === 0) {
        showNotification('warning', 'Export Failed', `No data available for ${collectionName}`);
        return;
      }
      
      // Show export started notification
      showNotification('info', 'Export Started', `Preparing ${collectionName} data for export...`);
      
      // Filter data to remove excluded fields
      const filteredData = filterData(collectionName, data);
      
      // Convert to CSV
      const csvContent = convertToCSV(filteredData);
      
      // Create download link
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `${collectionName}-${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      URL.revokeObjectURL(url);
      
      // Show success notification
      showNotification('success', 'Export Complete', `Exported ${filteredData.length} records from ${collectionName} (sensitive fields excluded)`);
    }

    // Convert data to CSV
    function convertToCSV(data) {
      if (!data || data.length === 0) return '';
      
      // Get all keys
      const keys = [...new Set(data.flatMap(item => Object.keys(item)))];
      
      // Create header row
      const header = keys.map(key => `"${formatHeader(key)}"`).join(',');
      
      // Create data rows
      const rows = data.map(item => {
        return keys.map(key => {
          let value = item[key];
          
          // Format special values
          if (value && typeof value === 'object') {
            if (value.toDate) {
              value = value.toDate().toISOString();
            } else if (Array.isArray(value)) {
              value = value.join('; ');
            } else {
              value = JSON.stringify(value);
            }
          }
          
          // Escape quotes and wrap in quotes
          return `"${String(value || '').replace(/"/g, '""')}"`;
        }).join(',');
      });
      
      return [header, ...rows].join('\n');
    }

    // Export all data as ZIP
    function exportAllData() {
      // Show export started notification
      showNotification('info', 'Export Started', 'Preparing all data for export...');
      
      // Create a ZIP file with all collections
      const zip = new JSZip();
      
      Object.keys(allData).forEach(collectionName => {
        const data = allData[collectionName];
        if (data && data.length > 0) {
          // Filter data to remove excluded fields
          const filteredData = filterData(collectionName, data);
          const csvContent = convertToCSV(filteredData);
          zip.file(`${collectionName}.csv`, csvContent);
        }
      });
      
      // Add a README file
      const readmeContent = `Palm Aegis Data Export\nGenerated on: ${new Date().toISOString()}\nTotal Collections: ${Object.keys(allData).length}\nTotal Records: ${Object.values(allData).reduce((sum, collection) => sum + collection.length, 0)}\n\nExcluded Fields:\n- Users: profile pictures and base64 images\n- Tree Health: userID fields\n- Treatments: image fields\n- Farm Data: userID fields`;
      zip.file("README.txt", readmeContent);
      
      // Generate and download the ZIP file
      zip.generateAsync({type:"blob"})
        .then(function(content) {
          const url = URL.createObjectURL(content);
          const link = document.createElement('a');
          link.href = url;
          link.download = `palm-aegis-full-export-${new Date().toISOString().split('T')[0]}.zip`;
          link.click();
          URL.revokeObjectURL(url);
          
          // Show success notification
          showNotification('success', 'Export Complete', 'All data exported successfully as ZIP file! (Sensitive fields excluded)');
        })
        .catch(function(error) {
          console.error('Error generating ZIP:', error);
          showNotification('error', 'Export Failed', 'Failed to export data. Please try again.');
        });
    }

    // Generate custom PDF report
    function generateCustomReport() {
      showNotification('info', 'PDF Generation', 'Preparing custom PDF report...');
      // This would use jsPDF to create a formatted PDF report
      // For now, we'll just show a notification
      setTimeout(() => {
        showNotification('success', 'PDF Generated', 'Custom PDF report has been generated successfully.');
      }, 1500);
    }
  </script>
</body>
</html>