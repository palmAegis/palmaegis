<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assessment | Palm Aegis</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/homepage.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="icon" href="images/logo1.png" type="image/png" sizes="32x32">
    <link rel="shortcut icon" href="images/logo1.png">
    <meta name="theme-color" content="#2e7d32">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Add Axios library -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="css/farmassessment.css" />
    
    <style>
    /* Page-specific styles */
    .health-status {
        padding: 8px 12px;
        border-radius: 4px;
        font-weight: bold;
        text-align: center;
    }

    .healthy {
        background-color: #f8f9fa;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .not-healthy {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .disease-input.auto-detected {
        background-color: #e9ecef;
        font-weight: bold;
    }

    .model-badge {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 10px;
        color: white;
        margin-left: 5px;
    }

    .ganoderma-badge {
        background-color: #28a745;
    }

    .blackspot-badge {
        background-color: #dc3545;
    }

    .detection-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #eee;
        border-left: 4px solid #ccc;
    }

    .detection-class {
        font-weight: bold;
    }

    .detection-confidence {
        color: white;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 12px;
    }

    .camera-container {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 1000;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .camera-video {
        max-width: 90%;
        max-height: 70%;
        border-radius: 8px;
    }

    .camera-controls {
        margin-top: 20px;
        display: flex;
        gap: 15px;
    }

    .capture-btn, .cancel-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
    }

    .capture-btn {
        background: #007bff;
        color: white;
    }

    .cancel-btn {
        background: #6c757d;
        color: white;
    }

    .upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        margin-bottom: 15px;
        transition: all 0.3s;
        background-color: #f8f9fa;
    }

    .upload-area:hover {
        border-color: #007bff;
        background-color: #e9ecef;
    }

    .confidence-slider {
        margin-bottom: 20px;
    }

    .slider-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
    }

    .slider-value {
        font-weight: bold;
        color: #007bff;
    }

    .threshold-info {
        margin-top: 8px;
        padding: 8px;
        border-radius: 4px;
        font-size: 12px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        font-size: 14px;
    }

    .form-input, .form-textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        box-sizing: border-box;
        font-size: 14px;
    }

    .form-textarea {
        min-height: 80px;
        resize: vertical;
    }

    .form-row {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }

    .form-row .form-group {
        flex: 1;
        margin-bottom: 0;
    }

    .camera-btn {
        width: 100%;
        padding: 10px;
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        margin-bottom: 10px;
        transition: background 0.3s;
        font-size: 14px;
    }

    .camera-btn:hover {
        background: #5a6268;
    }

    .image-container {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 15px;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f8f9fa;
        position: relative;
        width: 100%;
    }

    .no-image {
        text-align: center;
        color: #6c757d;
        padding: 20px;
    }

    #previewCanvas {
        max-width: 100%;
        max-height: 100%;
        width: auto;
        height: auto;
        object-fit: contain;
    }

    .loading {
        display: none;
        text-align: center;
        padding: 20px;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 2s linear infinite;
        margin: 0 auto 15px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .results-panel {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
        margin-top: 15px;
    }

    .results-header {
        background: #f8f9fa;
        padding: 10px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #dee2e6;
    }

    .results-title {
        font-weight: bold;
        font-size: 14px;
    }

    .objects-count {
        color: #6c757d;
        font-size: 12px;
        font-weight: 600;
    }

    .detections-list {
        max-height: 200px;
        overflow-y: auto;
    }

    .image-section {
        flex: 1;
        min-width: 0;
    }

    .form-section {
        flex: 1;
        min-width: 0;
    }

    .content {
        display: flex;
        gap: 20px;
        height: auto;
    }

    .container {
        padding: 20px;
        height: auto;
    }

    .main-content {
        flex: 1;
        overflow: auto;
        margin-left: 260px;
    }

    .dashboard-container {
        display: flex;
        min-height: 100vh;
    }

    .map-container {
        border: 1px solid #dee2e6;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 10px;
        height: 200px;
    }

    .assessment-id-container {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .assessment-id-container .form-input {
        flex: 1;
    }

    .regenerate-btn {
        padding: 8px 12px;
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        white-space: nowrap;
    }

    .regenerate-btn:hover {
        background: #5a6268;
    }

    .id-status {
        font-size: 12px;
        margin-top: 5px;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .id-status.valid {
        color: #28a745;
    }

    .id-status.invalid {
        color: #dc3545;
    }

    .id-status.info {
        color: #6c757d;
    }

    @media (max-width: 768px) {
        .content {
            flex-direction: column;
            gap: 15px;
        }
        
        .image-container {
            height: auto;
            min-height: 250px;
            aspect-ratio: 4/3;
        }
        
        #previewCanvas {
            width: 100%;
            height: auto;
            max-height: none;
        }
        
        .form-row {
            flex-direction: column;
            gap: 15px;
        }
        
        .main-content {
            margin-left: 0;
        }
        
        .container {
            padding: 15px;
        }
        
        .upload-area {
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .confidence-slider,
        .form-group {
            margin-bottom: 12px;
        }
        
        .assessment-id-container {
            flex-direction: column;
            gap: 8px;
        }
        
        .regenerate-btn {
            width: 100%;
            padding: 10px;
        }
    }

    @media (max-width: 576px) {
        .image-container {
            min-height: 200px;
            aspect-ratio: 4/3;
        }
        
        .map-container {
            height: 150px;
        }
        
        .container {
            padding: 10px;
        }
        
        .top-header {
            padding: 10px 15px;
        }
        
        h1 {
            font-size: 1.5rem;
        }
    }
    
    @media (max-width: 480px) {
        .camera-btn {
            padding: 8px;
            font-size: 13px;
            margin-bottom: 8px;
        }
        
        .form-input, .form-textarea {
            padding: 8px;
            font-size: 13px;
        }
        
        .image-container {
            min-height: 180px;
        }
        
        .detection-item {
            padding: 8px;
            font-size: 13px;
        }
    }
</style>
</head>
<body>
    <div class="dashboard-container">
        <div id="sidebarPlaceholder"></div>
        <script src="js/sidebar-loader.js"></script>

        <main class="main-content">
            <div class="top-header">
                <div class="header-left">
                    <h1>Disease Detection</h1>
                </div>
            </div>

            <div class="container">
                <div class="content">
                    <div class="image-section">
                        <div class="image-container" id="imageContainer">
                            <div class="no-image" id="noImage">
                                <i class="fas fa-camera fa-2x" style="margin-bottom: 10px; color: #6c757d;"></i>
                            </div>
                            <canvas id="previewCanvas" style="display: none;"></canvas>
                        </div>

                        <div class="loading" id="loading">
                            <div class="spinner"></div>
                            <p>Processing image...</p>
                        </div>

                        <div class="results-panel">
                            <div class="results-header">
                                <span class="results-title">DETECTIONS</span>
                                <span class="objects-count" id="objectsCount">0 objects</span>
                            </div>
                            <div class="detections-list" id="detectionsList">
                                <div style="text-align: center; color: #6c757d; padding: 20px;">
                                    No detections
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-cloud-upload-alt fa-2x" style="color: #6c757d; margin-bottom: 10px;"></i>
                            <p style="font-weight: 600; margin-bottom: 5px;">Click to upload image</p>
                            <p style="font-size: 12px; color: #6c757d; margin: 0;">Supported: JPG, PNG, JPEG</p>
                            <input type="file" id="fileInput" class="file-input" accept="image/*" style="display: none;">
                        </div>

                        <button onclick="openCamera()" class="camera-btn" id="cameraBtn">
                            <i class="fas fa-camera"></i> Take Photo
                        </button>

                        <div class="confidence-slider">
                            <div class="slider-label">
                                <span>Confidence Threshold:</span>
                                <span class="slider-value" id="confidenceValue">50%</span>
                            </div>
                            <input type="range" id="confidenceSlider" min="1" max="100" value="50"
                                oninput="updateConfidence(this.value)" style="width: 100%;">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Assessment ID <span style="color: red;">*</span></label>
                            <div class="assessment-id-container">
                                <input type="text" class="form-input" id="assessmentId" placeholder="Will auto-generate after image analysis" readonly>
                                <button type="button" class="regenerate-btn" onclick="generateAssessmentId()">
                                    <i class="fas fa-sync-alt"></i> Regenerate
                                </button>
                            </div>
                            <div id="assessmentIdStatus" class="id-status info">
                                Upload and analyze an image to generate Assessment ID
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Location</label>
                            <input type="text" class="form-input" id="locationInput" placeholder="Enter location or use current location">
                            <button type="button" class="camera-btn" style="margin-top: 10px; background: #28a745;"
                                onclick="getCurrentLocation()">
                                <i class="fas fa-map-marker-alt"></i> Use Current Location
                            </button>
                            <div class="map-container" id="mapContainer"></div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-input" id="assessmentDate">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Time</label>
                                <input type="time" class="form-input" id="assessmentTime">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Detected Disease</label>
                            <input type="text" class="form-input disease-input" id="diseaseInput" placeholder="" readonly>
                            <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                                Auto-detected based on image analysis
                            </small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Health Status</label>
                            <div id="healthStatus" class="health-status">Not assessed</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Treatment</label>
                            <textarea class="form-textarea" id="treatmentText" placeholder="Treatment recommendations will appear here"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Next Assessment</label>
                            <input type="text" class="form-input" id="nextAssessment" readonly>
                        </div>

                        <button class="camera-btn" style="background: #007bff;" onclick="saveAssessment()">
                            <i class="fas fa-save"></i> Save Assessment
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="camera-container" id="cameraContainer">
        <video id="cameraVideo" class="camera-video" autoplay playsinline></video>
        <div class="camera-controls">
            <button class="capture-btn" onclick="captureImage()">
                <i class="fas fa-camera"></i> Capture Image
            </button>
            <button class="cancel-btn" onclick="closeCamera()">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js'; 
    import { getFirestore, doc, getDoc, collection, addDoc, serverTimestamp, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAf-wtZpl8wVjCymdLlC-YGlv7xn0yEMMU",
        authDomain: "palmaegis-setup.firebaseapp.com",
        projectId: "palmaegis-setup",
        storageBucket: "palmaegis-setup.firebasestorage.app",
        messagingSenderId: "445887502374",
        appId: "1:445887502374:web:a5f6ecaa90b88447626ee7"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Global variables
    window.firebaseApp = app;
    window.firebaseAuth = auth;
    window.firestoreDb = db;
    window.firebaseAddDoc = addDoc;
    window.firebaseCollection = collection;
    window.firebaseServerTimestamp = serverTimestamp;

    // Configuration for multiple models
    const models = {
        'ganoderma': {
            name: 'Ganoderma Detection',
            url: 'https://serverless.roboflow.com/ganoderma-1-xpzwd/1',
            apiKey: 'KOIYcp3E5rAFhgSploex',
            color: '#28a745',
            badgeClass: 'ganoderma-badge',
            defaultThreshold: 0.7
        },
        'blackspot': {
            name: 'Blackspot Disease Detection',
            url: 'https://serverless.roboflow.com/blackspot-lhjog/1',
            apiKey: 'KOIYcp3E5rAFhgSploex',
            color: '#dc3545',
            badgeClass: 'blackspot-badge',
            defaultThreshold: 0.5
        }
    };

    // Disease codes for ID generation
    const diseaseCodes = {
        'ganoderma': 'GAN',
        'blackspot': 'BLS',
        'healthy': 'HLT',
        'unknown': 'UNK'
    };

    // Variables
    const fileInput = document.getElementById('fileInput');
    const loading = document.getElementById('loading');
    const noImage = document.getElementById('noImage');
    const previewCanvas = document.getElementById('previewCanvas');
    const imageContainer = document.getElementById('imageContainer');
    const detectionsList = document.getElementById('detectionsList');
    const objectsCount = document.getElementById('objectsCount');
    const confidenceSlider = document.getElementById('confidenceSlider');
    const confidenceValue = document.getElementById('confidenceValue');
    const cameraContainer = document.getElementById('cameraContainer');
    const cameraVideo = document.getElementById('cameraVideo');

    // Form elements
    const assessmentId = document.getElementById('assessmentId');
    const assessmentIdStatus = document.getElementById('assessmentIdStatus');
    const locationInput = document.getElementById('locationInput');
    const assessmentDate = document.getElementById('assessmentDate');
    const assessmentTime = document.getElementById('assessmentTime');
    const diseaseInput = document.getElementById('diseaseInput');
    const healthStatus = document.getElementById('healthStatus');
    const treatmentText = document.getElementById('treatmentText');
    const nextAssessment = document.getElementById('nextAssessment');
    const mapContainer = document.getElementById('mapContainer');

    let originalImage = null;
    let canvasContext = previewCanvas.getContext('2d');
    let confidenceThreshold = 0.5;
    let stream = null;
    let currentDiseaseType = null;
    let map = null;
    let marker = null;
    let currentDetections = [];
    let currentUser = null;
    let userData = null;
    let generatedAssessmentId = '';

    // Check authentication state
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            console.log('User is signed in:', user.email);
            currentUser = user;
            window.currentUser = user;
            
            try {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    userData = userDoc.data();
                    window.userData = userData;
                    console.log('ðŸ” User data from Firestore:', userData);
                    updateUserProfile(user, userData);
                } else {
                    console.log('No user data found in Firestore');
                    updateUserProfile(user, {});
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                updateUserProfile(user, {});
            }
        } else {
            console.log('User is not signed in');
            window.location.href = 'signin.html';
        }
    });

    function updateUserProfile(user, userData) {
        console.log('ðŸ”„ Updating user profile with data:', userData);
        
        const userNameElement = document.querySelector('.user-name');
        const userRoleElement = document.querySelector('.user-role');
        
        const displayName = userData.firstName && userData.lastName 
            ? `${userData.firstName} ${userData.lastName}`
            : userData.username 
            ? userData.username
            : userData.displayName || user.displayName || user.email.split('@')[0] || 'User';
        
        if (userNameElement) userNameElement.textContent = displayName;

        if (userRoleElement) {
            userRoleElement.textContent = userData.bio || 'Farmer';
        }

        updateProfilePicture(userData);
    }

    function updateProfilePicture(userData) {
        const avatarElements = document.querySelectorAll('.user-avatar');
        
        let imageSource = 'images/user-avatar.jpg';
        
        if (userData.imageBase64 && userData.imageBase64.trim() !== '') {
            imageSource = userData.imageBase64.trim();
            console.log('ðŸŽ¯ Using Base64 image from Firestore');
        } else if (userData.picture && userData.picture.trim() !== '') {
            imageSource = userData.picture.trim();
            console.log('ðŸŽ¯ Using picture URL from Firestore');
        } else if (userData.photoURL && userData.photoURL.trim() !== '') {
            imageSource = userData.photoURL.trim();
            console.log('ðŸŽ¯ Using photoURL from Firestore');
        }

        avatarElements.forEach(img => {
            img.src = imageSource;
            img.alt = 'User Avatar';
            img.onerror = function() {
                console.warn('âš ï¸ Failed to load user image, reverting to default.');
                this.src = 'images/user-avatar.jpg';
            };
        });

        console.log('ðŸ”„ Updated avatar images with source:', imageSource);
    }

    // Add logout functionality
    document.addEventListener('DOMContentLoaded', function() {
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                signOut(auth).then(() => {
                    window.location.href = 'signin.html';
                }).catch((error) => {
                    console.error('Logout error:', error);
                });
            });
        }

        // Initialize the map
        initializeMap();
    });

    // Initialize date and time
    function initializeDateTime() {
        const now = new Date();
        assessmentDate.value = now.toISOString().split('T')[0];
        assessmentTime.value = now.toTimeString().slice(0, 5);
    }

    // Initialize map
    function initializeMap() {
        map = L.map('mapContainer').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        marker = L.marker([0, 0]).addTo(map)
            .bindPopup('Default location')
            .openPopup();
    }

    // Update map with current location
    function updateMap(lat, lng, locationName = 'Current Location') {
        if (map) {
            map.setView([lat, lng], 15);
            if (marker) {
                map.removeLayer(marker);
            }
            marker = L.marker([lat, lng]).addTo(map)
                .bindPopup(locationName)
                .openPopup();
        }
    }

    // Get current location
    function getCurrentLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    locationInput.value = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
                    updateMap(lat, lng, 'Your Current Location');
                    getAddressFromCoordinates(lat, lng);
                },
                error => {
                    console.error('Error getting location:', error);
                    alert('Unable to get current location. Please enter manually.');
                }
            );
        } else {
            alert('Geolocation is not supported by this browser.');
        }
    }

    // Get address from coordinates
    function getAddressFromCoordinates(lat, lng) {
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`;
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data && data.display_name) {
                    locationInput.value = data.display_name;
                }
            })
            .catch(error => {
                console.error('Error getting address:', error);
            });
    }

    // Generate unique assessment ID based on disease detection
    async function generateAssessmentId() {
        // Check if an image has been uploaded
        if (!fileInput.files[0]) {
            alert('Please upload and analyze an image first to generate Assessment ID');
            return;
        }

        // Check if detection has been performed
        if (!currentDetections || currentDetections.length === 0) {
            alert('Please analyze an image first to generate Assessment ID');
            return;
        }

        try {
            // Determine disease type from detections
            const detectedDiseases = new Set();
            currentDetections.forEach(det => {
                if (det.confidence >= confidenceThreshold) {
                    detectedDiseases.add(det.model);
                }
            });

            let diseaseCode = diseaseCodes.unknown;
            if (detectedDiseases.has('ganoderma')) {
                diseaseCode = diseaseCodes.ganoderma;
            } else if (detectedDiseases.has('blackspot')) {
                diseaseCode = diseaseCodes.blackspot;
            } else if (detectedDiseases.size === 0) {
                diseaseCode = diseaseCodes.healthy;
            }

            // Generate timestamp component
            const now = new Date();
            const dateStr = now.toISOString().slice(2, 10).replace(/-/g, '');
            const timeStr = now.getHours().toString().padStart(2, '0') + 
                           now.getMinutes().toString().padStart(2, '0');

            // User initials (first letter of first name and last name)
            let userInitials = 'XX';
            if (userData) {
                const firstInitial = userData.firstName ? userData.firstName.charAt(0).toUpperCase() : 'U';
                const lastInitial = userData.lastName ? userData.lastName.charAt(0).toUpperCase() : 'S';
                userInitials = firstInitial + lastInitial;
            }

            // Generate base ID
            const baseId = `${diseaseCode}-${dateStr}-${userInitials}`;

            // Check for existing IDs and find a unique sequence number
            let sequence = 1;
            let isUnique = false;
            let maxAttempts = 100;

            while (!isUnique && sequence <= maxAttempts) {
                generatedAssessmentId = `${baseId}-${sequence.toString().padStart(3, '0')}`;
                
                // Check if this ID already exists in Firestore
                const assessmentsRef = collection(db, "assessments");
                const q = query(assessmentsRef, where("assessmentId", "==", generatedAssessmentId));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    isUnique = true;
                } else {
                    sequence++;
                }
            }

            if (!isUnique) {
                throw new Error('Could not generate unique Assessment ID');
            }

            // Update the input field
            assessmentId.value = generatedAssessmentId;
            updateAssessmentIdStatus(true, 'Unique Assessment ID generated');

        } catch (error) {
            console.error('Error generating Assessment ID:', error);
            // Fallback to random ID
            generatedAssessmentId = `ASS-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
            assessmentId.value = generatedAssessmentId;
            updateAssessmentIdStatus(true, 'Generated fallback ID');
        }
    }

    // Update assessment ID status display
    function updateAssessmentIdStatus(isValid, message) {
        assessmentIdStatus.textContent = message;
        if (isValid) {
            assessmentIdStatus.className = 'id-status valid';
        } else {
            assessmentIdStatus.className = 'id-status invalid';
        }
    }

    // Reset assessment ID status
    function resetAssessmentIdStatus() {
        assessmentId.value = '';
        assessmentIdStatus.textContent = 'Upload and analyze an image to generate Assessment ID';
        assessmentIdStatus.className = 'id-status info';
    }

    // Check if assessment ID already exists
    async function checkAssessmentIdExists(id) {
        try {
            const assessmentsRef = collection(db, "assessments");
            const q = query(assessmentsRef, where("assessmentId", "==", id));
            const querySnapshot = await getDocs(q);
            return !querySnapshot.empty;
        } catch (error) {
            console.error('Error checking assessment ID:', error);
            return false;
        }
    }

    // Update disease field based on detection results
    function updateDiseaseField(detections) {
        if (!detections || detections.length === 0) {
            diseaseInput.value = "No disease detected";
            diseaseInput.className = "form-input disease-input";
            return;
        }

        const uniqueDiseases = [...new Set(detections.map(detection => detection.class))];
        if (uniqueDiseases.length === 1) {
            diseaseInput.value = uniqueDiseases[0];
            diseaseInput.className = "form-input disease-input auto-detected";
        } else {
            diseaseInput.value = uniqueDiseases.join(", ");
            diseaseInput.className = "form-input disease-input auto-detected";
        }
    }

    // Update health status and treatment based on detection results
    function updateHealthStatus(detections) {
        const hasDisease = detections && detections.length > 0;

        if (hasDisease) {
            healthStatus.textContent = "Not Healthy";
            healthStatus.className = "health-status not-healthy";

            let treatment = "";
            let nextAssessmentDate = "";
            const today = new Date();

            const hasGanoderma = detections.some(d => d.model === 'ganoderma');
            const hasBlackspot = detections.some(d => d.model === 'blackspot');

            if (hasGanoderma) {
                treatment += "Ganoderma Treatment:\n";
                treatment += "- Remove and destroy infected plants\n";
                treatment += "- Apply fungicide treatment\n";
                treatment += "- Improve soil drainage\n";
                treatment += "- Avoid wounding plants\n\n";
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                nextAssessmentDate = tomorrow.toISOString().split('T')[0];
            }

            if (hasBlackspot) {
                treatment += "Blackspot Treatment:\n";
                treatment += "- Remove infected leaves\n";
                treatment += "- Apply fungicide spray\n";
                treatment += "- Improve air circulation\n";
                treatment += "- Water at the base, not on leaves\n\n";
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                nextAssessmentDate = tomorrow.toISOString().split('T')[0];
            }

            if (!hasGanoderma && !hasBlackspot) {
                treatment = "General Plant Disease Treatment:\n";
                treatment += "- Isolate affected plant\n";
                treatment += "- Apply broad-spectrum fungicide\n";
                treatment += "- Improve growing conditions\n";
                treatment += "- Monitor daily for changes\n";
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                nextAssessmentDate = tomorrow.toISOString().split('T')[0];
            }

            treatmentText.value = treatment;
            nextAssessment.value = nextAssessmentDate;
        } else {
            healthStatus.textContent = "Healthy";
            healthStatus.className = "health-status healthy";
            treatmentText.value = "No treatment needed. Plant appears healthy.";
            const today = new Date();
            const sixMonthsLater = new Date(today);
            sixMonthsLater.setMonth(sixMonthsLater.getMonth() + 6);
            nextAssessment.value = sixMonthsLater.toISOString().split('T')[0];
        }
    }

    // Function to update confidence threshold
    function updateConfidence(value) {
        confidenceThreshold = value / 100;
        confidenceValue.textContent = value + '%';
        if (originalImage && currentDetections.length > 0) {
            // Re-filter and display detections with new threshold
            const filteredDetections = currentDetections.filter(det => det.confidence >= confidenceThreshold);
            displayDetections(filteredDetections);
        }
    }

    // Function to set threshold based on disease type
    function setThresholdByDisease(diseaseType) {
        currentDiseaseType = diseaseType;
        if (diseaseType === 'ganoderma') {
            confidenceThreshold = models.ganoderma.defaultThreshold;
            confidenceSlider.value = models.ganoderma.defaultThreshold * 100;
            confidenceValue.textContent = Math.round(models.ganoderma.defaultThreshold * 100) + '%';
        } else if (diseaseType === 'blackspot') {
            confidenceThreshold = models.blackspot.defaultThreshold;
            confidenceSlider.value = models.blackspot.defaultThreshold * 100;
            confidenceValue.textContent = Math.round(models.blackspot.defaultThreshold * 100) + '%';
        }
    }

    // Function to open camera
    async function openCamera() {
        try {
            const constraints = { 
                video: { facingMode: 'environment' }
            };
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            cameraVideo.srcObject = stream;
            cameraContainer.style.display = 'flex';
        } catch (error) {
            console.error('Error accessing back camera:', error);
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                cameraVideo.srcObject = stream;
                cameraContainer.style.display = 'flex';
            } catch (fallbackError) {
                console.error('Fallback camera also failed:', fallbackError);
                alert('Unable to access camera. Please ensure you have granted camera permissions.');
            }
        }
    }

    // Function to close camera
    function closeCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
        cameraContainer.style.display = 'none';
    }

    // Function to capture image from camera
    function captureImage() {
        const tempCanvas = document.createElement('canvas');
        const tempContext = tempCanvas.getContext('2d');
        tempCanvas.width = cameraVideo.videoWidth;
        tempCanvas.height = cameraVideo.videoHeight;
        tempContext.drawImage(cameraVideo, 0, 0);

        tempCanvas.toBlob(function (blob) {
            const file = new File([blob], 'camera-capture.jpg', { type: 'image/jpeg' });
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
            processFileInput();
            closeCamera();
        }, 'image/jpeg');
    }

    // Function to process file input
    function processFileInput() {
        if (fileInput.files && fileInput.files[0]) {
            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
                originalImage = new Image();
                originalImage.onload = function () {
                    const containerWidth = imageContainer.clientWidth;
                    const containerHeight = imageContainer.clientHeight;
                    
                    // Calculate scaling to fit container
                    const scale = Math.min(
                        containerWidth / originalImage.width, 
                        containerHeight / originalImage.height, 
                        1
                    );
                    
                    previewCanvas.width = originalImage.width * scale;
                    previewCanvas.height = originalImage.height * scale;
                    canvasContext.drawImage(originalImage, 0, 0, previewCanvas.width, previewCanvas.height);
                    previewCanvas.style.display = 'block';
                    noImage.style.display = 'none';
                    currentDiseaseType = null;
                    
                    // Process the image for detection
                    performImageDetection(file);
                }
                originalImage.src = e.target.result;
            }
            reader.readAsDataURL(file);
        }
    }

    // Event listener for file input
    fileInput.addEventListener('change', processFileInput);

    // Add drag and drop functionality
    imageContainer.addEventListener('dragover', (e) => {
        e.preventDefault();
        imageContainer.style.borderColor = '#007bff';
        imageContainer.style.backgroundColor = '#e9ecef';
    });

    imageContainer.addEventListener('dragleave', (e) => {
        e.preventDefault();
        imageContainer.style.borderColor = '#dee2e6';
        imageContainer.style.backgroundColor = '#f8f9fa';
    });

    imageContainer.addEventListener('drop', (e) => {
        e.preventDefault();
        imageContainer.style.borderColor = '#dee2e6';
        imageContainer.style.backgroundColor = '#f8f9fa';
        
        if (e.dataTransfer.files.length) {
            fileInput.files = e.dataTransfer.files;
            processFileInput();
        }
    });

    // Main function to perform image detection
    async function performImageDetection(file) {
        if (!file) {
            alert('Please select an image first!');
            return;
        }

        loading.style.display = 'block';
        
        try {
            // Convert image to base64
            const base64Image = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });

            // Call all detection models
            const promises = Object.values(models).map(model =>
                axios({
                    method: "POST",
                    url: model.url,
                    params: { api_key: model.apiKey },
                    data: base64Image,
                    headers: { "Content-Type": "application/x-www-form-urlencoded" }
                })
            );

            const responses = await Promise.all(promises);
            
            // Combine all detection results
            let allDetections = [];
            responses.forEach((response, index) => {
                const modelKey = Object.keys(models)[index];
                if (response.data && response.data.predictions) {
                    const predictionsWithModel = response.data.predictions.map(pred => ({
                        ...pred,
                        model: modelKey,
                        modelName: models[modelKey].name
                    }));
                    allDetections.push(...predictionsWithModel);
                }
            });

            // Store all detections globally
            currentDetections = allDetections;
            
            // Auto-detect disease type and set threshold
            autoDetectDiseaseType(allDetections);
            
            // Filter by current threshold and display
            const filteredDetections = allDetections.filter(det => det.confidence >= confidenceThreshold);
            displayDetections(filteredDetections);

            // Auto-generate assessment ID based on detections
            generateAssessmentId();

        } catch (error) {
            console.error('Error during image detection:', error);
            alert('Error processing image: ' + error.message);
        } finally {
            loading.style.display = 'none';
        }
    }

    // Function to auto-detect disease type and set threshold
    function autoDetectDiseaseType(detections) {
        if (!detections || detections.length === 0) {
            currentDiseaseType = null;
            return;
        }

        const hasGanoderma = detections.some(pred =>
            pred.model === 'ganoderma' && pred.confidence >= models.ganoderma.defaultThreshold
        );
        const hasBlackspot = detections.some(pred =>
            pred.model === 'blackspot' && pred.confidence >= models.blackspot.defaultThreshold
        );

        if (hasGanoderma) {
            setThresholdByDisease('ganoderma');
        } else if (hasBlackspot) {
            setThresholdByDisease('blackspot');
        } else {
            currentDiseaseType = null;
        }
    }

    function displayDetections(filteredDetections) {
        clearDetections();
        
        if (!filteredDetections || filteredDetections.length === 0) {
            detectionsList.innerHTML = `<div style="text-align: center; color: #6c757d; padding: 20px;">No objects detected</div>`;
            objectsCount.textContent = '0 objects';
            updateDiseaseField([]);
            updateHealthStatus([]);
            return;
        }

        objectsCount.textContent = filteredDetections.length + ' objects';
        drawDetectionBoxes(filteredDetections);

        let detectionsHTML = '';
        filteredDetections.forEach((detection) => {
            const confidencePercent = Math.round(detection.confidence * 100);
            const modelConfig = models[detection.model];
            detectionsHTML += `
                <div class="detection-item" style="border-left-color: ${modelConfig.color}">
                    <span class="detection-class">
                        ${detection.class}
                        <span class="model-badge ${modelConfig.badgeClass}">${detection.model}</span>
                    </span>
                    <span class="detection-confidence" style="background: ${modelConfig.color}">${confidencePercent}%</span>
                </div>
            `;
        });

        detectionsList.innerHTML = detectionsHTML;
        updateDiseaseField(filteredDetections);
        updateHealthStatus(filteredDetections);
    }

    function drawDetectionBoxes(detections) {
        canvasContext.drawImage(originalImage, 0, 0, previewCanvas.width, previewCanvas.height);
        
        const scaleX = previewCanvas.width / originalImage.width;
        const scaleY = previewCanvas.height / originalImage.height;

        detections.forEach((detection) => {
            const confidencePercent = Math.round(detection.confidence * 100);
            const modelConfig = models[detection.model];
            const x = (detection.x - detection.width / 2) * scaleX;
            const y = (detection.y - detection.height / 2) * scaleY;
            const width = detection.width * scaleX;
            const height = detection.height * scaleY;

            canvasContext.strokeStyle = modelConfig.color;
            canvasContext.lineWidth = 3;
            canvasContext.strokeRect(x, y, width, height);

            canvasContext.fillStyle = modelConfig.color;
            const labelText = `${detection.class} (${detection.model}) ${confidencePercent}%`;
            const textMetrics = canvasContext.measureText(labelText);
            const textWidth = textMetrics.width + 10;
            const textHeight = 20;

            canvasContext.fillRect(x, y - textHeight, textWidth, textHeight);
            canvasContext.fillStyle = '#ffffff';
            canvasContext.font = 'bold 12px Arial';
            canvasContext.fillText(labelText, x + 5, y - 5);
        });
    }

    function clearDetections() {
        if (originalImage) {
            canvasContext.drawImage(originalImage, 0, 0, previewCanvas.width, previewCanvas.height);
        }
    }

    // Save assessment function with proper Firebase integration
    async function saveAssessment() {
        // Validate required fields
        if (!assessmentId.value) {
            alert('Please generate an Assessment ID first');
            return;
        }
        
        if (!locationInput.value) {
            alert('Please enter a location');
            return;
        }
        
        if (!fileInput.files[0]) {
            alert('Please upload an image first');
            return;
        }

        // Check if user is authenticated
        if (!currentUser) {
            alert('You must be logged in to save assessments');
            return;
        }

        // Double-check if Assessment ID already exists
        const idExists = await checkAssessmentIdExists(assessmentId.value);
        if (idExists) {
            alert('This Assessment ID already exists. Please regenerate a new one.');
            return;
        }

        try {
            // Convert image to base64 for storage
            const base64Image = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(fileInput.files[0]);
            });

            // Filter detections by current threshold
            const filteredDetections = currentDetections.filter(det => det.confidence >= confidenceThreshold);

            // Create assessment object with ALL detection data
            const assessment = {
                assessmentId: assessmentId.value,
                location: locationInput.value,
                date: assessmentDate.value,
                time: assessmentTime.value,
                disease: diseaseInput.value,
                healthStatus: healthStatus.textContent,
                treatment: treatmentText.value,
                nextAssessment: nextAssessment.value,
                detections: filteredDetections,
                detectionCount: filteredDetections.length,
                confidenceThreshold: confidenceThreshold,
                image: base64Image,
                userId: currentUser.uid,
                userEmail: currentUser.email,
                userName: userData?.firstName && userData?.lastName 
                    ? `${userData.firstName} ${userData.lastName}`
                    : userData?.username || currentUser.email.split('@')[0],
                timestamp: serverTimestamp(),
                createdAt: new Date().toISOString()
            };

            console.log('Saving assessment with detections:', assessment.detections);

            // Save to Firebase
            const docRef = await addDoc(collection(db, "assessments"), assessment);
            console.log("Assessment saved with ID: ", docRef.id);
            
            // Show success message
            alert('Assessment saved successfully with ID: ' + assessmentId.value);
            
            // Reset form
            resetForm();
            
        } catch (error) {
            console.error("Error saving assessment: ", error);
            alert('Error saving assessment: ' + error.message);
        }
    }

    // Reset form function
    function resetForm() {
        // Clear assessment ID
        resetAssessmentIdStatus();
        
        // Clear other fields
        locationInput.value = '';
        initializeDateTime();
        diseaseInput.value = '';
        diseaseInput.className = "form-input disease-input";
        healthStatus.textContent = "Not assessed";
        healthStatus.className = "health-status";
        treatmentText.value = '';
        nextAssessment.value = '';
        
        // Clear image and detections
        fileInput.value = '';
        previewCanvas.style.display = 'none';
        noImage.style.display = 'flex';
        detectionsList.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 20px;">No detections</div>';
        objectsCount.textContent = '0 objects';
        clearDetections();
        currentDetections = [];
    }

    // Initialize the application
    function init() {
        initializeDateTime();
        initializeMap();
        // DO NOT generate assessment ID on page load
        // Assessment ID will be generated after image analysis
    }

    // Initialize when page loads
    window.onload = init;

    // Make functions globally available
    window.openCamera = openCamera;
    window.closeCamera = closeCamera;
    window.captureImage = captureImage;
    window.getCurrentLocation = getCurrentLocation;
    window.updateConfidence = updateConfidence;
    window.saveAssessment = saveAssessment;
    window.performImageDetection = performImageDetection;
    window.generateAssessmentId = generateAssessmentId;
</script>
</body>
</html>