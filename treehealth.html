<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tree Health History | Palm Aegis</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/homepage.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="icon" href="images/logo1.png" type="image/png" sizes="32x32">
    <link rel="shortcut icon" href="images/logo1.png">
    <meta name="theme-color" content="#2e7d32">
    
    <style>
        :root {
            --primary-color: #2e7d32;
            --secondary-color: #388e3c;
            --danger-color: #d32f2f;
            --warning-color: #f57c00;
            --info-color: #0288d1;
            --light-bg: #f8f9fa;
            --border-color: #dee2e6;
            --text-primary: #212529;
            --text-secondary: #6c757d;
        }

        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
            height: 100vh;
            overflow: hidden;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin-left: 260px;
            background-color: #f5f5f5;
            height: 100vh;
        }

        .top-header {
            background: white;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-left h1 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.8rem;
            font-weight: 600;
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .search-box {
            position: relative;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
            background: white;
        }

        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: white;
            font-size: 14px;
            color: var(--text-primary);
            cursor: pointer;
            min-width: 150px;
            transition: all 0.3s;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
        }

        .refresh-btn {
            padding: 10px 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .content-wrapper {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
            border: 1px solid transparent;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            border-color: var(--primary-color);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .stat-info h3 {
            margin: 0 0 5px 0;
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .stat-value {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-trend {
            font-size: 12px;
            margin-top: 5px;
            font-weight: 600;
        }

        .trend-up {
            color: #28a745;
        }

        .trend-down {
            color: #dc3545;
        }

        .table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .table-header {
            background: var(--light-bg);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h2 {
            margin: 0;
            font-size: 18px;
            color: var(--text-primary);
            font-weight: 600;
        }

        .table-actions {
            display: flex;
            gap: 10px;
        }

        .export-btn {
            padding: 8px 15px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .export-btn:hover {
            background: var(--light-bg);
            border-color: var(--primary-color);
        }

        .table-wrapper {
            overflow-x: auto;
        }

        .assessments-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        .assessments-table th {
            background: var(--light-bg);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
        }

        .assessments-table td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
            color: var(--text-primary);
            vertical-align: middle;
        }

        .assessments-table tbody tr:hover {
            background: rgba(46, 125, 50, 0.04);
        }

        .assessments-table tbody tr:last-child td {
            border-bottom: none;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            min-width: 80px;
            text-align: center;
        }

        .status-healthy {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-not-healthy {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .disease-tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin: 2px;
        }

        .tag-ganoderma {
            background: #28a745;
            color: white;
        }

        .tag-blackspot {
            background: #dc3545;
            color: white;
        }

        .tag-unknown {
            background: #6c757d;
            color: white;
        }

        .detection-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: var(--info-color);
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: 600;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .view-btn, .delete-btn, .treatment-btn, .complete-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .view-btn {
            background: var(--primary-color);
            color: white;
        }

        .view-btn:hover {
            background: var(--secondary-color);
        }

        .delete-btn {
            background: #dc3545;
            color: white;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .treatment-btn {
            background: #f57c00;
            color: white;
        }

        .treatment-btn:hover {
            background: #e65100;
        }

        .complete-btn {
            background: #388e3c;
            color: white;
        }

        .complete-btn:hover {
            background: #2e7d32;
        }

        .no-data {
            text-align: center;
            padding: 50px 20px;
            color: var(--text-secondary);
        }

        .no-data i {
            font-size: 48px;
            margin-bottom: 20px;
            color: #dee2e6;
        }

        .no-data p {
            margin: 0 0 10px 0;
            font-size: 16px;
        }

        .no-data .subtext {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 20px;
            background: white;
            border-top: 1px solid var(--border-color);
        }

        .page-btn {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            background: white;
            color: var(--text-primary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .page-btn:hover:not(:disabled) {
            background: var(--light-bg);
            border-color: var(--primary-color);
        }

        .page-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-info {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--light-bg);
            border-radius: 12px 12px 0 0;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .close-modal:hover {
            background: rgba(0,0,0,0.1);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
        }

        .assessment-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .detail-group {
            margin-bottom: 15px;
        }

        .detail-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 5px;
            display: block;
        }

        .detail-value {
            font-size: 14px;
            color: var(--text-primary);
            word-break: break-word;
            padding: 8px 0;
        }

        .detections-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid var(--light-bg);
        }

        .detections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .detection-card {
            background: var(--light-bg);
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid var(--primary-color);
            transition: all 0.3s;
        }

        .detection-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .detection-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .detection-info {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        /* Treatment Modal Styles */
        .treatment-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
            transition: all 0.3s;
            background: white;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
            line-height: 1.5;
        }

        .treatment-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .treatment-type-card {
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            background: white;
        }

        .treatment-type-card:hover {
            border-color: var(--primary-color);
            background-color: rgba(46, 125, 50, 0.05);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .treatment-type-card.selected {
            border-color: var(--primary-color);
            background-color: rgba(46, 125, 50, 0.1);
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.2);
        }

        .treatment-type-icon {
            font-size: 28px;
            margin-bottom: 12px;
            color: var(--primary-color);
        }

        .treatment-type-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-size: 16px;
        }

        .treatment-type-desc {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .treatment-history {
            margin-top: 30px;
            border-top: 2px solid var(--light-bg);
            padding-top: 20px;
        }

        .history-item {
            background: var(--light-bg);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
            transition: all 0.3s;
        }

        .history-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .history-type {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 15px;
        }

        .history-date {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .history-details {
            font-size: 13px;
            color: var(--text-primary);
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .history-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .edit-btn, .remove-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .edit-btn {
            background: var(--primary-color);
            color: white;
        }

        .edit-btn:hover {
            background: var(--secondary-color);
        }

        .remove-btn {
            background: #dc3545;
            color: white;
        }

        .remove-btn:hover {
            background: #c82333;
        }

        .submit-btn {
            padding: 12px 24px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            align-self: flex-start;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .submit-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .treatment-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            min-width: 90px;
            text-align: center;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-inprogress {
            background: #cce5ff;
            color: #004085;
            border: 1px solid #b8daff;
        }

        /* New styles for treatment suggestions */
        .treatment-suggestions {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .treatment-suggestions.active {
            display: block;
        }

        .suggestion-header {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
        }

        .suggestion-header i {
            color: var(--primary-color);
        }

        .suggestion-list {
            margin: 0;
            padding-left: 20px;
        }

        .suggestion-list li {
            margin-bottom: 10px;
            font-size: 14px;
            color: var(--text-primary);
            line-height: 1.5;
            position: relative;
        }

        .suggestion-list li:before {
            content: "•";
            color: var(--primary-color);
            font-weight: bold;
            display: inline-block;
            width: 1em;
            margin-left: -1em;
        }

        .suggestion-category {
            font-weight: 600;
            color: var(--primary-color);
            margin-top: 15px;
            margin-bottom: 10px;
            display: block;
            font-size: 14px;
            padding-top: 10px;
            border-top: 1px dashed var(--border-color);
        }

        .suggestion-category:first-child {
            border-top: none;
            padding-top: 0;
        }

        .recommendation-note {
            font-size: 13px;
            color: var(--text-secondary);
            font-style: italic;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed var(--border-color);
            line-height: 1.5;
        }

        .recommendation-note i {
            color: #ffc107;
            margin-right: 8px;
        }

        .treatment-details-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #1976d2;
        }

        .details-title {
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
        }

        .details-content {
            font-size: 14px;
            color: #1976d2;
            line-height: 1.6;
        }

        .form-hint {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 8px;
            font-style: italic;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .form-hint i {
            font-size: 12px;
        }

        .disease-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            margin: 0 5px 5px 0;
        }

        .badge-ganoderma {
            background: #28a745;
            color: white;
        }

        .badge-blackspot {
            background: #dc3545;
            color: white;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-content {
                margin-left: 0;
            }
            
            .dashboard-container {
                flex-direction: column;
            }
        }

        @media (max-width: 768px) {
            .top-header {
                flex-direction: column;
                align-items: stretch;
            }

            .header-controls {
                flex-direction: column;
            }

            .search-box {
                min-width: 100%;
            }

            .filter-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-select {
                width: 100%;
            }

            .stats-cards {
                grid-template-columns: 1fr;
            }

            .assessment-details {
                grid-template-columns: 1fr;
            }

            .assessments-table {
                min-width: 1000px;
            }

            .form-row {
                flex-direction: column;
            }

            .treatment-type-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 576px) {
            .content-wrapper {
                padding: 15px;
            }

            .top-header {
                padding: 15px;
            }

            .table-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .table-actions {
                justify-content: center;
            }

            .action-buttons {
                flex-direction: column;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-icon {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            
            .stat-value {
                font-size: 20px;
            }

            .modal-content {
                width: 95%;
                margin: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .content-wrapper {
                padding: 10px;
            }
            
            .top-header {
                padding: 12px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .modal-header {
                padding: 15px;
            }
            
            .modal-body {
                padding: 15px;
            }
        }

        /* Custom scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Loading animation */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div id="sidebarPlaceholder"></div>
        <script src="js/sidebar-loader.js"></script>

        <main class="main-content">
            <div class="top-header">
                <div class="header-left">
                    <h1>Tree Health History</h1>
                </div>
                <div class="header-controls">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Search assessments...">
                    </div>
                    <div class="filter-controls">
                        <select id="statusFilter" class="filter-select">
                            <option value="">All Status</option>
                            <option value="Healthy">Healthy</option>
                            <option value="Not Healthy">Not Healthy</option>
                        </select>
                        <select id="diseaseFilter" class="filter-select">
                            <option value="">All Diseases</option>
                            <option value="Ganoderma">Ganoderma</option>
                            <option value="Blackspot">Blackspot</option>
                            <option value="Multiple">Multiple</option>
                        </select>
                        <button class="refresh-btn" onclick="loadAssessments()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
            </div>

            <div class="content-wrapper">
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #e3f2fd; color: #1976d2;">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Total Assessments</h3>
                            <p class="stat-value" id="totalAssessments">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #e8f5e9; color: #2e7d32;">
                            <i class="fas fa-heart"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Healthy Trees</h3>
                            <p class="stat-value" id="healthyCount">0</p>
                            <p class="stat-trend trend-up" id="healthyPercentage">0%</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #ffebee; color: #d32f2f;">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Disease Cases</h3>
                            <p class="stat-value" id="diseaseCount">0</p>
                            <p class="stat-trend trend-down" id="diseasePercentage">0%</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #fff3e0; color: #f57c00;">
                            <i class="fas fa-medkit"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Active Treatments</h3>
                            <p class="stat-value" id="activeTreatments">0</p>
                            <p class="stat-trend">Ongoing</p>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <h2>Assessment Records</h2>
                        <div class="table-actions">
                            <button class="export-btn" onclick="exportToCSV()">
                                <i class="fas fa-download"></i> Export CSV
                            </button>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table class="assessments-table" id="assessmentsTable">
                            <thead>
                                <tr>
                                    <th>Assessment ID</th>
                                    <th>Date & Time</th>
                                    <th>Location</th>
                                    <th>Disease Detected</th>
                                    <th>Detections</th>
                                    <th>Health Status</th>
                                    <th>Treatment Status</th>
                                    <th>Next Assessment</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="no-data" id="noDataMessage" style="display: none;">
                        <i class="fas fa-inbox"></i>
                        <p>No assessment records found</p>
                        <p class="subtext">Start by creating assessments in the Disease Detection page</p>
                        <a href="farmassessment.html" class="refresh-btn" style="margin-top: 15px;">
                            <i class="fas fa-plus"></i> Create Assessment
                        </a>
                    </div>
                    <div class="pagination" id="pagination" style="display: none;">
                        <button class="page-btn" onclick="changePage(-1)" id="prevBtn" disabled>
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <span class="page-info" id="pageInfo">Page 1 of 1</span>
                        <button class="page-btn" onclick="changePage(1)" id="nextBtn" disabled>
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Assessment Detail Modal -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Assessment Details</h3>
                <button class="close-modal" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Treatment Management Modal -->
    <div class="modal" id="treatmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Manage Treatment</h3>
                <button class="close-modal" onclick="closeTreatmentModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="treatmentModalBody">
                <!-- Treatment form will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, query, where, orderBy, deleteDoc, doc, updateDoc, arrayUnion, arrayRemove } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAf-wtZpl8wVjCymdLlC-YGlv7xn0yEMMU",
            authDomain: "palmaegis-setup.firebaseapp.com",
            projectId: "palmaegis-setup",
            storageBucket: "palmaegis-setup.firebasestorage.app",
            messagingSenderId: "445887502374",
            appId: "1:445887502374:web:a5f6ecaa90b88447626ee7"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let assessments = [];
        let filteredAssessments = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let selectedAssessmentId = null;
        let isEditingTreatment = false;
        let editingTreatmentIndex = -1;

        onAuthStateChanged(auth, (user) => {
    if (user) {
        currentUser = user;
        window.currentUser = user; // Make available globally
        
        // Force sidebar update if it's already loaded
        if (window.updateSidebarProfile) {
            window.updateSidebarProfile();
        }
        
        console.log('User authenticated:', user.email);
        loadAssessments();
    } else {
        console.log('User not authenticated');
        window.location.href = 'signin.html';
    }
});

        // Enhanced treatment types with detailed information and suggestions
        const treatmentTypes = {
            racun: {
                name: 'Racun (Pesticide)',
                icon: 'fas fa-skull-crossbones',
                description: 'Chemical treatment for pest and disease control',
                suggestions: {
                    ganoderma: [
                        'Systemic Fungicides: Use propiconazole (Tilt, Banner Maxx) at 15-20ml per liter for trunk injection',
                        'Contact Fungicides: Apply copper oxychloride (Blitox) at 3g per liter as foliar spray',
                        'Soil Treatment: Use hexaconazole (Contaf, Anvil) at 2ml per liter for soil drenching around root zone',
                        'Preventive Treatment: Phosphonic acid compounds (Agri-Fos) at 2.5ml per liter every 3 months'
                    ],
                    blackspot: [
                        'Protective Fungicides: Mancozeb (Dithane M-45) at 2g per liter weekly during wet season',
                        'Systemic Fungicides: Azoxystrobin (Amistar) at 0.5ml per liter every 14 days',
                        'Curative Treatment: Tebuconazole (Folicur) at 1ml per liter for active infections',
                        'Multi-site Fungicides: Chlorothalonil (Bravo) at 2ml per liter for broad-spectrum protection'
                    ],
                    general: [
                        'Application Timing: Apply during early morning or late evening to avoid sun exposure',
                        'Mixing Instructions: Always add pesticides to water, not water to pesticides',
                        'Safety Equipment: Use gloves, mask, goggles, and protective clothing during application',
                        'Weather Conditions: Avoid application before rain or during strong winds (>15 km/h)',
                        'Equipment Cleaning: Thoroughly clean sprayers after each use to prevent cross-contamination'
                    ]
                },
                details: 'Pesticides are chemical substances used to control, prevent, or eliminate pests and diseases. They work by disrupting the biological processes of target organisms. For palm trees, proper dosage and application timing are critical for effectiveness while minimizing environmental impact.',
                durationHint: 'Typical duration: 7-14 days per application cycle',
                reassessmentHint: 'Re-assess 7 days after application to check effectiveness'
            },
            penjagaan: {
                name: 'Penjagaan (Care)',
                icon: 'fas fa-hands-helping',
                description: 'Cultural practices and maintenance procedures',
                suggestions: {
                    ganoderma: [
                        'Sanitation Protocol: Remove and burn infected plant material immediately. Sterilize tools with 70% alcohol between trees',
                        'Pruning Technique: Cut infected fronds 30-50cm below visible symptoms. Make clean cuts at 45° angle',
                        'Water Management: Implement drainage channels to prevent waterlogging. Maintain soil moisture at 60-70% field capacity',
                        'Isolation Procedure: Create 3-meter buffer zones around infected trees. Mark with red warning tape',
                        'Monitoring Schedule: Weekly inspections during rainy season, bi-weekly during dry season'
                    ],
                    blackspot: [
                        'Pruning Strategy: Remove infected leaves with sterilized shears. Maintain proper spacing (8-10m between trees)',
                        'Irrigation Method: Use drip irrigation to avoid wetting foliage. Water at soil level only',
                        'Mulching Practice: Apply 10-15cm layer of organic mulch (coconut husk, empty fruit bunches) around base',
                        'Sanitation Routine: Collect and destroy fallen infected leaves. Clean debris from crown region',
                        'Air Circulation: Prune lower leaves to improve airflow through canopy'
                    ],
                    general: [
                        'Inspection Frequency: Visual inspections every 2 weeks during growing season',
                        'Record Keeping: Document all observations including weather conditions and tree responses',
                        'Tool Maintenance: Regularly sharpen and sterilize pruning tools',
                        'Worker Training: Ensure all personnel understand disease symptoms and prevention measures',
                        'Environmental Monitoring: Track rainfall, temperature, and humidity patterns'
                    ]
                },
                details: 'Cultural practices focus on preventing disease spread through proper maintenance, sanitation, and environmental management. These methods are sustainable, cost-effective, and reduce reliance on chemicals. Regular monitoring and timely interventions are key components of effective cultural control.',
                durationHint: 'Ongoing - implement as regular maintenance schedule',
                reassessmentHint: 'Monitor progress weekly and adjust practices as needed'
            },
            baja: {
                name: 'Baja (Fertilizer)',
                icon: 'fas fa-seedling',
                description: 'Nutrient management and soil amendment',
                suggestions: {
                    ganoderma: [
                        'Potassium Boost: Apply muriate of potash (MOP) at 1.5-2kg per tree quarterly to strengthen cell walls',
                        'Calcium Supplement: Use calcium nitrate at 500g per tree monthly to improve disease resistance',
                        'Silicon Fertilizer: Apply potassium silicate at 200g per tree every 2 months for structural strength',
                        'Nutrition Balance: Reduce nitrogen (avoid urea) to limit soft growth vulnerable to infection',
                        'Organic Amendments: Incorporate palm oil mill effluent (POME) compost at 20kg per tree annually'
                    ],
                    blackspot: [
                        'Balanced Nutrition: Apply NPK 12:12:17+2MgO at 2-3kg per tree every 4 months',
                        'Micronutrient Package: Include zinc sulfate (100g), manganese sulfate (50g), and boron (20g) per tree',
                        'Organic Matter: Incorporate well-decomposed EFB compost at 15-20kg per tree semi-annually',
                        'Slow-Release Formulation: Use controlled-release fertilizers for consistent nutrient availability',
                        'Foliar Feeding: Apply micronutrient sprays (especially magnesium and zinc) during recovery phase'
                    ],
                    general: [
                        'Soil Testing: Conduct soil analysis every 6 months to determine exact nutrient requirements',
                        'Application Timing: Fertilize during active growth periods (typically rainy season)',
                        'Application Method: Broadcast within drip line and incorporate lightly into soil',
                        'Moisture Management: Water thoroughly after fertilizer application to aid absorption',
                        '4R Nutrient Stewardship: Right source, Right rate, Right time, Right place'
                    ]
                },
                details: 'Fertilizers provide essential nutrients to improve tree health, strengthen natural defenses, and promote recovery from disease stress. Balanced nutrition enhances the tree\'s ability to resist and recover from infections. Soil amendments improve soil structure and microbial activity, creating unfavorable conditions for pathogens.',
                durationHint: '30-60 days for visible improvement, continue quarterly',
                reassessmentHint: 'Re-assess nutrient status and tree response after 30 days'
            }
        };

        // Check authentication state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                console.log('User authenticated:', user.email);
                loadAssessments();
            } else {
                console.log('User not authenticated');
                window.location.href = 'signin.html';
            }
        });

        // Load assessments from Firestore
        async function loadAssessments() {
            try {
                if (!currentUser) {
                    console.error('No user logged in');
                    return;
                }

                console.log('Loading assessments for user:', currentUser.uid);
                
                const assessmentsRef = collection(db, "assessments");
                const q = query(
                    assessmentsRef,
                    where("userId", "==", currentUser.uid)
                );

                const querySnapshot = await getDocs(q);
                console.log(`Found ${querySnapshot.size} assessments`);
                
                assessments = [];
                
                if (querySnapshot.size === 0) {
                    console.log('No assessments found for this user');
                    showNoDataMessage();
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    // Handle different timestamp formats
                    let dateObj;
                    if (data.createdAt) {
                        dateObj = new Date(data.createdAt);
                    } else if (data.timestamp && typeof data.timestamp === 'string') {
                        dateObj = new Date(data.timestamp);
                    } else if (data.timestamp && data.timestamp.toDate) {
                        dateObj = data.timestamp.toDate();
                    } else {
                        dateObj = new Date();
                    }
                    
                    assessments.push({
                        id: doc.id,
                        ...data,
                        dateObj: dateObj,
                        treatments: data.treatments || [],
                        treatmentStatus: data.treatmentStatus || 'No Treatment'
                    });
                });

                console.log(`Loaded ${assessments.length} assessments`);
                
                // Sort manually by date (newest first)
                assessments.sort((a, b) => b.dateObj - a.dateObj);
                
                updateStatistics();
                filterAssessments();
                renderTable();
            } catch (error) {
                console.error("Error loading assessments:", error);
                showNoDataMessage();
            }
        }

        // Update statistics
        function updateStatistics() {
            const total = assessments.length;
            const healthy = assessments.filter(a => a.healthStatus === "Healthy").length;
            const disease = assessments.filter(a => a.healthStatus === "Not Healthy").length;
            const activeTreatments = assessments.filter(a => {
                return a.treatments && a.treatments.some(t => t.status === 'inprogress' || t.status === 'pending');
            }).length;

            document.getElementById('totalAssessments').textContent = total;
            document.getElementById('healthyCount').textContent = healthy;
            document.getElementById('diseaseCount').textContent = disease;
            document.getElementById('activeTreatments').textContent = activeTreatments;
            
            if (total > 0) {
                document.getElementById('healthyPercentage').textContent = `${Math.round((healthy / total) * 100)}%`;
                document.getElementById('diseasePercentage').textContent = `${Math.round((disease / total) * 100)}%`;
            } else {
                document.getElementById('healthyPercentage').textContent = '0%';
                document.getElementById('diseasePercentage').textContent = '0%';
            }
        }

        // Filter assessments based on search and filters
        function filterAssessments() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const diseaseFilter = document.getElementById('diseaseFilter').value;

            filteredAssessments = assessments.filter(assessment => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    (assessment.assessmentId && assessment.assessmentId.toLowerCase().includes(searchTerm)) ||
                    (assessment.location && assessment.location.toLowerCase().includes(searchTerm)) ||
                    (assessment.disease && assessment.disease.toLowerCase().includes(searchTerm));

                // Status filter
                const matchesStatus = !statusFilter || assessment.healthStatus === statusFilter;

                // Disease filter
                let matchesDisease = true;
                if (diseaseFilter) {
                    if (!assessment.disease) {
                        matchesDisease = false;
                    } else if (diseaseFilter === "Multiple") {
                        matchesDisease = assessment.disease.includes(",") || 
                                       (assessment.detectionCount && assessment.detectionCount > 1);
                    } else {
                        matchesDisease = assessment.disease.toLowerCase().includes(diseaseFilter.toLowerCase());
                    }
                }

                return matchesSearch && matchesStatus && matchesDisease;
            });

            currentPage = 1;
            console.log(`Filtered to ${filteredAssessments.length} assessments`);
        }

        // Render table with pagination
        function renderTable() {
            const tableBody = document.getElementById('tableBody');
            const noDataMessage = document.getElementById('noDataMessage');
            const pagination = document.getElementById('pagination');

            if (filteredAssessments.length === 0) {
                tableBody.innerHTML = '';
                noDataMessage.style.display = 'block';
                pagination.style.display = 'none';
                return;
            }

            noDataMessage.style.display = 'none';
            pagination.style.display = 'flex';

            // Calculate pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageAssessments = filteredAssessments.slice(startIndex, endIndex);

            // Render table rows
            tableBody.innerHTML = pageAssessments.map(assessment => {
                const date = assessment.dateObj;
                const formattedDate = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                const formattedTime = date.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true 
                });

                // Create disease tags
                let diseaseTags = '<span class="disease-tag tag-unknown">None</span>';
                if (assessment.disease && assessment.disease !== "No disease detected") {
                    const diseases = assessment.disease.split(', ').map(disease => {
                        const tagClass = disease.includes('Ganoderma') ? 'tag-ganoderma' :
                                       disease.includes('Blackspot') ? 'tag-blackspot' : 'tag-unknown';
                        return `<span class="disease-tag ${tagClass}">${disease.trim()}</span>`;
                    }).join('');
                    diseaseTags = diseases;
                }

                // Detection count badge
                const detectionCount = assessment.detectionCount || 0;

                // Treatment status
                let treatmentStatus = 'No Treatment';
                let statusClass = 'status-pending';
                let activeTreatmentCount = 0;
                
                if (assessment.treatments && assessment.treatments.length > 0) {
                    const activeTreatment = assessment.treatments.find(t => 
                        t.status === 'inprogress' || t.status === 'pending'
                    );
                    
                    activeTreatmentCount = assessment.treatments.filter(t => 
                        t.status === 'inprogress' || t.status === 'pending'
                    ).length;
                    
                    if (activeTreatment) {
                        treatmentStatus = 'In Progress';
                        statusClass = 'status-inprogress';
                    } else if (assessment.treatments.some(t => t.status === 'completed')) {
                        treatmentStatus = 'Completed';
                        statusClass = 'status-completed';
                    } else {
                        treatmentStatus = 'Pending';
                        statusClass = 'status-pending';
                    }
                }

                // Count completed treatments
                const completedTreatmentCount = assessment.treatments ? 
                    assessment.treatments.filter(t => t.status === 'completed').length : 0;

                return `
                    <tr>
                        <td>
                            <strong>${assessment.assessmentId || 'N/A'}</strong><br>
                            <small style="color: #666;">By: ${assessment.userName || 'Unknown'}</small>
                        </td>
                        <td>
                            ${formattedDate}<br>
                            <small style="color: #666;">${formattedTime}</small>
                        </td>
                        <td>${assessment.location || 'Not specified'}</td>
                        <td>${diseaseTags}</td>
                        <td>
                            <span class="detection-count">${detectionCount}</span>
                        </td>
                        <td>
                            <span class="status-badge ${assessment.healthStatus === 'Healthy' ? 'status-healthy' : 'status-not-healthy'}">
                                ${assessment.healthStatus || 'Unknown'}
                            </span>
                        </td>
                        <td>
                            <span class="treatment-status ${statusClass}">${treatmentStatus}</span>
                            ${activeTreatmentCount > 0 ? `
                                <div style="margin-top: 4px;">
                                    <small style="color: #666; font-size: 11px;">
                                        <i class="fas fa-running"></i> ${activeTreatmentCount} active
                                        ${completedTreatmentCount > 0 ? ` | <i class="fas fa-check"></i> ${completedTreatmentCount} completed` : ''}
                                    </small>
                                </div>
                            ` : completedTreatmentCount > 0 ? `
                                <div style="margin-top: 4px;">
                                    <small style="color: #666; font-size: 11px;">
                                        <i class="fas fa-check"></i> ${completedTreatmentCount} completed
                                    </small>
                                </div>
                            ` : ''}
                        </td>
                        <td>${assessment.nextAssessment || 'Not scheduled'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="view-btn" onclick="viewAssessment('${assessment.id}')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="treatment-btn" onclick="manageTreatment('${assessment.id}')">
                                    <i class="fas fa-medkit"></i> Treatment
                                </button>
                                ${activeTreatmentCount > 0 ? `
                                <button class="complete-btn" onclick="completeTreatment('${assessment.id}')">
                                    <i class="fas fa-check"></i> Complete
                                </button>
                                ` : ''}
                                <button class="delete-btn" onclick="deleteAssessment('${assessment.id}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // Update pagination controls
            updatePaginationControls();
        }

        // Update pagination controls
        function updatePaginationControls() {
            const totalPages = Math.ceil(filteredAssessments.length / itemsPerPage);
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages || totalPages === 0;
        }

        // Change page
        function changePage(direction) {
            const newPage = currentPage + direction;
            const totalPages = Math.ceil(filteredAssessments.length / itemsPerPage);
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderTable();
            }
        }

        // View assessment details
        async function viewAssessment(assessmentId) {
            try {
                const assessment = assessments.find(a => a.id === assessmentId);
                if (!assessment) {
                    console.error('Assessment not found:', assessmentId);
                    return;
                }

                const modalBody = document.getElementById('modalBody');
                const date = assessment.dateObj;
                const formattedDateTime = date.toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });

                // Format disease tags
                let diseaseTags = 'None detected';
                if (assessment.disease && assessment.disease !== "No disease detected") {
                    diseaseTags = assessment.disease.split(', ').map(disease => {
                        const tagClass = disease.includes('Ganoderma') ? 'tag-ganoderma' :
                                       disease.includes('Blackspot') ? 'tag-blackspot' : 'tag-unknown';
                        return `<span class="disease-tag ${tagClass}">${disease.trim()}</span>`;
                    }).join(' ');
                }

                // Create detection details
                let detectionDetails = '<p>No detection data available</p>';
                if (assessment.detections && assessment.detections.length > 0) {
                    detectionDetails = assessment.detections.map(det => {
                        const confidencePercent = Math.round((det.confidence || 0) * 100);
                        const borderColor = det.model === 'ganoderma' ? '#28a745' : 
                                          det.model === 'blackspot' ? '#dc3545' : '#0288d1';
                        
                        return `
                            <div class="detection-card" style="border-left-color: ${borderColor}">
                                <div class="detection-title">${det.class || 'Unknown'}</div>
                                <div class="detection-info"><strong>Model:</strong> ${det.model || 'Unknown'}</div>
                                <div class="detection-info"><strong>Confidence:</strong> ${confidencePercent}%</div>
                                <div class="detection-info"><strong>Coordinates:</strong> X: ${Math.round(det.x || 0)}, Y: ${Math.round(det.y || 0)}</div>
                                <div class="detection-info"><strong>Size:</strong> ${Math.round(det.width || 0)} × ${Math.round(det.height || 0)}</div>
                            </div>
                        `;
                    }).join('');
                }

                // Create treatment history
                let treatmentHistory = '<p>No treatment history available</p>';
                if (assessment.treatments && assessment.treatments.length > 0) {
                    treatmentHistory = assessment.treatments.map(treatment => {
                        const startDate = new Date(treatment.startDate).toLocaleDateString();
                        const endDate = treatment.endDate ? new Date(treatment.endDate).toLocaleDateString() : 'Ongoing';
                        const statusClass = treatment.status === 'completed' ? 'status-completed' :
                                          treatment.status === 'inprogress' ? 'status-inprogress' : 'status-pending';
                        
                        // Show treatment type with icon
                        const treatmentType = treatmentTypes[treatment.type];
                        const typeIcon = treatmentType ? `<i class="${treatmentType.icon}"></i>` : '';
                        const typeName = treatmentType ? treatmentType.name : treatment.type;
                        
                        return `
                            <div class="history-item">
                                <div class="history-header">
                                    <span class="history-type">${typeIcon} ${typeName}</span>
                                    <span class="treatment-status ${statusClass}">${treatment.status.charAt(0).toUpperCase() + treatment.status.slice(1)}</span>
                                </div>
                                <div class="history-details">
                                    <p><strong>Duration:</strong> ${treatment.duration} ${treatment.durationUnit}</p>
                                    <p><strong>Start Date:</strong> ${startDate}</p>
                                    <p><strong>End Date:</strong> ${endDate}</p>
                                    <p><strong>Re-assessment Date:</strong> ${treatment.reassessmentDate ? new Date(treatment.reassessmentDate).toLocaleDateString() : 'Not set'}</p>
                                    <p><strong>Notes:</strong> ${treatment.notes || 'No notes'}</p>
                                    ${treatment.createdByName ? `<p><strong>Created by:</strong> ${treatment.createdByName} on ${new Date(treatment.createdAt).toLocaleDateString()}</p>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                modalBody.innerHTML = `
                    <div class="assessment-details">
                        <div class="detail-group">
                            <span class="detail-label">Assessment ID</span>
                            <span class="detail-value">${assessment.assessmentId || 'N/A'}</span>
                        </div>
                        <div class="detail-group">
                            <span class="detail-label">Date & Time</span>
                            <span class="detail-value">${formattedDateTime}</span>
                        </div>
                        <div class="detail-group">
                            <span class="detail-label">Location</span>
                            <span class="detail-value">${assessment.location || 'Not specified'}</span>
                        </div>
                        <div class="detail-group">
                            <span class="detail-label">Detected Diseases</span>
                            <span class="detail-value">${diseaseTags}</span>
                        </div>
                        <div class="detail-group">
                            <span class="detail-label">Health Status</span>
                            <span class="detail-value">
                                <span class="status-badge ${assessment.healthStatus === 'Healthy' ? 'status-healthy' : 'status-not-healthy'}">
                                    ${assessment.healthStatus || 'Unknown'}
                                </span>
                            </span>
                        </div>
                        <div class="detail-group">
                            <span class="detail-label">Detection Count</span>
                            <span class="detail-value">${assessment.detectionCount || 0}</span>
                        </div>
                        <div class="detail-group">
                            <span class="detail-label">Confidence Threshold</span>
                            <span class="detail-value">${Math.round((assessment.confidenceThreshold || 0) * 100)}%</span>
                        </div>
                        <div class="detail-group">
                            <span class="detail-label">Next Assessment</span>
                            <span class="detail-value">${assessment.nextAssessment || 'Not scheduled'}</span>
                        </div>
                    </div>

                    <div class="detections-section">
                        <h4>Detection Details (${assessment.detectionCount || 0})</h4>
                        <div class="detections-grid" id="detectionsGrid">
                            ${detectionDetails}
                        </div>
                    </div>

                    <div class="treatment-history">
                        <h4>Treatment History (${assessment.treatments?.length || 0})</h4>
                        ${treatmentHistory}
                    </div>

                    ${assessment.image ? `
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--light-bg);">
                        <h4>Captured Image</h4>
                        <div style="text-align: center; margin-top: 15px;">
                            <img src="${assessment.image}" 
                                 alt="Assessment Image" 
                                 style="max-width: 100%; max-height: 300px; border-radius: 8px; border: 1px solid #dee2e6; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        </div>
                    </div>
                    ` : ''}
                `;

                document.getElementById('detailModal').style.display = 'flex';
            } catch (error) {
                console.error('Error loading assessment details:', error);
                alert('Error loading assessment details');
            }
        }

        // Manage treatment
        async function manageTreatment(assessmentId) {
            selectedAssessmentId = assessmentId;
            const assessment = assessments.find(a => a.id === assessmentId);
            
            if (!assessment) {
                alert('Assessment not found');
                return;
            }

            // Reset edit mode
            isEditingTreatment = false;
            editingTreatmentIndex = -1;

            const modalBody = document.getElementById('treatmentModalBody');
            
            // Detect disease type for suggestions
            let detectedDiseases = [];
            if (assessment.disease && assessment.disease !== "No disease detected") {
                if (assessment.disease.toLowerCase().includes('ganoderma')) {
                    detectedDiseases.push('Ganoderma');
                }
                if (assessment.disease.toLowerCase().includes('blackspot')) {
                    detectedDiseases.push('Blackspot');
                }
            }
            
            const diseaseBadges = detectedDiseases.map(disease => 
                `<span class="disease-badge ${disease === 'Ganoderma' ? 'badge-ganoderma' : 'badge-blackspot'}">${disease}</span>`
            ).join('');
            
            modalBody.innerHTML = `
                <div class="treatment-form">
                    <h4>Add New Treatment</h4>
                    
                    ${detectedDiseases.length > 0 ? `
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">Detected Diseases:</div>
                            ${diseaseBadges}
                        </div>
                    ` : ''}
                    
                    <div class="treatment-type-grid">
                        ${Object.entries(treatmentTypes).map(([key, type]) => `
                            <div class="treatment-type-card" onclick="selectTreatmentType('${key}', '${assessmentId}')" id="type-${key}">
                                <div class="treatment-type-icon">
                                    <i class="${type.icon}"></i>
                                </div>
                                <div class="treatment-type-title">${type.name}</div>
                                <div class="treatment-type-desc">${type.description}</div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <input type="hidden" id="selectedTreatmentType" value="">
                    
                    <!-- Treatment Suggestions Section -->
                    <div id="treatmentSuggestions" class="treatment-suggestions">
                        <!-- Suggestions will be displayed here -->
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="startDate">Start Date</label>
                            <input type="date" id="startDate" class="form-input" value="${new Date().toISOString().split('T')[0]}">
                            <div class="form-hint">
                                <i class="fas fa-calendar-alt"></i> Best to start treatment immediately after detection
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="duration">Duration</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="number" id="duration" class="form-input" placeholder="Duration" min="1" value="7">
                                <select id="durationUnit" class="form-select" style="flex: 1;">
                                    <option value="days">Days</option>
                                    <option value="weeks">Weeks</option>
                                    <option value="months">Months</option>
                                </select>
                            </div>
                            <div class="form-hint" id="durationHint">
                                <i class="fas fa-clock"></i> Select treatment type for specific duration recommendation
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="reassessmentDate">Re-assessment Date</label>
                            <input type="date" id="reassessmentDate" class="form-input">
                            <div class="form-hint" id="reassessmentHint">
                                <i class="fas fa-calendar-check"></i> Schedule follow-up to monitor treatment effectiveness
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="status">Status</label>
                            <select id="status" class="form-select">
                                <option value="pending">Pending</option>
                                <option value="inprogress" selected>In Progress</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="notes">Treatment Notes</label>
                        <textarea id="notes" class="form-textarea" placeholder="Enter specific details: Product name, dosage, application method, weather conditions, observations..."></textarea>
                        <div class="form-hint">
                            <i class="fas fa-sticky-note"></i> Include: Product used, concentration, application rate, and any observed effects
                        </div>
                    </div>
                    
                    <button class="submit-btn" onclick="saveTreatment()" id="saveTreatmentBtn">
                        <i class="fas fa-save"></i> Save Treatment
                    </button>
                    
                    <div class="treatment-history" style="margin-top: 30px;">
                        <h4>Treatment History (${assessment.treatments?.length || 0})</h4>
                        <div id="treatmentHistoryList">
                            ${assessment.treatments && assessment.treatments.length > 0 ? 
                                assessment.treatments.map((treatment, index) => {
                                    const treatmentType = treatmentTypes[treatment.type];
                                    const typeName = treatmentType ? treatmentType.name : treatment.type;
                                    const statusClass = treatment.status === 'completed' ? 'status-completed' : 
                                                      treatment.status === 'inprogress' ? 'status-inprogress' : 'status-pending';
                                    
                                    return `
                                        <div class="history-item">
                                            <div class="history-header">
                                                <span class="history-type">${typeName}</span>
                                                <span class="treatment-status ${statusClass}">
                                                    ${treatment.status.charAt(0).toUpperCase() + treatment.status.slice(1)}
                                                </span>
                                            </div>
                                            <div class="history-details">
                                                <p><strong>Duration:</strong> ${treatment.duration} ${treatment.durationUnit}</p>
                                                <p><strong>Start Date:</strong> ${new Date(treatment.startDate).toLocaleDateString()}</p>
                                                <p><strong>End Date:</strong> ${treatment.endDate ? new Date(treatment.endDate).toLocaleDateString() : 'Ongoing'}</p>
                                                <p><strong>Re-assessment:</strong> ${treatment.reassessmentDate ? new Date(treatment.reassessmentDate).toLocaleDateString() : 'Not set'}</p>
                                                <p><strong>Notes:</strong> ${treatment.notes || 'No notes'}</p>
                                                ${treatment.createdByName ? `<p><strong>Created by:</strong> ${treatment.createdByName} on ${new Date(treatment.createdAt).toLocaleDateString()}</p>` : ''}
                                            </div>
                                            <div class="history-actions">
                                                <button class="edit-btn" onclick="editTreatment('${assessmentId}', ${index})">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                                <button class="remove-btn" onclick="removeTreatment('${assessmentId}', ${index})">
                                                    <i class="fas fa-trash"></i> Remove
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                }).join('') : 
                                '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">No treatment history available</p>'
                            }
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('treatmentModal').style.display = 'flex';
        }

        // Show treatment suggestions based on selected type and assessment disease
        function showTreatmentSuggestions(treatmentType, assessmentId = null) {
            const suggestionsDiv = document.getElementById('treatmentSuggestions');
            const durationHint = document.getElementById('durationHint');
            const reassessmentHint = document.getElementById('reassessmentHint');
            
            if (!suggestionsDiv) return;

            const treatmentInfo = treatmentTypes[treatmentType];
            if (!treatmentInfo) {
                suggestionsDiv.innerHTML = '';
                suggestionsDiv.classList.remove('active');
                return;
            }

            // Get assessment disease if available
            let diseaseTypes = ['general'];
            if (assessmentId) {
                const assessment = assessments.find(a => a.id === assessmentId);
                if (assessment && assessment.disease) {
                    if (assessment.disease.toLowerCase().includes('ganoderma')) {
                        diseaseTypes.push('ganoderma');
                    }
                    if (assessment.disease.toLowerCase().includes('blackspot')) {
                        diseaseTypes.push('blackspot');
                    }
                }
            }

            // Build suggestions HTML
            let suggestionsHTML = `
                <div class="suggestion-header">
                    <i class="fas fa-lightbulb"></i>
                    <span>Recommended Practices for ${treatmentInfo.name}</span>
                </div>
            `;

            // Add disease-specific suggestions
            diseaseTypes.forEach(diseaseType => {
                if (treatmentInfo.suggestions[diseaseType]) {
                    const diseaseTitle = diseaseType === 'ganoderma' ? 'Ganoderma' : 
                                       diseaseType === 'blackspot' ? 'Blackspot' : 'General Guidelines';
                    
                    suggestionsHTML += `
                        <span class="suggestion-category">${diseaseTitle}:</span>
                        <ul class="suggestion-list">
                            ${treatmentInfo.suggestions[diseaseType].map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    `;
                }
            });

            // Add details section
            suggestionsHTML += `
                <div class="treatment-details-info">
                    <div class="details-title">
                        <i class="fas fa-info-circle"></i>
                        <span>About ${treatmentInfo.name}</span>
                    </div>
                    <div class="details-content">
                        ${treatmentInfo.details}
                    </div>
                </div>
            `;

            // Add recommendation note
            suggestionsHTML += `
                <div class="recommendation-note">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Important:</strong> These are general recommendations. Adjust based on local conditions, tree age, infection severity, and consult with agricultural experts for specific situations.
                </div>
            `;

            suggestionsDiv.innerHTML = suggestionsHTML;
            suggestionsDiv.classList.add('active');

            // Update hints
            if (durationHint && treatmentInfo.durationHint) {
                durationHint.innerHTML = `<i class="fas fa-clock"></i> ${treatmentInfo.durationHint}`;
            }
            if (reassessmentHint && treatmentInfo.reassessmentHint) {
                reassessmentHint.innerHTML = `<i class="fas fa-calendar-check"></i> ${treatmentInfo.reassessmentHint}`;
            }
        }

        // Select treatment type
        function selectTreatmentType(type, assessmentId = null) {
            // Remove selected class from all cards
            document.querySelectorAll('.treatment-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selected class to clicked card
            const selectedCard = document.getElementById(`type-${type}`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }
            
            // Update hidden input
            document.getElementById('selectedTreatmentType').value = type;
            
            // Show treatment suggestions
            showTreatmentSuggestions(type, assessmentId);
        }

        // Save treatment
        async function saveTreatment() {
            const type = document.getElementById('selectedTreatmentType').value;
            const startDate = document.getElementById('startDate').value;
            const duration = parseInt(document.getElementById('duration').value);
            const durationUnit = document.getElementById('durationUnit').value;
            const reassessmentDate = document.getElementById('reassessmentDate').value;
            const status = document.getElementById('status').value;
            const notes = document.getElementById('notes').value;

            if (!type) {
                alert('Please select a treatment type');
                return;
            }

            if (!startDate) {
                alert('Please select a start date');
                return;
            }

            if (!duration || duration < 1) {
                alert('Please enter a valid duration');
                return;
            }

            try {
                const assessment = assessments.find(a => a.id === selectedAssessmentId);
                if (!assessment) {
                    alert('Assessment not found');
                    return;
                }

                // Calculate end date based on duration
                const endDateObj = new Date(startDate);
                if (durationUnit === 'days') {
                    endDateObj.setDate(endDateObj.getDate() + duration);
                } else if (durationUnit === 'weeks') {
                    endDateObj.setDate(endDateObj.getDate() + (duration * 7));
                } else if (durationUnit === 'months') {
                    endDateObj.setMonth(endDateObj.getMonth() + duration);
                }
                const endDate = endDateObj.toISOString().split('T')[0];

                const treatment = {
                    id: Date.now().toString(),
                    type: type,
                    startDate: startDate,
                    endDate: status === 'completed' ? endDate : null,
                    plannedEndDate: endDate,
                    duration: duration,
                    durationUnit: durationUnit,
                    reassessmentDate: reassessmentDate || null,
                    status: status,
                    notes: notes,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.uid,
                    createdByName: currentUser.displayName || currentUser.email.split('@')[0]
                };

                if (isEditingTreatment && editingTreatmentIndex !== -1) {
                    // Update existing treatment
                    const assessmentRef = doc(db, "assessments", selectedAssessmentId);
                    const updatedTreatments = [...assessment.treatments];
                    treatment.updatedAt = new Date().toISOString();
                    treatment.updatedBy = currentUser.uid;
                    treatment.updatedByName = currentUser.displayName || currentUser.email.split('@')[0];
                    updatedTreatments[editingTreatmentIndex] = treatment;
                    
                    await updateDoc(assessmentRef, {
                        treatments: updatedTreatments
                    });

                    assessment.treatments = updatedTreatments;
                    alert('Treatment updated successfully!');
                } else {
                    // Add new treatment
                    const assessmentRef = doc(db, "assessments", selectedAssessmentId);
                    await updateDoc(assessmentRef, {
                        treatments: arrayUnion(treatment)
                    });

                    assessment.treatments = assessment.treatments || [];
                    assessment.treatments.push(treatment);
                    alert('Treatment saved successfully!');
                }

                loadAssessments();
                manageTreatment(selectedAssessmentId); // Refresh modal
            } catch (error) {
                console.error('Error saving treatment:', error);
                alert('Error saving treatment: ' + error.message);
            }
        }

        // Edit treatment
        function editTreatment(assessmentId, treatmentIndex) {
            const assessment = assessments.find(a => a.id === assessmentId);
            if (!assessment || !assessment.treatments || !assessment.treatments[treatmentIndex]) {
                alert('Treatment not found');
                return;
            }

            const treatment = assessment.treatments[treatmentIndex];
            selectedAssessmentId = assessmentId;
            isEditingTreatment = true;
            editingTreatmentIndex = treatmentIndex;

            // Select the treatment type
            selectTreatmentType(treatment.type, assessmentId);

            // Populate form fields
            document.getElementById('startDate').value = treatment.startDate || new Date().toISOString().split('T')[0];
            document.getElementById('duration').value = treatment.duration || 7;
            document.getElementById('durationUnit').value = treatment.durationUnit || 'days';
            document.getElementById('reassessmentDate').value = treatment.reassessmentDate || '';
            document.getElementById('status').value = treatment.status || 'inprogress';
            document.getElementById('notes').value = treatment.notes || '';

            // Change button text
            const saveBtn = document.getElementById('saveTreatmentBtn');
            if (saveBtn) {
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Update Treatment';
            }

            // Scroll to form top
            document.querySelector('.treatment-form').scrollIntoView({ behavior: 'smooth' });
        }

        // Complete treatment
        async function completeTreatment(assessmentId) {
            const assessment = assessments.find(a => a.id === assessmentId);
            if (!assessment || !assessment.treatments) {
                alert('No treatments found for this assessment');
                return;
            }

            const activeTreatments = assessment.treatments.filter(t => 
                t.status === 'inprogress' || t.status === 'pending'
            );

            if (activeTreatments.length === 0) {
                alert('No active treatments to complete');
                return;
            }

            if (confirm(`Complete ${activeTreatments.length} active treatment(s)? This will mark them as completed and set the end date to today.`)) {
                try {
                    const assessmentRef = doc(db, "assessments", assessmentId);
                    
                    // Update each active treatment
                    const updatedTreatments = assessment.treatments.map(treatment => {
                        if (treatment.status === 'inprogress' || treatment.status === 'pending') {
                            return {
                                ...treatment,
                                status: 'completed',
                                endDate: new Date().toISOString().split('T')[0],
                                updatedAt: new Date().toISOString(),
                                updatedBy: currentUser.uid,
                                updatedByName: currentUser.displayName || currentUser.email.split('@')[0]
                            };
                        }
                        return treatment;
                    });

                    await updateDoc(assessmentRef, {
                        treatments: updatedTreatments
                    });

                    assessment.treatments = updatedTreatments;

                    alert('Treatments marked as completed!');
                    loadAssessments();
                } catch (error) {
                    console.error('Error completing treatments:', error);
                    alert('Error completing treatments: ' + error.message);
                }
            }
        }

        // Remove treatment
        async function removeTreatment(assessmentId, treatmentIndex) {
            if (!confirm('Are you sure you want to remove this treatment? This action cannot be undone.')) {
                return;
            }

            try {
                const assessment = assessments.find(a => a.id === assessmentId);
                if (!assessment || !assessment.treatments || !assessment.treatments[treatmentIndex]) {
                    alert('Treatment not found');
                    return;
                }

                const treatmentToRemove = assessment.treatments[treatmentIndex];
                const assessmentRef = doc(db, "assessments", assessmentId);
                
                // Remove the specific treatment using arrayRemove
                await updateDoc(assessmentRef, {
                    treatments: arrayRemove(treatmentToRemove)
                });

                // Update local data
                assessment.treatments = assessment.treatments.filter((_, index) => index !== treatmentIndex);

                alert('Treatment removed successfully!');
                manageTreatment(assessmentId);
            } catch (error) {
                console.error('Error removing treatment:', error);
                alert('Error removing treatment: ' + error.message);
            }
        }

        // Close treatment modal
        function closeTreatmentModal() {
            document.getElementById('treatmentModal').style.display = 'none';
            selectedAssessmentId = null;
            isEditingTreatment = false;
            editingTreatmentIndex = -1;
        }

        // Close assessment modal
        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        // Delete assessment
        async function deleteAssessment(assessmentId) {
            if (!confirm('Are you sure you want to delete this assessment? This action cannot be undone.')) {
                return;
            }

            try {
                await deleteDoc(doc(db, "assessments", assessmentId));
                
                // Remove from local arrays
                assessments = assessments.filter(a => a.id !== assessmentId);
                filteredAssessments = filteredAssessments.filter(a => a.id !== assessmentId);
                
                // Update UI
                updateStatistics();
                renderTable();
                
                alert('Assessment deleted successfully');
            } catch (error) {
                console.error('Error deleting assessment:', error);
                alert('Error deleting assessment: ' + error.message);
            }
        }

        // Export to CSV
        function exportToCSV() {
            if (filteredAssessments.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = [
                'Assessment ID',
                'Date',
                'Time',
                'Location',
                'Disease',
                'Detection Count',
                'Health Status',
                'Treatment Status',
                'Active Treatments',
                'Completed Treatments',
                'Total Treatments',
                'Next Assessment'
            ];

            const csvData = filteredAssessments.map(assessment => {
                const date = assessment.dateObj;
                const activeTreatmentCount = assessment.treatments ? 
                    assessment.treatments.filter(t => t.status === 'inprogress' || t.status === 'pending').length : 0;
                const completedTreatmentCount = assessment.treatments ? 
                    assessment.treatments.filter(t => t.status === 'completed').length : 0;
                const totalTreatmentCount = (activeTreatmentCount + completedTreatmentCount);
                
                let treatmentStatus = 'No Treatment';
                if (totalTreatmentCount > 0) {
                    if (activeTreatmentCount > 0) {
                        treatmentStatus = 'In Progress';
                    } else if (completedTreatmentCount > 0) {
                        treatmentStatus = 'Completed';
                    } else {
                        treatmentStatus = 'Pending';
                    }
                }
                
                return [
                    `"${assessment.assessmentId || ''}"`,
                    `"${date.toLocaleDateString()}"`,
                    `"${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}"`,
                    `"${assessment.location || ''}"`,
                    `"${assessment.disease || ''}"`,
                    assessment.detectionCount || 0,
                    `"${assessment.healthStatus || ''}"`,
                    `"${treatmentStatus}"`,
                    activeTreatmentCount,
                    completedTreatmentCount,
                    totalTreatmentCount,
                    `"${assessment.nextAssessment || ''}"`
                ];
            });

            const csvContent = [
                headers.join(','),
                ...csvData.map(row => row.join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `tree-health-assessments-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Show no data message
        function showNoDataMessage() {
            document.getElementById('tableBody').innerHTML = '';
            document.getElementById('noDataMessage').style.display = 'block';
            document.getElementById('pagination').style.display = 'none';
            
            // Reset statistics
            document.getElementById('totalAssessments').textContent = '0';
            document.getElementById('healthyCount').textContent = '0';
            document.getElementById('diseaseCount').textContent = '0';
            document.getElementById('activeTreatments').textContent = '0';
            document.getElementById('healthyPercentage').textContent = '0%';
            document.getElementById('diseasePercentage').textContent = '0%';
        }

        // Event listeners for filters
        document.getElementById('searchInput').addEventListener('input', () => {
            filterAssessments();
            renderTable();
        });

        document.getElementById('statusFilter').addEventListener('change', () => {
            filterAssessments();
            renderTable();
        });

        document.getElementById('diseaseFilter').addEventListener('change', () => {
            filterAssessments();
            renderTable();
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const detailModal = document.getElementById('detailModal');
            const treatmentModal = document.getElementById('treatmentModal');
            
            if (event.target === detailModal) {
                closeModal();
            }
            if (event.target === treatmentModal) {
                closeTreatmentModal();
            }
        }

        // Make functions globally available
        window.loadAssessments = loadAssessments;
        window.viewAssessment = viewAssessment;
        window.manageTreatment = manageTreatment;
        window.selectTreatmentType = selectTreatmentType;
        window.showTreatmentSuggestions = showTreatmentSuggestions;
        window.saveTreatment = saveTreatment;
        window.editTreatment = editTreatment;
        window.completeTreatment = completeTreatment;
        window.removeTreatment = removeTreatment;
        window.deleteAssessment = deleteAssessment;
        window.closeModal = closeModal;
        window.closeTreatmentModal = closeTreatmentModal;
        window.changePage = changePage;
        window.exportToCSV = exportToCSV;
    </script>
</body>
</html>