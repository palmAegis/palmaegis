<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forum | Palm Aegis</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/homepage.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="icon" href="images/logo1.png" type="image/png" sizes="32x32">
    <link rel="shortcut icon" href="images/logo1.png">
    <meta name="theme-color" content="#2e7d32">

    <style>
        :root {
            --primary-color: #2e7d32;
            --secondary-color: #4caf50;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --info-color: #2196f3;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #c8f0c8;
            color: #333;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .top-header {
            background-color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header-left h1 {
            font-size: 1.8rem;
            color: var(--primary-color);
        }

        .search-box {
            display: flex;
            align-items: center;
            background-color: #f5f5f5;
            border-radius: 20px;
            padding: 8px 15px;
            width: 300px;
        }

        .search-box i {
            color: #777;
            margin-right: 10px;
        }

        .search-box input {
            border: none;
            background: transparent;
            outline: none;
            width: 100%;
        }

        .container {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 1.8rem;
            color: var(--primary-color);
        }

        .page-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #1b5e20;
        }

        .btn-secondary {
            background-color: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background-color: #d6d6d6;
        }

        /* Forum Styles */
        .forum-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .category-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .category-tab {
            padding: 10px 20px;
            background-color: white;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .category-tab:hover {
            background-color: #f0f0f0;
        }

        .category-tab.active {
            background-color: var(--primary-color);
            color: white;
        }

        .category-tag {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .tag-disease {
            background-color: #ffebee;
            color: #d32f2f;
        }

        .tag-treatment {
            background-color: #e8f5e9;
            color: var(--primary-color);
        }

        .tag-general {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .tag-farming {
            background-color: #fff3e0;
            color: #f57c00;
        }

        /* Create Post Section */
        .create-post {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .post-input {
            width: 100%;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 15px;
            resize: vertical;
            min-height: 100px;
        }

        .post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .post-tags {
            display: flex;
            gap: 10px;
        }

        /* Image Upload Styles */
        .image-upload-section {
            margin-bottom: 15px;
            display: none;
        }

        .image-preview {
            margin-top: 10px;
            max-width: 100%;
        }

        .image-preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .upload-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .upload-btn {
            padding: 8px 15px;
            background-color: #e0e0e0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .upload-btn:hover {
            background-color: #d0d0d0;
        }

        .upload-btn.camera {
            background-color: #2196f3;
            color: white;
        }

        .upload-btn.camera:hover {
            background-color: #1976d2;
        }

        /* Posts Grid */
        .posts-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .post-card {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .post-card:hover {
            transform: translateY(-2px);
        }

        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .post-author {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .author-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #2e7d32;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
        }

        .author-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .avatar-initial {
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .author-info h4 {
            font-size: 1rem;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .author-info .post-time {
            font-size: 0.85rem;
            color: #777;
        }

        .post-category {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .post-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 10px;
        }

        .post-content {
            color: #555;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .post-images {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .post-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .post-image:hover {
            transform: scale(1.02);
        }

        .post-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #777;
        }

        .post-actions-footer {
            display: flex;
            gap: 15px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 5px;
            color: #777;
            transition: all 0.3s;
        }

        .action-btn:hover {
            background-color: #f5f5f5;
            color: var(--primary-color);
        }

        .action-btn.liked {
            color: #f44336;
        }

        .action-btn.upvoted {
            color: var(--primary-color);
        }

        .action-btn.downvoted {
            color: #2196f3;
        }

        /* Replies Section */
        .replies-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .reply-input {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .reply-input textarea {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            resize: vertical;
            min-height: 80px;
        }

        .reply-btn {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .replies-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .reply-card {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
        }

        .reply-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .reply-author {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .reply-author .author-avatar {
            width: 30px;
            height: 30px;
        }

        .expert-tag {
            background-color: #fff3e0;
            color: #f57c00;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #777;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-textarea {
            min-height: 150px;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #777;
        }

        .no-data i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #ddd;
        }

        /* Image Preview Modal */
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .image-modal-content {
            max-width: 90%;
            max-height: 90%;
        }

        .image-modal-content img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
        }

        .close-image-modal {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            cursor: pointer;
            background: none;
            border: none;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard-container {
                flex-direction: column;
            }

            .main-content {
                width: 100%;
            }

            .post-actions {
                flex-direction: column;
                gap: 15px;
            }

            .post-tags {
                flex-wrap: wrap;
            }

            .modal-content {
                width: 95%;
                margin: 20px;
            }

            .category-tabs {
                overflow-x: auto;
            }

            .upload-options {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <div id="sidebarPlaceholder"></div>
        <script src="js/sidebar-loader.js"></script>

        <main class="main-content">
            <div class="top-header">
                <div class="header-left">
                    <h1>Community Forum</h1>
                </div>
            </div>

            <div class="container">
                <div class="page-header">
                    <h2 class="page-title">Community Discussions</h2>
                    <div class="page-actions">
                        <button class="btn btn-secondary" id="filterBtn">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                        <button class="btn btn-primary" id="newPostBtn">
                            <i class="fas fa-plus"></i> New Discussion
                        </button>
                    </div>
                </div>

                <!-- Category Tabs -->
                <div class="category-tabs">
                    <div class="category-tab active" data-category="all">
                        <i class="fas fa-globe"></i>
                        <span>All Topics</span>
                    </div>
                    <div class="category-tab" data-category="disease">
                        <i class="fas fa-virus"></i>
                        <span>Diseases</span>
                    </div>
                    <div class="category-tab" data-category="treatment">
                        <i class="fas fa-shield-alt"></i>
                        <span>Treatments</span>
                    </div>
                    <div class="category-tab" data-category="farming">
                        <i class="fas fa-tractor"></i>
                        <span>General Farming</span>
                    </div>
                    <div class="category-tab" data-category="question">
                        <i class="fas fa-question-circle"></i>
                        <span>Questions</span>
                    </div>
                </div>

                <!-- Create Post Section -->
                <div class="create-post" id="createPostSection" style="display: none;">
                    <input type="text" id="postTitleInput" class="post-input" placeholder="Title of your discussion">
                    <textarea class="post-input" id="postContentInput"
                        placeholder="What would you like to discuss?"></textarea>
                    
                    <!-- Image Upload Section -->
                    <div class="image-upload-section" id="imageUploadSection">
                        <div class="upload-options">
                            <label class="upload-btn">
                                <i class="fas fa-image"></i> Upload Image
                                <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                            </label>
                            <button class="upload-btn camera" id="cameraBtn">
                                <i class="fas fa-camera"></i> Take Photo
                            </button>
                            <button class="upload-btn" id="clearImagesBtn">
                                <i class="fas fa-times"></i> Clear Images
                            </button>
                        </div>
                        <div class="image-preview" id="imagePreview"></div>
                    </div>
                    
                    <div class="post-actions">
                        <div class="post-tags">
                            <select id="postCategorySelect" class="category-tab">
                                <option value="disease">Disease Discussion</option>
                                <option value="treatment">Treatment Methods</option>
                                <option value="farming">General Farming</option>
                                <option value="question">Ask Question</option>
                            </select>
                            <input type="text" id="postTagsInput" placeholder="Add tags (comma separated)"
                                style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                            <button class="btn btn-secondary" id="toggleImageBtn">
                                <i class="fas fa-image"></i> Add Images
                            </button>
                        </div>
                        <div>
                            <button class="btn btn-secondary" id="cancelPostBtn">Cancel</button>
                            <button class="btn btn-primary" id="submitPostBtn">Post Discussion</button>
                        </div>
                    </div>
                </div>

                <!-- Posts Grid -->
                <div class="posts-grid" id="postsGrid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading discussions...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Post Detail Modal -->
    <div class="modal" id="postDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Discussion Details</h2>
                <button class="close-modal" id="closePostModal">&times;</button>
            </div>
            <div class="modal-body" id="postDetailContent">
                <!-- Post details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Edit Post Modal -->
    <div class="modal" id="editPostModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Discussion</h2>
                <button class="close-modal" id="closeEditModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editPostForm">
                    <div class="form-group">
                        <label class="form-label">Title</label>
                        <input type="text" id="editPostTitle" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Content</label>
                        <textarea id="editPostContent" class="form-textarea" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select id="editPostCategory" class="form-select">
                            <option value="disease">Disease Discussion</option>
                            <option value="treatment">Treatment Methods</option>
                            <option value="farming">General Farming</option>
                            <option value="question">Ask Question</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tags</label>
                        <input type="text" id="editPostTags" class="form-input"
                            placeholder="e.g., ganoderma, fertilizer, pests">
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancelEditBtn">Cancel</button>
                <button class="btn btn-primary" id="saveEditBtn">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Filter Modal -->
    <div class="modal" id="filterModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Filter Discussions</h2>
                <button class="close-modal" id="closeFilterBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select id="filterCategory" class="form-select">
                        <option value="all">All Categories</option>
                        <option value="disease">Disease Discussion</option>
                        <option value="treatment">Treatment Methods</option>
                        <option value="farming">General Farming</option>
                        <option value="question">Ask Question</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Sort By</label>
                    <select id="filterSort" class="form-select">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="mostLiked">Most Liked</option>
                        <option value="mostReplies">Most Replies</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Time Range</label>
                    <select id="filterTime" class="form-select">
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                    </select>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="clearFiltersBtn">Clear Filters</button>
                <button class="btn btn-primary" id="applyFiltersBtn">Apply Filters</button>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div class="modal image-modal" id="imagePreviewModal">
        <button class="close-image-modal" id="closeImageModal">&times;</button>
        <div class="image-modal-content">
            <img id="fullSizeImage" src="" alt="Full size image">
        </div>
    </div>

    <!-- Camera Modal -->
    <div class="modal" id="cameraModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Take Photo</h2>
                <button class="close-modal" id="closeCameraBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="cameraContainer">
                    <video id="cameraView" autoplay style="width: 100%; border-radius: 8px;"></video>
                </div>
                <canvas id="cameraCanvas" style="display: none;"></canvas>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="retakeBtn">Retake</button>
                <button class="btn btn-primary" id="captureBtn">Capture Photo</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, collection, getDocs, addDoc, updateDoc, deleteDoc, query, where, orderBy, limit, serverTimestamp, arrayUnion, arrayRemove, Timestamp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';
        import { getStorage, ref, uploadString, getDownloadURL } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAf-wtZpl8wVjCymdLlC-YGlv7xn0yEMMU",
            authDomain: "palmaegis-setup.firebaseapp.com",
            projectId: "palmaegis-setup",
            storageBucket: "palmaegis-setup.firebasestorage.app",
            messagingSenderId: "445887502374",
            appId: "1:445887502374:web:a5f6ecaa90b88447626ee7"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Global variables
        let currentUser = null;
        let currentFilters = {
            category: 'all',
            sort: 'newest',
            time: 'all'
        };
        let posts = [];
        let currentPostId = null;
        let selectedImages = []; // Store images for new posts
        let mediaStream = null; // For camera access

        // Check authentication state
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                window.currentUser = user;
                console.log('User signed in:', user.email);

                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        window.userData = userData;
                        updateUserProfile(user, userData);
                    }

                    // Load posts data
                    await loadPosts();
                } catch (error) {
                    console.error('Error loading user data:', error);
                    showError("Failed to load forum data. Please try again.");
                }
            } else {
                console.log('User not signed in');
                window.location.href = 'signin.html';
            }
        });

        function updateUserProfile(user, userData) {
            const userNameElement = document.querySelector('.user-name');
            const userRoleElement = document.querySelector('.user-role');
            const userAvatarElement = document.getElementById('sidebarUserAvatar');

            const displayName = userData.firstName && userData.lastName
                ? `${userData.firstName} ${userData.lastName}`
                : userData.username
                    ? userData.username
                    : userData.displayName || user.displayName || user.email.split('@')[0] || 'User';

            if (userNameElement) userNameElement.textContent = displayName;
            if (userRoleElement) userRoleElement.textContent = userData.bio || 'Farmer';

            // Update profile image
            if (userAvatarElement) {
                const profileImageUrl = userData.imageBase64 || userData.picture || user.photoURL;
                if (profileImageUrl) {
                    userAvatarElement.src = profileImageUrl;
                    userAvatarElement.onerror = () => {
                        userAvatarElement.onerror = null;
                        userAvatarElement.src = 'images/user-avatar.jpg';
                    };
                }
            }
        }

        // Get user's profile data
        async function getUserProfile(userId) {
            try {
                const userDoc = await getDoc(doc(db, "users", userId));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    
                    const fullName = userData.firstName && userData.lastName
                        ? `${userData.firstName} ${userData.lastName}`
                        : userData.username || 'User';
                    const profileImage = userData.imageBase64 || userData.profileImage || userData.avatar || null;
                    
                    return {
                        fullName: fullName,
                        profileImage: profileImage,
                        isExpert: userData.isExpert || false
                    };
                }
                return null;
            } catch (error) {
                console.error('Error getting user profile:', error);
                return null;
            }
        }

        // Convert File/Blob to Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // Upload image to Firebase Storage and return URL
        async function uploadImageToStorage(imageBase64, postId) {
            try {
                const timestamp = Date.now();
                const imageName = `forum_images/${postId || 'temp'}_${timestamp}.jpg`;
                const storageRef = ref(storage, imageName);
                
                // Upload base64 string
                const snapshot = await uploadString(storageRef, imageBase64, 'data_url');
                const downloadURL = await getDownloadURL(snapshot.ref);
                return downloadURL;
            } catch (error) {
                console.error('Error uploading image:', error);
                throw error;
            }
        }

        // Load posts from Firebase
        async function loadPosts() {
            try {
                const postsGrid = document.getElementById('postsGrid');
                postsGrid.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading discussions...</p>
                </div>
            `;

                const postsRef = collection(db, "forum_posts");
                const q = query(postsRef, orderBy("createdAt", "desc"), limit(200));
                const querySnapshot = await getDocs(q);

                const allPosts = [];
                querySnapshot.forEach((d) => {
                    const data = d.data() || {};
                    let createdAtDate = null;
                    if (data.createdAt && typeof data.createdAt.toDate === 'function') {
                        createdAtDate = data.createdAt.toDate();
                    } else if (data.createdAt instanceof Date) {
                        createdAtDate = data.createdAt;
                    }
                    
                    allPosts.push({ 
                        id: d.id, 
                        createdAtDate, 
                        ...data,
                        images: data.images || [] // Ensure images array exists
                    });
                });

                // Apply filters client-side
                let filtered = allPosts;

                if (currentFilters.category && currentFilters.category !== 'all') {
                    filtered = filtered.filter(p => (p.category || '').toLowerCase() === String(currentFilters.category).toLowerCase());
                }

                if (currentFilters.time && currentFilters.time !== 'all') {
                    const now = new Date();
                    let startDate = null;
                    switch (currentFilters.time) {
                        case 'today':
                            startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
                            break;
                        case 'week':
                            startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
                            break;
                        case 'month':
                            startDate = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                            break;
                    }
                    if (startDate) {
                        filtered = filtered.filter(p => p.createdAtDate && p.createdAtDate >= startDate);
                    }
                }

                const searchEl = document.getElementById('searchInput');
                const searchTerm = searchEl && searchEl.value ? searchEl.value.trim().toLowerCase() : '';
                if (searchTerm) {
                    filtered = filtered.filter(p => {
                        const title = (p.title || '').toLowerCase();
                        const content = (p.content || '').toLowerCase();
                        const author = (p.authorName || '').toLowerCase();
                        return title.includes(searchTerm) || content.includes(searchTerm) || author.includes(searchTerm);
                    });
                }

                switch (currentFilters.sort) {
                    case 'newest':
                        filtered.sort((a, b) => (b.createdAtDate || 0) - (a.createdAtDate || 0));
                        break;
                    case 'oldest':
                        filtered.sort((a, b) => (a.createdAtDate || 0) - (b.createdAtDate || 0));
                        break;
                    case 'mostLiked':
                        filtered.sort((a, b) => ((b.likesCount || 0) - (a.likesCount || 0)));
                        break;
                    case 'mostReplies':
                        filtered.sort((a, b) => ((b.repliesCount || 0) - (a.repliesCount || 0)));
                        break;
                    default:
                        filtered.sort((a, b) => (b.createdAtDate || 0) - (a.createdAtDate || 0));
                }

                posts = filtered;
                if (posts.length === 0) {
                    showNoPosts();
                    return;
                }
                displayPosts();
            } catch (error) {
                console.error("Error loading posts:", error);
                const message = (error && error.message) ? error.message : 'Unable to load discussions. Please try again.';
                showError(message, error);
            }
        }

        // Display posts in grid
        function displayPosts() {
            const postsGrid = document.getElementById('postsGrid');
            postsGrid.innerHTML = '';

            if (posts.length === 0) {
                showNoPosts();
                return;
            }

            posts.forEach(post => {
                createPostCard(post);
            });
        }

        // Create a post card
        function createPostCard(post) {
            const postsGrid = document.getElementById('postsGrid');

            const postDate = post.createdAt ? new Date(post.createdAt.toDate()).toLocaleDateString() : 'Recent';
            const tags = post.tags || [];
            const likesCount = post.likes ? post.likes.length : 0;
            const repliesCount = post.replies ? post.replies.length : 0;
            const images = post.images || [];

            let categoryTag = '';
            switch (post.category) {
                case 'disease':
                    categoryTag = '<span class="category-tag tag-disease">Disease</span>';
                    break;
                case 'treatment':
                    categoryTag = '<span class="category-tag tag-treatment">Treatment</span>';
                    break;
                case 'farming':
                    categoryTag = '<span class="category-tag tag-farming">Farming</span>';
                    break;
                case 'question':
                    categoryTag = '<span class="category-tag tag-general">Question</span>';
                    break;
            }

            const isLiked = post.likes && post.likes.includes(currentUser.uid);
            const isUpvoted = post.upvotes && post.upvotes.includes(currentUser.uid);
            const isDownvoted = post.downvotes && post.downvotes.includes(currentUser.uid);

            let avatarHtml = '';
            if (post.authorAvatar) {
                avatarHtml = `<img src="${post.authorAvatar}" alt="${post.authorName || 'User'}" 
                                 onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'avatar-initial\'>${post.authorName ? post.authorName.charAt(0).toUpperCase() : 'U'}</div>';" />`;
            } else {
                avatarHtml = `<div class="avatar-initial">${post.authorName ? post.authorName.charAt(0).toUpperCase() : 'U'}</div>`;
            }

            // Create images HTML if there are images
            let imagesHtml = '';
            if (images.length > 0) {
                imagesHtml = `<div class="post-images">`;
                images.forEach((imageUrl, index) => {
                    imagesHtml += `
                        <img src="${imageUrl}" 
                             alt="Post image ${index + 1}" 
                             class="post-image"
                             onclick="viewFullImage('${imageUrl}')"
                             onerror="this.style.display='none'">
                    `;
                });
                imagesHtml += `</div>`;
            }

            const postCard = document.createElement('div');
            postCard.className = 'post-card';
            postCard.setAttribute('data-id', post.id);

            postCard.innerHTML = `
            <div class="post-header">
                <div class="post-author">
                    <div class="author-avatar">
                        ${avatarHtml}
                    </div>
                    <div class="author-info">
                        <h4>${post.authorName || 'Anonymous'} 
                            ${post.isExpert ? '<span class="expert-tag">Expert</span>' : ''}
                        </h4>
                        <div class="post-time">${postDate}</div>
                    </div>
                </div>
                <div class="post-category">
                    ${categoryTag}
                    ${tags.map(tag => `<span class="category-tag tag-general">${tag}</span>`).join('')}
                </div>
            </div>
            
            <h3 class="post-title">${post.title || 'Untitled'}</h3>
            <div class="post-content">${post.content}</div>
            
            ${imagesHtml}
            
            <div class="post-stats">
                <div class="stat">
                    <i class="fas fa-heart"></i>
                    <span>${likesCount}</span>
                </div>
                <div class="stat">
                    <i class="fas fa-comment"></i>
                    <span>${repliesCount}</span>
                </div>
                <div class="stat">
                    <i class="fas fa-thumbs-up"></i>
                    <span>${post.upvotes ? post.upvotes.length : 0}</span>
                </div>
                <div class="stat">
                    <i class="fas fa-thumbs-down"></i>
                    <span>${post.downvotes ? post.downvotes.length : 0}</span>
                </div>
            </div>
            
            <div class="post-actions-footer">
                <button class="action-btn like-btn ${isLiked ? 'liked' : ''}" data-action="like">
                    <i class="fas fa-heart"></i>
                    <span>Like</span>
                </button>
                <button class="action-btn upvote-btn ${isUpvoted ? 'upvoted' : ''}" data-action="upvote">
                    <i class="fas fa-thumbs-up"></i>
                    <span>Upvote</span>
                </button>
                <button class="action-btn downvote-btn ${isDownvoted ? 'downvoted' : ''}" data-action="downvote">
                    <i class="fas fa-thumbs-down"></i>
                    <span>Downvote</span>
                </button>
                <button class="action-btn reply-btn" data-action="reply">
                    <i class="fas fa-reply"></i>
                    <span>Reply</span>
                </button>
                ${post.authorId === currentUser.uid ? `
                    <button class="action-btn edit-btn" data-action="edit">
                        <i class="fas fa-edit"></i>
                        <span>Edit</span>
                    </button>
                    <button class="action-btn delete-btn" data-action="delete">
                        <i class="fas fa-trash"></i>
                        <span>Delete</span>
                    </button>
                ` : ''}
                <button class="action-btn view-btn" data-action="view">
                    <i class="fas fa-expand"></i>
                    <span>View</span>
                </button>
            </div>
        `;

            postsGrid.appendChild(postCard);
            attachPostEventListeners(postCard, post.id);
        }

        // Function to view full size image
        window.viewFullImage = function(imageUrl) {
            const modal = document.getElementById('imagePreviewModal');
            const img = document.getElementById('fullSizeImage');
            img.src = imageUrl;
            modal.style.display = 'flex';
        }

        // Attach event listeners to post card buttons
        function attachPostEventListeners(postCard, postId) {
            const likeBtn = postCard.querySelector('.like-btn');
            const upvoteBtn = postCard.querySelector('.upvote-btn');
            const downvoteBtn = postCard.querySelector('.downvote-btn');
            const replyBtn = postCard.querySelector('.reply-btn');
            const editBtn = postCard.querySelector('.edit-btn');
            const deleteBtn = postCard.querySelector('.delete-btn');
            const viewBtn = postCard.querySelector('.view-btn');

            if (likeBtn) likeBtn.addEventListener('click', () => toggleLike(postId));
            if (upvoteBtn) upvoteBtn.addEventListener('click', () => toggleVote(postId, 'upvote'));
            if (downvoteBtn) downvoteBtn.addEventListener('click', () => toggleVote(postId, 'downvote'));
            if (replyBtn) replyBtn.addEventListener('click', () => showReplySection(postId));
            if (editBtn) editBtn.addEventListener('click', () => openEditPostModal(postId));
            if (deleteBtn) deleteBtn.addEventListener('click', () => deletePost(postId));
            if (viewBtn) viewBtn.addEventListener('click', () => viewPostDetails(postId));
        }

        // Toggle like on a post
        async function toggleLike(postId) {
            try {
                const postRef = doc(db, "forum_posts", postId);
                const post = posts.find(p => p.id === postId);

                if (post.likes && post.likes.includes(currentUser.uid)) {
                    await updateDoc(postRef, {
                        likes: arrayRemove(currentUser.uid),
                        likesCount: (post.likesCount || 0) - 1
                    });
                } else {
                    await updateDoc(postRef, {
                        likes: arrayUnion(currentUser.uid),
                        likesCount: (post.likesCount || 0) + 1
                    });
                }

                await loadPosts();

            } catch (error) {
                console.error("Error toggling like:", error);
                alert("Failed to update like. Please try again.");
            }
        }

        // Toggle vote (upvote/downvote)
        async function toggleVote(postId, voteType) {
            try {
                const postRef = doc(db, "forum_posts", postId);
                const post = posts.find(p => p.id === postId);

                const oppositeVoteType = voteType === 'upvote' ? 'downvote' : 'upvote';
                const oppositeArray = oppositeVoteType + 's';

                if (post[voteType + 's'] && post[voteType + 's'].includes(currentUser.uid)) {
                    await updateDoc(postRef, {
                        [voteType + 's']: arrayRemove(currentUser.uid)
                    });
                } else {
                    const updates = {
                        [voteType + 's']: arrayUnion(currentUser.uid)
                    };

                    if (post[oppositeArray] && post[oppositeArray].includes(currentUser.uid)) {
                        updates[oppositeArray] = arrayRemove(currentUser.uid);
                    }

                    await updateDoc(postRef, updates);
                }

                await loadPosts();

            } catch (error) {
                console.error("Error toggling vote:", error);
                alert("Failed to update vote. Please try again.");
            }
        }

        // Create a new post with images
        async function createPost(title, content, category, tags, images) {
            try {
                if (!content.trim()) {
                    alert("Please enter some content for your discussion.");
                    return;
                }

                if (!title.trim()) {
                    title = content.substring(0, 100) + (content.length > 100 ? '...' : '');
                }

                const userProfile = await getUserProfile(currentUser.uid);

                // Upload images to storage and get URLs
                const imageUrls = [];
                for (const imageBase64 of images) {
                    try {
                        const imageUrl = await uploadImageToStorage(imageBase64);
                        imageUrls.push(imageUrl);
                    } catch (error) {
                        console.error('Error uploading image:', error);
                    }
                }

                const postData = {
                    title: title,
                    content: content,
                    category: category,
                    tags: tags ? tags.split(',').map(tag => tag.trim()) : [],
                    images: imageUrls, // Store image URLs
                    authorId: currentUser.uid,
                    authorName: userProfile?.fullName || currentUser.email.split('@')[0],
                    authorAvatar: userProfile?.profileImage || null,
                    isExpert: userProfile?.isExpert || false,
                    createdAt: serverTimestamp(),
                    likes: [],
                    likesCount: 0,
                    upvotes: [],
                    downvotes: [],
                    replies: [],
                    repliesCount: 0
                };

                await addDoc(collection(db, "forum_posts"), postData);

                // Clear form and reset images
                document.getElementById('postTitleInput').value = '';
                document.getElementById('postContentInput').value = '';
                document.getElementById('postTagsInput').value = '';
                document.getElementById('imagePreview').innerHTML = '';
                selectedImages = [];
                document.getElementById('createPostSection').style.display = 'none';

                await loadPosts();
                alert("Discussion posted successfully!");

            } catch (error) {
                console.error("Error creating post:", error);
                alert("Failed to create discussion. Please try again.");
            }
        }

        // Update an existing post
        async function updatePost(postId, title, content, category, tags) {
            try {
                const postRef = doc(db, "forum_posts", postId);

                await updateDoc(postRef, {
                    title: title,
                    content: content,
                    category: category,
                    tags: tags ? tags.split(',').map(tag => tag.trim()) : [],
                    updatedAt: serverTimestamp()
                });

                closeModal('editPostModal');
                await loadPosts();
                alert("Discussion updated successfully!");

            } catch (error) {
                console.error("Error updating post:", error);
                alert("Failed to update discussion. Please try again.");
            }
        }

        // Delete a post
        async function deletePost(postId) {
            if (!confirm("Are you sure you want to delete this discussion? This action cannot be undone.")) {
                return;
            }

            try {
                await deleteDoc(doc(db, "forum_posts", postId));
                await loadPosts();
                alert("Discussion deleted successfully!");

            } catch (error) {
                console.error("Error deleting post:", error);
                alert("Failed to delete discussion. Please try again.");
            }
        }

        // Show reply section for a post
        function showReplySection(postId) {
            const postCard = document.querySelector(`.post-card[data-id="${postId}"]`);
            let replySection = postCard.querySelector('.replies-section');

            if (!replySection) {
                replySection = document.createElement('div');
                replySection.className = 'replies-section';
                replySection.innerHTML = `
                <div class="reply-input">
                    <textarea placeholder="Write your reply..." class="reply-textarea"></textarea>
                    <button class="reply-btn submit-reply">Reply</button>
                </div>
                <div class="replies-list" id="replies-${postId}">
                    <p>Loading replies...</p>
                </div>
            `;

                postCard.appendChild(replySection);
                const submitBtn = replySection.querySelector('.submit-reply');
                submitBtn.addEventListener('click', () => submitReply(postId));
                loadReplies(postId);
            } else {
                replySection.style.display = replySection.style.display === 'none' ? 'block' : 'none';
            }
        }

        // Submit a reply to a post
        async function submitReply(postId) {
            const replySection = document.querySelector(`.post-card[data-id="${postId}"] .replies-section`);
            const textarea = replySection.querySelector('.reply-textarea');
            const replyContent = textarea.value.trim();

            if (!replyContent) {
                alert("Please enter a reply.");
                return;
            }

            try {
                const userProfile = await getUserProfile(currentUser.uid);
                const postRef = doc(db, "forum_posts", postId);
                const post = posts.find(p => p.id === postId);

                const replyData = {
                    content: replyContent,
                    authorId: currentUser.uid,
                    authorName: userProfile?.fullName || currentUser.email.split('@')[0],
                    authorAvatar: userProfile?.profileImage || null,
                    createdAt: serverTimestamp(),
                    isExpert: userProfile?.isExpert || false
                };

                await updateDoc(postRef, {
                    replies: arrayUnion(replyData),
                    repliesCount: (post.repliesCount || 0) + 1
                });

                textarea.value = '';
                loadReplies(postId);

            } catch (error) {
                console.error("Error submitting reply:", error);
                alert("Failed to submit reply. Please try again.");
            }
        }

        // Load replies for a post
        async function loadReplies(postId) {
            try {
                const postRef = doc(db, "forum_posts", postId);
                const postDoc = await getDoc(postRef);

                if (postDoc.exists()) {
                    const postData = postDoc.data();
                    const replies = postData.replies || [];

                    const repliesList = document.getElementById(`replies-${postId}`);
                    repliesList.innerHTML = '';

                    if (replies.length === 0) {
                        repliesList.innerHTML = '<p>No replies yet. Be the first to reply!</p>';
                        return;
                    }

                    replies.forEach(reply => {
                        const replyDate = reply.createdAt ? new Date(reply.createdAt.toDate()).toLocaleDateString() : 'Recent';

                        let replyAvatarHtml = '';
                        if (reply.authorAvatar) {
                            replyAvatarHtml = `<img src="${reply.authorAvatar}" alt="${reply.authorName || 'User'}" 
                                               onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'avatar-initial\'>${reply.authorName ? reply.authorName.charAt(0).toUpperCase() : 'R'}</div>';" />`;
                        } else {
                            replyAvatarHtml = `<div class="avatar-initial">${reply.authorName ? reply.authorName.charAt(0).toUpperCase() : 'R'}</div>`;
                        }

                        const replyCard = document.createElement('div');
                        replyCard.className = 'reply-card';
                        replyCard.innerHTML = `
                        <div class="reply-header">
                            <div class="reply-author">
                                <div class="author-avatar" style="width: 30px; height: 30px;">
                                    ${replyAvatarHtml}
                                </div>
                                <div>
                                    <strong>${reply.authorName || 'Anonymous'}</strong>
                                    ${reply.isExpert ? '<span class="expert-tag">Expert</span>' : ''}
                                </div>
                            </div>
                            <div class="reply-time">${replyDate}</div>
                        </div>
                        <div class="reply-content">${reply.content}</div>
                    `;

                        repliesList.appendChild(replyCard);
                    });
                }

            } catch (error) {
                console.error("Error loading replies:", error);
            }
        }

        // View post details
        async function viewPostDetails(postId) {
            try {
                const postRef = doc(db, "forum_posts", postId);
                const postDoc = await getDoc(postRef);

                if (postDoc.exists()) {
                    const post = postDoc.data();
                    const postDate = post.createdAt ? new Date(post.createdAt.toDate()).toLocaleDateString() : 'Recent';

                    let modalAvatarHtml = '';
                    if (post.authorAvatar) {
                        modalAvatarHtml = `<img src="${post.authorAvatar}" alt="${post.authorName || 'User'}" 
                                           onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'avatar-initial\'>${post.authorName ? post.authorName.charAt(0).toUpperCase() : 'U'}</div>';" />`;
                    } else {
                        modalAvatarHtml = `<div class="avatar-initial">${post.authorName ? post.authorName.charAt(0).toUpperCase() : 'U'}</div>`;
                    }

                    // Create images HTML for modal
                    let imagesHtml = '';
                    if (post.images && post.images.length > 0) {
                        imagesHtml = `<div class="post-images" style="margin: 15px 0;">`;
                        post.images.forEach((imageUrl, index) => {
                            imagesHtml += `
                                <img src="${imageUrl}" 
                                     alt="Post image ${index + 1}" 
                                     class="post-image"
                                     onclick="viewFullImage('${imageUrl}')"
                                     style="max-width: 150px; max-height: 150px; margin: 5px;"
                                     onerror="this.style.display='none'">
                            `;
                        });
                        imagesHtml += `</div>`;
                    }

                    const modalContent = document.getElementById('postDetailContent');
                    modalContent.innerHTML = `
                    <div class="post-detail">
                        <div class="post-header">
                            <div class="post-author">
                                <div class="author-avatar">
                                    ${modalAvatarHtml}
                                </div>
                                <div class="author-info">
                                    <h3>${post.authorName || 'Anonymous'} 
                                        ${post.isExpert ? '<span class="expert-tag">Expert</span>' : ''}
                                    </h3>
                                    <div class="post-time">${postDate}</div>
                                </div>
                            </div>
                            <div class="post-category">
                                ${post.category === 'disease' ? '<span class="category-tag tag-disease">Disease</span>' : ''}
                                ${post.category === 'treatment' ? '<span class="category-tag tag-treatment">Treatment</span>' : ''}
                                ${post.category === 'farming' ? '<span class="category-tag tag-farming">Farming</span>' : ''}
                                ${post.category === 'question' ? '<span class="category-tag tag-general">Question</span>' : ''}
                            </div>
                        </div>
                        
                        <h2>${post.title || 'Untitled'}</h2>
                        <div class="post-content" style="margin: 20px 0; padding: 20px; background: #f9f9f9; border-radius: 8px;">
                            ${post.content}
                        </div>
                        
                        ${imagesHtml}
                        
                        <div class="post-tags" style="margin-bottom: 20px;">
                            ${(post.tags || []).map(tag => `<span class="category-tag tag-general">${tag}</span>`).join('')}
                        </div>
                        
                        <div class="post-stats" style="margin-bottom: 20px;">
                            <div class="stat"><i class="fas fa-heart"></i> ${post.likesCount || 0} Likes</div>
                            <div class="stat"><i class="fas fa-comment"></i> ${post.repliesCount || 0} Replies</div>
                            <div class="stat"><i class="fas fa-thumbs-up"></i> ${post.upvotes ? post.upvotes.length : 0} Upvotes</div>
                            <div class="stat"><i class="fas fa-thumbs-down"></i> ${post.downvotes ? post.downvotes.length : 0} Downvotes</div>
                        </div>
                        
                        <div class="replies-section" id="detail-replies-${postId}">
                            <h3>Replies (${post.repliesCount || 0})</h3>
                            <div class="reply-input" style="margin: 20px 0;">
                                <textarea placeholder="Write your reply..." id="detail-reply-text" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"></textarea>
                                <button class="btn btn-primary" onclick="submitDetailReply('${postId}')" style="margin-top: 10px;">Post Reply</button>
                            </div>
                            <div class="replies-list" id="detail-replies-list-${postId}">
                                Loading replies...
                            </div>
                        </div>
                    </div>
                `;

                window.currentDetailPostId = postId;
                loadDetailReplies(postId);
                openModal('postDetailModal');

                }

            } catch (error) {
                console.error("Error loading post details:", error);
                alert("Failed to load post details.");
            }
        }

        // Load replies for detail view
        async function loadDetailReplies(postId) {
            try {
                const postRef = doc(db, "forum_posts", postId);
                const postDoc = await getDoc(postRef);

                if (postDoc.exists()) {
                    const postData = postDoc.data();
                    const replies = postData.replies || [];

                    const repliesList = document.getElementById(`detail-replies-list-${postId}`);
                    repliesList.innerHTML = '';

                    if (replies.length === 0) {
                        repliesList.innerHTML = '<p>No replies yet. Be the first to reply!</p>';
                        return;
                    }

                    replies.forEach(reply => {
                        const replyDate = reply.createdAt ? new Date(reply.createdAt.toDate()).toLocaleDateString() : 'Recent';

                        let detailReplyAvatarHtml = '';
                        if (reply.authorAvatar) {
                            detailReplyAvatarHtml = `<img src="${reply.authorAvatar}" alt="${reply.authorName || 'User'}" 
                                                     onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'avatar-initial\'>${reply.authorName ? reply.authorName.charAt(0).toUpperCase() : 'R'}</div>';" />`;
                        } else {
                            detailReplyAvatarHtml = `<div class="avatar-initial">${reply.authorName ? reply.authorName.charAt(0).toUpperCase() : 'R'}</div>`;
                        }

                        const replyCard = document.createElement('div');
                        replyCard.className = 'reply-card';
                        replyCard.innerHTML = `
                        <div class="reply-header">
                            <div class="reply-author">
                                <div class="author-avatar" style="width: 30px; height: 30px;">
                                    ${detailReplyAvatarHtml}
                                </div>
                                <div>
                                    <strong>${reply.authorName || 'Anonymous'}</strong>
                                    ${reply.isExpert ? '<span class="expert-tag">Expert</span>' : ''}
                                </div>
                            </div>
                            <div class="reply-time">${replyDate}</div>
                        </div>
                        <div class="reply-content">${reply.content}</div>
                    `;

                        repliesList.appendChild(replyCard);
                    });
                }

            } catch (error) {
                console.error("Error loading replies:", error);
            }
        }

        // Submit reply from detail view
        window.submitDetailReply = async function (postId) {
            const textarea = document.getElementById('detail-reply-text');
            const replyContent = textarea.value.trim();

            if (!replyContent) {
                alert("Please enter a reply.");
                return;
            }

            try {
                const userProfile = await getUserProfile(currentUser.uid);
                const postRef = doc(db, "forum_posts", postId);
                const post = posts.find(p => p.id === postId) || {};

                const replyData = {
                    content: replyContent,
                    authorId: currentUser.uid,
                    authorName: userProfile?.fullName || currentUser.email.split('@')[0],
                    authorAvatar: userProfile?.profileImage || null,
                    createdAt: serverTimestamp(),
                    isExpert: userProfile?.isExpert || false
                };

                await updateDoc(postRef, {
                    replies: arrayUnion(replyData),
                    repliesCount: (post.repliesCount || 0) + 1
                });

                textarea.value = '';
                loadDetailReplies(postId);
                await loadPosts();

            } catch (error) {
                console.error("Error submitting reply:", error);
                alert("Failed to submit reply. Please try again.");
            }
        }

        // Open edit post modal
        async function openEditPostModal(postId) {
            try {
                const postRef = doc(db, "forum_posts", postId);
                const postDoc = await getDoc(postRef);

                if (postDoc.exists()) {
                    const post = postDoc.data();
                    currentPostId = postId;

                    document.getElementById('editPostTitle').value = post.title || '';
                    document.getElementById('editPostContent').value = post.content || '';
                    document.getElementById('editPostCategory').value = post.category || 'general';
                    document.getElementById('editPostTags').value = (post.tags || []).join(', ');

                    openModal('editPostModal');
                }

            } catch (error) {
                console.error("Error loading post for editing:", error);
                alert("Failed to load post for editing.");
            }
        }

        // Image handling functions
        function handleImageUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (!file.type.match('image.*')) {
                    alert('Please select only image files.');
                    continue;
                }

                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    alert('Image size should be less than 5MB.');
                    continue;
                }

                fileToBase64(file).then(base64 => {
                    selectedImages.push(base64);
                    updateImagePreview();
                }).catch(error => {
                    console.error('Error converting file:', error);
                    alert('Error processing image.');
                });
            }
        }

        function updateImagePreview() {
            const previewContainer = document.getElementById('imagePreview');
            previewContainer.innerHTML = '';
            
            selectedImages.forEach((imageBase64, index) => {
                const imgContainer = document.createElement('div');
                imgContainer.style.display = 'inline-block';
                imgContainer.style.margin = '5px';
                imgContainer.style.position = 'relative';
                
                const img = document.createElement('img');
                img.src = imageBase64;
                img.style.maxWidth = '100px';
                img.style.maxHeight = '100px';
                img.style.borderRadius = '5px';
                
                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = '';
                removeBtn.style.position = 'absolute';
                removeBtn.style.top = '0';
                removeBtn.style.right = '0';
                removeBtn.style.background = 'rgba(255, 0, 0, 0.7)';
                removeBtn.style.color = 'white';
                removeBtn.style.border = 'none';
                removeBtn.style.borderRadius = '50%';
                removeBtn.style.width = '20px';
                removeBtn.style.height = '20px';
                removeBtn.style.cursor = 'pointer';
                removeBtn.onclick = () => removeImage(index);
                
                imgContainer.appendChild(img);
                imgContainer.appendChild(removeBtn);
                previewContainer.appendChild(imgContainer);
            });
        }

        function removeImage(index) {
            selectedImages.splice(index, 1);
            updateImagePreview();
        }

        async function startCamera() {
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                const video = document.getElementById('cameraView');
                video.srcObject = mediaStream;
                openModal('cameraModal');
            } catch (error) {
                console.error('Error accessing camera:', error);
                alert('Could not access camera. Please check permissions.');
            }
        }

        function capturePhoto() {
            const video = document.getElementById('cameraView');
            const canvas = document.getElementById('cameraCanvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageData = canvas.toDataURL('image/jpeg');
            selectedImages.push(imageData);
            updateImagePreview();
            
            stopCamera();
            closeModal('cameraModal');
        }

        function stopCamera() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
        }

        // Show no posts message
        function showNoPosts() {
            const postsGrid = document.getElementById('postsGrid');
            postsGrid.innerHTML = `
            <div class="no-data">
                <i class="fas fa-comments"></i>
                <h3>No Discussions Yet</h3>
                <p>Be the first to start a discussion!</p>
                <button class="btn btn-primary" id="createFirstPostBtn" style="margin-top: 15px;">
                    <i class="fas fa-plus"></i> Start Discussion
                </button>
            </div>
        `;

            document.getElementById('createFirstPostBtn').addEventListener('click', () => {
                document.getElementById('createPostSection').style.display = 'block';
                document.getElementById('postTitleInput').focus();
            });
        }

        // Show error message
        function showError(message) {
            const postsGrid = document.getElementById('postsGrid');
            postsGrid.innerHTML = `
            <div class="error-message" style="background-color: #ffebee; border: 1px solid #f44336; border-radius: 8px; padding: 20px; text-align: center;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #f44336; margin-bottom: 15px;"></i>
                <h3>Error Loading Discussions</h3>
                <p>${message}</p>
                <button class="btn btn-primary" id="retryBtn" style="margin-top: 15px;">
                    <i class="fas fa-redo"></i> Try Again
                </button>
            </div>
        `;

            document.getElementById('retryBtn').addEventListener('click', () => {
                loadPosts();
            });
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // New post button
            document.getElementById('newPostBtn').addEventListener('click', () => {
                const createPostSection = document.getElementById('createPostSection');
                createPostSection.style.display = createPostSection.style.display === 'none' ? 'block' : 'none';
                if (createPostSection.style.display === 'block') {
                    document.getElementById('postTitleInput').focus();
                }
            });

            // Cancel post button
            document.getElementById('cancelPostBtn').addEventListener('click', () => {
                document.getElementById('createPostSection').style.display = 'none';
                document.getElementById('postTitleInput').value = '';
                document.getElementById('postContentInput').value = '';
                document.getElementById('postTagsInput').value = '';
                document.getElementById('imagePreview').innerHTML = '';
                selectedImages = [];
                document.getElementById('imageUploadSection').style.display = 'none';
            });

            // Submit post button
            document.getElementById('submitPostBtn').addEventListener('click', () => {
                const title = document.getElementById('postTitleInput').value;
                const content = document.getElementById('postContentInput').value;
                const category = document.getElementById('postCategorySelect').value;
                const tags = document.getElementById('postTagsInput').value;
                createPost(title, content, category, tags, selectedImages);
            });

            // Toggle image upload section
            document.getElementById('toggleImageBtn').addEventListener('click', () => {
                const imageSection = document.getElementById('imageUploadSection');
                imageSection.style.display = imageSection.style.display === 'none' ? 'block' : 'none';
            });

            // Image upload
            document.getElementById('imageUpload').addEventListener('change', handleImageUpload);

            // Camera button
            document.getElementById('cameraBtn').addEventListener('click', startCamera);

            // Clear images button
            document.getElementById('clearImagesBtn').addEventListener('click', () => {
                selectedImages = [];
                document.getElementById('imagePreview').innerHTML = '';
            });

            // Capture photo
            document.getElementById('captureBtn').addEventListener('click', capturePhoto);

            // Retake photo
            document.getElementById('retakeBtn').addEventListener('click', () => {
                stopCamera();
                startCamera();
            });

            // Close camera modal
            document.getElementById('closeCameraBtn').addEventListener('click', () => {
                stopCamera();
                closeModal('cameraModal');
            });

            // Close image preview modal
            document.getElementById('closeImageModal').addEventListener('click', () => {
                closeModal('imagePreviewModal');
            });

            // Category tabs
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentFilters.category = tab.dataset.category;
                    loadPosts();
                });
            });

            // Filter modal
            document.getElementById('filterBtn').addEventListener('click', () => openModal('filterModal'));
            document.getElementById('closeFilterBtn').addEventListener('click', () => closeModal('filterModal'));
            document.getElementById('closePostModal').addEventListener('click', () => closeModal('postDetailModal'));
            document.getElementById('closeEditModal').addEventListener('click', () => closeModal('editPostModal'));
            document.getElementById('cancelEditBtn').addEventListener('click', () => closeModal('editPostModal'));

            // Apply filters
            document.getElementById('applyFiltersBtn').addEventListener('click', () => {
                currentFilters.category = document.getElementById('filterCategory').value;
                currentFilters.sort = document.getElementById('filterSort').value;
                currentFilters.time = document.getElementById('filterTime').value;

                closeModal('filterModal');
                loadPosts();
            });

            // Clear filters
            document.getElementById('clearFiltersBtn').addEventListener('click', () => {
                document.getElementById('filterCategory').value = 'all';
                document.getElementById('filterSort').value = 'newest';
                document.getElementById('filterTime').value = 'all';

                currentFilters = {
                    category: 'all',
                    sort: 'newest',
                    time: 'all'
                };

                document.querySelectorAll('.category-tab').forEach(tab => {
                    if (tab.dataset.category === 'all') {
                        tab.classList.add('active');
                    } else {
                        tab.classList.remove('active');
                    }
                });

                closeModal('filterModal');
                loadPosts();
            });

            // Save edit
            document.getElementById('saveEditBtn').addEventListener('click', () => {
                const title = document.getElementById('editPostTitle').value;
                const content = document.getElementById('editPostContent').value;
                const category = document.getElementById('editPostCategory').value;
                const tags = document.getElementById('editPostTags').value;

                if (currentPostId) {
                    updatePost(currentPostId, title, content, category, tags);
                }
            });

            // Logout functionality
            document.getElementById('logoutBtn').addEventListener('click', function (e) {
                e.preventDefault();
                signOut(auth).then(() => {
                    window.location.href = 'signin.html';
                }).catch((error) => {
                    console.error('Logout error:', error);
                });
            });

            // Close modals when clicking outside
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });
        });
    </script>
</body>
</html>