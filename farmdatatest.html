<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farm Data Management | Palm Aegis</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/homepage.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <style>
        :root {
            --primary-color: #2e7d32;
            --secondary-color: #4caf50;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --info-color: #2196f3;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .top-header {
            background-color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-left h1 {
            font-size: 1.8rem;
            color: var(--primary-color);
        }

        .search-box {
            display: flex;
            align-items: center;
            background-color: #f5f5f5;
            border-radius: 20px;
            padding: 8px 15px;
            width: 300px;
        }

        .search-box i {
            color: #777;
            margin-right: 10px;
        }

        .search-box input {
            border: none;
            background: transparent;
            outline: none;
            width: 100%;
        }

        .container {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 1.8rem;
            color: var(--primary-color);
        }

        .page-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #1b5e20;
        }

        .btn-secondary {
            background-color: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background-color: #d6d6d6;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .data-card {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .data-card:hover {
            transform: translateY(-5px);
        }

        .data-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .data-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .data-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-optimal {
            background-color: #e8f5e9;
            color: var(--primary-color);
        }

        .status-warning {
            background-color: #fff3e0;
            color: var(--warning-color);
        }

        .status-critical {
            background-color: #ffebee;
            color: var(--danger-color);
        }

        .data-body {
            padding: 15px;
        }

        .data-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
        }

        .info-label {
            color: #777;
        }

        .info-value {
            font-weight: 600;
        }

        .data-footer {
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }

        .data-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            background: none;
            border: none;
            color: #777;
            cursor: pointer;
            font-size: 1.1rem;
            transition: color 0.3s;
        }

        .action-btn:hover {
            color: var(--primary-color);
        }

        .data-details {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            padding: 25px;
            margin-top: 30px;
        }

        .details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .details-title {
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .details-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .details-section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--primary-color);
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .data-list {
            list-style: none;
        }

        .data-item {
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .data-name {
            font-weight: 600;
        }

        .data-confidence {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
        }

        .recommendation-plan {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .recommendation-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .affected-areas {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .area-tag {
            padding: 5px 10px;
            background-color: #e3f2fd;
            border-radius: 15px;
            font-size: 0.8rem;
            color: var(--info-color);
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #777;
            grid-column: 1 / -1;
        }

        .no-data i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #ddd;
        }

        .loading {
            text-align: center;
            padding: 40px;
            grid-column: 1 / -1;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background-color: #ffebee;
            border: 1px solid #f44336;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            grid-column: 1 / -1;
        }

        .error-message i {
            font-size: 2rem;
            color: #f44336;
            margin-bottom: 15px;
        }

        /* Analytics Section */
        .analytics-section {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            padding: 25px;
            margin-top: 30px;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .analytics-card {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .analytics-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }

        .analytics-label {
            color: #777;
            font-size: 0.9rem;
        }

        /* Form Styles */
        .form-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .form-modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .form-title {
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .close-form {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #777;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid #ddd;
            color: #333;
        }

        .btn-outline:hover {
            background-color: #f5f5f5;
        }

        /* Filter Modal Styles */
        .filter-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .filter-modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .filter-title {
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .close-filter {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #777;
        }

        .filter-options {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .filter-label {
            font-weight: 600;
            color: #555;
        }

        .filter-select, .filter-input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .filter-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        @media (max-width: 768px) {
            .dashboard-container {
                flex-direction: column;
            }

            .main-content { width: 100%; }
            .details-content {
                grid-template-columns: 1fr;
            }

            .data-grid {
                grid-template-columns: 1fr;
            }

            .filter-modal-content, .form-modal-content {
                width: 95%;
                margin: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div id="sidebarPlaceholder"></div>
        <script src="js/sidebar-loader.js"></script>

        <main class="main-content">
            <div class="top-header">
                <div class="header-left">
                    <h1>Farm Data Management</h1>
                </div>
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search farm data..." id="searchInput">
                </div>
            </div>

            <div class="container">
                <div class="page-header">
                    <h2 class="page-title">Farm Data & Analytics</h2>
                    <div class="page-actions">
                        <button class="btn btn-secondary" id="filterBtn">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                        <button class="btn btn-primary" id="addDataBtn">
                            <i class="fas fa-plus"></i> Add Data
                        </button>
                    </div>
                </div>

                <div class="analytics-section">
                    <h2 class="section-title">Farm Analytics Overview</h2>
                    <div class="analytics-grid" id="analyticsGrid">
                        <div class="analytics-card">
                            <i class="fas fa-seedling" style="font-size: 2rem; color: var(--primary-color);"></i>
                            <div class="analytics-value" id="totalCrops">0</div>
                            <div class="analytics-label">Total Crops Tracked</div>
                        </div>
                        <div class="analytics-card">
                            <i class="fas fa-tint" style="font-size: 2rem; color: var(--info-color);"></i>
                            <div class="analytics-value" id="avgSoilQuality">0%</div>
                            <div class="analytics-label">Average Soil Quality</div>
                        </div>
                        <div class="analytics-card">
                            <i class="fas fa-cloud-sun" style="font-size: 2rem; color: var(--warning-color);"></i>
                            <div class="analytics-value" id="optimalConditions">0</div>
                            <div class="analytics-label">Optimal Conditions</div>
                        </div>
                        <div class="analytics-card">
                            <i class="fas fa-chart-line" style="font-size: 2rem; color: var(--secondary-color);"></i>
                            <div class="analytics-value" id="yieldIncrease">0%</div>
                            <div class="analytics-label">Projected Yield Increase</div>
                        </div>
                    </div>
                </div>

                <div class="data-grid" id="dataGrid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading farm data...</p>
                    </div>
                </div>

                <div class="data-details" id="dataDetails" style="display: none;">
                    <div class="details-header">
                        <h2 class="details-title" id="detailsTitle">Farm Data Details</h2>
                        <div>
                            <button class="btn btn-secondary" id="editDataBtn">
                                <i class="fas fa-edit"></i> Edit Data
                            </button>
                            <button class="btn btn-secondary" id="closeDetailsBtn">
                                <i class="fas fa-times"></i> Close
                            </button>
                        </div>
                    </div>
                    <div class="details-content">
                        <div class="details-column">
                            <div class="details-section">
                                <h3 class="section-title">Basic Information</h3>
                                <div class="data-info">
                                    <div class="info-item">
                                        <span class="info-label">Data ID:</span>
                                        <span class="info-value" id="detailId">-</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Date Recorded:</span>
                                        <span class="info-value" id="detailDate">-</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Location:</span>
                                        <span class="info-value" id="detailLocation">-</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Crop Type:</span>
                                        <span class="info-value" id="detailCropType">-</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="details-section">
                                <h3 class="section-title">Soil Quality</h3>
                                <div class="data-info">
                                    <div class="info-item">
                                        <span class="info-label">pH Level:</span>
                                        <span class="info-value" id="detailPH">-</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Nutrient Level:</span>
                                        <span class="info-value" id="detailNutrients">-</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Moisture:</span>
                                        <span class="info-value" id="detailMoisture">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="details-column">
                            <div class="details-section">
                                <h3 class="section-title">Weather Conditions</h3>
                                <div class="data-info">
                                    <div class="info-item">
                                        <span class="info-label">Temperature:</span>
                                        <span class="info-value" id="detailTemperature">-</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Humidity:</span>
                                        <span class="info-value" id="detailHumidity">-</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Rainfall:</span>
                                        <span class="info-value" id="detailRainfall">-</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="details-section">
                                <h3 class="section-title">Irrigation & Schedule</h3>
                                <div class="data-info">
                                    <div class="info-item">
                                        <span class="info-label">Last Irrigation:</span>
                                        <span class="info-value" id="detailLastIrrigation">-</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Next Irrigation:</span>
                                        <span class="info-value" id="detailNextIrrigation">-</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Schedule Type:</span>
                                        <span class="info-value" id="detailScheduleType">-</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="details-section">
                                <h3 class="section-title">Recommendations</h3>
                                <div class="recommendation-plan">
                                    <div class="recommendation-title">Optimization Suggestions:</div>
                                    <div id="detailRecommendations">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add Data Modal -->
    <div class="form-modal" id="addDataModal">
        <div class="form-modal-content">
            <div class="form-header">
                <h2 class="form-title">Add Farm Data</h2>
                <button class="close-form" id="closeAddDataBtn">&times;</button>
            </div>
            <form id="farmDataForm">
                <div class="form-group">
                    <label class="form-label" for="cropType">Crop Type</label>
                    <select class="form-select" id="cropType" required>
                        <option value="">Select Crop Type</option>
                        <option value="palm">Palm Tree</option>
                        <option value="rice">Rice</option>
                        <option value="corn">Corn</option>
                        <option value="vegetables">Vegetables</option>
                        <option value="fruits">Fruits</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="location">Location</label>
                    <input type="text" class="form-input" id="location" placeholder="Enter location" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="soilPH">Soil pH Level</label>
                    <input type="number" class="form-input" id="soilPH" min="0" max="14" step="0.1" placeholder="Enter pH level" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="nutrientLevel">Nutrient Level</label>
                    <select class="form-select" id="nutrientLevel" required>
                        <option value="">Select Nutrient Level</option>
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="soilMoisture">Soil Moisture (%)</label>
                    <input type="number" class="form-input" id="soilMoisture" min="0" max="100" placeholder="Enter moisture percentage" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="temperature">Temperature (Â°C)</label>
                    <input type="number" class="form-input" id="temperature" placeholder="Enter temperature" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="humidity">Humidity (%)</label>
                    <input type="number" class="form-input" id="humidity" min="0" max="100" placeholder="Enter humidity percentage" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="rainfall">Rainfall (mm)</label>
                    <input type="number" class="form-input" id="rainfall" min="0" placeholder="Enter rainfall amount" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="irrigationSchedule">Irrigation Schedule</label>
                    <select class="form-select" id="irrigationSchedule" required>
                        <option value="">Select Schedule</option>
                        <option value="daily">Daily</option>
                        <option value="every_other_day">Every Other Day</option>
                        <option value="twice_weekly">Twice Weekly</option>
                        <option value="weekly">Weekly</option>
                        <option value="as_needed">As Needed</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="cropHistory">Crop History Notes</label>
                    <textarea class="form-textarea" id="cropHistory" placeholder="Enter crop history and observations"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" id="cancelAddDataBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Data</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Filter Modal -->
    <div class="filter-modal" id="filterModal">
        <div class="filter-modal-content">
            <div class="filter-header">
                <h2 class="filter-title">Filter Farm Data</h2>
                <button class="close-filter" id="closeFilterBtn">&times;</button>
            </div>
            <div class="filter-options">
                <div class="filter-group">
                    <label class="filter-label">Crop Type</label>
                    <select class="filter-select" id="cropTypeFilter">
                        <option value="all">All Crops</option>
                        <option value="palm">Palm Tree</option>
                        <option value="rice">Rice</option>
                        <option value="corn">Corn</option>
                        <option value="vegetables">Vegetables</option>
                        <option value="fruits">Fruits</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Soil Quality</label>
                    <select class="filter-select" id="soilQualityFilter">
                        <option value="all">All Qualities</option>
                        <option value="optimal">Optimal</option>
                        <option value="needs_attention">Needs Attention</option>
                        <option value="poor">Poor</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Date Range</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="date" class="filter-input" id="dateFrom" style="flex: 1;">
                        <input type="date" class="filter-input" id="dateTo" style="flex: 1;">
                    </div>
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn btn-outline" id="clearFiltersBtn">Clear Filters</button>
                <button class="btn btn-primary" id="applyFiltersBtn">Apply Filters</button>
            </div>
        </div>
    </div>

    <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js'; 
    import { getFirestore, doc, getDoc, collection, getDocs, addDoc, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAf-wtZpl8wVjCymdLlC-YGlv7xn0yEMMU",
        authDomain: "palmaegis-setup.firebaseapp.com",
        projectId: "palmaegis-setup",
        storageBucket: "palmaegis-setup.firebasestorage.app",
        messagingSenderId: "445887502374",
        appId: "1:445887502374:web:a5f6ecaa90b88447626ee7"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Global variables for filtering
    let currentFilters = {
        cropType: 'all',
        soilQuality: 'all',
        dateFrom: '',
        dateTo: ''
    };

    // Check authentication state
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            console.log('User is signed in:', user.email);
            window.currentUser = user;
            
            try {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    window.userData = userData;
                    updateUserProfile(user, userData);
                } else {
                    updateUserProfile(user, {});
                }
                
                // Load farm data
                await loadFarmData(user.uid);
            } catch (error) {
                console.error('Error loading user data:', error);
                updateUserProfile(user, {});
                showError("Failed to load user data. Please try again.");
            }
        } else {
            console.log('User is not signed in');
            window.location.href = 'signin.html';
        }
    });

    function updateUserProfile(user, userData) {
        const userNameElement = document.querySelector('.user-name');
        const userRoleElement = document.querySelector('.user-role');

        const displayName = userData.firstName && userData.lastName 
            ? `${userData.firstName} ${userData.lastName}`
            : userData.username 
            ? userData.username
            : userData.displayName || user.displayName || user.email.split('@')[0] || 'User';

        if (userNameElement) userNameElement.textContent = displayName;
        if (userRoleElement) userRoleElement.textContent = userData.bio || 'Farmer';

        // set avatar(s) safely (use base64/photoURL/picture or fall back to default)
        const avatarSrc = userData.imageBase64 || userData.picture || userData.photoURL || 'images/user-avatar.jpg';
        const avatars = document.querySelectorAll('.user-avatar');
        avatars.forEach(img => {
            if (img) {
                img.src = avatarSrc;
                img.onerror = () => { img.src = 'images/default-avatar.png'; };
            }
        });

        // store for later in case sidebar is loaded after profile
        window.userData = userData;
    }

    // If sidebar is loaded after user data, re-apply avatar when sidebar is inserted
    if (window.__sidebarLoaded) {
        // sidebar might already be present
        if (window.userData) updateUserProfile(window.currentUser, window.userData);
    } else {
        window.addEventListener('sidebar:loaded', () => {
            if (window.currentUser) updateUserProfile(window.currentUser, window.userData || {});
        }, { once: true });
    }

    // Show error message
    function showError(message) {
        const dataGrid = document.getElementById('dataGrid');
        dataGrid.innerHTML = `
            <div class="error-message">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Error Loading Farm Data</h3>
                <p>${message}</p>
                <button class="btn btn-primary" id="retryBtn" style="margin-top: 15px;">
                    <i class="fas fa-redo"></i> Try Again
                </button>
            </div>
        `;
        
        document.getElementById('retryBtn').addEventListener('click', () => {
            if (window.currentUser) {
                loadFarmData(window.currentUser.uid);
            }
        });
    }

    // Show no data message
    function showNoData() {
        const dataGrid = document.getElementById('dataGrid');
        dataGrid.innerHTML = `
            <div class="no-data">
                <i class="fas fa-tractor"></i>
                <h3>No Farm Data Available</h3>
                <p>Add your first farm data entry to get started with tracking and analytics.</p>
                <button class="btn btn-primary" id="createDataBtn" style="margin-top: 15px;">
                    <i class="fas fa-plus"></i> Add Farm Data
                </button>
            </div>
        `;
        
        document.getElementById('createDataBtn').addEventListener('click', openAddDataModal);
    }

    // Load farm data from Firebase
    async function loadFarmData(userId) {
        try {
            const dataGrid = document.getElementById('dataGrid');
            dataGrid.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading farm data...</p>
                </div>
            `;

            console.log("Loading farm data for user:", userId);
            
            const farmDataRef = collection(db, "farmData");
            
            // Try different query approaches
            let querySnapshot;
            try {
                // First try: Query with user filter and ordering
                const q = query(farmDataRef, where("userId", "==", userId), orderBy("timestamp", "desc"));
                querySnapshot = await getDocs(q);
            } catch (queryError) {
                console.log("First query failed, trying without ordering:", queryError);
                
                // Second try: Query without ordering (in case timestamp field doesn't exist)
                try {
                    const q = query(farmDataRef, where("userId", "==", userId));
                    querySnapshot = await getDocs(q);
                } catch (secondError) {
                    console.log("Second query failed, trying to get all farm data:", secondError);
                    
                    // Third try: Get all farm data and filter client-side
                    querySnapshot = await getDocs(farmDataRef);
                    // Filter by userId manually
                    const filteredDocs = [];
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.userId === userId) {
                            filteredDocs.push({...doc, data: () => data});
                        }
                    });
                    // Create a mock querySnapshot
                    querySnapshot = {
                        empty: filteredDocs.length === 0,
                        forEach: (callback) => filteredDocs.forEach(callback),
                        size: filteredDocs.length
                    };
                }
            }
            
            console.log("Found farm data entries:", querySnapshot.size);
            
            if (querySnapshot.empty) {
                showNoData();
                updateAnalytics([]);
                return;
            }
            
            dataGrid.innerHTML = '';
            
            const allFarmData = [];
            querySnapshot.forEach((doc) => {
                const farmData = doc.data ? doc.data() : doc;
                allFarmData.push({farmData, docId: doc.id});
            });
            
            // Store all farm data for filtering
            window.allFarmData = allFarmData;
            
            // Update analytics
            updateAnalytics(allFarmData);
            
            // Apply any existing filters
            applyFilters();
            
        } catch (error) {
            console.error("Error loading farm data: ", error);
            
            // More specific error messages
            if (error.code === 'permission-denied') {
                showError("Database permission denied. Please contact support.");
            } else if (error.code === 'unavailable') {
                showError("Network error. Please check your internet connection.");
            } else if (error.message && error.message.includes('index')) {
                showError("Database indexing issue. Please try creating farm data first.");
            } else {
                showError("Unable to load farm data. Please try adding farm data first.");
            }
        }
    }

    // Update analytics with farm data
    function updateAnalytics(farmData) {
        if (!farmData || farmData.length === 0) {
            document.getElementById('totalCrops').textContent = '0';
            document.getElementById('avgSoilQuality').textContent = '0%';
            document.getElementById('optimalConditions').textContent = '0';
            document.getElementById('yieldIncrease').textContent = '0%';
            return;
        }
        
        // Calculate analytics
        const totalCrops = farmData.length;
        
        // Calculate average soil quality (simplified)
        let totalQuality = 0;
        let optimalCount = 0;
        
        farmData.forEach(({farmData}) => {
            // Simplified soil quality calculation based on pH and nutrients
            let qualityScore = 0;
            
            // pH scoring (optimal range 6.0-7.0)
            if (farmData.soilPH >= 6.0 && farmData.soilPH <= 7.0) {
                qualityScore += 50;
            } else if (farmData.soilPH >= 5.5 && farmData.soilPH <= 7.5) {
                qualityScore += 30;
            } else {
                qualityScore += 10;
            }
            
            // Nutrient level scoring
            if (farmData.nutrientLevel === 'high') {
                qualityScore += 40;
            } else if (farmData.nutrientLevel === 'medium') {
                qualityScore += 25;
            } else {
                qualityScore += 10;
            }
            
            // Moisture scoring (optimal 40-60%)
            if (farmData.soilMoisture >= 40 && farmData.soilMoisture <= 60) {
                qualityScore += 10;
            } else if (farmData.soilMoisture >= 30 && farmData.soilMoisture <= 70) {
                qualityScore += 5;
            }
            
            totalQuality += qualityScore;
            
            // Count optimal conditions (quality > 80)
            if (qualityScore > 80) {
                optimalCount++;
            }
        });
        
        const avgSoilQuality = Math.round(totalQuality / farmData.length);
        const projectedYieldIncrease = Math.min(25, Math.round(avgSoilQuality / 4));
        
        // Update analytics display
        document.getElementById('totalCrops').textContent = totalCrops;
        document.getElementById('avgSoilQuality').textContent = `${avgSoilQuality}%`;
        document.getElementById('optimalConditions').textContent = optimalCount;
        document.getElementById('yieldIncrease').textContent = `${projectedYieldIncrease}%`;
    }

    // Apply filters to farm data
    function applyFilters() {
        const dataGrid = document.getElementById('dataGrid');
        dataGrid.innerHTML = '';
        
        if (!window.allFarmData || window.allFarmData.length === 0) {
            showNoData();
            return;
        }
        
        const filteredData = window.allFarmData.filter(({farmData, docId}) => {
            // Crop type filter
            if (currentFilters.cropType !== 'all' && farmData.cropType !== currentFilters.cropType) {
                return false;
            }
            
            // Soil quality filter
            if (currentFilters.soilQuality !== 'all') {
                const qualityStatus = getQualityStatus(farmData);
                if (currentFilters.soilQuality !== qualityStatus) {
                    return false;
                }
            }
            
            // Date filter
            if (currentFilters.dateFrom || currentFilters.dateTo) {
                let dataDate;
                try {
                    if (farmData.date) {
                        dataDate = new Date(farmData.date);
                    } else if (farmData.timestamp) {
                        dataDate = new Date(farmData.timestamp.toDate());
                    } else {
                        dataDate = new Date();
                    }
                } catch (dateError) {
                    dataDate = new Date();
                }
                
                if (currentFilters.dateFrom) {
                    const fromDate = new Date(currentFilters.dateFrom);
                    if (dataDate < fromDate) return false;
                }
                
                if (currentFilters.dateTo) {
                    const toDate = new Date(currentFilters.dateTo);
                    toDate.setHours(23, 59, 59, 999); // End of the day
                    if (dataDate > toDate) return false;
                }
            }
            
            return true;
        });
        
        if (filteredData.length === 0) {
            dataGrid.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-filter"></i>
                    <h3>No Farm Data Matches Your Filters</h3>
                    <p>Try adjusting your filter criteria to see more results.</p>
                    <button class="btn btn-primary" id="clearFilterResultsBtn" style="margin-top: 15px;">
                        <i class="fas fa-times"></i> Clear Filters
                    </button>
                </div>
            `;
            
            document.getElementById('clearFilterResultsBtn').addEventListener('click', clearFilters);
        } else {
            filteredData.forEach(({farmData, docId}) => {
                createDataCard(farmData, docId);
            });
        }
    }

    // Get quality status for farm data
    function getQualityStatus(farmData) {
        // Simplified quality calculation
        let qualityScore = 0;
        
        // pH scoring (optimal range 6.0-7.0)
        if (farmData.soilPH >= 6.0 && farmData.soilPH <= 7.0) {
            qualityScore += 50;
        } else if (farmData.soilPH >= 5.5 && farmData.soilPH <= 7.5) {
            qualityScore += 30;
        } else {
            qualityScore += 10;
        }
        
        // Nutrient level scoring
        if (farmData.nutrientLevel === 'high') {
            qualityScore += 40;
        } else if (farmData.nutrientLevel === 'medium') {
            qualityScore += 25;
        } else {
            qualityScore += 10;
        }
        
        // Moisture scoring (optimal 40-60%)
        if (farmData.soilMoisture >= 40 && farmData.soilMoisture <= 60) {
            qualityScore += 10;
        } else if (farmData.soilMoisture >= 30 && farmData.soilMoisture <= 70) {
            qualityScore += 5;
        }
        
        if (qualityScore > 80) return 'optimal';
        if (qualityScore > 50) return 'needs_attention';
        return 'poor';
    }

    // Get status information for farm data
    function getStatusInfo(farmData) {
        const qualityStatus = getQualityStatus(farmData);
        
        let statusClass = "status-optimal";
        let statusText = "Optimal";
        
        if (qualityStatus === 'needs_attention') {
            statusClass = "status-warning";
            statusText = "Needs Attention";
        } else if (qualityStatus === 'poor') {
            statusClass = "status-critical";
            statusText = "Poor";
        }
        
        return { statusClass, statusText };
    }

    // Clear all filters
    function clearFilters() {
        currentFilters = {
            cropType: 'all',
            soilQuality: 'all',
            dateFrom: '',
            dateTo: ''
        };
        
        // Reset filter inputs
        document.getElementById('cropTypeFilter').value = 'all';
        document.getElementById('soilQualityFilter').value = 'all';
        document.getElementById('dateFrom').value = '';
        document.getElementById('dateTo').value = '';
        
        applyFilters();
        closeFilterModal();
    }

    // Open filter modal
    function openFilterModal() {
        document.getElementById('filterModal').style.display = 'flex';
    }

    // Close filter modal
    function closeFilterModal() {
        document.getElementById('filterModal').style.display = 'none';
    }

    // Open add data modal
    function openAddDataModal() {
        document.getElementById('addDataModal').style.display = 'flex';
    }

    // Close add data modal
    function closeAddDataModal() {
        document.getElementById('addDataModal').style.display = 'none';
        document.getElementById('farmDataForm').reset();
    }

    // Create a data card for each farm data entry
    function createDataCard(farmData, docId) {
        const dataGrid = document.getElementById('dataGrid');
        
        const { statusClass, statusText } = getStatusInfo(farmData);
        
        // Format date safely
        let dataDate = 'Not specified';
        try {
            if (farmData.date) {
                dataDate = new Date(farmData.date).toLocaleDateString();
            } else if (farmData.timestamp) {
                dataDate = new Date(farmData.timestamp.toDate()).toLocaleDateString();
            }
        } catch (dateError) {
            console.log("Date parsing error:", dateError);
        }
        
        const dataCard = document.createElement('div');
        dataCard.className = 'data-card';
        dataCard.setAttribute('data-id', docId);
        
        dataCard.innerHTML = `
            <div class="data-header">
                <div class="data-title">${farmData.cropType ? farmData.cropType.charAt(0).toUpperCase() + farmData.cropType.slice(1) : 'Unknown'} Crop</div>
                <div class="data-status ${statusClass}">${statusText}</div>
            </div>
            <div class="data-body">
                <div class="data-info">
                    <div class="info-item">
                        <span class="info-label">Date:</span>
                        <span class="info-value">${dataDate}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Location:</span>
                        <span class="info-value">${farmData.location || 'Not specified'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Soil pH:</span>
                        <span class="info-value">${farmData.soilPH || 'Not measured'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Nutrients:</span>
                        <span class="info-value">${farmData.nutrientLevel ? farmData.nutrientLevel.charAt(0).toUpperCase() + farmData.nutrientLevel.slice(1) : 'Unknown'}</span>
                    </div>
                </div>
            </div>
            <div class="data-footer">
                <div class="data-date">${dataDate}</div>
                <div class="data-actions">
                    <button class="action-btn view-details" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="action-btn edit-data" title="Edit Data">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
            </div>
        `;
        
        dataGrid.appendChild(dataCard);
        
        // Add event listener for view details
        const viewBtn = dataCard.querySelector('.view-details');
        viewBtn.addEventListener('click', () => {
            showDataDetails(farmData, docId);
        });
        
        // Add event listener for edit data
        const editBtn = dataCard.querySelector('.edit-data');
        editBtn.addEventListener('click', () => {
            editData(farmData, docId);
        });
    }

    // Show detailed data view
    function showDataDetails(farmData, docId) {
        const detailsPanel = document.getElementById('dataDetails');
        const dataGrid = document.getElementById('dataGrid');
        
        // Hide data grid and show details
        dataGrid.style.display = 'none';
        detailsPanel.style.display = 'block';
        
        // Store current farm data for editing
        window.currentFarmData = farmData;
        window.currentFarmDataId = docId;
        
        // Populate details with safe defaults
        document.getElementById('detailsTitle').textContent = `${farmData.cropType ? farmData.cropType.charAt(0).toUpperCase() + farmData.cropType.slice(1) : 'Unknown'} Crop Data`;
        document.getElementById('detailId').textContent = docId || 'Not specified';
        
        let dataDate = 'Not specified';
        try {
            if (farmData.date) {
                dataDate = new Date(farmData.date).toLocaleDateString();
            } else if (farmData.timestamp) {
                dataDate = new Date(farmData.timestamp.toDate()).toLocaleDateString();
            }
        } catch (dateError) {
            console.log("Date parsing error:", dateError);
        }
        
        document.getElementById('detailDate').textContent = dataDate;
        document.getElementById('detailLocation').textContent = farmData.location || 'Not specified';
        document.getElementById('detailCropType').textContent = farmData.cropType ? farmData.cropType.charAt(0).toUpperCase() + farmData.cropType.slice(1) : 'Not specified';
        document.getElementById('detailPH').textContent = farmData.soilPH || 'Not measured';
        document.getElementById('detailNutrients').textContent = farmData.nutrientLevel ? farmData.nutrientLevel.charAt(0).toUpperCase() + farmData.nutrientLevel.slice(1) : 'Unknown';
        document.getElementById('detailMoisture').textContent = farmData.soilMoisture ? `${farmData.soilMoisture}%` : 'Not measured';
        document.getElementById('detailTemperature').textContent = farmData.temperature ? `${farmData.temperature}Â°C` : 'Not recorded';
        document.getElementById('detailHumidity').textContent = farmData.humidity ? `${farmData.humidity}%` : 'Not recorded';
        document.getElementById('detailRainfall').textContent = farmData.rainfall ? `${farmData.rainfall}mm` : 'Not recorded';
        document.getElementById('detailLastIrrigation').textContent = farmData.lastIrrigation || 'Not recorded';
        document.getElementById('detailNextIrrigation').textContent = farmData.nextIrrigation || 'Not scheduled';
        document.getElementById('detailScheduleType').textContent = farmData.irrigationSchedule ? farmData.irrigationSchedule.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Not specified';
        
        // Generate recommendations based on data
        const recommendations = generateRecommendations(farmData);
        document.getElementById('detailRecommendations').textContent = recommendations;
    }

    // Generate recommendations based on farm data
    function generateRecommendations(farmData) {
        let recommendations = [];
        
        // pH recommendations
        if (farmData.soilPH < 6.0) {
            recommendations.push("Consider adding lime to increase soil pH.");
        } else if (farmData.soilPH > 7.0) {
            recommendations.push("Consider adding sulfur to decrease soil pH.");
        }
        
        // Nutrient recommendations
        if (farmData.nutrientLevel === 'low') {
            recommendations.push("Apply fertilizer to improve nutrient levels.");
        } else if (farmData.nutrientLevel === 'high') {
            recommendations.push("Reduce fertilizer application to avoid nutrient burn.");
        }
        
        // Moisture recommendations
        if (farmData.soilMoisture < 30) {
            recommendations.push("Increase irrigation frequency to improve soil moisture.");
        } else if (farmData.soilMoisture > 70) {
            recommendations.push("Reduce irrigation to prevent waterlogging.");
        }
        
        // Temperature recommendations
        if (farmData.temperature > 35) {
            recommendations.push("Consider shade options during peak heat hours.");
        } else if (farmData.temperature < 10) {
            recommendations.push("Consider protective covers during cold periods.");
        }
        
        if (recommendations.length === 0) {
            return "Current conditions appear optimal. Continue current practices.";
        }
        
        return recommendations.join(" ");
    }

    // Edit data function
    function editData(farmData, docId) {
        // For now, just show the details and enable editing
        showDataDetails(farmData, docId);
        
        // In a real implementation, you would:
        // 1. Populate the form with existing data
        // 2. Change the form to update mode
        // 3. Handle the update in Firebase
        alert("Edit functionality would be implemented here. For now, please add new data entries.");
    }

    // Save farm data to Firebase
    async function saveFarmData(formData) {
        try {
            const userId = window.currentUser.uid;
            
            const farmData = {
                userId: userId,
                cropType: formData.cropType,
                location: formData.location,
                soilPH: parseFloat(formData.soilPH),
                nutrientLevel: formData.nutrientLevel,
                soilMoisture: parseInt(formData.soilMoisture),
                temperature: parseInt(formData.temperature),
                humidity: parseInt(formData.humidity),
                rainfall: parseInt(formData.rainfall),
                irrigationSchedule: formData.irrigationSchedule,
                cropHistory: formData.cropHistory,
                timestamp: new Date()
            };
            
            // Add document to farmData collection
            const docRef = await addDoc(collection(db, "farmData"), farmData);
            console.log("Farm data saved with ID: ", docRef.id);
            
            // Reload farm data
            await loadFarmData(userId);
            
            // Close modal
            closeAddDataModal();
            
            // Show success message
            alert("Farm data saved successfully!");
            
        } catch (error) {
            console.error("Error saving farm data: ", error);
            alert("Error saving farm data. Please try again.");
        }
    }

    // Event Listeners
    document.getElementById('filterBtn').addEventListener('click', openFilterModal);
    document.getElementById('closeFilterBtn').addEventListener('click', closeFilterModal);
    document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
    
    document.getElementById('applyFiltersBtn').addEventListener('click', () => {
        currentFilters.cropType = document.getElementById('cropTypeFilter').value;
        currentFilters.soilQuality = document.getElementById('soilQualityFilter').value;
        currentFilters.dateFrom = document.getElementById('dateFrom').value;
        currentFilters.dateTo = document.getElementById('dateTo').value;
        
        applyFilters();
        closeFilterModal();
    });

    // Add data modal events
    document.getElementById('addDataBtn').addEventListener('click', openAddDataModal);
    document.getElementById('closeAddDataBtn').addEventListener('click', closeAddDataModal);
    document.getElementById('cancelAddDataBtn').addEventListener('click', closeAddDataModal);
    
    // Form submission
    document.getElementById('farmDataForm').addEventListener('submit', (e) => {
        e.preventDefault();
        
        const formData = {
            cropType: document.getElementById('cropType').value,
            location: document.getElementById('location').value,
            soilPH: document.getElementById('soilPH').value,
            nutrientLevel: document.getElementById('nutrientLevel').value,
            soilMoisture: document.getElementById('soilMoisture').value,
            temperature: document.getElementById('temperature').value,
            humidity: document.getElementById('humidity').value,
            rainfall: document.getElementById('rainfall').value,
            irrigationSchedule: document.getElementById('irrigationSchedule').value,
            cropHistory: document.getElementById('cropHistory').value
        };
        
        saveFarmData(formData);
    });

    // Close details view
    document.getElementById('closeDetailsBtn').addEventListener('click', () => {
        const detailsPanel = document.getElementById('dataDetails');
        const dataGrid = document.getElementById('dataGrid');
        
        detailsPanel.style.display = 'none';
        dataGrid.style.display = 'grid';
    });

    // Edit data button
    document.getElementById('editDataBtn').addEventListener('click', () => {
        if (window.currentFarmData) {
            editData(window.currentFarmData, window.currentFarmDataId);
        }
    });

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const dataCards = document.querySelectorAll('.data-card');
        
        dataCards.forEach(card => {
            const title = card.querySelector('.data-title').textContent.toLowerCase();
            const infoValues = card.querySelectorAll('.info-value');
            const location = infoValues[1] ? infoValues[1].textContent.toLowerCase() : '';
            const status = card.querySelector('.data-status').textContent.toLowerCase();
            
            if (title.includes(searchTerm) || location.includes(searchTerm) || status.includes(searchTerm)) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    });

    // Logout functionality
    document.getElementById('logoutBtn').addEventListener('click', function(e) {
        e.preventDefault();
        signOut(auth).then(() => {
            window.location.href = 'signin.html';
        }).catch((error) => {
            console.error('Logout error:', error);
        });
    });

    // Close modals when clicking outside
    document.getElementById('filterModal').addEventListener('click', (e) => {
        if (e.target.id === 'filterModal') {
            closeFilterModal();
        }
    });
    
    document.getElementById('addDataModal').addEventListener('click', (e) => {
        if (e.target.id === 'addDataModal') {
            closeAddDataModal();
        }
    });
</script>
</body>
</html>