<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PalmAegis - Oil Palm Health Detection</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js"></script>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #10B981;
            --success-color: #10B981;
            --warning-color: #F59E0B;
            --danger-color: #EF4444;
            --healthy-color: #3B82F6;
            --background-color: #F9FAFB;
            --card-color: #FFFFFF;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --border-color: #E5E7EB;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background-color: var(--background-color);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--primary-color) !important;
        }
        
        .card {
            border: none;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            margin-bottom: 24px;
            overflow: hidden;
        }
        
        .card-header {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
            border: none;
            padding: 24px;
            border-radius: 20px 20px 0 0 !important;
        }
        
        .form-control, .form-select {
            border-radius: 12px;
            border: 1px solid var(--border-color);
            padding: 12px 16px;
            background-color: var(--background-color);
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(16, 185, 129, 0.25);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 500;
        }
        
        .btn-primary:hover {
            background-color: #0DA271;
        }
        
        .btn-outline-primary {
            border-color: var(--primary-color);
            color: var(--primary-color);
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 500;
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .status-card {
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 24px;
            border: 2px solid;
        }
        
        .status-healthy {
            background-color: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
        }
        
        .status-at-risk {
            background-color: rgba(245, 158, 11, 0.1);
            border-color: rgba(245, 158, 11, 0.3);
        }
        
        .status-no-palm {
            background-color: var(--background-color);
            border-color: var(--border-color);
        }
        
        .status-error {
            background-color: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
        }
        
        .image-upload-area {
            height: 300px;
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            background-color: var(--background-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            overflow: hidden;
        }
        
        .image-upload-area:hover {
            border-color: var(--primary-color);
            background-color: rgba(16, 185, 129, 0.05);
        }
        
        .image-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .detection-item {
            padding: 16px;
            border-radius: 12px;
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            margin-bottom: 12px;
        }
        
        .detection-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
        }
        
        .ganoderma-icon {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--primary-color);
        }
        
        .blackspot-icon {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }
        
        .healthy-icon {
            background-color: rgba(59, 130, 246, 0.1);
            color: var(--healthy-color);
        }
        
        .loading-spinner {
            border: 3px solid rgba(16, 185, 129, 0.1);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
        }
        
        .confidence-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--border-color);
            outline: none;
            -webkit-appearance: none;
        }
        
        .confidence-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }
        
        .location-select {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background-color: var(--background-color);
            color: var(--text-primary);
        }
        
        .treatment-textarea {
            min-height: 200px;
            resize: vertical;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .canvas-container {
            position: relative;
            width: 100%;
            height: 300px;
        }
        
        .detection-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .detection-box {
            position: absolute;
            border: 2px solid;
            background-color: transparent;
        }
        
        .detection-label {
            position: absolute;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            border-radius: 4px;
            transform: translateY(-100%);
        }
        
        @media (max-width: 768px) {
            .container {
                padding-left: 15px;
                padding-right: 15px;
            }
            
            .card {
                border-radius: 16px;
            }
            
            .image-upload-area {
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-pagelines me-2"></i>PalmAegis
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#"><i class="fas fa-home me-1"></i> Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="fas fa-history me-1"></i> History</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="userEmail"></a>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-outline-primary btn-sm ms-2" id="signOutBtn">Sign Out</button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container py-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="fw-bold mb-0">Oil Palm Health Detection</h2>
                    <button class="btn btn-outline-primary" id="infoBtn">
                        <i class="fas fa-info-circle me-2"></i>Guide
                    </button>
                </div>
            </div>
        </div>

        <!-- Health Status Card -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div id="healthStatusCard" class="status-card status-no-palm">
                            <div class="d-flex align-items-center mb-3">
                                <i class="fas fa-question-circle fa-2x me-3" id="statusIcon"></i>
                                <h4 class="fw-bold mb-0" id="healthStatus">Unknown</h4>
                                <span class="badge bg-primary ms-auto d-none" id="issuesCount">0 Issues</span>
                            </div>
                            <p class="mb-0" id="healthDescription">Upload an image to assess palm health</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Image Upload Section -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header text-center">
                        <i class="fas fa-tree fa-3x mb-3" style="color: var(--primary-color);"></i>
                        <h4 class="fw-bold">Oil Palm Health Detection</h4>
                        <p class="text-muted mb-0">Upload a clear photo of oil palm leaves or trees for disease analysis</p>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3 mb-md-0">
                                <div id="imageUploadArea" class="image-upload-area">
                                    <div id="uploadPlaceholder" class="text-center">
                                        <i class="fas fa-camera fa-3x mb-3 text-muted"></i>
                                        <h5>Upload oil palm photo</h5>
                                        <p class="text-muted">Focus on leaves or affected areas</p>
                                    </div>
                                    <canvas id="detectionCanvas" class="detection-canvas d-none"></canvas>
                                    <img id="imagePreview" class="image-preview d-none" alt="Preview">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div id="loadingSection" class="d-none text-center py-5">
                                    <div class="loading-spinner mx-auto mb-3"></div>
                                    <h5>Analyzing Oil Palm Health...</h5>
                                    <p class="text-muted">Detecting palm diseases and assessing health</p>
                                </div>
                                
                                <div id="detectionResults" class="d-none">
                                    <h5 class="fw-bold mb-3">Detection Results</h5>
                                    <div id="detectionList"></div>
                                    
                                    <div class="mt-4">
                                        <label class="form-label fw-bold">Confidence Threshold</label>
                                        <input type="range" class="confidence-slider" id="confidenceSlider" min="0" max="1" step="0.1" value="0.5">
                                        <div class="d-flex justify-content-between mt-1">
                                            <small class="text-muted">0%</small>
                                            <small id="thresholdValue" class="fw-bold">50%</small>
                                            <small class="text-muted">100%</small>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <h6 class="fw-bold">Total Detections: <span id="totalDetections">0</span></h6>
                                        <h6 class="fw-bold">Filtered Detections: <span id="filteredDetections">0</span></h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-6">
                                <button class="btn btn-outline-primary w-100" id="cameraBtn">
                                    <i class="fas fa-camera me-2"></i>Take Photo
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-primary w-100" id="galleryBtn">
                                    <i class="fas fa-image me-2"></i>Choose from Gallery
                                </button>
                            </div>
                        </div>
                        
                        <input type="file" id="fileInput" accept="image/*" class="d-none">
                    </div>
                </div>
            </div>
        </div>

        <!-- Assessment Form -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h4 class="fw-bold mb-4"><i class="fas fa-clipboard-list me-2"></i>Assessment Details</h4>
                        
                        <!-- Location Selection -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Oil Palm Location</label>
                            <select class="form-select" id="locationSelect">
                                <option value="Parit Raja">Parit Raja</option>
                                <option value="Senggarang">Senggarang</option>
                                <option value="Batu Pahat">Batu Pahat</option>
                                <option value="Specific Location">Specific Location</option>
                            </select>
                            
                            <div id="customLocationField" class="mt-3 d-none">
                                <label class="form-label fw-bold">Enter Specific Location</label>
                                <input type="text" class="form-control" id="customLocationInput" placeholder="Enter the exact oil palm tree location...">
                            </div>
                        </div>
                        
                        <!-- Assessment Date -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Assessment Date</label>
                            <input type="date" class="form-control" id="assessmentDate" value="">
                        </div>
                        
                        <!-- Treatment Recommendation -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label fw-bold mb-0">Treatment Recommendation</label>
                                <button class="btn btn-sm btn-outline-primary" id="autoGenerateBtn">
                                    <i class="fas fa-magic me-1"></i>Auto-generate
                                </button>
                            </div>
                            <textarea class="form-control treatment-textarea" id="treatmentTextarea" rows="8" 
                                      placeholder="Treatment recommendations will be auto-generated based on detected diseases..."></textarea>
                            <small class="text-muted">Treatment is auto-generated based on detected oil palm conditions.</small>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="row mt-4">
                            <div class="col-6">
                                <button class="btn btn-outline-primary w-100" id="clearBtn">
                                    <i class="fas fa-trash-alt me-2"></i>Clear
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-primary w-100" id="saveBtn" disabled>
                                    <i class="fas fa-save me-2"></i>Save Assessment
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tips Section -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="fw-bold mb-3"><i class="fas fa-lightbulb me-2" style="color: var(--primary-color);"></i>Tips for better oil palm detection</h5>
                        <ul class="mb-0">
                            <li>Focus on oil palm leaves or affected areas</li>
                            <li>Ensure good lighting on the palm</li>
                            <li>Take close-up photos of disease symptoms</li>
                            <li>For healthy detection: show clear, green palm leaves</li>
                            <li>System filters out non-palm objects automatically</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="guideModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Oil Palm Health Detection Guide</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>1. Upload clear photos of oil palm leaves or trees</p>
                    <p>2. System detects oil palm diseases AND healthy leaves</p>
                    <p>3. Non-palm objects are filtered out automatically</p>
                    <p>4. Provides oil palm specific treatment advice</p>
                    <p>5. Save assessments for future reference</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase and App Script -->
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAf-wtZpl8wVjCymdLlC-YGlv7xn0yEMMU",
            authDomain: "palmaegis-setup.firebaseapp.com",
            projectId: "palmaegis-setup",
            storageBucket: "palmaegis-setup.firebasestorage.app",
            messagingSenderId: "445887502374",
            appId: "1:445887502374:web:a5f6ecaa90b88447626ee7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // App Configuration
        const models = {
            'ganoderma': {
                'name': 'Ganoderma',
                'url': 'https://serverless.roboflow.com/ganoderma-1-xpzwd/1',
                'apiKey': 'KOIYcp3E5rAFhgSploex',
                'color': '#10B981',
                'icon': 'fas fa-warning',
                'defaultThreshold': 0.7,
                'validClasses': ['Ganoderma', 'ganoderma', 'Basal Stem Rot', 'BSR']
            },
            'blackspot': {
                'name': 'Blackspot',
                'url': 'https://serverless.roboflow.com/blackspot-lhjog/1',
                'apiKey': 'KOIYcp3E5rAFhgSploex',
                'color': '#EF4444',
                'icon': 'fas fa-circle',
                'defaultThreshold': 0.5,
                'validClasses': ['Blackspot', 'blackspot', 'Black Spot', 'Leaf Spot']
            },
            'healthy': {
                'name': 'Healthy Leaves',
                'url': 'https://serverless.roboflow.com/date-final/1',
                'apiKey': 'KOIYcp3E5rAFhgSploex',
                'color': '#3B82F6',
                'icon': 'fas fa-heartbeat',
                'defaultThreshold': 0.5,
                'validClasses': ['Healthy', 'healthy', 'normal', 'good', 'leaf', 'leaves']
            }
        };

        // App State
        let currentUser = null;
        let imageData = null;
        let processedImage = null;
        let currentDetections = [];
        let confidenceThreshold = 0.5;
        let healthStatus = 'Unknown';
        let healthDescription = 'Upload an image to assess palm health';
        let objectsCount = 0;
        let isLoading = false;
        let isAnalyzing = false;

        // DOM Elements
        const elements = {
            userEmail: document.getElementById('userEmail'),
            signOutBtn: document.getElementById('signOutBtn'),
            infoBtn: document.getElementById('infoBtn'),
            healthStatusCard: document.getElementById('healthStatusCard'),
            statusIcon: document.getElementById('statusIcon'),
            healthStatus: document.getElementById('healthStatus'),
            healthDescription: document.getElementById('healthDescription'),
            issuesCount: document.getElementById('issuesCount'),
            imageUploadArea: document.getElementById('imageUploadArea'),
            uploadPlaceholder: document.getElementById('uploadPlaceholder'),
            detectionCanvas: document.getElementById('detectionCanvas'),
            imagePreview: document.getElementById('imagePreview'),
            loadingSection: document.getElementById('loadingSection'),
            detectionResults: document.getElementById('detectionResults'),
            detectionList: document.getElementById('detectionList'),
            confidenceSlider: document.getElementById('confidenceSlider'),
            thresholdValue: document.getElementById('thresholdValue'),
            totalDetections: document.getElementById('totalDetections'),
            filteredDetections: document.getElementById('filteredDetections'),
            cameraBtn: document.getElementById('cameraBtn'),
            galleryBtn: document.getElementById('galleryBtn'),
            fileInput: document.getElementById('fileInput'),
            locationSelect: document.getElementById('locationSelect'),
            customLocationField: document.getElementById('customLocationField'),
            customLocationInput: document.getElementById('customLocationInput'),
            assessmentDate: document.getElementById('assessmentDate'),
            treatmentTextarea: document.getElementById('treatmentTextarea'),
            autoGenerateBtn: document.getElementById('autoGenerateBtn'),
            clearBtn: document.getElementById('clearBtn'),
            saveBtn: document.getElementById('saveBtn')
        };

        // Initialize Date
        elements.assessmentDate.value = new Date().toISOString().split('T')[0];

        // Authentication
        function initAuth() {
            auth.onAuthStateChanged((user) => {
                currentUser = user;
                if (user) {
                    elements.userEmail.textContent = user.email;
                    showToast('Signed in as ' + user.email, 'success');
                } else {
                    window.location.href = 'index.html';
                }
            });
        }

        // Toast Notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'warning'} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            document.body.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            setTimeout(() => toast.remove(), 3000);
        }

        // Image Processing
        async function processImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        resolve({
                            blob: file,
                            dataUrl: canvas.toDataURL('image/jpeg', 0.8),
                            width: img.width,
                            height: img.height
                        });
                    };
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Display Image
        function displayImage(imageData) {
            elements.uploadPlaceholder.classList.add('d-none');
            elements.imagePreview.classList.remove('d-none');
            elements.imagePreview.src = imageData.dataUrl;
            elements.detectionCanvas.classList.remove('d-none');
            elements.detectionCanvas.width = imageData.width;
            elements.detectionCanvas.height = imageData.height;
        }

        // Update Health Status
        function updateHealthStatus(status, description) {
            healthStatus = status;
            healthDescription = description;
            
            elements.healthStatus.textContent = status;
            elements.healthDescription.textContent = description;
            
            const statusCard = elements.healthStatusCard;
            statusCard.className = 'status-card ';
            
            switch(status) {
                case 'Healthy':
                    elements.statusIcon.className = 'fas fa-check-circle fa-2x me-3';
                    statusCard.classList.add('status-healthy');
                    break;
                case 'At Risk':
                    elements.statusIcon.className = 'fas fa-exclamation-triangle fa-2x me-3';
                    statusCard.classList.add('status-at-risk');
                    break;
                case 'No Palm Detected':
                    elements.statusIcon.className = 'fas fa-tree fa-2x me-3';
                    statusCard.classList.add('status-no-palm');
                    break;
                case 'Error':
                    elements.statusIcon.className = 'fas fa-times-circle fa-2x me-3';
                    statusCard.classList.add('status-error');
                    break;
                default:
                    elements.statusIcon.className = 'fas fa-question-circle fa-2x me-3';
                    statusCard.classList.add('status-no-palm');
            }
            
            if (objectsCount > 0 && status === 'At Risk') {
                elements.issuesCount.textContent = objectsCount + ' Issues';
                elements.issuesCount.classList.remove('d-none');
            } else {
                elements.issuesCount.classList.add('d-none');
            }
        }

        // Draw Detection Boxes
        function drawDetectionBoxes(detections) {
            const canvas = elements.detectionCanvas;
            const ctx = canvas.getContext('2d');
            const img = elements.imagePreview;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw image
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            
            // Filter detections by threshold
            const filteredDetections = detections.filter(d => d.confidence >= confidenceThreshold);
            
            // Draw bounding boxes
            filteredDetections.forEach(detection => {
                const x = detection.x * canvas.width;
                const y = detection.y * canvas.height;
                const width = detection.width * canvas.width;
                const height = detection.height * canvas.height;
                const confidence = detection.confidence;
                const className = detection.class;
                const modelKey = detection.model;
                const modelConfig = models[modelKey];
                
                // Draw box
                ctx.strokeStyle = modelConfig.color;
                ctx.lineWidth = 2;
                ctx.strokeRect(x - width/2, y - height/2, width, height);
                
                // Draw label background
                const label = `${className} ${(confidence * 100).toFixed(1)}%`;
                ctx.font = 'bold 12px Arial';
                const textWidth = ctx.measureText(label).width;
                const textHeight = 16;
                
                ctx.fillStyle = modelConfig.color;
                ctx.fillRect(x - width/2, y - height/2 - textHeight, textWidth + 8, textHeight);
                
                // Draw label text
                ctx.fillStyle = '#FFFFFF';
                ctx.fillText(label, x - width/2 + 4, y - height/2 - 4);
            });
            
            // Update counts
            elements.totalDetections.textContent = detections.length;
            elements.filteredDetections.textContent = filteredDetections.length;
            
            return filteredDetections;
        }

        // Update Detection List
        function updateDetectionList(detections) {
            const filteredDetections = detections.filter(d => d.confidence >= confidenceThreshold);
            elements.detectionList.innerHTML = '';
            
            if (filteredDetections.length === 0) {
                elements.detectionList.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        No significant diseases detected
                        <small class="d-block">All detections are below confidence threshold</small>
                    </div>
                `;
                return;
            }
            
            filteredDetections.forEach(detection => {
                const modelConfig = models[detection.model];
                const isHealthy = detection.model === 'healthy';
                
                const item = document.createElement('div');
                item.className = 'detection-item d-flex align-items-center';
                item.innerHTML = `
                    <div class="detection-icon ${detection.model}-icon">
                        <i class="${modelConfig.icon}"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="fw-bold mb-1">${detection.class}</h6>
                        <p class="mb-1 text-muted">Confidence: ${(detection.confidence * 100).toFixed(1)}%</p>
                        <small class="${isHealthy ? 'text-primary' : 'text-success'}">
                            ${isHealthy ? 'Healthy oil palm leaves detected' : 'Oil palm specific disease'}
                        </small>
                    </div>
                `;
                elements.detectionList.appendChild(item);
            });
        }

        // Perform Image Detection
        async function performImageDetection(imageData) {
            try {
                isLoading = true;
                isAnalyzing = true;
                
                // Show loading
                elements.loadingSection.classList.remove('d-none');
                elements.detectionResults.classList.add('d-none');
                
                // Convert image to base64
                const base64Image = imageData.dataUrl.split(',')[1];
                
                // Call all models
                const promises = Object.entries(models).map(async ([modelKey, model]) => {
                    try {
                        const response = await fetch(`${model.url}?api_key=${model.apiKey}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: base64Image
                        });
                        
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        
                        const data = await response.json();
                        if (data.predictions) {
                            return data.predictions.map(pred => ({
                                ...pred,
                                model: modelKey,
                                modelName: model.name,
                                modelColor: model.color
                            }));
                        }
                        return [];
                    } catch (error) {
                        console.error(`Error with model ${modelKey}:`, error);
                        return [];
                    }
                });
                
                const results = await Promise.all(promises);
                currentDetections = results.flat();
                
                // Filter valid detections (simplified for web)
                const validDetections = currentDetections.filter(d => d.confidence >= 0.3);
                
                if (validDetections.length === 0) {
                    updateHealthStatus('No Palm Detected', 
                        'No valid palm tree detected. Please ensure the image contains clear photos of oil palm trees.');
                    objectsCount = 0;
                } else {
                    objectsCount = validDetections.length;
                    updateHealthStatus('At Risk', 
                        `Detected ${objectsCount} palm disease${objectsCount > 1 ? 's' : ''}.`);
                }
                
                // Draw boxes and update UI
                const filteredDetections = drawDetectionBoxes(validDetections);
                updateDetectionList(validDetections);
                generateTreatmentAdvice(filteredDetections);
                
                // Show results
                elements.loadingSection.classList.add('d-none');
                elements.detectionResults.classList.remove('d-none');
                elements.saveBtn.disabled = false;
                
            } catch (error) {
                console.error('Detection error:', error);
                updateHealthStatus('Error', 'Failed to analyze image. Please try again.');
                showToast('Error processing image: ' + error.message, 'error');
            } finally {
                isLoading = false;
                isAnalyzing = false;
            }
        }

        // Generate Treatment Advice
        function generateTreatmentAdvice(detections) {
            let treatmentAdvice = '';
            
            const diseaseDetections = detections.filter(d => d.model !== 'healthy');
            const healthyDetections = detections.filter(d => d.model === 'healthy');
            
            if (diseaseDetections.length === 0 && healthyDetections.length > 0) {
                treatmentAdvice = getHealthyLeavesTreatment();
            } else if (diseaseDetections.length === 0) {
                treatmentAdvice = 'No treatment required. Your oil palm tree appears healthy. Continue regular maintenance and monitoring.';
            } else {
                const hasGanoderma = diseaseDetections.some(d => d.model === 'ganoderma');
                const hasBlackspot = diseaseDetections.some(d => d.model === 'blackspot');
                
                if (hasGanoderma && hasBlackspot) {
                    treatmentAdvice = getCombinedTreatment();
                } else if (hasGanoderma) {
                    treatmentAdvice = getGanodermaTreatment();
                } else if (hasBlackspot) {
                    treatmentAdvice = getBlackspotTreatment();
                } else {
                    treatmentAdvice = getGeneralTreatment();
                }
            }
            
            elements.treatmentTextarea.value = treatmentAdvice;
        }

        // Treatment Templates
        function getGanodermaTreatment() {
            return `GANODERMA DISEASE TREATMENT (Oil Palm Specific):

IMMEDIATE ACTIONS:
• Remove and destroy infected oil palm trees immediately by burning
• Mark and isolate infected area (minimum 10-meter radius)
• Apply systemic fungicide (Thiophanate-methyl or Fosetyl-Al) to surrounding palms
• Avoid any wounding or pruning of healthy palms

LONG-TERM MANAGEMENT:
• Improve soil drainage in the plantation
• Apply soil drench with Propiconazole every 3 months
• Consider soil replacement in heavily infected areas
• Plant resistant oil palm varieties (if available)
• Regular monitoring every 2 months`;
        }

        function getBlackspotTreatment() {
            return `BLACK SPOT DISEASE TREATMENT (Oil Palm Specific):

IMMEDIATE TREATMENT:
• Remove all infected palm leaves and fronds
• Apply copper-based fungicide (copper hydroxide 50WP) to affected areas
• Spray thoroughly covering both sides of oil palm leaves
• Repeat fungicide application every 10-14 days for 4 applications

CULTURAL CONTROL FOR OIL PALM:
• Water at soil level only (avoid overhead irrigation)
• Improve air circulation by proper spacing
• Remove weeds that may harbor the fungus
• Apply organic mulch around palm base
• Prune only during dry weather`;
        }

        function getHealthyLeavesTreatment() {
            return `HEALTHY OIL PALM LEAVES - MAINTENANCE GUIDE:

CURRENT STATUS:
• Your oil palm leaves are in excellent health condition
• No signs of disease or nutrient deficiencies detected
• Leaves appear green, vibrant, and properly formed

RECOMMENDED MAINTENANCE:
• Continue with current watering schedule
• Maintain regular fertilization program
• Monitor for early signs of disease
• Keep plantation area clean

PREVENTIVE CARE FOR HEALTHY PALMS:
• Regular inspection every 2-4 weeks
• Maintain proper drainage
• Ensure adequate sunlight
• Prune only damaged or old fronds
• Apply preventive fungicide during rainy season`;
        }

        function getCombinedTreatment() {
            return `COMBINED DISEASE TREATMENT (Oil Palm):

URGENT ACTIONS:
• Remove Ganoderma-infected palms immediately (highest priority)
• Isolate entire affected area (20-meter radius)
• Apply systemic fungicide for Ganoderma control
• Apply contact fungicide for Black Spot control

TREATMENT SCHEDULE FOR OIL PALM:
Week 1-2: Remove infected palms and debris
Week 3-4: Soil drench for Ganoderma control
Week 5-6: Foliar spray for Black Spot control
Week 7-8: Second preventive treatment

IMPORTANT: Ganoderma is soil-borne and fatal to oil palm. Black Spot is foliar and manageable. Prioritize Ganoderma eradication.`;
        }

        function getGeneralTreatment() {
            return `GENERAL OIL PALM DISEASE TREATMENT:

INITIAL RESPONSE:
• Isolate affected oil palm from healthy ones
• Apply broad-spectrum fungicide to affected areas
• Remove visibly infected plant parts
• Improve growing conditions

ONGOING CARE FOR OIL PALM:
• Monitor daily for symptom changes
• Adjust watering schedule (oil palms need consistent moisture)
• Ensure proper sunlight exposure
• Apply balanced oil palm fertilizer (N:P:K 12:12:17+2)
• Maintain soil pH between 5.0-5.5`;
        }

        // Save Assessment
        async function saveAssessment() {
            if (isLoading || !imageData || !currentUser) return;
            
            const location = elements.locationSelect.value === 'Specific Location' 
                ? elements.customLocationInput.value 
                : elements.locationSelect.value;
            
            if (!location.trim()) {
                showToast('Please enter a location for the palm', 'error');
                return;
            }
            
            if (!imageData) {
                showToast('Please upload an image first', 'error');
                return;
            }
            
            try {
                isLoading = true;
                elements.saveBtn.disabled = true;
                elements.saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
                
                // Prepare assessment data
                const filteredDetections = currentDetections.filter(d => d.confidence >= confidenceThreshold);
                const assessmentId = 'ASS' + Date.now() + Math.floor(Math.random() * 1000);
                
                const assessmentData = {
                    assessmentId: assessmentId,
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    userName: currentUser.displayName || currentUser.email.split('@')[0] || 'User',
                    
                    location: location,
                    locationType: elements.locationSelect.value === 'Specific Location' ? 'custom' : 'predefined',
                    treatment: elements.treatmentTextarea.value.trim(),
                    date: elements.assessmentDate.value,
                    time: new Date().toLocaleTimeString(),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    
                    healthStatus: healthStatus,
                    objectsCount: objectsCount,
                    confidenceThreshold: confidenceThreshold,
                    
                    diseases: filteredDetections.map(d => d.class),
                    detectionCount: filteredDetections.length,
                    totalDetections: currentDetections.length,
                    
                    imageData: imageData.dataUrl,
                    imageSize: imageData.blob.size,
                    imageFormat: 'jpg',
                    imageProcessedAt: new Date().toISOString(),
                    
                    modelsUsed: [...new Set(filteredDetections.map(d => d.model))],
                    isAnalyzed: true,
                    isValidPalmImage: healthStatus !== 'No Palm Detected',
                    createdAt: new Date().toISOString()
                };
                
                // Save to Firestore
                await db.collection('assessments').add(assessmentData);
                
                showToast('Oil palm health assessment saved successfully!', 'success');
                
                // Reset form after delay
                setTimeout(resetForm, 1500);
                
            } catch (error) {
                console.error('Save error:', error);
                showToast('Failed to save assessment: ' + error.message, 'error');
            } finally {
                isLoading = false;
                elements.saveBtn.disabled = false;
                elements.saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Assessment';
            }
        }

        // Reset Form
        function resetForm() {
            imageData = null;
            processedImage = null;
            currentDetections = [];
            confidenceThreshold = 0.5;
            healthStatus = 'Unknown';
            healthDescription = 'Upload an image to assess palm health';
            objectsCount = 0;
            
            elements.uploadPlaceholder.classList.remove('d-none');
            elements.imagePreview.classList.add('d-none');
            elements.detectionCanvas.classList.add('d-none');
            elements.loadingSection.classList.add('d-none');
            elements.detectionResults.classList.add('d-none');
            elements.treatmentTextarea.value = '';
            elements.confidenceSlider.value = 0.5;
            elements.thresholdValue.textContent = '50%';
            elements.saveBtn.disabled = true;
            elements.locationSelect.value = 'Parit Raja';
            elements.customLocationField.classList.add('d-none');
            elements.customLocationInput.value = '';
            
            updateHealthStatus('Unknown', 'Upload an image to assess palm health');
        }

        // Event Listeners
        function initEventListeners() {
            // Sign Out
            elements.signOutBtn.addEventListener('click', () => auth.signOut());
            
            // Info Button
            elements.infoBtn.addEventListener('click', () => {
                new bootstrap.Modal(document.getElementById('guideModal')).show();
            });
            
            // Camera Button
            elements.cameraBtn.addEventListener('click', () => {
                // Note: Camera access requires HTTPS
                if (!navigator.mediaDevices) {
                    showToast('Camera access not available', 'error');
                    return;
                }
                elements.fileInput.accept = 'image/*';
                elements.fileInput.capture = 'environment';
                elements.fileInput.click();
            });
            
            // Gallery Button
            elements.galleryBtn.addEventListener('click', () => {
                elements.fileInput.accept = 'image/*';
                elements.fileInput.capture = null;
                elements.fileInput.click();
            });
            
            // File Input
            elements.fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    imageData = await processImage(file);
                    displayImage(imageData);
                    await performImageDetection(imageData);
                } catch (error) {
                    showToast('Error processing image: ' + error.message, 'error');
                }
            });
            
            // Confidence Slider
            elements.confidenceSlider.addEventListener('input', (e) => {
                confidenceThreshold = parseFloat(e.target.value);
                elements.thresholdValue.textContent = Math.round(confidenceThreshold * 100) + '%';
                
                if (currentDetections.length > 0) {
                    const filteredDetections = drawDetectionBoxes(currentDetections);
                    updateDetectionList(currentDetections);
                    
                    // Update object count
                    objectsCount = filteredDetections.length;
                    if (objectsCount > 0 && healthStatus === 'At Risk') {
                        elements.issuesCount.textContent = objectsCount + ' Issues';
                        elements.issuesCount.classList.remove('d-none');
                    } else {
                        elements.issuesCount.classList.add('d-none');
                    }
                }
            });
            
            // Location Select
            elements.locationSelect.addEventListener('change', (e) => {
                if (e.target.value === 'Specific Location') {
                    elements.customLocationField.classList.remove('d-none');
                } else {
                    elements.customLocationField.classList.add('d-none');
                }
            });
            
            // Auto Generate Button
            elements.autoGenerateBtn.addEventListener('click', () => {
                if (currentDetections.length > 0) {
                    const filteredDetections = currentDetections.filter(d => d.confidence >= confidenceThreshold);
                    generateTreatmentAdvice(filteredDetections);
                    showToast('Treatment advice generated', 'success');
                } else {
                    showToast('No detections available', 'error');
                }
            });
            
            // Clear Button
            elements.clearBtn.addEventListener('click', resetForm);
            
            // Save Button
            elements.saveBtn.addEventListener('click', saveAssessment);
        }

        // Initialize App
        function initApp() {
            initAuth();
            initEventListeners();
        }

        // Start when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>