<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings | Palm Aegis</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/homepage.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="icon" href="images/logo1.png" type="image/png" sizes="32x32">
    <link rel="shortcut icon" href="images/logo1.png">
    <meta name="theme-color" content="#2e7d32">

    <style>
        :root {
            --primary-color: #2e7d32;
            --secondary-color: #4caf50;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --info-color: #2196f3;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --border-color: #dee2e6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #c8f0c8;
            color: #333;
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark-mode {
            background-color: #1a1a1a;
            color: #f0f0f0;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .top-header {
            background-color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        body.dark-mode .top-header {
            background-color: #2d2d2d;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-left h1 {
            font-size: 1.8rem;
            color: var(--primary-color);
        }

        body.dark-mode .header-left h1 {
            color: #4caf50;
        }

        /* Mobile Header */
        .mobile-header {
            display: none;
            background-color: white;
            padding: 15px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            align-items: center;
            justify-content: space-between;
        }

        body.dark-mode .mobile-header {
            background-color: #2d2d2d;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .mobile-header h1 {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin: 0;
        }

        body.dark-mode .mobile-header h1 {
            color: #4caf50;
        }

        .menu-toggle {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--primary-color);
            cursor: pointer;
            padding: 5px;
        }

        body.dark-mode .menu-toggle {
            color: #4caf50;
        }

        .mobile-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .theme-toggle {
            background: none;
            border: none;
            font-size: 1.3rem;
            color: var(--primary-color);
            cursor: pointer;
            padding: 5px;
        }

        body.dark-mode .theme-toggle {
            color: #ff9800;
        }

        /* Mobile Overlay */
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .mobile-overlay.active {
            display: block;
            opacity: 1;
        }

        /* Scroll to Top Button */
        .scroll-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .scroll-to-top.visible {
            opacity: 1;
            transform: translateY(0);
        }

        body.dark-mode .scroll-to-top {
            background-color: #4caf50;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
        }

        .scroll-to-top:hover {
            background-color: #1b5e20;
            transform: translateY(-2px);
        }

        /* Section Navigation Indicator */
        .section-indicator {
            position: fixed;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }

        .section-indicator a {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ddd;
            position: relative;
            transition: all 0.3s;
        }

        body.dark-mode .section-indicator a {
            background-color: #555;
        }

        .section-indicator a.active {
            background-color: var(--primary-color);
            transform: scale(1.2);
        }

        body.dark-mode .section-indicator a.active {
            background-color: #4caf50;
        }

        .section-indicator a::after {
            content: attr(data-title);
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background-color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        body.dark-mode .section-indicator a::after {
            background-color: #2d2d2d;
            color: #f0f0f0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
        }

        .section-indicator a:hover::after {
            opacity: 1;
        }

        /* Settings Container */
        .settings-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            background-color: white;
            margin: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .settings-container {
            background-color: #2d2d2d;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        @media (max-width: 768px) {
            .settings-container {
                margin: 10px;
                border-radius: 8px;
                flex-direction: column;
            }
        }

        /* Settings Sidebar */
        .settings-sidebar {
            width: 250px;
            background-color: var(--light-color);
            border-right: 1px solid var(--border-color);
            padding: 20px 0;
        }

        body.dark-mode .settings-sidebar {
            background-color: #333;
            border-right-color: #444;
        }

        .settings-nav {
            list-style: none;
            padding: 0;
        }

        .settings-nav li {
            margin-bottom: 5px;
        }

        .settings-nav a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 25px;
            color: var(--dark-color);
            text-decoration: none;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }

        body.dark-mode .settings-nav a {
            color: #f0f0f0;
        }

        .settings-nav a:hover {
            background-color: rgba(46, 125, 50, 0.1);
            border-left-color: var(--primary-color);
        }

        body.dark-mode .settings-nav a:hover {
            background-color: rgba(76, 175, 80, 0.2);
        }

        .settings-nav a.active {
            background-color: rgba(46, 125, 50, 0.15);
            border-left-color: var(--primary-color);
            font-weight: 600;
            color: var(--primary-color);
        }

        body.dark-mode .settings-nav a.active {
            background-color: rgba(76, 175, 80, 0.3);
            color: #4caf50;
        }

        .settings-nav i {
            width: 20px;
            text-align: center;
        }

        /* Settings Content */
        .settings-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            max-height: calc(100vh - 150px);
        }

        @media (max-width: 768px) {
            .settings-content {
                padding: 20px;
                max-height: none;
                height: auto;
            }
        }

        /* Profile Sections */
        .profile-section {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s, transform 0.5s;
        }

        .profile-section.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .profile-section.scrolling-content {
            opacity: 1 !important;
            transform: translateY(0) !important;
        }

        /* Section Header */
        .section-header {
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        body.dark-mode .section-header {
            border-bottom-color: #444;
        }

        .section-header h2 {
            font-size: 1.8rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        body.dark-mode .section-header h2 {
            color: #4caf50;
        }

        .section-header p {
            color: var(--gray);
            font-size: 0.95rem;
        }

        body.dark-mode .section-header p {
            color: #aaa;
        }

        /* Profile Card */
        .profile-card {
            background-color: var(--light-color);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        body.dark-mode .profile-card {
            background-color: #333;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .profile-picture-container {
            position: relative;
            width: 100px;
            height: 100px;
        }

        .profile-picture {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--primary-color);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .profile-picture {
            border-color: #4caf50;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .upload-overlay {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: var(--primary-color);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid white;
        }

        body.dark-mode .upload-overlay {
            background-color: #4caf50;
            border-color: #2d2d2d;
        }

        .upload-overlay:hover {
            background-color: #1b5e20;
            transform: scale(1.1);
        }

        body.dark-mode .upload-overlay:hover {
            background-color: #3d8b40;
        }

        .upload-overlay .loading {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .profile-info {
            flex: 1;
        }

        .profile-info h3 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            color: var(--dark-color);
        }

        body.dark-mode .profile-info h3 {
            color: #f0f0f0;
        }

        .profile-info p {
            color: var(--gray);
            margin-bottom: 10px;
        }

        body.dark-mode .profile-info p {
            color: #aaa;
        }

        .badge {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        body.dark-mode .badge {
            background-color: #4caf50;
        }

        .profile-bio {
            color: var(--dark-color);
            line-height: 1.6;
            font-style: italic;
            padding: 15px;
            background-color: rgba(46, 125, 50, 0.05);
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        body.dark-mode .profile-bio {
            color: #ddd;
            background-color: rgba(76, 175, 80, 0.1);
            border-left-color: #4caf50;
        }

        /* Notifications */
        .notification {
            display: none;
            align-items: center;
            gap: 12px;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .notification.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        body.dark-mode .notification.success {
            background-color: rgba(76, 175, 80, 0.2);
            color: #81c784;
            border-color: #4caf50;
        }

        .notification.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        body.dark-mode .notification.error {
            background-color: rgba(244, 67, 54, 0.2);
            color: #e57373;
            border-color: #f44336;
        }

        .notification i {
            font-size: 1.2rem;
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        .form-group {
            margin-bottom: 0;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
        }

        body.dark-mode .form-group label {
            color: #f0f0f0;
        }

        .input-with-icon {
            position: relative;
        }

        .input-with-icon i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            pointer-events: none;
        }

        body.dark-mode .input-with-icon i {
            color: #aaa;
        }

        .input-with-icon input,
        .input-with-icon textarea,
        .input-with-icon select {
            width: 100%;
            padding: 12px 15px 12px 45px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
            background-color: white;
            color: var(--dark-color);
        }

        body.dark-mode .input-with-icon input,
        body.dark-mode .input-with-icon textarea,
        body.dark-mode .input-with-icon select {
            background-color: #333;
            border-color: #444;
            color: #f0f0f0;
        }

        .input-with-icon input:focus,
        .input-with-icon textarea:focus,
        .input-with-icon select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.2);
        }

        body.dark-mode .input-with-icon input:focus,
        body.dark-mode .input-with-icon textarea:focus,
        body.dark-mode .input-with-icon select:focus {
            border-color: #4caf50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.3);
        }

        .input-with-icon input:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
            opacity: 0.7;
        }

        body.dark-mode .input-with-icon input:disabled {
            background-color: #444;
        }

        .input-with-icon textarea {
            min-height: 120px;
            resize: vertical;
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            padding: 5px;
        }

        body.dark-mode .password-toggle {
            color: #aaa;
        }

        .password-toggle:hover {
            color: var(--primary-color);
        }

        body.dark-mode .password-toggle:hover {
            color: #4caf50;
        }

        /* Password Requirements */
        .password-requirements {
            background-color: var(--light-color);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        body.dark-mode .password-requirements {
            background-color: #333;
        }

        .password-requirements p {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--dark-color);
        }

        body.dark-mode .password-requirements p {
            color: #f0f0f0;
        }

        .password-requirements ul {
            list-style: none;
            padding: 0;
        }

        .password-requirements li {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }

        .password-requirements li::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #ddd;
        }

        .password-requirements li.valid {
            color: #28a745;
        }

        .password-requirements li.valid::before {
            background-color: #28a745;
        }

        .password-requirements li.invalid {
            color: var(--gray);
        }

        .password-requirements li.invalid::before {
            background-color: #ddd;
        }

        body.dark-mode .password-requirements li.valid {
            color: #81c784;
        }

        body.dark-mode .password-requirements li.invalid {
            color: #888;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .action-buttons {
                flex-direction: column;
            }
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #1b5e20;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
        }

        body.dark-mode .btn-primary:hover:not(:disabled) {
            background-color: #3d8b40;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: var(--light-gray);
            color: var(--dark-color);
        }

        .btn-secondary:hover {
            background-color: #ddd;
        }

        body.dark-mode .btn-secondary {
            background-color: #444;
            color: #f0f0f0;
        }

        body.dark-mode .btn-secondary:hover {
            background-color: #555;
        }

        .btn i {
            font-size: 1rem;
        }

        /* Placeholder Content */
        .placeholder-content {
            background-color: var(--light-color);
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            color: var(--gray);
        }

        body.dark-mode .placeholder-content {
            background-color: #333;
            color: #aaa;
        }

        /* File Input */
        .file-input {
            display: none;
        }

        /* Loading State */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard-container {
                flex-direction: column;
            }

            .main-content {
                width: 100%;
                margin-top: 60px; /* Space for mobile header */
            }

            .top-header {
                display: none;
            }

            .mobile-header {
                display: flex;
            }

            .settings-sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                padding: 15px 0;
            }

            body.dark-mode .settings-sidebar {
                border-bottom-color: #444;
            }

            .settings-nav {
                display: flex;
                overflow-x: auto;
                padding: 0 15px;
            }

            .settings-nav li {
                margin-bottom: 0;
                flex-shrink: 0;
            }

            .settings-nav a {
                padding: 12px 15px;
                border-left: none;
                border-bottom: 3px solid transparent;
                white-space: nowrap;
            }

            .settings-nav a:hover,
            .settings-nav a.active {
                border-left: none;
                border-bottom-color: var(--primary-color);
            }

            .section-indicator {
                display: none;
            }

            .profile-header {
                flex-direction: column;
                text-align: center;
            }

            .profile-picture-container {
                width: 120px;
                height: 120px;
            }

            .upload-overlay {
                width: 40px;
                height: 40px;
            }
        }

        @media (max-width: 480px) {
            .settings-content {
                padding: 15px;
            }

            .profile-card {
                padding: 20px;
            }

            .action-buttons .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Smooth transitions */
        .transition-all {
            transition: all 0.3s ease;
        }
    </style>
</head>

<body>
    <!-- Mobile Header -->
    <div class="mobile-header">
        <button class="menu-toggle" id="menuToggle">
            <i class="fas fa-bars"></i>
        </button>
        <h1>Settings</h1>
        <div class="mobile-actions">
            <button class="theme-toggle" id="mobileThemeToggle">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </div>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobileOverlay"></div>

    <!-- Scroll to Top Button -->
    <button class="scroll-to-top" id="scrollToTop">
        <i class="fas fa-chevron-up"></i>
    </button>

    <!-- Section Navigation Indicator -->
    <div class="section-indicator" id="sectionIndicator">
        <a href="#profile" data-title="Profile" class="active"></a>
        <a href="#password" data-title="Security"></a>
    </div>

    <div class="dashboard-container">
        <div id="sidebarPlaceholder"></div>
        
        <div class="main-content" id="mainContent">
            <!-- Desktop Header (Forum Style) -->
            <div class="top-header">
                <div class="header-left">
                    <h1>Settings</h1>
                    <button class="theme-toggle" id="desktopThemeToggle">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>

            <div class="settings-container">
                <!-- Settings Navigation -->
                <div class="settings-sidebar">
                    <ul class="settings-nav">
                        <li><a href="#profile" class="active" data-section="profile">
                            <i class="fas fa-user"></i> Profile Settings
                        </a></li>
                        <li><a href="#password" data-section="password">
                            <i class="fas fa-lock"></i> Security
                        </a></li>
                    </ul>
                </div>

                <!-- Settings Content -->
                <div class="settings-content" id="settingsContent">
                    <!-- Profile Section -->
                    <div class="profile-section active" id="profile-section">
                        <div class="section-header">
                            <h2><i class="fas fa-user-edit"></i> Profile Information</h2>
                            <p>Update your personal information and profile picture</p>
                        </div>

                        <div class="profile-card">
                            <div class="profile-header">
                                <div class="profile-picture-container">
                                    <img id="profile-picture" src="images/default-avatar.png" alt="Profile Picture" class="profile-picture">
                                    <div class="upload-overlay" id="upload-trigger">
                                        <i class="fas fa-camera"></i>
                                    </div>
                                    <input type="file" id="file-input" class="file-input" accept="image/*">
                                </div>
                                <div class="profile-info">
                                    <h3 id="display-name">Loading...</h3>
                                    <p id="display-username">@username</p>
                                    <span class="badge">Member</span>
                                </div>
                            </div>
                            <p class="profile-bio" id="display-bio">Loading bio...</p>
                        </div>

                        <!-- Notifications -->
                        <div id="success-notification" class="notification success">
                            <i class="fas fa-check-circle"></i> Profile updated successfully!
                        </div>
                        
                        <div id="error-notification" class="notification error">
                            <i class="fas fa-exclamation-circle"></i> Please fill in all required fields.
                        </div>

                        <div id="auth-notification" class="notification error">
                            <i class="fas fa-exclamation-circle"></i> You must be logged in to save your profile.
                        </div>

                        <!-- Profile Form -->
                        <form id="profile-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="username">Username</label>
                                    <div class="input-with-icon">
                                        <i class="fas fa-at"></i>
                                        <input type="text" id="username" name="username" placeholder="johndoe" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="email">Email Address</label>
                                    <div class="input-with-icon">
                                        <i class="fas fa-envelope"></i>
                                        <input type="email" id="email" name="email" placeholder="john@example.com" disabled>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="first-name">First Name</label>
                                    <div class="input-with-icon">
                                        <i class="fas fa-user"></i>
                                        <input type="text" id="first-name" name="first-name" placeholder="John" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="last-name">Last Name</label>
                                    <div class="input-with-icon">
                                        <i class="fas fa-user"></i>
                                        <input type="text" id="last-name" name="last-name" placeholder="Doe" required>
                                    </div>
                                </div>
                                
                                <div class="form-group full-width">
                                    <label for="bio">Bio</label>
                                    <div class="input-with-icon">
                                        <i class="fas fa-pencil-alt"></i>
                                        <textarea id="bio" name="bio" placeholder="Tell us about yourself..."></textarea>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="location">Location</label>
                                    <div class="input-with-icon">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <input type="text" id="location" name="location" placeholder="New York, USA">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="phone">Phone Number</label>
                                    <div class="input-with-icon">
                                        <i class="fas fa-phone"></i>
                                        <input type="tel" id="phone" name="phone" placeholder="+1 (123) 456-7890">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="action-buttons">
                                <button type="submit" class="btn btn-primary" id="save-button">
                                    <i class="fas fa-save"></i> Save Changes
                                </button>
                                <button type="button" class="btn btn-secondary" id="cancel-button">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Password Section -->
                    <div class="profile-section" id="password-section">
                        <div class="section-header">
                            <h2><i class="fas fa-lock"></i> Change Password</h2>
                            <p>Update your password to keep your account secure</p>
                        </div>

                        <!-- Notifications -->
                        <div id="password-success-notification" class="notification success">
                            <i class="fas fa-check-circle"></i> Password changed successfully!
                        </div>
                        
                        <div id="password-error-notification" class="notification error">
                            <i class="fas fa-exclamation-circle"></i> Error changing password.
                        </div>

                        <form id="password-form">
                            <div class="form-grid">
                                <div class="form-group full-width">
                                    <label for="current-password">Current Password</label>
                                    <div class="input-with-icon">
                                        <i class="fas fa-key"></i>
                                        <input type="password" id="current-password" name="current-password" placeholder="Enter current password" required>
                                        <button type="button" class="password-toggle" data-target="current-password">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="new-password">New Password</label>
                                    <div class="input-with-icon">
                                        <i class="fas fa-lock"></i>
                                        <input type="password" id="new-password" name="new-password" placeholder="Enter new password" required>
                                        <button type="button" class="password-toggle" data-target="new-password">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="confirm-password">Confirm New Password</label>
                                    <div class="input-with-icon">
                                        <i class="fas fa-lock"></i>
                                        <input type="password" id="confirm-password" name="confirm-password" placeholder="Confirm new password" required>
                                        <button type="button" class="password-toggle" data-target="confirm-password">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="password-requirements">
                                <p>Password Requirements:</p>
                                <ul>
                                    <li id="length-req" class="invalid">Minimum 8 characters</li>
                                    <li id="case-req" class="invalid">Uppercase and lowercase letters</li>
                                    <li id="number-req" class="invalid">At least one number</li>
                                    <li id="special-req" class="invalid">At least one special character</li>
                                </ul>
                            </div>
                            
                            <div id="password-match" class="notification" style="display: none;">
                                <i class="fas fa-info-circle"></i> Passwords match
                            </div>
                            
                            <div class="action-buttons">
                                <button type="submit" class="btn btn-primary" id="change-password-button">
                                    <i class="fas fa-key"></i> Update Password
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Other Sections (Placeholder) -->
                    <div class="profile-section" id="notifications-section">
                        <div class="section-header">
                            <h2><i class="fas fa-bell"></i> Notification Settings</h2>
                            <p>Manage how you receive notifications</p>
                        </div>
                        <div class="placeholder-content">
                            <p style="color: var(--gray); padding: 40px; text-align: center;">
                                Notification settings will be available soon.
                            </p>
                        </div>
                    </div>

                    <div class="profile-section" id="privacy-section">
                        <div class="section-header">
                            <h2><i class="fas fa-shield-alt"></i> Privacy Settings</h2>
                            <p>Control your privacy and data sharing preferences</p>
                        </div>
                        <div class="placeholder-content">
                            <p style="color: var(--gray); padding: 40px; text-align: center;">
                                Privacy settings will be available soon.
                            </p>
                        </div>
                    </div>

                    <div class="profile-section" id="appearance-section">
                        <div class="section-header">
                            <h2><i class="fas fa-palette"></i> Appearance</h2>
                            <p>Customize the look and feel of your dashboard</p>
                        </div>
                        <div class="placeholder-content">
                            <p style="color: var(--gray); padding: 40px; text-align: center;">
                                Appearance settings will be available soon.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forum | Palm Aegis</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/homepage.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="icon" href="images/logo1.png" type="image/png" sizes="32x32">
    <link rel="shortcut icon" href="images/logo1.png">
    <meta name="theme-color" content="#2e7d32">

    <style>
        :root {
            --primary-color: #2e7d32;
            --secondary-color: #4caf50;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --info-color: #2196f3;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #c8f0c8;
            color: #333;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .top-header {
            background-color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header-left h1 {
            font-size: 1.8rem;
            color: var(--primary-color);
        }

        .search-box {
            display: flex;
            align-items: center;
            background-color: #f5f5f5;
            border-radius: 20px;
            padding: 8px 15px;
            width: 300px;
        }

        .search-box i {
            color: #777;
            margin-right: 10px;
        }

        .search-box input {
            border: none;
            background: transparent;
            outline: none;
            width: 100%;
        }

        .container {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 1.8rem;
            color: var(--primary-color);
        }

        .page-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #1b5e20;
        }

        .btn-secondary {
            background-color: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background-color: #d6d6d6;
        }

        /* Forum Styles */
        .forum-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .category-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .category-tab {
            padding: 10px 20px;
            background-color: white;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .category-tab:hover {
            background-color: #f0f0f0;
        }

        .category-tab.active {
            background-color: var(--primary-color);
            color: white;
        }

        .category-tag {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .tag-disease {
            background-color: #ffebee;
            color: #d32f2f;
        }

        .tag-treatment {
            background-color: #e8f5e9;
            color: var(--primary-color);
        }

        .tag-general {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .tag-farming {
            background-color: #fff3e0;
            color: #f57c00;
        }

        /* Create Post Section */
        .create-post {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .post-input {
            width: 100%;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 15px;
            resize: vertical;
            min-height: 100px;
        }

        .post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .post-tags {
            display: flex;
            gap: 10px;
        }

        /* Posts Grid */
        .posts-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .post-card {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .post-card:hover {
            transform: translateY(-2px);
        }

        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .post-author {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .author-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #2e7d32;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
        }

        .author-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .avatar-initial {
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .author-info h4 {
            font-size: 1rem;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .author-info .post-time {
            font-size: 0.85rem;
            color: #777;
        }

        .post-category {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .post-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 10px;
        }

        .post-content {
            color: #555;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .post-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #777;
        }

        .post-actions-footer {
            display: flex;
            gap: 15px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 5px;
            color: #777;
            transition: all 0.3s;
        }

        .action-btn:hover {
            background-color: #f5f5f5;
            color: var(--primary-color);
        }

        .action-btn.liked {
            color: #f44336;
        }

        .action-btn.upvoted {
            color: var(--primary-color);
        }

        .action-btn.downvoted {
            color: #2196f3;
        }

        /* Replies Section */
        .replies-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .reply-input {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .reply-input textarea {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            resize: vertical;
            min-height: 80px;
        }

        .reply-btn {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .replies-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .reply-card {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
        }

        .reply-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .reply-author {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .reply-author .author-avatar {
            width: 30px;
            height: 30px;
        }

        .expert-tag {
            background-color: #fff3e0;
            color: #f57c00;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* Comment styles */
        .comment {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .comment-author {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #2e7d32;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
        }

        .comment-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .comment-avatar .avatar-initial {
            font-size: 1rem;
            color: white;
            font-weight: 600;
        }

        .comment-info {
            flex: 1;
        }

        .comment-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .comment-author-name {
            font-weight: 600;
            color: #333;
        }

        .comment-time {
            color: #666;
            font-size: 0.85rem;
        }

        .comment-content {
            color: #444;
            line-height: 1.5;
        }

        .expert-badge {
            background-color: #ff9800;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .expert-badge i {
            font-size: 0.7rem;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #777;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-textarea {
            min-height: 150px;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #777;
        }

        .no-data i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #ddd;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard-container {
                flex-direction: column;
            }

            .main-content {
                width: 100%;
            }

            .post-actions {
                flex-direction: column;
                gap: 15px;
            }

            .post-tags {
                flex-wrap: wrap;
            }

            .modal-content {
                width: 95%;
                margin: 20px;
            }

            .category-tabs {
                overflow-x: auto;
            }
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <div id="sidebarPlaceholder"></div>
        <script src="js/sidebar-loader.js"></script>

        <main class="main-content">
            <div class="top-header">
                <div class="header-left">
                    <h1>Community Forum</h1>
                </div>
            </div>

            <div class="container">
                <div class="page-header">
                    <h2 class="page-title">Community Discussions</h2>
                    <div class="page-actions">
                        <button class="btn btn-secondary" id="filterBtn">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                        <button class="btn btn-primary" id="newPostBtn">
                            <i class="fas fa-plus"></i> New Discussion
                        </button>
                    </div>
                </div>

                <!-- Category Tabs -->
                <div class="category-tabs">
                    <div class="category-tab active" data-category="all">
                        <i class="fas fa-globe"></i>
                        <span>All Topics</span>
                    </div>
                    <div class="category-tab" data-category="disease">
                        <i class="fas fa-virus"></i>
                        <span>Diseases</span>
                    </div>
                    <div class="category-tab" data-category="treatment">
                        <i class="fas fa-shield-alt"></i>
                        <span>Treatments</span>
                    </div>
                    <div class="category-tab" data-category="farming">
                        <i class="fas fa-tractor"></i>
                        <span>General Farming</span>
                    </div>
                    <div class="category-tab" data-category="question">
                        <i class="fas fa-question-circle"></i>
                        <span>Questions</span>
                    </div>
                </div>

                <!-- Create Post Section -->
                <div class="create-post" id="createPostSection" style="display: none;">
                    <textarea class="post-input" id="postContentInput"
                        placeholder="What would you like to discuss?"></textarea>
                    <div class="post-actions">
                        <div class="post-tags">
                            <select id="postCategorySelect" class="category-tab">
                                <option value="disease">Disease Discussion</option>
                                <option value="treatment">Treatment Methods</option>
                                <option value="farming">General Farming</option>
                                <option value="question">Ask Question</option>
                            </select>
                            <input type="text" id="postTagsInput" placeholder="Add tags (comma separated)"
                                style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div>
                            <button class="btn btn-secondary" id="cancelPostBtn">Cancel</button>
                            <button class="btn btn-primary" id="submitPostBtn">Post Discussion</button>
                        </div>
                    </div>
                </div>

                <!-- Posts Grid -->
                <div class="posts-grid" id="postsGrid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading discussions...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Post Detail Modal -->
    <div class="modal" id="postDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Discussion Details</h2>
                <button class="close-modal" id="closePostModal">&times;</button>
            </div>
            <div class="modal-body" id="postDetailContent">
                <!-- Post details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Edit Post Modal -->
    <div class="modal" id="editPostModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Discussion</h2>
                <button class="close-modal" id="closeEditModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editPostForm">
                    <div class="form-group">
                        <label class="form-label">Title</label>
                        <input type="text" id="editPostTitle" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Content</label>
                        <textarea id="editPostContent" class="form-textarea" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select id="editPostCategory" class="form-select">
                            <option value="disease">Disease Discussion</option>
                            <option value="treatment">Treatment Methods</option>
                            <option value="farming">General Farming</option>
                            <option value="question">Ask Question</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tags</label>
                        <input type="text" id="editPostTags" class="form-input"
                            placeholder="e.g., ganoderma, fertilizer, pests">
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancelEditBtn">Cancel</button>
                <button class="btn btn-primary" id="saveEditBtn">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Filter Modal -->
    <div class="modal" id="filterModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Filter Discussions</h2>
                <button class="close-modal" id="closeFilterBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select id="filterCategory" class="form-select">
                        <option value="all">All Categories</option>
                        <option value="disease">Disease Discussion</option>
                        <option value="treatment">Treatment Methods</option>
                        <option value="farming">General Farming</option>
                        <option value="question">Ask Question</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Sort By</label>
                    <select id="filterSort" class="form-select">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="mostLiked">Most Liked</option>
                        <option value="mostReplies">Most Replies</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Time Range</label>
                    <select id="filterTime" class="form-select">
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                    </select>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="clearFiltersBtn">Clear Filters</button>
                <button class="btn btn-primary" id="applyFiltersBtn">Apply Filters</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, collection, getDocs, addDoc, updateDoc, deleteDoc, query, where, orderBy, limit, serverTimestamp, arrayUnion, arrayRemove, Timestamp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAf-wtZpl8wVjCymdLlC-YGlv7xn0yEMMU",
            authDomain: "palmaegis-setup.firebaseapp.com",
            projectId: "palmaegis-setup",
            storageBucket: "palmaegis-setup.firebasestorage.app",
            messagingSenderId: "445887502374",
            appId: "1:445887502374:web:a5f6ecaa90b88447626ee7"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables
        let currentUser = null;
        let currentFilters = {
            category: 'all',
            sort: 'newest',
            time: 'all'
        };
        let posts = [];
        let currentPostId = null;

        // Check authentication state
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                window.currentUser = user; // Make available globally for sidebar
                console.log('User signed in:', user.email);

                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        window.userData = userData; // Make available globally for sidebar
                        updateUserProfile(user, userData);
                    }

                    // Load posts data
                    await loadPosts();
                } catch (error) {
                    console.error('Error loading user data:', error);
                    showError("Failed to load forum data. Please try again.");
                }
            } else {
                console.log('User not signed in');
                window.location.href = 'signin.html';
            }
        });

        function updateUserProfile(user, userData) {
            const userNameElement = document.querySelector('.user-name');
            const userRoleElement = document.querySelector('.user-role');
            const userAvatarElement = document.getElementById('sidebarUserAvatar');

            const displayName = userData.firstName && userData.lastName
                ? `${userData.firstName} ${userData.lastName}`
                : userData.username
                    ? userData.username
                    : userData.displayName || user.displayName || user.email.split('@')[0] || 'User';

            if (userNameElement) userNameElement.textContent = displayName;
            if (userRoleElement) userRoleElement.textContent = userData.bio || 'Farmer';

            // Update profile image
            if (userAvatarElement) {
                const profileImageUrl = userData.imageBase64 || userData.picture || user.photoURL;
                if (profileImageUrl) {
                    userAvatarElement.src = profileImageUrl;
                    userAvatarElement.onerror = () => {
                        userAvatarElement.onerror = null;
                        userAvatarElement.src = 'images/user-avatar.jpg';
                    };
                }
            }
        }

        // Get user's profile data (name + avatar)
        async function getUserProfile(userId) {
            try {
                const userDoc = await getDoc(doc(db, "users", userId));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    console.log('User profile data retrieved:', { 
                        userId, 
                        hasImageBase64: !!userData.imageBase64,
                        imageBase64Length: userData.imageBase64 ? userData.imageBase64.length : 0,
                        imageBase64Start: userData.imageBase64 ? userData.imageBase64.substring(0, 50) + '...' : 'none'
                    });
                    
                    const fullName = userData.firstName && userData.lastName
                        ? `${userData.firstName} ${userData.lastName}`
                        : userData.username || 'User';
                    const profileImage = userData.imageBase64 || userData.profileImage || userData.avatar || null;
                    
                    return {
                        fullName: fullName,
                        profileImage: profileImage,
                        isExpert: userData.isExpert || false
                    };
                }
                console.log('No user document found for ID:', userId);
                return null;
            } catch (error) {
                console.error('Error getting user profile:', error);
                return null;
            }
        }

        // Load posts from Firebase
        async function loadPosts() {
            try {
                const postsGrid = document.getElementById('postsGrid');
                postsGrid.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading discussions...</p>
                </div>
            `;

                // SIMPLE server query (single orderBy only) to avoid composite index requirements
                const postsRef = collection(db, "forum_posts");
                // fetch the most recent 200 posts (adjust number if you need)
                const q = query(postsRef, orderBy("createdAt", "desc"), limit(200));
                const querySnapshot = await getDocs(q);

                // turn snapshot into plain array with normalized dates
                const allPosts = [];
                querySnapshot.forEach((d) => {
                    const data = d.data() || {};
                    let createdAtDate = null;
                    if (data.createdAt && typeof data.createdAt.toDate === 'function') {
                        createdAtDate = data.createdAt.toDate();
                    } else if (data.createdAt instanceof Date) {
                        createdAtDate = data.createdAt;
                    }
                    
                    // Debug: Check avatar data
                    console.log(`Post ${d.id} avatar data:`, {
                        authorName: data.authorName,
                        hasAuthorAvatar: !!data.authorAvatar,
                        avatarType: data.authorAvatar ? (data.authorAvatar.startsWith('data:image') ? 'Base64' : 'URL') : 'None'
                    });
                    
                    allPosts.push({ id: d.id, createdAtDate, ...data });
                });

                // CLIENT-SIDE: apply category and time filters and sorting to avoid composite index
                let filtered = allPosts;

                // category
                if (currentFilters.category && currentFilters.category !== 'all') {
                    filtered = filtered.filter(p => (p.category || '').toLowerCase() === String(currentFilters.category).toLowerCase());
                }

                // time range
                if (currentFilters.time && currentFilters.time !== 'all') {
                    const now = new Date();
                    let startDate = null;
                    switch (currentFilters.time) {
                        case 'today':
                            startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
                            break;
                        case 'week':
                            startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
                            break;
                        case 'month':
                            startDate = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
                            break;
                    }
                    if (startDate) {
                        filtered = filtered.filter(p => p.createdAtDate && p.createdAtDate >= startDate);
                    }
                }

                // search text (if search input present)
                const searchEl = document.getElementById('searchInput');
                const searchTerm = searchEl && searchEl.value ? searchEl.value.trim().toLowerCase() : '';
                if (searchTerm) {
                    filtered = filtered.filter(p => {
                        const title = (p.title || '').toLowerCase();
                        const content = (p.content || '').toLowerCase();
                        const author = (p.authorName || '').toLowerCase();
                        return title.includes(searchTerm) || content.includes(searchTerm) || author.includes(searchTerm);
                    });
                }

                // client-side sorting
                switch (currentFilters.sort) {
                    case 'newest':
                        filtered.sort((a, b) => (b.createdAtDate || 0) - (a.createdAtDate || 0));
                        break;
                    case 'oldest':
                        filtered.sort((a, b) => (a.createdAtDate || 0) - (b.createdAtDate || 0));
                        break;
                    case 'mostLiked':
                        filtered.sort((a, b) => ((b.likesCount || 0) - (a.likesCount || 0)));
                        break;
                    case 'mostReplies':
                        filtered.sort((a, b) => ((b.repliesCount || 0) - (a.repliesCount || 0)));
                        break;
                    default:
                        // already ordered by createdAt desc from server, but ensure fallback
                        filtered.sort((a, b) => (b.createdAtDate || 0) - (a.createdAtDate || 0));
                }

                // set global posts and render
                posts = filtered;
                if (posts.length === 0) {
                    showNoPosts();
                    return;
                }
                displayPosts();
            } catch (error) {
                console.error("Error loading posts:", error);
                const message = (error && error.message) ? error.message : 'Unable to load discussions. Please try again.';
                showError(message, error);
            }
        }

        // Display posts in grid
        function displayPosts() {
            const postsGrid = document.getElementById('postsGrid');
            postsGrid.innerHTML = '';

            if (posts.length === 0) {
                showNoPosts();
                return;
            }

            posts.forEach(post => {
                createPostCard(post);
            });
        }

        // Create a post card
        function createPostCard(post) {
            const postsGrid = document.getElementById('postsGrid');

            const postDate = post.createdAt ? new Date(post.createdAt.toDate()).toLocaleDateString() : 'Recent';
            const tags = post.tags || [];
            const likesCount = post.likes ? post.likes.length : 0;
            const repliesCount = post.replies ? post.replies.length : 0;

            let categoryTag = '';
            switch (post.category) {
                case 'disease':
                    categoryTag = '<span class="category-tag tag-disease">Disease</span>';
                    break;
                case 'treatment':
                    categoryTag = '<span class="category-tag tag-treatment">Treatment</span>';
                    break;
                case 'farming':
                    categoryTag = '<span class="category-tag tag-farming">Farming</span>';
                    break;
                case 'question':
                    categoryTag = '<span class="category-tag tag-general">Question</span>';
                    break;
            }

            const isLiked = post.likes && post.likes.includes(currentUser.uid);
            const isUpvoted = post.upvotes && post.upvotes.includes(currentUser.uid);
            const isDownvoted = post.downvotes && post.downvotes.includes(currentUser.uid);

            // Create avatar HTML
            let avatarHtml = '';
            if (post.authorAvatar) {
                console.log(`Creating avatar for post ${post.id}: Using image`);
                avatarHtml = `<img src="${post.authorAvatar}" alt="${post.authorName || 'User'}" 
                                 onerror="console.error('Failed to load image for post ${post.id}'); this.onerror=null; this.parentElement.innerHTML='<div class=\'avatar-initial\'>${post.authorName ? post.authorName.charAt(0).toUpperCase() : 'U'}</div>';" />`;
            } else {
                console.log(`Creating avatar for post ${post.id}: Using initial`);
                avatarHtml = `<div class="avatar-initial">${post.authorName ? post.authorName.charAt(0).toUpperCase() : 'U'}</div>`;
            }

            const postCard = document.createElement('div');
            postCard.className = 'post-card';
            postCard.setAttribute('data-id', post.id);

            postCard.innerHTML = `
            <div class="post-header">
                <div class="post-author">
                    <div class="author-avatar">
                        ${avatarHtml}
                    </div>
                    <div class="author-info">
                        <h4>${post.authorName || 'Anonymous'} 
                            ${post.isExpert ? '<span class="expert-tag">Expert</span>' : ''}
                        </h4>
                        <div class="post-time">${postDate}</div>
                    </div>
                </div>
                <div class="post-category">
                    ${categoryTag}
                    ${tags.map(tag => `<span class="category-tag tag-general">${tag}</span>`).join('')}
                </div>
            </div>
            
            <h3 class="post-title">${post.title}</h3>
            <div class="post-content">${post.content}</div>
            
            <div class="post-stats">
                <div class="stat">
                    <i class="fas fa-heart"></i>
                    <span>${likesCount}</span>
                </div>
                <div class="stat">
                    <i class="fas fa-comment"></i>
                    <span>${repliesCount}</span>
                </div>
                <div class="stat">
                    <i class="fas fa-thumbs-up"></i>
                    <span>${post.upvotes ? post.upvotes.length : 0}</span>
                </div>
                <div class="stat">
                    <i class="fas fa-thumbs-down"></i>
                    <span>${post.downvotes ? post.downvotes.length : 0}</span>
                </div>
            </div>
            
            <div class="post-actions-footer">
                <button class="action-btn like-btn ${isLiked ? 'liked' : ''}" data-action="like">
                    <i class="fas fa-heart"></i>
                    <span>Like</span>
                </button>
                <button class="action-btn upvote-btn ${isUpvoted ? 'upvoted' : ''}" data-action="upvote">
                    <i class="fas fa-thumbs-up"></i>
                    <span>Upvote</span>
                </button>
                <button class="action-btn downvote-btn ${isDownvoted ? 'downvoted' : ''}" data-action="downvote">
                    <i class="fas fa-thumbs-down"></i>
                    <span>Downvote</span>
                </button>
                <button class="action-btn reply-btn" data-action="reply">
                    <i class="fas fa-reply"></i>
                    <span>Reply</span>
                </button>
                ${post.authorId === currentUser.uid ? `
                    <button class="action-btn edit-btn" data-action="edit">
                        <i class="fas fa-edit"></i>
                        <span>Edit</span>
                    </button>
                    <button class="action-btn delete-btn" data-action="delete">
                        <i class="fas fa-trash"></i>
                        <span>Delete</span>
                    </button>
                ` : ''}
                <button class="action-btn view-btn" data-action="view">
                    <i class="fas fa-expand"></i>
                    <span>View</span>
                </button>
            </div>
        `;

            postsGrid.appendChild(postCard);

            // Add event listeners for buttons
            attachPostEventListeners(postCard, post.id);
        }

        // Attach event listeners to post card buttons
        function attachPostEventListeners(postCard, postId) {
            const likeBtn = postCard.querySelector('.like-btn');
            const upvoteBtn = postCard.querySelector('.upvote-btn');
            const downvoteBtn = postCard.querySelector('.downvote-btn');
            const replyBtn = postCard.querySelector('.reply-btn');
            const editBtn = postCard.querySelector('.edit-btn');
            const deleteBtn = postCard.querySelector('.delete-btn');
            const viewBtn = postCard.querySelector('.view-btn');

            if (likeBtn) {
                likeBtn.addEventListener('click', () => toggleLike(postId));
            }

            if (upvoteBtn) {
                upvoteBtn.addEventListener('click', () => toggleVote(postId, 'upvote'));
            }

            if (downvoteBtn) {
                downvoteBtn.addEventListener('click', () => toggleVote(postId, 'downvote'));
            }

            if (replyBtn) {
                replyBtn.addEventListener('click', () => showReplySection(postId));
            }

            if (editBtn) {
                editBtn.addEventListener('click', () => openEditPostModal(postId));
            }

            if (deleteBtn) {
                deleteBtn.addEventListener('click', () => deletePost(postId));
            }

            if (viewBtn) {
                viewBtn.addEventListener('click', () => viewPostDetails(postId));
            }
        }

        // Toggle like on a post
        async function toggleLike(postId) {
            try {
                const postRef = doc(db, "forum_posts", postId);
                const post = posts.find(p => p.id === postId);

                if (post.likes && post.likes.includes(currentUser.uid)) {
                    // Unlike
                    await updateDoc(postRef, {
                        likes: arrayRemove(currentUser.uid),
                        likesCount: (post.likesCount || 0) - 1
                    });
                } else {
                    // Like
                    await updateDoc(postRef, {
                        likes: arrayUnion(currentUser.uid),
                        likesCount: (post.likesCount || 0) + 1
                    });
                }

                // Reload posts
                await loadPosts();

            } catch (error) {
                console.error("Error toggling like:", error);
                alert("Failed to update like. Please try again.");
            }
        }

        // Toggle vote (upvote/downvote)
        async function toggleVote(postId, voteType) {
            try {
                const postRef = doc(db, "forum_posts", postId);
                const post = posts.find(p => p.id === postId);

                const oppositeVoteType = voteType === 'upvote' ? 'downvote' : 'upvote';
                const oppositeArray = oppositeVoteType + 's';

                if (post[voteType + 's'] && post[voteType + 's'].includes(currentUser.uid)) {
                    // Remove vote
                    await updateDoc(postRef, {
                        [voteType + 's']: arrayRemove(currentUser.uid)
                    });
                } else {
                    // Add vote and remove opposite vote if exists
                    const updates = {
                        [voteType + 's']: arrayUnion(currentUser.uid)
                    };

                    if (post[oppositeArray] && post[oppositeArray].includes(currentUser.uid)) {
                        updates[oppositeArray] = arrayRemove(currentUser.uid);
                    }

                    await updateDoc(postRef, updates);
                }

                // Reload posts
                await loadPosts();

            } catch (error) {
                console.error("Error toggling vote:", error);
                alert("Failed to update vote. Please try again.");
            }
        }

        // Create a new post
        async function createPost(content, category, tags) {
            try {
                if (!content.trim()) {
                    alert("Please enter some content for your discussion.");
                    return;
                }

                const userProfile = await getUserProfile(currentUser.uid);

                const postData = {
                    title: content.substring(0, 100) + (content.length > 100 ? '...' : ''),
                    content: content,
                    category: category,
                    tags: tags ? tags.split(',').map(tag => tag.trim()) : [],
                    authorId: currentUser.uid,
                    authorName: userProfile?.fullName || currentUser.email.split('@')[0],
                    authorAvatar: userProfile?.profileImage || null,
                    isExpert: userProfile?.isExpert || false,
                    createdAt: serverTimestamp(),
                    likes: [],
                    likesCount: 0,
                    upvotes: [],
                    downvotes: [],
                    replies: [],
                    repliesCount: 0
                };

                await addDoc(collection(db, "forum_posts"), postData);

                // Clear input and hide create post section
                document.getElementById('postContentInput').value = '';
                document.getElementById('postTagsInput').value = '';
                document.getElementById('createPostSection').style.display = 'none';

                // Reload posts
                await loadPosts();

                alert("Discussion posted successfully!");

            } catch (error) {
                console.error("Error creating post:", error);
                alert("Failed to create discussion. Please try again.");
            }
        }

        // Update an existing post
        async function updatePost(postId, title, content, category, tags) {
            try {
                const postRef = doc(db, "forum_posts", postId);

                await updateDoc(postRef, {
                    title: title,
                    content: content,
                    category: category,
                    tags: tags ? tags.split(',').map(tag => tag.trim()) : [],
                    updatedAt: serverTimestamp()
                });

                // Close edit modal
                closeModal('editPostModal');

                // Reload posts
                await loadPosts();

                alert("Discussion updated successfully!");

            } catch (error) {
                console.error("Error updating post:", error);
                alert("Failed to update discussion. Please try again.");
            }
        }

        // Delete a post
        async function deletePost(postId) {
            if (!confirm("Are you sure you want to delete this discussion? This action cannot be undone.")) {
                return;
            }

            try {
                await deleteDoc(doc(db, "forum_posts", postId));

                // Reload posts
                await loadPosts();

                alert("Discussion deleted successfully!");

            } catch (error) {
                console.error("Error deleting post:", error);
                alert("Failed to delete discussion. Please try again.");
            }
        }

        // Show reply section for a post
        function showReplySection(postId) {
            const postCard = document.querySelector(`.post-card[data-id="${postId}"]`);

            // Check if reply section already exists
            let replySection = postCard.querySelector('.replies-section');

            if (!replySection) {
                replySection = document.createElement('div');
                replySection.className = 'replies-section';
                replySection.innerHTML = `
                <div class="reply-input">
                    <textarea placeholder="Write your reply..." class="reply-textarea"></textarea>
                    <button class="reply-btn submit-reply">Reply</button>
                </div>
                <div class="replies-list" id="replies-${postId}">
                    <p>Loading replies...</p>
                </div>
            `;

                postCard.appendChild(replySection);

                // Add event listener for reply button
                const submitBtn = replySection.querySelector('.submit-reply');
                submitBtn.addEventListener('click', () => submitReply(postId));

                // Load replies
                loadReplies(postId);
            } else {
                replySection.style.display = replySection.style.display === 'none' ? 'block' : 'none';
            }
        }

        // Submit a reply to a post
        async function submitReply(postId) {
            const replySection = document.querySelector(`.post-card[data-id="${postId}"] .replies-section`);
            const textarea = replySection.querySelector('.reply-textarea');
            const replyContent = textarea.value.trim();

            if (!replyContent) {
                alert("Please enter a reply.");
                return;
            }

            try {
                const userProfile = await getUserProfile(currentUser.uid);

                const postRef = doc(db, "forum_posts", postId);
                const post = posts.find(p => p.id === postId);

                const replyData = {
                    content: replyContent,
                    authorId: currentUser.uid,
                    authorName: userProfile?.fullName || currentUser.email.split('@')[0],
                    authorAvatar: userProfile?.profileImage || null,
                    createdAt: serverTimestamp(),
                    isExpert: userProfile?.isExpert || false
                };

                // Add reply to post
                await updateDoc(postRef, {
                    replies: arrayUnion(replyData),
                    repliesCount: (post.repliesCount || 0) + 1
                });

                // Clear textarea
                textarea.value = '';

                // Reload replies
                loadReplies(postId);

            } catch (error) {
                console.error("Error submitting reply:", error);
                alert("Failed to submit reply. Please try again.");
            }
        }

        // Load replies for a post
        async function loadReplies(postId) {
            try {
                const postRef = doc(db, "forum_posts", postId);
                const postDoc = await getDoc(postRef);

                if (postDoc.exists()) {
                    const postData = postDoc.data();
                    const replies = postData.replies || [];

                    const repliesList = document.getElementById(`replies-${postId}`);
                    repliesList.innerHTML = '';

                    if (replies.length === 0) {
                        repliesList.innerHTML = '<p>No replies yet. Be the first to reply!</p>';
                        return;
                    }

                    replies.forEach(reply => {
                        const replyDate = reply.createdAt ? new Date(reply.createdAt.toDate()).toLocaleDateString() : 'Recent';

                        // Create reply avatar HTML
                        let replyAvatarHtml = '';
                        if (reply.authorAvatar) {
                            replyAvatarHtml = `<img src="${reply.authorAvatar}" alt="${reply.authorName || 'User'}" 
                                               onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'avatar-initial\'>${reply.authorName ? reply.authorName.charAt(0).toUpperCase() : 'R'}</div>';" />`;
                        } else {
                            replyAvatarHtml = `<div class="avatar-initial">${reply.authorName ? reply.authorName.charAt(0).toUpperCase() : 'R'}</div>`;
                        }

                        const replyCard = document.createElement('div');
                        replyCard.className = 'reply-card';
                        replyCard.innerHTML = `
                        <div class="reply-header">
                            <div class="reply-author">
                                <div class="author-avatar" style="width: 30px; height: 30px;">
                                    ${replyAvatarHtml}
                                </div>
                                <div>
                                    <strong>${reply.authorName || 'Anonymous'}</strong>
                                    ${reply.isExpert ? '<span class="expert-tag">Expert</span>' : ''}
                                </div>
                            </div>
                            <div class="reply-time">${replyDate}</div>
                        </div>
                        <div class="reply-content">${reply.content}</div>
                    `;

                        repliesList.appendChild(replyCard);
                    });
                }

            } catch (error) {
                console.error("Error loading replies:", error);
            }
        }

        // View post details
        async function viewPostDetails(postId) {
            try {
                const postRef = doc(db, "forum_posts", postId);
                const postDoc = await getDoc(postRef);

                if (postDoc.exists()) {
                    const post = postDoc.data();
                    const postDate = post.createdAt ? new Date(post.createdAt.toDate()).toLocaleDateString() : 'Recent';

                    // Create avatar HTML for modal
                    let modalAvatarHtml = '';
                    if (post.authorAvatar) {
                        modalAvatarHtml = `<img src="${post.authorAvatar}" alt="${post.authorName || 'User'}" 
                                           onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'avatar-initial\'>${post.authorName ? post.authorName.charAt(0).toUpperCase() : 'U'}</div>';" />`;
                    } else {
                        modalAvatarHtml = `<div class="avatar-initial">${post.authorName ? post.authorName.charAt(0).toUpperCase() : 'U'}</div>`;
                    }

                    const modalContent = document.getElementById('postDetailContent');
                    modalContent.innerHTML = `
                    <div class="post-detail">
                        <div class="post-header">
                            <div class="post-author">
                                <div class="author-avatar">
                                    ${modalAvatarHtml}
                                </div>
                                <div class="author-info">
                                    <h3>${post.authorName || 'Anonymous'} 
                                        ${post.isExpert ? '<span class="expert-tag">Expert</span>' : ''}
                                    </h3>
                                    <div class="post-time">${postDate}</div>
                                </div>
                            </div>
                            <div class="post-category">
                                ${post.category === 'disease' ? '<span class="category-tag tag-disease">Disease</span>' : ''}
                                ${post.category === 'treatment' ? '<span class="category-tag tag-treatment">Treatment</span>' : ''}
                                ${post.category === 'farming' ? '<span class="category-tag tag-farming">Farming</span>' : ''}
                                ${post.category === 'question' ? '<span class="category-tag tag-general">Question</span>' : ''}
                            </div>
                        </div>
                        
                        <h2>${post.title}</h2>
                        <div class="post-content" style="margin: 20px 0; padding: 20px; background: #f9f9f9; border-radius: 8px;">
                            ${post.content}
                        </div>
                        
                        <div class="post-tags" style="margin-bottom: 20px;">
                            ${(post.tags || []).map(tag => `<span class="category-tag tag-general">${tag}</span>`).join('')}
                        </div>
                        
                        <div class="post-stats" style="margin-bottom: 20px;">
                            <div class="stat"><i class="fas fa-heart"></i> ${post.likesCount || 0} Likes</div>
                            <div class="stat"><i class="fas fa-comment"></i> ${post.repliesCount || 0} Replies</div>
                            <div class="stat"><i class="fas fa-thumbs-up"></i> ${post.upvotes ? post.upvotes.length : 0} Upvotes</div>
                            <div class="stat"><i class="fas fa-thumbs-down"></i> ${post.downvotes ? post.downvotes.length : 0} Downvotes</div>
                        </div>
                        
                        <div class="replies-section" id="detail-replies-${postId}">
                            <h3>Replies (${post.repliesCount || 0})</h3>
                            <div class="reply-input" style="margin: 20px 0;">
                                <textarea placeholder="Write your reply..." id="detail-reply-text" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"></textarea>
                                <button class="btn btn-primary" onclick="submitDetailReply('${postId}')" style="margin-top: 10px;">Post Reply</button>
                            </div>
                            <div class="replies-list" id="detail-replies-list-${postId}">
                                Loading replies...
                            </div>
                        </div>
                    </div>
                `;

                    // Store current post ID globally for the reply function
                    window.currentDetailPostId = postId;

                    // Load replies
                    loadDetailReplies(postId);

                    // Show modal
                    openModal('postDetailModal');
                }

            } catch (error) {
                console.error("Error loading post details:", error);
                alert("Failed to load post details.");
            }
        }

        // Load replies for detail view
        async function loadDetailReplies(postId) {
            try {
                const postRef = doc(db, "forum_posts", postId);
                const postDoc = await getDoc(postRef);

                if (postDoc.exists()) {
                    const postData = postDoc.data();
                    const replies = postData.replies || [];

                    const repliesList = document.getElementById(`detail-replies-list-${postId}`);
                    repliesList.innerHTML = '';

                    if (replies.length === 0) {
                        repliesList.innerHTML = '<p>No replies yet. Be the first to reply!</p>';
                        return;
                    }

                    replies.forEach(reply => {
                        const replyDate = reply.createdAt ? new Date(reply.createdAt.toDate()).toLocaleDateString() : 'Recent';

                        // Create reply avatar HTML for detail view
                        let detailReplyAvatarHtml = '';
                        if (reply.authorAvatar) {
                            detailReplyAvatarHtml = `<img src="${reply.authorAvatar}" alt="${reply.authorName || 'User'}" 
                                                     onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'avatar-initial\'>${reply.authorName ? reply.authorName.charAt(0).toUpperCase() : 'R'}</div>';" />`;
                        } else {
                            detailReplyAvatarHtml = `<div class="avatar-initial">${reply.authorName ? reply.authorName.charAt(0).toUpperCase() : 'R'}</div>`;
                        }

                        const replyCard = document.createElement('div');
                        replyCard.className = 'reply-card';
                        replyCard.innerHTML = `
                        <div class="reply-header">
                            <div class="reply-author">
                                <div class="author-avatar" style="width: 30px; height: 30px;">
                                    ${detailReplyAvatarHtml}
                                </div>
                                <div>
                                    <strong>${reply.authorName || 'Anonymous'}</strong>
                                    ${reply.isExpert ? '<span class="expert-tag">Expert</span>' : ''}
                                </div>
                            </div>
                            <div class="reply-time">${replyDate}</div>
                        </div>
                        <div class="reply-content">${reply.content}</div>
                    `;

                        repliesList.appendChild(replyCard);
                    });
                }

            } catch (error) {
                console.error("Error loading replies:", error);
            }
        }

        // Submit reply from detail view
        window.submitDetailReply = async function (postId) {
            const textarea = document.getElementById('detail-reply-text');
            const replyContent = textarea.value.trim();

            if (!replyContent) {
                alert("Please enter a reply.");
                return;
            }

            try {
                const userProfile = await getUserProfile(currentUser.uid);

                const postRef = doc(db, "forum_posts", postId);
                const post = posts.find(p => p.id === postId) || {};

                const replyData = {
                    content: replyContent,
                    authorId: currentUser.uid,
                    authorName: userProfile?.fullName || currentUser.email.split('@')[0],
                    authorAvatar: userProfile?.profileImage || null,
                    createdAt: serverTimestamp(),
                    isExpert: userProfile?.isExpert || false
                };

                // Add reply to post
                await updateDoc(postRef, {
                    replies: arrayUnion(replyData),
                    repliesCount: (post.repliesCount || 0) + 1
                });

                // Clear textarea
                textarea.value = '';

                // Reload replies
                loadDetailReplies(postId);

                // Also reload main posts to update counts
                await loadPosts();

            } catch (error) {
                console.error("Error submitting reply:", error);
                alert("Failed to submit reply. Please try again.");
            }
        }

        // Open edit post modal
        async function openEditPostModal(postId) {
            try {
                const postRef = doc(db, "forum_posts", postId);
                const postDoc = await getDoc(postRef);

                if (postDoc.exists()) {
                    const post = postDoc.data();
                    currentPostId = postId;

                    document.getElementById('editPostTitle').value = post.title || '';
                    document.getElementById('editPostContent').value = post.content || '';
                    document.getElementById('editPostCategory').value = post.category || 'general';
                    document.getElementById('editPostTags').value = (post.tags || []).join(', ');

                    openModal('editPostModal');
                }

            } catch (error) {
                console.error("Error loading post for editing:", error);
                alert("Failed to load post for editing.");
            }
        }

        // Show no posts message
        function showNoPosts() {
            const postsGrid = document.getElementById('postsGrid');
            postsGrid.innerHTML = `
            <div class="no-data">
                <i class="fas fa-comments"></i>
                <h3>No Discussions Yet</h3>
                <p>Be the first to start a discussion!</p>
                <button class="btn btn-primary" id="createFirstPostBtn" style="margin-top: 15px;">
                    <i class="fas fa-plus"></i> Start Discussion
                </button>
            </div>
        `;

            document.getElementById('createFirstPostBtn').addEventListener('click', () => {
                document.getElementById('createPostSection').style.display = 'block';
                document.getElementById('postContentInput').focus();
            });
        }

        // Show error message
        function showError(message) {
            const postsGrid = document.getElementById('postsGrid');
            postsGrid.innerHTML = `
            <div class="error-message" style="background-color: #ffebee; border: 1px solid #f44336; border-radius: 8px; padding: 20px; text-align: center;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #f44336; margin-bottom: 15px;"></i>
                <h3>Error Loading Discussions</h3>
                <p>${message}</p>
                <button class="btn btn-primary" id="retryBtn" style="margin-top: 15px;">
                    <i class="fas fa-redo"></i> Try Again
                </button>
            </div>
        `;

            document.getElementById('retryBtn').addEventListener('click', () => {
                loadPosts();
            });
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // New post button
            document.getElementById('newPostBtn').addEventListener('click', () => {
                const createPostSection = document.getElementById('createPostSection');
                createPostSection.style.display = createPostSection.style.display === 'none' ? 'block' : 'none';
                if (createPostSection.style.display === 'block') {
                    document.getElementById('postContentInput').focus();
                }
            });

            // Cancel post button
            document.getElementById('cancelPostBtn').addEventListener('click', () => {
                document.getElementById('createPostSection').style.display = 'none';
                document.getElementById('postContentInput').value = '';
                document.getElementById('postTagsInput').value = '';
            });

            // Submit post button
            document.getElementById('submitPostBtn').addEventListener('click', () => {
                const content = document.getElementById('postContentInput').value;
                const category = document.getElementById('postCategorySelect').value;
                const tags = document.getElementById('postTagsInput').value;
                createPost(content, category, tags);
            });

            // Category tabs
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs
                    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                    // Add active class to clicked tab
                    tab.classList.add('active');

                    // Update filter and reload posts
                    currentFilters.category = tab.dataset.category;
                    loadPosts();
                });
            });

            // Filter modal
            document.getElementById('filterBtn').addEventListener('click', () => openModal('filterModal'));
            document.getElementById('closeFilterBtn').addEventListener('click', () => closeModal('filterModal'));
            document.getElementById('closePostModal').addEventListener('click', () => closeModal('postDetailModal'));
            document.getElementById('closeEditModal').addEventListener('click', () => closeModal('editPostModal'));
            document.getElementById('cancelEditBtn').addEventListener('click', () => closeModal('editPostModal'));

            // Apply filters
            document.getElementById('applyFiltersBtn').addEventListener('click', () => {
                currentFilters.category = document.getElementById('filterCategory').value;
                currentFilters.sort = document.getElementById('filterSort').value;
                currentFilters.time = document.getElementById('filterTime').value;

                closeModal('filterModal');
                loadPosts();
            });

            // Clear filters
            document.getElementById('clearFiltersBtn').addEventListener('click', () => {
                document.getElementById('filterCategory').value = 'all';
                document.getElementById('filterSort').value = 'newest';
                document.getElementById('filterTime').value = 'all';

                currentFilters = {
                    category: 'all',
                    sort: 'newest',
                    time: 'all'
                };

                // Reset category tabs
                document.querySelectorAll('.category-tab').forEach(tab => {
                    if (tab.dataset.category === 'all') {
                        tab.classList.add('active');
                    } else {
                        tab.classList.remove('active');
                    }
                });

                closeModal('filterModal');
                loadPosts();
            });

            // Save edit
            document.getElementById('saveEditBtn').addEventListener('click', () => {
                const title = document.getElementById('editPostTitle').value;
                const content = document.getElementById('editPostContent').value;
                const category = document.getElementById('editPostCategory').value;
                const tags = document.getElementById('editPostTags').value;

                if (currentPostId) {
                    updatePost(currentPostId, title, content, category, tags);
                }
            });

            // Search functionality
            document.getElementById('searchInput').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const postCards = document.querySelectorAll('.post-card');

                postCards.forEach(card => {
                    const title = card.querySelector('.post-title').textContent.toLowerCase();
                    const content = card.querySelector('.post-content').textContent.toLowerCase();
                    const author = card.querySelector('.author-info h4').textContent.toLowerCase();

                    if (title.includes(searchTerm) || content.includes(searchTerm) || author.includes(searchTerm)) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });

            // Logout functionality
            document.getElementById('logoutBtn').addEventListener('click', function (e) {
                e.preventDefault();
                signOut(auth).then(() => {
                    window.location.href = 'signin.html';
                }).catch((error) => {
                    console.error('Logout error:', error);
                });
            });

            // Close modals when clicking outside
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });
        });
    </script>
</body>
</html>
    <div id="sidebarPlaceholder"></div>
    <script src="js/sidebar-loader.js"></script>
    <!-- Add Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-storage-compat.js"></script>

    <script>
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAf-wtZpl8wVjCymdLlC-YGlv7xn0yEMMU",
        authDomain: "palmaegis-setup.firebaseapp.com",
        projectId: "palmaegis-setup",
        storageBucket: "palmaegis-setup.firebasestorage.app",
        messagingSenderId: "445887502374",
        appId: "1:445887502374:web:a5f6ecaa90b88447626ee7"
    };

    // Initialize Firebase
    try {
        // Check if Firebase is already initialized
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase initialized successfully");
        }
    } catch (error) {
        console.error("Firebase initialization error:", error);
    }

    // Get Firebase services
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();

    // Global variables for mobile scrolling
    let isMobileView = false;
    let touchStartY = 0;

    // Function to create dynamic avatar with initials
    function createDefaultAvatar(name) {
        console.log("Creating default avatar for:", name);
        const firstName = name?.split(' ')[0] || 'User';
        const lastName = name?.split(' ')[1] || '';
        const initials = (firstName.charAt(0) + (lastName ? lastName.charAt(0) : '')).toUpperCase();
        
        // Create a colored avatar with initials using SVG
        const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100">
            <rect width="100" height="100" fill="#2e7d32"/>
            <text x="50" y="55" font-size="40" text-anchor="middle" fill="white" font-family="Arial, sans-serif" font-weight="bold">${initials}</text>
        </svg>`;
        
        return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
    }

    // Mobile scrolling functionality
    function setupMobileScrolling() {
        const mainContent = document.getElementById('mainContent');
        const settingsContent = document.getElementById('settingsContent');
        
        isMobileView = window.innerWidth <= 768;
        
        if (!isMobileView) {
            // Desktop behavior
            if (mainContent) {
                mainContent.style.overflow = 'auto';
                mainContent.style.webkitOverflowScrolling = 'auto';
                mainContent.style.height = 'auto';
            }
            
            if (settingsContent) {
                settingsContent.style.height = 'calc(100vh - 150px)';
                settingsContent.style.overflowY = 'auto';
            }
            return;
        }
        
        // Mobile behavior
        if (mainContent) {
            // Enable smooth scrolling on mobile
            mainContent.style.webkitOverflowScrolling = 'touch';
            mainContent.style.overflow = 'auto';
            
            // Calculate proper height
            const headerHeight = document.querySelector('.mobile-header').offsetHeight;
            mainContent.style.height = `calc(100vh - ${headerHeight}px)`;
            
            // Handle scroll events
            mainContent.addEventListener('scroll', function() {
                updateScrollPosition();
            });
            
            // Prevent body scroll when scrolling content
            mainContent.addEventListener('touchstart', function(e) {
                touchStartY = e.touches[0].clientY;
            }, { passive: true });
            
            mainContent.addEventListener('touchmove', function(e) {
                // Allow scroll only if content is scrollable
                const content = this;
                const atTop = content.scrollTop === 0;
                const atBottom = content.scrollHeight - content.scrollTop === content.clientHeight;
                const direction = e.touches[0].clientY - touchStartY;
                
                // Prevent overscroll bounce effect
                if ((atTop && direction > 0) || (atBottom && direction < 0)) {
                    e.preventDefault();
                }
            }, { passive: false });
        }
        
        if (settingsContent) {
            settingsContent.style.webkitOverflowScrolling = 'touch';
            settingsContent.style.overflowY = 'auto';
            settingsContent.style.maxHeight = 'none';
            settingsContent.style.height = 'auto';
            
            // Adjust for iOS safe areas
            const safeAreaBottom = getSafeAreaBottom();
            if (safeAreaBottom > 0) {
                settingsContent.style.paddingBottom = `${safeAreaBottom + 20}px`;
            }
        }
        
        // Adjust viewport for mobile browsers
        adjustViewportForMobile();
        
        // Set up form inputs for mobile
        setupMobileFormInputs();
    }

    function getSafeAreaBottom() {
        // Get safe area inset for bottom (iOS notch devices)
        const style = window.getComputedStyle(document.documentElement);
        const safeAreaInsetBottom = style.getPropertyValue('--safe-area-inset-bottom');
        
        if (safeAreaInsetBottom) {
            return parseInt(safeAreaInsetBottom);
        }
        
        // Fallback detection
        const isIphone = /iPhone/.test(navigator.userAgent);
        const hasNotch = isIphone && window.screen.height >= 812;
        
        return hasNotch ? 34 : 0;
    }

    function adjustViewportForMobile() {
        if (!isMobileView) return;
        
        // Calculate viewport units considering browser UI
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
        
        // Apply to main content
        const mainContent = document.getElementById('mainContent');
        if (mainContent) {
            const headerHeight = document.querySelector('.mobile-header').offsetHeight;
            mainContent.style.height = `calc(var(--vh, 1vh) * 100 - ${headerHeight}px)`;
        }
    }

    function updateScrollPosition() {
        const scrollToTopBtn = document.getElementById('scrollToTop');
        const mainContent = document.getElementById('mainContent');
        
        if (scrollToTopBtn && mainContent) {
            if (mainContent.scrollTop > 300) {
                scrollToTopBtn.classList.add('visible');
            } else {
                scrollToTopBtn.classList.remove('visible');
            }
        }
    }

    function setupMobileFormInputs() {
        if (!isMobileView) return;
        
        const inputs = document.querySelectorAll('input, textarea, select');
        
        inputs.forEach(input => {
            // Prevent zoom on focus in iOS
            input.addEventListener('focus', function() {
                if (this.tagName === 'INPUT' || this.tagName === 'TEXTAREA') {
                    this.style.fontSize = '16px';
                }
                
                // Scroll input into view with delay for keyboard animation
                setTimeout(() => {
                    const inputRect = this.getBoundingClientRect();
                    const isInputInView = (
                        inputRect.top >= 0 &&
                        inputRect.bottom <= (window.innerHeight || document.documentElement.clientHeight)
                    );
                    
                    if (!isInputInView) {
                        this.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center',
                            inline: 'nearest'
                        });
                    }
                }, 500);
            });
            
            // Reset font size on blur
            input.addEventListener('blur', function() {
                if (this.tagName === 'INPUT' || this.tagName === 'TEXTAREA') {
                    this.style.fontSize = '';
                }
            });
            
            // Handle touch events for better mobile UX
            input.addEventListener('touchstart', function(e) {
                e.stopPropagation();
            });
        });
    }

    // Scroll to Top functionality
    const scrollToTopBtn = document.getElementById('scrollToTop');
    const settingsContent = document.getElementById('settingsContent');
    const sectionIndicator = document.getElementById('sectionIndicator');
    const indicatorDots = sectionIndicator ? sectionIndicator.querySelectorAll('a') : [];

    // Show/hide scroll to top button
    function handleScroll() {
        const scrollContainer = isMobileView ? 
            document.getElementById('mainContent') : 
            document.getElementById('settingsContent');
        
        if (scrollContainer) {
            if (scrollContainer.scrollTop > 300) {
                scrollToTopBtn.classList.add('visible');
            } else {
                scrollToTopBtn.classList.remove('visible');
            }

            // Update section indicator
            if (!isMobileView && indicatorDots.length > 0) {
                const sections = document.querySelectorAll('.profile-section.active');
                if (sections.length > 0) {
                    const currentSection = sections[0];
                    const sectionId = currentSection.id;
                    
                    indicatorDots.forEach(dot => {
                        dot.classList.remove('active');
                        if (dot.getAttribute('href').substring(1) === sectionId.replace('-section', '')) {
                            dot.classList.add('active');
                        }
                    });
                }
            }
        }
    }

    // Scroll to top function
    function scrollToTop() {
        const scrollContainer = isMobileView ? 
            document.getElementById('mainContent') : 
            document.getElementById('settingsContent');
        
        if (scrollContainer) {
            scrollContainer.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
    }

    // Mobile menu functionality
    const menuToggle = document.getElementById('menuToggle');
    const mobileOverlay = document.getElementById('mobileOverlay');
    const mainContent = document.getElementById('mainContent');

    // Function to safely get sidebar element
    function getSidebar() {
        return document.querySelector('.sidebar');
    }

    // Toggle mobile sidebar
    function toggleMobileMenu() {
        const sidebar = getSidebar();
        if (sidebar) {
            sidebar.classList.toggle('active');
            mobileOverlay.classList.toggle('active');
            document.body.style.overflow = sidebar.classList.contains('active') ? 'hidden' : '';
            
            // Lock/unlock main content scroll when menu is open
            if (mainContent) {
                if (sidebar.classList.contains('active')) {
                    mainContent.style.overflow = 'hidden';
                } else {
                    mainContent.style.overflow = 'auto';
                    if (isMobileView) {
                        mainContent.style.webkitOverflowScrolling = 'touch';
                    }
                }
            }
        }
    }

    if (menuToggle) {
        menuToggle.addEventListener('click', toggleMobileMenu);
    }

    if (mobileOverlay) {
        mobileOverlay.addEventListener('click', toggleMobileMenu);
    }

    // Close sidebar when clicking on a nav link (mobile)
    document.addEventListener('click', (e) => {
        if (window.innerWidth <= 768) {
            const sidebar = getSidebar();
            if (sidebar && sidebar.classList.contains('active')) {
                if (e.target.closest('.sidebar-nav a') || e.target.closest('.logout-btn')) {
                    toggleMobileMenu();
                }
            }
        }
    });

    // Theme toggle functionality
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const isDarkMode = document.body.classList.contains('dark-mode');
        
        // Update both theme toggles
        const desktopToggle = document.getElementById('desktopThemeToggle');
        const mobileToggle = document.getElementById('mobileThemeToggle');
        
        if (isDarkMode) {
            if (desktopToggle) desktopToggle.innerHTML = '<i class="fas fa-sun"></i>';
            if (mobileToggle) mobileToggle.innerHTML = '<i class="fas fa-sun"></i>';
        } else {
            if (desktopToggle) desktopToggle.innerHTML = '<i class="fas fa-moon"></i>';
            if (mobileToggle) mobileToggle.innerHTML = '<i class="fas fa-moon"></i>';
        }
        
        // Save theme preference
        localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        const desktopToggle = document.getElementById('desktopThemeToggle');
        const mobileToggle = document.getElementById('mobileThemeToggle');
        if (desktopToggle) desktopToggle.innerHTML = '<i class="fas fa-sun"></i>';
        if (mobileToggle) mobileToggle.innerHTML = '<i class="fas fa-sun"></i>';
    }

    // Attach theme toggle events
    const desktopThemeToggle = document.getElementById('desktopThemeToggle');
    const mobileThemeToggle = document.getElementById('mobileThemeToggle');
    
    if (desktopThemeToggle) {
        desktopThemeToggle.addEventListener('click', toggleTheme);
    }
    
    if (mobileThemeToggle) {
        mobileThemeToggle.addEventListener('click', toggleTheme);
    }

    // Section Navigation
    const navLinks = document.querySelectorAll('.settings-nav a');
    const sections = document.querySelectorAll('.profile-section');
    
    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const sectionId = link.getAttribute('data-section');
            
            // Update active nav
            navLinks.forEach(l => l.classList.remove('active'));
            link.classList.add('active');
            
            // Show corresponding section
            sections.forEach(section => {
                section.classList.remove('active');
                if (section.id === `${sectionId}-section`) {
                    section.classList.add('active');
                    section.classList.add('scrolling-content');
                    setTimeout(() => {
                        section.classList.remove('scrolling-content');
                    }, 500);
                }
            });

            // Scroll to top of section
            const scrollContainer = isMobileView ? 
                document.getElementById('mainContent') : 
                document.getElementById('settingsContent');
            
            if (scrollContainer) {
                scrollContainer.scrollTop = 0;
            }

            // Update section indicator
            if (!isMobileView && indicatorDots.length > 0) {
                indicatorDots.forEach(dot => {
                    dot.classList.remove('active');
                    if (dot.getAttribute('href').substring(1) === sectionId) {
                        dot.classList.add('active');
                    }
                });
            }
        });
    });

    // Section indicator navigation
    if (indicatorDots.length > 0) {
        indicatorDots.forEach(dot => {
            dot.addEventListener('click', (e) => {
                e.preventDefault();
                const sectionId = dot.getAttribute('href').substring(1);
                
                // Find corresponding nav link and click it
                const correspondingNavLink = document.querySelector(`.settings-nav a[data-section="${sectionId}"]`);
                if (correspondingNavLink) {
                    correspondingNavLink.click();
                }
            });
        });
    }

    // Profile management elements
    const profileForm = document.getElementById('profile-form');
    const passwordForm = document.getElementById('password-form');
    const fileInput = document.getElementById('file-input');
    const uploadTrigger = document.getElementById('upload-trigger');
    const profilePicture = document.getElementById('profile-picture');
    const usernameInput = document.getElementById('username');
    const firstNameInput = document.getElementById('first-name');
    const lastNameInput = document.getElementById('last-name');
    const bioInput = document.getElementById('bio');
    const locationInput = document.getElementById('location');
    const emailInput = document.getElementById('email');
    const phoneInput = document.getElementById('phone');
    const displayName = document.getElementById('display-name');
    const displayUsername = document.getElementById('display-username');
    const displayBio = document.getElementById('display-bio');
    const successNotification = document.getElementById('success-notification');
    const errorNotification = document.getElementById('error-notification');
    const authNotification = document.getElementById('auth-notification');
    const saveButton = document.getElementById('save-button');
    const cancelButton = document.getElementById('cancel-button');
    
    // Password elements
    const currentPasswordInput = document.getElementById('current-password');
    const newPasswordInput = document.getElementById('new-password');
    const confirmPasswordInput = document.getElementById('confirm-password');
    const passwordSuccessNotification = document.getElementById('password-success-notification');
    const passwordErrorNotification = document.getElementById('password-error-notification');
    const changePasswordButton = document.getElementById('change-password-button');
    const passwordToggleButtons = document.querySelectorAll('.password-toggle');
    const lengthReq = document.getElementById('length-req');
    const caseReq = document.getElementById('case-req');
    const numberReq = document.getElementById('number-req');
    const specialReq = document.getElementById('special-req');
    const passwordMatch = document.getElementById('password-match');

    let currentUser = null;
    let isUploading = false;

    // Set default avatar on error
    if (profilePicture) {
        profilePicture.onerror = function() {
            console.log("Profile picture failed to load, creating default avatar");
            const name = displayName ? displayName.textContent : 'User';
            this.src = createDefaultAvatar(name);
            this.onerror = null; // Prevent infinite loop
        };
    }

    // Authentication
    auth.onAuthStateChanged((user) => {
        if (user) {
            currentUser = user;
            console.log("User authenticated:", user.email);
            if (authNotification) authNotification.style.display = 'none';
            loadProfileData();
        } else {
            console.log("No user authenticated");
            currentUser = null;
            if (authNotification) authNotification.style.display = 'block';
            // Redirect to login if needed
            // window.location.href = 'signin.html';
        }
    });

    // Load profile data
    async function loadProfileData() {
        if (!currentUser) {
            console.log("No current user, skipping profile load");
            return;
        }

        try {
            console.log("Loading profile for user:", currentUser.uid);
            const doc = await db.collection('users').doc(currentUser.uid).get();
            
            if (doc.exists) {
                const data = doc.data();
                console.log("Profile data loaded:", data);

                // Update form fields
                if (usernameInput) {
                    usernameInput.value = data.username || currentUser.email?.split('@')[0] || '';
                }
                
                if (displayUsername) {
                    const username = data.username || currentUser.email?.split('@')[0] || 'username';
                    displayUsername.textContent = '@' + username;
                }
                
                if (firstNameInput) firstNameInput.value = data.firstName || '';
                if (lastNameInput) lastNameInput.value = data.lastName || '';
                
                if (displayName) {
                    const firstName = data.firstName || '';
                    const lastName = data.lastName || '';
                    const fullName = `${firstName} ${lastName}`.trim() || 'User';
                    displayName.textContent = fullName;
                }
                
                if (bioInput) bioInput.value = data.bio || '';
                if (displayBio) displayBio.textContent = data.bio || 'No bio yet';
                if (locationInput) locationInput.value = data.location || '';
                if (emailInput) emailInput.value = currentUser.email || '';
                if (phoneInput) phoneInput.value = data.phone || '';
                
                // UPDATE: Load profile picture from Firebase (like forum.html)
                if (profilePicture) {
                    console.log("Checking profile picture sources:", {
                        hasImageBase64: !!data.imageBase64,
                        hasPicture: !!data.picture,
                        hasPhotoURL: !!data.photoURL
                    });
                    
                    if (data.imageBase64) {
                        console.log("Using imageBase64 from Firestore");
                        profilePicture.src = data.imageBase64;
                    } else if (data.picture) {
                        console.log("Using picture field from Firestore");
                        profilePicture.src = data.picture;
                    } else if (data.photoURL) {
                        console.log("Using photoURL from Firebase Auth");
                        profilePicture.src = data.photoURL;
                    } else {
                        // Create dynamic avatar with user initials
                        console.log("No profile image found, creating dynamic avatar");
                        const name = `${data.firstName || ''} ${data.lastName || ''}`.trim() || 'User';
                        profilePicture.src = createDefaultAvatar(name);
                    }
                }
                
            } else {
                console.log("No profile found for user");
                // Set default values
                if (emailInput && currentUser.email) emailInput.value = currentUser.email;
                if (displayName) displayName.textContent = 'User';
                if (displayUsername) {
                    const username = currentUser.email?.split('@')[0] || 'username';
                    displayUsername.textContent = '@' + username;
                }
                
                // Set default avatar
                if (profilePicture) {
                    const name = currentUser.displayName || currentUser.email?.split('@')[0] || 'User';
                    profilePicture.src = createDefaultAvatar(name);
                }
            }
        } catch (err) {
            console.error('Error loading profile:', err);
            showNotification(errorNotification, 'Error loading profile data');
            
            // Set default avatar on error
            if (profilePicture) {
                profilePicture.src = createDefaultAvatar('User');
            }
        }
    }

    // File upload
    if (uploadTrigger) {
        uploadTrigger.addEventListener('click', () => {
            if (!currentUser) {
                showNotification(authNotification, 'Please log in first.');
                return;
            }
            if (fileInput) fileInput.click();
        });
    }

    if (fileInput) {
        fileInput.addEventListener('change', async () => {
            if (!currentUser || isUploading || !fileInput.files.length) return;
            const file = fileInput.files[0];
            if (!file) return;

            try {
                if (!file.type.startsWith('image/')) throw new Error('Only image files allowed.');
                if (file.size > 5 * 1024 * 1024) throw new Error('File too large (max 5MB).');

                isUploading = true;
                if (uploadTrigger) uploadTrigger.innerHTML = '<div class="loading"></div>';

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64Image = e.target.result;
                    if (profilePicture) profilePicture.src = base64Image;

                    try {
                        // Save to Firestore (same as forum.html does)
                        await db.collection('users').doc(currentUser.uid).set({
                            imageBase64: base64Image,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });

                        console.log("Profile picture saved to Firestore as base64");
                        showNotification(successNotification, 'Profile picture updated!');
                    } catch (dbError) {
                        console.error('Database error:', dbError);
                        showNotification(errorNotification, 'Error saving picture');
                    }
                };
                
                reader.onerror = () => {
                    throw new Error('Error reading file');
                };
                
                reader.readAsDataURL(file);

            } catch (error) {
                console.error('Upload error:', error);
                showNotification(errorNotification, error.message || 'Upload failed');
            } finally {
                isUploading = false;
                if (uploadTrigger) uploadTrigger.innerHTML = '<i class="fas fa-camera"></i>';
                fileInput.value = '';
            }
        });
    }

    // Profile form submission
    if (profileForm) {
        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) {
                showNotification(authNotification, 'Please log in first.');
                return;
            }

            if (!usernameInput || !usernameInput.value || !firstNameInput || !firstNameInput.value || !lastNameInput || !lastNameInput.value) {
                showNotification(errorNotification, 'Please fill all required fields.');
                return;
            }

            const profileData = {
                username: usernameInput.value,
                firstName: firstNameInput.value,
                lastName: lastNameInput.value,
                email: currentUser.email,
                bio: bioInput ? bioInput.value : '',
                location: locationInput ? locationInput.value : '',
                phone: phoneInput ? phoneInput.value : '',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (saveButton) {
                saveButton.disabled = true;
                saveButton.innerHTML = '<div class="loading"></div> Saving...';
            }

            try {
                await db.collection('users').doc(currentUser.uid).set(profileData, { merge: true });
                showNotification(successNotification, 'Profile updated successfully!');
                
                if (displayName) {
                    displayName.textContent = `${firstNameInput.value} ${lastNameInput.value}`.trim();
                }
                
                if (displayUsername) {
                    displayUsername.textContent = '@' + usernameInput.value;
                }
                
                if (displayBio && bioInput) {
                    displayBio.textContent = bioInput.value || 'No bio yet';
                }
                
                // Update avatar initials if no image is set
                if (profilePicture && !profilePicture.src.includes('data:image')) {
                    const name = `${firstNameInput.value} ${lastNameInput.value}`.trim() || 'User';
                    profilePicture.src = createDefaultAvatar(name);
                }
            } catch (err) {
                console.error('Error saving profile:', err);
                showNotification(errorNotification, 'Error saving profile');
            } finally {
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                }
            }
        });
    }

    // Cancel button
    if (cancelButton) {
        cancelButton.addEventListener('click', () => {
            loadProfileData();
        });
    }

    // Password form submission
    if (passwordForm) {
        passwordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) {
                showNotification(authNotification, 'Please log in first.');
                return;
            }

            const currentPassword = currentPasswordInput ? currentPasswordInput.value : '';
            const newPassword = newPasswordInput ? newPasswordInput.value : '';
            const confirmPassword = confirmPasswordInput ? confirmPasswordInput.value : '';

            if (!validatePassword(newPassword)) {
                showNotification(passwordErrorNotification, 'New password does not meet requirements.');
                return;
            }

            if (newPassword !== confirmPassword) {
                showNotification(passwordErrorNotification, 'Passwords do not match.');
                return;
            }

            if (changePasswordButton) {
                changePasswordButton.disabled = true;
                changePasswordButton.innerHTML = '<div class="loading"></div> Updating...';
            }

            try {
                const credential = firebase.auth.EmailAuthProvider.credential(
                    currentUser.email, 
                    currentPassword
                );
                
                await currentUser.reauthenticateWithCredential(credential);
                await currentUser.updatePassword(newPassword);
                
                showNotification(passwordSuccessNotification, 'Password changed successfully!');
                
                if (passwordForm) passwordForm.reset();
                resetPasswordValidation();
            } catch (err) {
                console.error('Error changing password:', err);
                let errorMessage = 'Error changing password.';
                
                if (err.code === 'auth/wrong-password') {
                    errorMessage = 'Current password is incorrect.';
                } else if (err.code === 'auth/weak-password') {
                    errorMessage = 'New password is too weak.';
                } else if (err.code === 'auth/requires-recent-login') {
                    errorMessage = 'Please log in again to change password.';
                }
                
                showNotification(passwordErrorNotification, errorMessage);
            } finally {
                if (changePasswordButton) {
                    changePasswordButton.disabled = false;
                    changePasswordButton.innerHTML = '<i class="fas fa-key"></i> Update Password';
                }
            }
        });
    }

    // Password validation
    function validatePassword(password) {
        if (!password) return false;
        
        const hasLength = password.length >= 8;
        const hasCase = /[a-z]/.test(password) && /[A-Z]/.test(password);
        const hasNumber = /\d/.test(password);
        const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);
        
        if (lengthReq) lengthReq.className = hasLength ? 'valid' : 'invalid';
        if (caseReq) caseReq.className = hasCase ? 'valid' : 'invalid';
        if (numberReq) numberReq.className = hasNumber ? 'valid' : 'invalid';
        if (specialReq) specialReq.className = hasSpecial ? 'valid' : 'invalid';
        
        return hasLength && hasCase && hasNumber && hasSpecial;
    }

    // Password validation UI
    if (newPasswordInput) {
        newPasswordInput.addEventListener('input', () => {
            validatePassword(newPasswordInput.value);
            checkPasswordMatch();
        });
    }

    if (confirmPasswordInput) {
        confirmPasswordInput.addEventListener('input', checkPasswordMatch);
    }

    function checkPasswordMatch() {
        if (!newPasswordInput || !confirmPasswordInput || !passwordMatch) return;
        
        const password = newPasswordInput.value;
        const confirm = confirmPasswordInput.value;
        
        if (confirm === '') {
            passwordMatch.style.display = 'none';
        } else if (password === confirm) {
            passwordMatch.style.display = 'flex';
            passwordMatch.className = 'notification success';
            passwordMatch.innerHTML = '<i class="fas fa-check-circle"></i> Passwords match';
        } else {
            passwordMatch.style.display = 'flex';
            passwordMatch.className = 'notification error';
            passwordMatch.innerHTML = '<i class="fas fa-exclamation-circle"></i> Passwords do not match';
        }
    }

    function resetPasswordValidation() {
        if (lengthReq) lengthReq.className = 'invalid';
        if (caseReq) caseReq.className = 'invalid';
        if (numberReq) numberReq.className = 'invalid';
        if (specialReq) specialReq.className = 'invalid';
        if (passwordMatch) passwordMatch.style.display = 'none';
    }

    // Password visibility toggle
    passwordToggleButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetId = button.getAttribute('data-target');
            const targetInput = document.getElementById(targetId);
            
            if (targetInput) {
                if (targetInput.type === 'password') {
                    targetInput.type = 'text';
                    button.innerHTML = '<i class="fas fa-eye-slash"></i>';
                } else {
                    targetInput.type = 'password';
                    button.innerHTML = '<i class="fas fa-eye"></i>';
                }
            }
        });
    });

    // Notification helper
    function showNotification(el, message) {
        if (!el) {
            console.log("Notification:", message);
            return;
        }
        
        // Clear existing text nodes except the icon
        while (el.childNodes.length > 1) {
            el.removeChild(el.lastChild);
        }
        
        // Add new message
        el.appendChild(document.createTextNode(' ' + message));
        el.style.display = 'flex';
        
        // Hide after 4 seconds
        setTimeout(() => {
            el.style.display = 'none';
        }, 4000);
    }

    // Handle window resize
    function handleResize() {
        setupMobileScrolling();
        
        if (window.innerWidth > 768) {
            // Close mobile menu on desktop
            const sidebar = getSidebar();
            if (sidebar) {
                sidebar.classList.remove('active');
                if (mobileOverlay) mobileOverlay.classList.remove('active');
                document.body.style.overflow = '';
                
                if (mainContent) {
                    mainContent.style.overflow = 'auto';
                }
            }
            
            // Show section indicator on desktop
            if (sectionIndicator) {
                sectionIndicator.style.display = 'flex';
            }
        } else {
            // Hide section indicator on mobile
            if (sectionIndicator) {
                sectionIndicator.style.display = 'none';
            }
            
            // Adjust viewport for mobile
            adjustViewportForMobile();
        }
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
        // Set initial scrolling setup
        setupMobileScrolling();
        
        // Set up scroll event listeners
        const scrollContainer = isMobileView ? 
            document.getElementById('mainContent') : 
            document.getElementById('settingsContent');
        
        if (scrollContainer) {
            scrollContainer.addEventListener('scroll', handleScroll);
        }
        
        if (scrollToTopBtn) {
            scrollToTopBtn.addEventListener('click', scrollToTop);
        }
        
        // Set initial padding for main content based on sidebar
        const sidebarElement = getSidebar();
        if (sidebarElement && window.innerWidth > 768 && mainContent) {
            const sidebarWidth = sidebarElement.offsetWidth;
            mainContent.style.marginLeft = `${sidebarWidth}px`;
            mainContent.style.width = `calc(100% - ${sidebarWidth}px)`;
        }
        
        // Initialize Firebase auth state
        console.log("Settings page initialized");
        
        // Set up resize listener
        window.addEventListener('resize', handleResize);
        
        // Handle orientation change specifically for mobile
        window.addEventListener('orientationchange', function() {
            if (window.innerWidth <= 768) {
                setTimeout(() => {
                    adjustViewportForMobile();
                    setupMobileScrolling();
                }, 300);
            }
        });
        
        // Add safe area CSS variable for iOS
        const safeAreaBottom = getSafeAreaBottom();
        if (safeAreaBottom > 0) {
            document.documentElement.style.setProperty('--safe-area-inset-bottom', `${safeAreaBottom}px`);
        }
        
        // Initial section indicator visibility
        handleResize();
    });
</script>
</body>
</html>