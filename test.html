<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Settings | Palm Aegis</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/homepage.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="icon" href="images/logo1.png" type="image/png" sizes="32x32">
    <link rel="shortcut icon" href="images/logo1.png">
    <meta name="theme-color" content="#2e7d32">

    <style>
        :root {
            --primary-color: #2e7d32;
            --secondary-color: #4caf50;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --info-color: #2196f3;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #c8f0c8;
            color: #333;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .top-header {
            background-color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header-left h1 {
            font-size: 1.8rem;
            color: var(--primary-color);
        }

        .container {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 1.8rem;
            color: var(--primary-color);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #1b5e20;
        }

        .btn-secondary {
            background-color: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background-color: #d6d6d6;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #d32f2f;
        }

        /* Profile Settings Styles */
        .settings-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .settings-card {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .settings-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.3rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: var(--primary-color);
        }

        /* Profile Picture Section */
        .profile-picture-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .profile-image-container {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }

        .profile-image {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--primary-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .image-placeholder {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background-color: #4caf50;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.5rem;
            font-weight: bold;
            border: 4px solid var(--primary-color);
            margin: 0 auto 20px;
        }

        .upload-overlay {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: var(--primary-color);
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-overlay:hover {
            background-color: #1b5e20;
            transform: scale(1.1);
        }

        #imageUpload {
            display: none;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-input[readonly] {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }

        .field-info {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .field-info i {
            color: var(--primary-color);
        }

        .save-changes-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .save-changes-btn:hover {
            background-color: #1b5e20;
            transform: translateY(-2px);
        }

        .save-changes-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .actions-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        /* Password Change Section */
        .password-toggle {
            position: relative;
        }

        .password-toggle .toggle-icon {
            position: absolute;
            right: 12px;
            top: 42px;
            cursor: pointer;
            color: #666;
        }

        .password-strength {
            height: 4px;
            border-radius: 2px;
            background-color: #e0e0e0;
            margin-top: 8px;
            overflow: hidden;
        }

        .strength-bar {
            height: 100%;
            width: 0%;
            transition: width 0.3s, background-color 0.3s;
        }

        /* Account Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid var(--primary-color);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: white;
            color: #333;
            padding: 15px 25px;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(150%);
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left: 4px solid var(--primary-color);
        }

        .toast.error {
            border-left: 4px solid var(--danger-color);
        }

        .toast.info {
            border-left: 4px solid var(--info-color);
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard-container {
                flex-direction: column;
            }

            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .form-row .form-group {
                margin-bottom: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .actions-row {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .container {
                padding: 20px;
            }

            .settings-card {
                padding: 20px;
            }
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <div id="sidebarPlaceholder"></div>
        <script src="js/sidebar-loader.js"></script>

        <main class="main-content">
            <div class="top-header">
                <div class="header-left">
                    <h1>Profile Settings</h1>
                </div>
            </div>

            <div class="container">
                <div class="page-header">
                    <h2 class="page-title">Manage Your Profile</h2>
                    <div class="page-actions">
                        <button class="btn btn-secondary" id="viewProfileBtn">
                            <i class="fas fa-eye"></i> View Public Profile
                        </button>
                    </div>
                </div>

                <div class="settings-container">
                    <!-- Toast Notification -->
                    <div id="toast" class="toast">
                        <i class="fas fa-check-circle"></i>
                        <span id="toastMessage">Changes saved successfully!</span>
                    </div>

                    <!-- Loading State -->
                    <div id="loadingState" class="loading">
                        <div class="spinner"></div>
                        <p>Loading your profile...</p>
                    </div>

                    <!-- Profile Settings Form -->
                    <form id="profileSettingsForm" style="display: none;">
                        <!-- Profile Picture Section -->
                        <div class="settings-card">
                            <div class="profile-picture-section">
                                <div class="profile-image-container">
                                    <div id="profileImagePlaceholder" class="image-placeholder">
                                        <span id="userInitials">JD</span>
                                    </div>
                                    <img id="profileImage" class="profile-image" src="" alt="Profile Picture" style="display: none;">
                                    <div class="upload-overlay" onclick="document.getElementById('imageUpload').click()">
                                        <i class="fas fa-camera"></i>
                                    </div>
                                    <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                                </div>
                                <p>Click the camera icon to upload a new profile picture</p>
                                <p class="field-info">
                                    <i class="fas fa-info-circle"></i> Recommended: Square image, max 2MB
                                </p>
                            </div>

                            <!-- Personal Information Section -->
                            <div class="settings-section">
                                <h3 class="section-title">
                                    <i class="fas fa-user"></i> Personal Information
                                </h3>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label" for="firstName">First Name *</label>
                                        <input type="text" id="firstName" class="form-input" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="lastName">Last Name *</label>
                                        <input type="text" id="lastName" class="form-input" required>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="username">Username *</label>
                                    <input type="text" id="username" class="form-input" required>
                                    <p class="field-info">
                                        <i class="fas fa-info-circle"></i> This will be displayed publicly in the forum
                                    </p>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="email">Email Address</label>
                                    <input type="email" id="email" class="form-input" readonly>
                                    <p class="field-info">
                                        <i class="fas fa-lock"></i> Email cannot be changed for security reasons
                                    </p>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="phone">Phone Number</label>
                                    <input type="tel" id="phone" class="form-input">
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="bio">Bio/Description</label>
                                    <textarea id="bio" class="form-textarea" 
                                              placeholder="Tell us about yourself, your farming experience, or your interests..."></textarea>
                                    <p class="field-info">
                                        <i class="fas fa-info-circle"></i> This will be visible on your public profile
                                    </p>
                                </div>
                            </div>

                            <!-- Account Security Section -->
                            <div class="settings-section">
                                <h3 class="section-title">
                                    <i class="fas fa-shield-alt"></i> Account Security
                                </h3>

                                <div class="form-group">
                                    <label class="form-label" for="currentPassword">Current Password</label>
                                    <div class="password-toggle">
                                        <input type="password" id="currentPassword" class="form-input">
                                        <i class="fas fa-eye toggle-icon" id="toggleCurrentPassword"></i>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="newPassword">New Password</label>
                                    <div class="password-toggle">
                                        <input type="password" id="newPassword" class="form-input">
                                        <i class="fas fa-eye toggle-icon" id="toggleNewPassword"></i>
                                    </div>
                                    <div class="password-strength">
                                        <div class="strength-bar" id="passwordStrengthBar"></div>
                                    </div>
                                    <p class="field-info">
                                        <i class="fas fa-info-circle"></i> Password must be at least 8 characters long
                                    </p>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="confirmPassword">Confirm New Password</label>
                                    <div class="password-toggle">
                                        <input type="password" id="confirmPassword" class="form-input">
                                        <i class="fas fa-eye toggle-icon" id="toggleConfirmPassword"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Account Statistics Section -->
                            <div class="settings-section">
                                <h3 class="section-title">
                                    <i class="fas fa-chart-bar"></i> Your Activity
                                </h3>
                                <div class="stats-grid">
                                    <div class="stat-card">
                                        <div class="stat-value" id="statPosts">0</div>
                                        <div class="stat-label">Forum Posts</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value" id="statReplies">0</div>
                                        <div class="stat-label">Replies</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value" id="statLikes">0</div>
                                        <div class="stat-label">Likes Received</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value" id="statDays">0</div>
                                        <div class="stat-label">Days Active</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="actions-row">
                                <div>
                                    <button type="button" class="btn btn-danger" id="deleteAccountBtn">
                                        <i class="fas fa-trash"></i> Delete Account
                                    </button>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-secondary" id="cancelChangesBtn">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                    <button type="submit" class="btn btn-primary" id="saveChangesBtn">
                                        <i class="fas fa-save"></i> Save Changes
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Delete Account Confirmation Modal -->
    <div class="modal" id="deleteAccountModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="modal-content" style="background-color: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                <h2 class="modal-title" style="color: var(--danger-color);">
                    <i class="fas fa-exclamation-triangle"></i> Delete Account
                </h2>
                <button class="close-modal" id="closeDeleteModal" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #777;">
                    &times;
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; color: #d32f2f; font-weight: 600;">
                    <i class="fas fa-exclamation-circle"></i> This action cannot be undone!
                </p>
                <p style="margin-bottom: 20px;">
                    Are you sure you want to delete your account? All your data, including forum posts and profile information, will be permanently removed.
                </p>
                <div class="form-group">
                    <label class="form-label" for="confirmDeletePassword">Enter your password to confirm:</label>
                    <input type="password" id="confirmDeletePassword" class="form-input" placeholder="Your current password">
                </div>
            </div>
            <div class="modal-actions" style="display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-secondary" id="cancelDeleteBtn">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash"></i> Delete Account Permanently
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js';
        import { 
            getAuth, 
            onAuthStateChanged, 
            updatePassword, 
            reauthenticateWithCredential,
            EmailAuthProvider,
            deleteUser 
        } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js';
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            updateDoc, 
            collection, 
            query, 
            where, 
            getDocs,
            deleteDoc 
        } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAf-wtZpl8wVjCymdLlC-YGlv7xn0yEMMU",
            authDomain: "palmaegis-setup.firebaseapp.com",
            projectId: "palmaegis-setup",
            storageBucket: "palmaegis-setup.firebasestorage.app",
            messagingSenderId: "445887502374",
            appId: "1:445887502374:web:a5f6ecaa90b88447626ee7"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables
        let currentUser = null;
        let userData = null;
        let originalFormData = {};

        // Check authentication state
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                window.currentUser = user; // Make available globally for sidebar
                console.log('User signed in:', user.email);

                try {
                    // Load user data from Firestore
                    await loadUserData(user.uid);
                    
                    // Load user statistics
                    await loadUserStatistics(user.uid);
                    
                    // Show the form
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('profileSettingsForm').style.display = 'block';
                    
                } catch (error) {
                    console.error('Error loading user data:', error);
                    showToast('Failed to load profile data. Please try again.', 'error');
                }
            } else {
                console.log('User not signed in');
                window.location.href = 'signin.html';
            }
        });

        // Load user data from Firestore
        async function loadUserData(userId) {
            try {
                const userDoc = await getDoc(doc(db, "users", userId));
                
                if (userDoc.exists()) {
                    userData = userDoc.data();
                    console.log('User data loaded:', userData);
                    
                    // Populate form fields
                    populateForm(userData);
                    
                    // Store original data for comparison
                    storeOriginalData();
                    
                    // Update sidebar profile
                    updateSidebarProfile(userData);
                } else {
                    console.log('No user document found, creating default...');
                    // Create default user document if it doesn't exist
                    await initializeUserProfile(userId);
                }
                
            } catch (error) {
                console.error('Error loading user data:', error);
                throw error;
            }
        }

        // Initialize user profile with default data
        async function initializeUserProfile(userId) {
            const defaultData = {
                firstName: currentUser.displayName ? currentUser.displayName.split(' ')[0] : 'User',
                lastName: currentUser.displayName ? currentUser.displayName.split(' ')[1] || '' : '',
                username: currentUser.email.split('@')[0],
                email: currentUser.email,
                phone: '',
                bio: '',
                createdAt: new Date(),
                imageBase64: null,
                isExpert: false
            };
            
            userData = defaultData;
            populateForm(defaultData);
            storeOriginalData();
            
            // Note: We won't create the document here since it should be created during registration
            // Instead, we'll use the default data for the session
            console.log('Using default user data');
        }

        // Populate form with user data
        function populateForm(data) {
            // Personal Information
            document.getElementById('firstName').value = data.firstName || '';
            document.getElementById('lastName').value = data.lastName || '';
            document.getElementById('username').value = data.username || '';
            document.getElementById('email').value = data.email || currentUser.email || '';
            document.getElementById('phone').value = data.phone || '';
            document.getElementById('bio').value = data.bio || '';
            
            // Set user initials
            const firstName = data.firstName || '';
            const lastName = data.lastName || '';
            const username = data.username || '';
            let initials = 'JD'; // Default
            
            if (firstName && lastName) {
                initials = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();
            } else if (username) {
                initials = username.substring(0, 2).toUpperCase();
            } else if (currentUser.email) {
                initials = currentUser.email.substring(0, 2).toUpperCase();
            }
            
            document.getElementById('userInitials').textContent = initials;
            
            // Load profile image
            if (data.imageBase64) {
                document.getElementById('profileImage').src = data.imageBase64;
                document.getElementById('profileImage').style.display = 'block';
                document.getElementById('profileImagePlaceholder').style.display = 'none';
            } else {
                document.getElementById('profileImage').style.display = 'none';
                document.getElementById('profileImagePlaceholder').style.display = 'block';
            }
        }

        // Store original form data for comparison
        function storeOriginalData() {
            originalFormData = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                username: document.getElementById('username').value,
                phone: document.getElementById('phone').value,
                bio: document.getElementById('bio').value,
                imageBase64: userData?.imageBase64 || null
            };
        }

        // Check if form has changes
        function hasFormChanges() {
            return (
                document.getElementById('firstName').value !== originalFormData.firstName ||
                document.getElementById('lastName').value !== originalFormData.lastName ||
                document.getElementById('username').value !== originalFormData.username ||
                document.getElementById('phone').value !== originalFormData.phone ||
                document.getElementById('bio').value !== originalFormData.bio ||
                document.getElementById('newPassword').value ||
                (document.getElementById('profileImage').style.display === 'block' && 
                 document.getElementById('profileImage').src !== originalFormData.imageBase64)
            );
        }

        // Update sidebar profile
        function updateSidebarProfile(data) {
            const userNameElement = document.querySelector('.user-name');
            const userRoleElement = document.querySelector('.user-role');
            const userAvatarElement = document.getElementById('sidebarUserAvatar');

            const displayName = data.firstName && data.lastName
                ? `${data.firstName} ${data.lastName}`
                : data.username || currentUser.email.split('@')[0] || 'User';

            if (userNameElement) userNameElement.textContent = displayName;
            if (userRoleElement) userRoleElement.textContent = data.bio || 'Farmer';

            // Update profile image in sidebar
            if (userAvatarElement && data.imageBase64) {
                userAvatarElement.src = data.imageBase64;
                userAvatarElement.onerror = () => {
                    userAvatarElement.onerror = null;
                    userAvatarElement.src = 'images/user-avatar.jpg';
                };
            }
        }

        // Load user statistics
        async function loadUserStatistics(userId) {
            try {
                // Count forum posts
                const postsQuery = query(
                    collection(db, "forum_posts"),
                    where("authorId", "==", userId)
                );
                const postsSnapshot = await getDocs(postsQuery);
                document.getElementById('statPosts').textContent = postsSnapshot.size;

                // Count total replies (this would need additional logic to count all replies across posts)
                // For now, we'll use a placeholder or you can implement this based on your database structure
                document.getElementById('statReplies').textContent = '0';

                // Count likes received (this would need to query all posts and sum likes)
                // For now, we'll use a placeholder
                document.getElementById('statLikes').textContent = '0';

                // Calculate days since account creation
                if (userData?.createdAt) {
                    const createdDate = userData.createdAt.toDate ? userData.createdAt.toDate() : new Date(userData.createdAt);
                    const today = new Date();
                    const diffTime = Math.abs(today - createdDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    document.getElementById('statDays').textContent = diffDays;
                } else {
                    document.getElementById('statDays').textContent = '1';
                }

            } catch (error) {
                console.error('Error loading user statistics:', error);
                // Set default values if there's an error
                document.getElementById('statPosts').textContent = '0';
                document.getElementById('statReplies').textContent = '0';
                document.getElementById('statLikes').textContent = '0';
                document.getElementById('statDays').textContent = '1';
            }
        }

        // Handle image upload
        document.getElementById('imageUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Validate file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showToast('Image size should be less than 2MB', 'error');
                return;
            }

            // Validate file type
            if (!file.type.match('image.*')) {
                showToast('Please select an image file', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const imageBase64 = e.target.result;
                
                // Update profile image display
                document.getElementById('profileImage').src = imageBase64;
                document.getElementById('profileImage').style.display = 'block';
                document.getElementById('profileImagePlaceholder').style.display = 'none';
                
                // Store in userData for saving
                userData.imageBase64 = imageBase64;
                
                showToast('Profile picture updated! Click Save Changes to keep it.', 'info');
            };
            reader.readAsDataURL(file);
        });

        // Handle password visibility toggle
        function setupPasswordToggles() {
            const togglePassword = (inputId, toggleIconId) => {
                const input = document.getElementById(inputId);
                const toggleIcon = document.getElementById(toggleIconId);
                
                if (toggleIcon) {
                    toggleIcon.addEventListener('click', () => {
                        const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                        input.setAttribute('type', type);
                        toggleIcon.classList.toggle('fa-eye');
                        toggleIcon.classList.toggle('fa-eye-slash');
                    });
                }
            };
            
            togglePassword('currentPassword', 'toggleCurrentPassword');
            togglePassword('newPassword', 'toggleNewPassword');
            togglePassword('confirmPassword', 'toggleConfirmPassword');
        }

        // Password strength indicator
        document.getElementById('newPassword').addEventListener('input', function(e) {
            const password = e.target.value;
            const strengthBar = document.getElementById('passwordStrengthBar');
            
            let strength = 0;
            let color = '#f44336'; // Red
            
            // Length check
            if (password.length >= 8) strength += 25;
            
            // Lowercase check
            if (/[a-z]/.test(password)) strength += 25;
            
            // Uppercase check
            if (/[A-Z]/.test(password)) strength += 25;
            
            // Number/Special char check
            if (/[0-9!@#$%^&*]/.test(password)) strength += 25;
            
            // Update strength bar
            strengthBar.style.width = `${strength}%`;
            
            // Update color based on strength
            if (strength <= 25) {
                color = '#f44336'; // Red
            } else if (strength <= 50) {
                color = '#ff9800'; // Orange
            } else if (strength <= 75) {
                color = '#ffc107'; // Yellow
            } else {
                color = '#4caf50'; // Green
            }
            
            strengthBar.style.backgroundColor = color;
        });

        // Handle form submission
        document.getElementById('profileSettingsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!validateForm()) {
                return;
            }
            
            await saveProfileChanges();
        });

        // Validate form data
        function validateForm() {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const username = document.getElementById('username').value.trim();
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Check required fields
            if (!firstName || !lastName || !username) {
                showToast('Please fill in all required fields', 'error');
                return false;
            }
            
            // Check username length
            if (username.length < 3) {
                showToast('Username must be at least 3 characters long', 'error');
                return false;
            }
            
            // Check password match
            if (newPassword) {
                if (newPassword.length < 8) {
                    showToast('New password must be at least 8 characters long', 'error');
                    return false;
                }
                
                if (newPassword !== confirmPassword) {
                    showToast('New passwords do not match', 'error');
                    return false;
                }
                
                // If changing password, current password is required
                const currentPassword = document.getElementById('currentPassword').value;
                if (!currentPassword) {
                    showToast('Please enter your current password to change password', 'error');
                    return false;
                }
            }
            
            return true;
        }

        // Save profile changes to Firestore
        async function saveProfileChanges() {
            try {
                const saveBtn = document.getElementById('saveChangesBtn');
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                
                // Collect form data
                const updatedData = {
                    firstName: document.getElementById('firstName').value.trim(),
                    lastName: document.getElementById('lastName').value.trim(),
                    username: document.getElementById('username').value.trim(),
                    phone: document.getElementById('phone').value.trim(),
                    bio: document.getElementById('bio').value.trim(),
                    updatedAt: new Date()
                };
                
                // Add profile image if changed
                if (userData.imageBase64 && userData.imageBase64 !== originalFormData.imageBase64) {
                    updatedData.imageBase64 = userData.imageBase64;
                }
                
                // Update Firestore
                const userRef = doc(db, "users", currentUser.uid);
                await updateDoc(userRef, updatedData);
                
                // Update password if provided
                const newPassword = document.getElementById('newPassword').value;
                if (newPassword) {
                    const currentPassword = document.getElementById('currentPassword').value;
                    
                    // Re-authenticate user
                    const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
                    await reauthenticateWithCredential(currentUser, credential);
                    
                    // Update password
                    await updatePassword(currentUser, newPassword);
                    
                    // Clear password fields
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                    document.getElementById('passwordStrengthBar').style.width = '0%';
                    
                    showToast('Password updated successfully!', 'success');
                }
                
                // Update local userData
                userData = { ...userData, ...updatedData };
                
                // Update original form data
                storeOriginalData();
                
                // Update sidebar
                updateSidebarProfile(userData);
                
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                
                showToast('Profile updated successfully!', 'success');
                
            } catch (error) {
                console.error('Error saving profile:', error);
                document.getElementById('saveChangesBtn').disabled = false;
                document.getElementById('saveChangesBtn').innerHTML = '<i class="fas fa-save"></i> Save Changes';
                
                let errorMessage = 'Failed to save changes. ';
                
                if (error.code === 'auth/wrong-password') {
                    errorMessage += 'Current password is incorrect.';
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage += 'Please log in again to change your password.';
                } else {
                    errorMessage += 'Please try again.';
                }
                
                showToast(errorMessage, 'error');
            }
        }

        // Handle delete account
        async function deleteAccount() {
            const password = document.getElementById('confirmDeletePassword').value;
            
            if (!password) {
                showToast('Please enter your password to confirm account deletion', 'error');
                return;
            }
            
            try {
                // Re-authenticate user
                const credential = EmailAuthProvider.credential(currentUser.email, password);
                await reauthenticateWithCredential(currentUser, credential);
                
                // Delete user data from Firestore
                const userRef = doc(db, "users", currentUser.uid);
                await deleteDoc(userRef);
                
                // Delete forum posts (optional - you might want to anonymize instead)
                const postsQuery = query(
                    collection(db, "forum_posts"),
                    where("authorId", "==", currentUser.uid)
                );
                const postsSnapshot = await getDocs(postsQuery);
                const deletePromises = postsSnapshot.docs.map(doc => deleteDoc(doc.ref));
                await Promise.all(deletePromises);
                
                // Delete user from Firebase Auth
                await deleteUser(currentUser);
                
                showToast('Account deleted successfully. Redirecting to login...', 'success');
                
                // Redirect to login page after a delay
                setTimeout(() => {
                    window.location.href = 'signin.html';
                }, 2000);
                
            } catch (error) {
                console.error('Error deleting account:', error);
                
                let errorMessage = 'Failed to delete account. ';
                if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Incorrect password. Please try again.';
                } else {
                    errorMessage += 'Please try again.';
                }
                
                showToast(errorMessage, 'error');
            }
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.className = 'toast ' + type;
            
            // Show toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // Hide toast after 5 seconds
            setTimeout(() => {
                toast.classList.remove('show');
            }, 5000);
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Setup password toggles
            setupPasswordToggles();
            
            // Save changes button
            document.getElementById('saveChangesBtn').addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('profileSettingsForm').dispatchEvent(new Event('submit'));
            });
            
            // Cancel changes button
            document.getElementById('cancelChangesBtn').addEventListener('click', function() {
                if (hasFormChanges()) {
                    if (confirm('You have unsaved changes. Are you sure you want to cancel?')) {
                        populateForm(userData);
                        showToast('Changes discarded', 'info');
                    }
                } else {
                    showToast('No changes to discard', 'info');
                }
            });
            
            // Delete account button
            document.getElementById('deleteAccountBtn').addEventListener('click', function() {
                openModal('deleteAccountModal');
            });
            
            // Delete account modal buttons
            document.getElementById('closeDeleteModal').addEventListener('click', function() {
                closeModal('deleteAccountModal');
            });
            
            document.getElementById('cancelDeleteBtn').addEventListener('click', function() {
                closeModal('deleteAccountModal');
                document.getElementById('confirmDeletePassword').value = '';
            });
            
            document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
                deleteAccount();
            });
            
            // View public profile button
            document.getElementById('viewProfileBtn').addEventListener('click', function() {
                // You can implement a public profile view page here
                showToast('Public profile view coming soon!', 'info');
            });
            
            // Warn user before leaving with unsaved changes
            window.addEventListener('beforeunload', function(e) {
                if (hasFormChanges()) {
                    e.preventDefault();
                    e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                }
            });
            
            // Check for changes on form input
            const formInputs = document.querySelectorAll('#profileSettingsForm input, #profileSettingsForm textarea');
            formInputs.forEach(input => {
                input.addEventListener('input', function() {
                    // You could add visual indicators for changed fields here
                });
            });
        });
    </script>
</body>
</html>