<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Settings | Palm Aegis</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/homepage.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="icon" href="images/logo1.png" type="image/png" sizes="32x32">
    <link rel="shortcut icon" href="images/logo1.png">
    <meta name="theme-color" content="#2e7d32">

    <style>
        :root {
            --primary-color: #2e7d32;
            --secondary-color: #4caf50;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --info-color: #2196f3;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #c8f0c8;
            color: #333;
            overflow: hidden;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
            max-height: 100vh;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .top-header {
            background-color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .header-left h1 {
            font-size: 1.8rem;
            color: var(--primary-color);
        }

        .container {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            overflow-x: hidden;
            max-height: calc(100vh - 80px);
        }

        /* Custom scrollbar styling */
        .container::-webkit-scrollbar {
            width: 8px;
        }

        .container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .container::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        .container::-webkit-scrollbar-thumb:hover {
            background: #1b5e20;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 1.8rem;
            color: var(--primary-color);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #1b5e20;
        }

        .btn-secondary {
            background-color: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background-color: #d6d6d6;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #d32f2f;
        }

        /* Profile Settings Styles */
        .settings-container {
            max-width: 1000px;
            margin: 0 auto;
            min-height: 100%;
        }

        /* Settings Navigation Tabs */
        .settings-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            overflow-x: auto;
        }

        .settings-nav::-webkit-scrollbar {
            height: 4px;
        }

        .settings-nav::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .settings-nav::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 2px;
        }

        .nav-tab {
            padding: 12px 25px;
            background-color: #f5f5f5;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background-color: #e8f5e9;
            color: var(--primary-color);
        }

        .nav-tab.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 2px 8px rgba(46, 125, 50, 0.2);
        }

        .settings-card {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .settings-card.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .settings-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.3rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: var(--primary-color);
        }

        /* Profile Picture Section */
        .profile-picture-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .profile-image-container {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }

        .profile-image {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--primary-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .image-placeholder {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background-color: #4caf50;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.5rem;
            font-weight: bold;
            border: 4px solid var(--primary-color);
            margin: 0 auto 20px;
        }

        .upload-overlay {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: var(--primary-color);
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-overlay:hover {
            background-color: #1b5e20;
            transform: scale(1.1);
        }

        #imageUpload {
            display: none;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-input[readonly] {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }

        .field-info {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .field-info i {
            color: var(--primary-color);
        }

        .save-changes-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .save-changes-btn:hover {
            background-color: #1b5e20;
            transform: translateY(-2px);
        }

        .save-changes-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .actions-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        /* Password Change Section */
        .password-toggle {
            position: relative;
        }

        .password-toggle .toggle-icon {
            position: absolute;
            right: 12px;
            top: 42px;
            cursor: pointer;
            color: #666;
        }

        .password-strength {
            height: 4px;
            border-radius: 2px;
            background-color: #e0e0e0;
            margin-top: 8px;
            overflow: hidden;
        }

        .strength-bar {
            height: 100%;
            width: 0%;
            transition: width 0.3s, background-color 0.3s;
        }

        /* Account Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid var(--primary-color);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: white;
            color: #333;
            padding: 15px 25px;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(150%);
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left: 4px solid var(--primary-color);
        }

        .toast.error {
            border-left: 4px solid var(--danger-color);
        }

        .toast.info {
            border-left: 4px solid var(--info-color);
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .modal-content::-webkit-scrollbar {
            width: 6px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #777;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard-container {
                flex-direction: column;
            }

            .container {
                padding: 20px;
                max-height: calc(100vh - 70px);
            }

            .settings-nav {
                flex-wrap: wrap;
                gap: 5px;
            }

            .nav-tab {
                padding: 10px 15px;
                font-size: 0.9rem;
            }

            .settings-card {
                padding: 20px;
            }

            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .form-row .form-group {
                margin-bottom: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .actions-row {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .page-actions {
                width: 100%;
                justify-content: flex-start;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            .settings-card {
                padding: 15px;
            }

            .profile-image {
                width: 120px;
                height: 120px;
            }

            .image-placeholder {
                width: 120px;
                height: 120px;
                font-size: 2.5rem;
            }

            .upload-overlay {
                width: 35px;
                height: 35px;
            }

            .stat-value {
                font-size: 1.5rem;
            }
        }

        @media (max-height: 600px) {
            .container {
                padding: 15px;
                max-height: calc(100vh - 60px);
            }

            .settings-section {
                margin-bottom: 25px;
            }

            .form-group {
                margin-bottom: 15px;
            }
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <div id="sidebarPlaceholder"></div>
        <script src="js/sidebar-loader.js"></script>

        <main class="main-content">
            <div class="top-header">
                <div class="header-left">
                    <h1>Profile Settings</h1>
                </div>
            </div>

            <div class="container">
                <div class="page-header">
                    <h2 class="page-title">Manage Your Profile</h2>
                    <div class="page-actions">
                        <button class="btn btn-secondary" id="viewProfileBtn">
                            <i class="fas fa-eye"></i> View Public Profile
                        </button>
                    </div>
                </div>

                <div class="settings-container">
                    <!-- Toast Notification -->
                    <div id="toast" class="toast">
                        <i class="fas fa-check-circle"></i>
                        <span id="toastMessage">Changes saved successfully!</span>
                    </div>

                    <!-- Loading State -->
                    <div id="loadingState" class="loading">
                        <div class="spinner"></div>
                        <p>Loading your profile...</p>
                    </div>

                    <!-- Settings Navigation Tabs -->
                    <div class="settings-nav" id="settingsNav" style="display: none;">
                        <button class="nav-tab active" data-tab="personal">
                            <i class="fas fa-user"></i> Personal Information
                        </button>
                        <button class="nav-tab" data-tab="security">
                            <i class="fas fa-shield-alt"></i> Account Security
                        </button>
                        <button class="nav-tab" data-tab="activity">
                            <i class="fas fa-chart-bar"></i> Activity & Stats
                        </button>
                        <button class="nav-tab" data-tab="danger">
                            <i class="fas fa-exclamation-triangle"></i> Danger Zone
                        </button>
                    </div>

                    <!-- Personal Information Card -->
                    <form id="profileSettingsForm" style="display: none;">
                        <!-- Personal Information Card -->
                        <div class="settings-card active" id="personalCard">
                            <!-- Profile Picture Section -->
                            <div class="profile-picture-section">
                                <div class="profile-image-container">
                                    <div id="profileImagePlaceholder" class="image-placeholder">
                                        <span id="userInitials">JD</span>
                                    </div>
                                    <img id="profileImage" class="profile-image" src="" alt="Profile Picture" style="display: none;">
                                    <div class="upload-overlay" onclick="document.getElementById('imageUpload').click()">
                                        <i class="fas fa-camera"></i>
                                    </div>
                                    <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                                </div>
                                <p>Click the camera icon to upload a new profile picture</p>
                                <p class="field-info">
                                    <i class="fas fa-info-circle"></i> Recommended: Square image, max 2MB
                                </p>
                            </div>

                            <!-- Personal Information Section -->
                            <div class="settings-section">
                                <h3 class="section-title">
                                    <i class="fas fa-user"></i> Personal Information
                                </h3>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label" for="firstName">First Name *</label>
                                        <input type="text" id="firstName" class="form-input" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="lastName">Last Name *</label>
                                        <input type="text" id="lastName" class="form-input" required>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="username">Username *</label>
                                    <input type="text" id="username" class="form-input" required>
                                    <p class="field-info">
                                        <i class="fas fa-info-circle"></i> This will be displayed publicly in the forum
                                    </p>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="email">Email Address</label>
                                    <input type="email" id="email" class="form-input" readonly>
                                    <p class="field-info">
                                        <i class="fas fa-lock"></i> Email cannot be changed for security reasons
                                    </p>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="phone">Phone Number</label>
                                    <input type="tel" id="phone" class="form-input">
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="bio">Bio/Description</label>
                                    <textarea id="bio" class="form-textarea" 
                                              placeholder="Tell us about yourself, your farming experience, or your interests..."></textarea>
                                    <p class="field-info">
                                        <i class="fas fa-info-circle"></i> This will be visible on your public profile
                                    </p>
                                </div>
                            </div>

                            <!-- Action Buttons for Personal Info -->
                            <div class="actions-row">
                                <div>
                                    <button type="button" class="btn btn-secondary" id="cancelPersonalBtn">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-primary" id="savePersonalBtn">
                                        <i class="fas fa-save"></i> Save Changes
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Account Security Card -->
                        <div class="settings-card" id="securityCard">
                            <div class="settings-section">
                                <h3 class="section-title">
                                    <i class="fas fa-shield-alt"></i> Account Security
                                </h3>
                                <p style="margin-bottom: 20px; color: #666;">
                                    Update your password and enhance your account security.
                                </p>

                                <div class="form-group">
                                    <label class="form-label" for="currentPassword">Current Password</label>
                                    <div class="password-toggle">
                                        <input type="password" id="currentPassword" class="form-input">
                                        <i class="fas fa-eye toggle-icon" id="toggleCurrentPassword"></i>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="newPassword">New Password</label>
                                    <div class="password-toggle">
                                        <input type="password" id="newPassword" class="form-input">
                                        <i class="fas fa-eye toggle-icon" id="toggleNewPassword"></i>
                                    </div>
                                    <div class="password-strength">
                                        <div class="strength-bar" id="passwordStrengthBar"></div>
                                    </div>
                                    <p class="field-info">
                                        <i class="fas fa-info-circle"></i> Password must be at least 8 characters long
                                    </p>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="confirmPassword">Confirm New Password</label>
                                    <div class="password-toggle">
                                        <input type="password" id="confirmPassword" class="form-input">
                                        <i class="fas fa-eye toggle-icon" id="toggleConfirmPassword"></i>
                                    </div>
                                </div>

                                <!-- Security Tips -->
                                <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 30px;">
                                    <h4 style="color: var(--primary-color); margin-bottom: 10px;">
                                        <i class="fas fa-lightbulb"></i> Security Tips
                                    </h4>
                                    <ul style="color: #666; padding-left: 20px;">
                                        <li>Use a strong, unique password</li>
                                        <li>Don't reuse passwords across different sites</li>
                                        <li>Consider using a password manager</li>
                                        <li>Never share your password with anyone</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Action Buttons for Security -->
                            <div class="actions-row">
                                <div>
                                    <button type="button" class="btn btn-secondary" id="cancelSecurityBtn">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-primary" id="saveSecurityBtn">
                                        <i class="fas fa-save"></i> Update Password
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Activity & Stats Card -->
                        <div class="settings-card" id="activityCard">
                            <div class="settings-section">
                                <h3 class="section-title">
                                    <i class="fas fa-chart-bar"></i> Your Activity
                                </h3>
                                <p style="margin-bottom: 20px; color: #666;">
                                    Overview of your activity and contributions to the community.
                                </p>

                                <div class="stats-grid">
                                    <div class="stat-card">
                                        <div class="stat-value" id="statPosts">0</div>
                                        <div class="stat-label">Forum Posts</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value" id="statReplies">0</div>
                                        <div class="stat-label">Replies</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value" id="statLikes">0</div>
                                        <div class="stat-label">Likes Received</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value" id="statDays">0</div>
                                        <div class="stat-label">Days Active</div>
                                    </div>
                                </div>

                                <!-- Recent Activity -->
                                <div style="margin-top: 40px;">
                                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">
                                        <i class="fas fa-history"></i> Recent Activity
                                    </h4>
                                    <div id="recentActivity" style="background-color: #f8f9fa; padding: 20px; border-radius: 8px;">
                                        <p style="text-align: center; color: #999;">
                                            <i class="fas fa-spinner fa-spin"></i> Loading your recent activity...
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Danger Zone Card -->
                        <div class="settings-card" id="dangerCard">
                            <div class="settings-section">
                                <h3 class="section-title" style="color: var(--danger-color);">
                                    <i class="fas fa-exclamation-triangle"></i> Danger Zone
                                </h3>
                                <p style="margin-bottom: 30px; color: #666;">
                                    These actions are irreversible. Please proceed with caution.
                                </p>

                                <!-- Delete Account Section -->
                                <div style="background-color: #ffebee; border: 1px solid #ffcdd2; border-radius: 8px; padding: 20px; margin-bottom: 30px;">
                                    <h4 style="color: var(--danger-color); margin-bottom: 10px;">
                                        <i class="fas fa-trash"></i> Delete Account
                                    </h4>
                                    <p style="color: #666; margin-bottom: 15px;">
                                        Once you delete your account, there is no going back. All your data, including forum posts, replies, and profile information will be permanently removed.
                                    </p>
                                    <button type="button" class="btn btn-danger" id="deleteAccountBtn">
                                        <i class="fas fa-trash"></i> Delete My Account
                                    </button>
                                </div>

                                <!-- Export Data Section -->
                                <div style="background-color: #fff3e0; border: 1px solid #ffe0b2; border-radius: 8px; padding: 20px;">
                                    <h4 style="color: var(--warning-color); margin-bottom: 10px;">
                                        <i class="fas fa-download"></i> Export Your Data
                                    </h4>
                                    <p style="color: #666; margin-bottom: 15px;">
                                        Download a copy of all your personal data from Palm Aegis.
                                    </p>
                                    <button type="button" class="btn btn-secondary" id="exportDataBtn">
                                        <i class="fas fa-download"></i> Export My Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Delete Account Confirmation Modal -->
    <div class="modal" id="deleteAccountModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" style="color: var(--danger-color);">
                    <i class="fas fa-exclamation-triangle"></i> Delete Account
                </h2>
                <button class="close-modal" id="closeDeleteModal">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; color: #d32f2f; font-weight: 600;">
                    <i class="fas fa-exclamation-circle"></i> This action cannot be undone!
                </p>
                <p style="margin-bottom: 20px;">
                    Are you sure you want to delete your account? All your data, including forum posts and profile information, will be permanently removed.
                </p>
                <div class="form-group">
                    <label class="form-label" for="confirmDeletePassword">Enter your password to confirm:</label>
                    <input type="password" id="confirmDeletePassword" class="form-input" placeholder="Your current password">
                </div>
            </div>
            <div class="modal-actions" style="display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-secondary" id="cancelDeleteBtn">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash"></i> Delete Account Permanently
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js';
        import { 
            getAuth, 
            onAuthStateChanged, 
            updatePassword, 
            reauthenticateWithCredential,
            EmailAuthProvider,
            deleteUser 
        } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js';
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            updateDoc, 
            collection, 
            query, 
            where, 
            getDocs,
            deleteDoc,
            orderBy,
            limit
        } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAf-wtZpl8wVjCymdLlC-YGlv7xn0yEMMU",
            authDomain: "palmaegis-setup.firebaseapp.com",
            projectId: "palmaegis-setup",
            storageBucket: "palmaegis-setup.firebasestorage.app",
            messagingSenderId: "445887502374",
            appId: "1:445887502374:web:a5f6ecaa90b88447626ee7"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables
        let currentUser = null;
        let userData = null;
        let originalFormData = {};

        // Check authentication state
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                window.currentUser = user;
                console.log('User signed in:', user.email);

                try {
                    // Load user data from Firestore
                    await loadUserData(user.uid);
                    
                    // Show the form and navigation
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('settingsNav').style.display = 'flex';
                    document.getElementById('profileSettingsForm').style.display = 'block';
                    
                    // Load user statistics
                    await loadUserStatistics(user.uid);
                    
                    // Load recent activity
                    await loadRecentActivity(user.uid);
                    
                } catch (error) {
                    console.error('Error loading user data:', error);
                    showToast('Failed to load profile data. Please try again.', 'error');
                }
            } else {
                console.log('User not signed in');
                window.location.href = 'signin.html';
            }
        });

        // Load user data from Firestore
        async function loadUserData(userId) {
            try {
                const userDoc = await getDoc(doc(db, "users", userId));
                
                if (userDoc.exists()) {
                    userData = userDoc.data();
                    console.log('User data loaded:', userData);
                    
                    // Populate form fields
                    populateForm(userData);
                    
                    // Store original data for comparison
                    storeOriginalData();
                    
                    // Update sidebar profile
                    updateSidebarProfile(userData);
                } else {
                    console.log('No user document found, creating default...');
                    await initializeUserProfile(userId);
                }
                
            } catch (error) {
                console.error('Error loading user data:', error);
                throw error;
            }
        }

        // Initialize user profile with default data
        async function initializeUserProfile(userId) {
            const defaultData = {
                firstName: currentUser.displayName ? currentUser.displayName.split(' ')[0] : 'User',
                lastName: currentUser.displayName ? currentUser.displayName.split(' ')[1] || '' : '',
                username: currentUser.email.split('@')[0],
                email: currentUser.email,
                phone: '',
                bio: '',
                createdAt: new Date(),
                imageBase64: null,
                isExpert: false
            };
            
            userData = defaultData;
            populateForm(defaultData);
            storeOriginalData();
            
            console.log('Using default user data');
        }

        // Populate form with user data
        function populateForm(data) {
            // Personal Information
            document.getElementById('firstName').value = data.firstName || '';
            document.getElementById('lastName').value = data.lastName || '';
            document.getElementById('username').value = data.username || '';
            document.getElementById('email').value = data.email || currentUser.email || '';
            document.getElementById('phone').value = data.phone || '';
            document.getElementById('bio').value = data.bio || '';
            
            // Set user initials
            const firstName = data.firstName || '';
            const lastName = data.lastName || '';
            const username = data.username || '';
            let initials = 'JD'; // Default
            
            if (firstName && lastName) {
                initials = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();
            } else if (username) {
                initials = username.substring(0, 2).toUpperCase();
            } else if (currentUser.email) {
                initials = currentUser.email.substring(0, 2).toUpperCase();
            }
            
            document.getElementById('userInitials').textContent = initials;
            
            // Load profile image
            if (data.imageBase64) {
                document.getElementById('profileImage').src = data.imageBase64;
                document.getElementById('profileImage').style.display = 'block';
                document.getElementById('profileImagePlaceholder').style.display = 'none';
            } else {
                document.getElementById('profileImage').style.display = 'none';
                document.getElementById('profileImagePlaceholder').style.display = 'block';
            }
        }

        // Store original form data for comparison
        function storeOriginalData() {
            originalFormData = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                username: document.getElementById('username').value,
                phone: document.getElementById('phone').value,
                bio: document.getElementById('bio').value,
                imageBase64: userData?.imageBase64 || null
            };
        }

        // Check if personal info has changes
        function hasPersonalChanges() {
            return (
                document.getElementById('firstName').value !== originalFormData.firstName ||
                document.getElementById('lastName').value !== originalFormData.lastName ||
                document.getElementById('username').value !== originalFormData.username ||
                document.getElementById('phone').value !== originalFormData.phone ||
                document.getElementById('bio').value !== originalFormData.bio ||
                (document.getElementById('profileImage').style.display === 'block' && 
                 document.getElementById('profileImage').src !== originalFormData.imageBase64)
            );
        }

        // Update sidebar profile
        function updateSidebarProfile(data) {
            const userNameElement = document.querySelector('.user-name');
            const userRoleElement = document.querySelector('.user-role');
            const userAvatarElement = document.getElementById('sidebarUserAvatar');

            const displayName = data.firstName && data.lastName
                ? `${data.firstName} ${data.lastName}`
                : data.username || currentUser.email.split('@')[0] || 'User';

            if (userNameElement) userNameElement.textContent = displayName;
            if (userRoleElement) userRoleElement.textContent = data.bio || 'Farmer';

            if (userAvatarElement && data.imageBase64) {
                userAvatarElement.src = data.imageBase64;
                userAvatarElement.onerror = () => {
                    userAvatarElement.onerror = null;
                    userAvatarElement.src = 'images/user-avatar.jpg';
                };
            }
        }

        // Load user statistics
        async function loadUserStatistics(userId) {
            try {
                // Count forum posts
                const postsQuery = query(
                    collection(db, "forum_posts"),
                    where("authorId", "==", userId)
                );
                const postsSnapshot = await getDocs(postsQuery);
                document.getElementById('statPosts').textContent = postsSnapshot.size;

                // Calculate days since account creation
                if (userData?.createdAt) {
                    const createdDate = userData.createdAt.toDate ? userData.createdAt.toDate() : new Date(userData.createdAt);
                    const today = new Date();
                    const diffTime = Math.abs(today - createdDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    document.getElementById('statDays').textContent = diffDays;
                } else {
                    document.getElementById('statDays').textContent = '1';
                }

            } catch (error) {
                console.error('Error loading user statistics:', error);
                document.getElementById('statPosts').textContent = '0';
                document.getElementById('statDays').textContent = '1';
            }
        }

        // Load recent activity
        async function loadRecentActivity(userId) {
            try {
                const recentActivityDiv = document.getElementById('recentActivity');
                
                // Get recent forum posts
                const postsQuery = query(
                    collection(db, "forum_posts"),
                    where("authorId", "==", userId),
                    orderBy("createdAt", "desc"),
                    limit(5)
                );
                const postsSnapshot = await getDocs(postsQuery);
                
                if (postsSnapshot.empty) {
                    recentActivityDiv.innerHTML = `
                        <p style="text-align: center; color: #999;">
                            <i class="fas fa-comments"></i> No recent activity yet
                        </p>
                    `;
                    return;
                }
                
                let activityHTML = '<div style="display: flex; flex-direction: column; gap: 15px;">';
                
                postsSnapshot.docs.forEach((doc, index) => {
                    const post = doc.data();
                    const postDate = post.createdAt ? new Date(post.createdAt.toDate()).toLocaleDateString() : 'Recently';
                    
                    activityHTML += `
                        <div style="padding: 10px; background-color: white; border-radius: 6px; border-left: 4px solid var(--primary-color);">
                            <div style="font-weight: 600; color: #333; margin-bottom: 5px;">
                                <i class="fas fa-comment"></i> ${post.title || 'Forum Post'}
                            </div>
                            <div style="font-size: 0.85rem; color: #666;">
                                ${postDate} â€¢ ${post.category || 'General'}
                            </div>
                        </div>
                    `;
                });
                
                activityHTML += '</div>';
                recentActivityDiv.innerHTML = activityHTML;
                
            } catch (error) {
                console.error('Error loading recent activity:', error);
                document.getElementById('recentActivity').innerHTML = `
                    <p style="text-align: center; color: #999;">
                        <i class="fas fa-exclamation-circle"></i> Unable to load activity
                    </p>
                `;
            }
        }

        // Handle image upload
        document.getElementById('imageUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 2 * 1024 * 1024) {
                showToast('Image size should be less than 2MB', 'error');
                return;
            }

            if (!file.type.match('image.*')) {
                showToast('Please select an image file', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const imageBase64 = e.target.result;
                
                document.getElementById('profileImage').src = imageBase64;
                document.getElementById('profileImage').style.display = 'block';
                document.getElementById('profileImagePlaceholder').style.display = 'none';
                
                userData.imageBase64 = imageBase64;
                
                showToast('Profile picture updated! Click Save Changes to keep it.', 'info');
            };
            reader.readAsDataURL(file);
        });

        // Handle password visibility toggle
        function setupPasswordToggles() {
            const togglePassword = (inputId, toggleIconId) => {
                const input = document.getElementById(inputId);
                const toggleIcon = document.getElementById(toggleIconId);
                
                if (toggleIcon) {
                    toggleIcon.addEventListener('click', () => {
                        const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                        input.setAttribute('type', type);
                        toggleIcon.classList.toggle('fa-eye');
                        toggleIcon.classList.toggle('fa-eye-slash');
                    });
                }
            };
            
            togglePassword('currentPassword', 'toggleCurrentPassword');
            togglePassword('newPassword', 'toggleNewPassword');
            togglePassword('confirmPassword', 'toggleConfirmPassword');
        }

        // Password strength indicator
        document.getElementById('newPassword').addEventListener('input', function(e) {
            const password = e.target.value;
            const strengthBar = document.getElementById('passwordStrengthBar');
            
            let strength = 0;
            let color = '#f44336';
            
            if (password.length >= 8) strength += 25;
            if (/[a-z]/.test(password)) strength += 25;
            if (/[A-Z]/.test(password)) strength += 25;
            if (/[0-9!@#$%^&*]/.test(password)) strength += 25;
            
            strengthBar.style.width = `${strength}%`;
            
            if (strength <= 25) {
                color = '#f44336';
            } else if (strength <= 50) {
                color = '#ff9800';
            } else if (strength <= 75) {
                color = '#ffc107';
            } else {
                color = '#4caf50';
            }
            
            strengthBar.style.backgroundColor = color;
        });

        // Validate personal information form
        function validatePersonalForm() {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const username = document.getElementById('username').value.trim();
            
            if (!firstName || !lastName || !username) {
                showToast('Please fill in all required fields', 'error');
                return false;
            }
            
            if (username.length < 3) {
                showToast('Username must be at least 3 characters long', 'error');
                return false;
            }
            
            return true;
        }

        // Validate security form
        function validateSecurityForm() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword) {
                if (newPassword.length < 8) {
                    showToast('New password must be at least 8 characters long', 'error');
                    return false;
                }
                
                if (newPassword !== confirmPassword) {
                    showToast('New passwords do not match', 'error');
                    return false;
                }
                
                const currentPassword = document.getElementById('currentPassword').value;
                if (!currentPassword) {
                    showToast('Please enter your current password to change password', 'error');
                    return false;
                }
            }
            
            return true;
        }

        // Save personal information
        async function savePersonalInfo() {
            try {
                const saveBtn = document.getElementById('savePersonalBtn');
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                
                const updatedData = {
                    firstName: document.getElementById('firstName').value.trim(),
                    lastName: document.getElementById('lastName').value.trim(),
                    username: document.getElementById('username').value.trim(),
                    phone: document.getElementById('phone').value.trim(),
                    bio: document.getElementById('bio').value.trim(),
                    updatedAt: new Date()
                };
                
                if (userData.imageBase64 && userData.imageBase64 !== originalFormData.imageBase64) {
                    updatedData.imageBase64 = userData.imageBase64;
                }
                
                const userRef = doc(db, "users", currentUser.uid);
                await updateDoc(userRef, updatedData);
                
                userData = { ...userData, ...updatedData };
                storeOriginalData();
                updateSidebarProfile(userData);
                
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                
                showToast('Profile updated successfully!', 'success');
                
            } catch (error) {
                console.error('Error saving profile:', error);
                document.getElementById('savePersonalBtn').disabled = false;
                document.getElementById('savePersonalBtn').innerHTML = '<i class="fas fa-save"></i> Save Changes';
                showToast('Failed to save changes. Please try again.', 'error');
            }
        }

        // Update password
        async function updateUserPassword() {
            try {
                const saveBtn = document.getElementById('saveSecurityBtn');
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
                
                const newPassword = document.getElementById('newPassword').value;
                const currentPassword = document.getElementById('currentPassword').value;
                
                if (!newPassword) {
                    showToast('Please enter a new password', 'error');
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Update Password';
                    return;
                }
                
                const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
                await reauthenticateWithCredential(currentUser, credential);
                await updatePassword(currentUser, newPassword);
                
                // Clear password fields
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                document.getElementById('passwordStrengthBar').style.width = '0%';
                
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Update Password';
                
                showToast('Password updated successfully!', 'success');
                
            } catch (error) {
                console.error('Error updating password:', error);
                document.getElementById('saveSecurityBtn').disabled = false;
                document.getElementById('saveSecurityBtn').innerHTML = '<i class="fas fa-save"></i> Update Password';
                
                let errorMessage = 'Failed to update password. ';
                if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Current password is incorrect.';
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage = 'Please log in again to change your password.';
                } else {
                    errorMessage += 'Please try again.';
                }
                
                showToast(errorMessage, 'error');
            }
        }

        // Handle delete account
        async function deleteAccount() {
            const password = document.getElementById('confirmDeletePassword').value;
            
            if (!password) {
                showToast('Please enter your password to confirm account deletion', 'error');
                return;
            }
            
            try {
                const credential = EmailAuthProvider.credential(currentUser.email, password);
                await reauthenticateWithCredential(currentUser, credential);
                
                const userRef = doc(db, "users", currentUser.uid);
                await deleteDoc(userRef);
                
                const postsQuery = query(
                    collection(db, "forum_posts"),
                    where("authorId", "==", currentUser.uid)
                );
                const postsSnapshot = await getDocs(postsQuery);
                const deletePromises = postsSnapshot.docs.map(doc => deleteDoc(doc.ref));
                await Promise.all(deletePromises);
                
                await deleteUser(currentUser);
                
                showToast('Account deleted successfully. Redirecting to login...', 'success');
                
                setTimeout(() => {
                    window.location.href = 'signin.html';
                }, 2000);
                
            } catch (error) {
                console.error('Error deleting account:', error);
                
                let errorMessage = 'Failed to delete account. ';
                if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Incorrect password. Please try again.';
                } else {
                    errorMessage += 'Please try again.';
                }
                
                showToast(errorMessage, 'error');
            }
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.className = 'toast ' + type;
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 5000);
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Tab switching function
        function switchTab(tabName) {
            // Hide all cards
            document.querySelectorAll('.settings-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // Show selected card
            document.getElementById(`${tabName}Card`).classList.add('active');
            
            // Update tab active state
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.nav-tab[data-tab="${tabName}"]`).classList.add('active');
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Setup password toggles
            setupPasswordToggles();
            
            // Tab navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
            
            // Save personal info button
            document.getElementById('savePersonalBtn').addEventListener('click', function(e) {
                e.preventDefault();
                if (validatePersonalForm()) {
                    savePersonalInfo();
                }
            });
            
            // Cancel personal changes button
            document.getElementById('cancelPersonalBtn').addEventListener('click', function() {
                if (hasPersonalChanges()) {
                    if (confirm('You have unsaved changes. Are you sure you want to discard them?')) {
                        populateForm(userData);
                        showToast('Changes discarded', 'info');
                    }
                } else {
                    showToast('No changes to discard', 'info');
                }
            });
            
            // Save security button
            document.getElementById('saveSecurityBtn').addEventListener('click', function(e) {
                e.preventDefault();
                if (validateSecurityForm()) {
                    updateUserPassword();
                }
            });
            
            // Cancel security changes button
            document.getElementById('cancelSecurityBtn').addEventListener('click', function() {
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                document.getElementById('passwordStrengthBar').style.width = '0%';
                showToast('Password fields cleared', 'info');
            });
            
            // Delete account button
            document.getElementById('deleteAccountBtn').addEventListener('click', function() {
                openModal('deleteAccountModal');
            });
            
            // Export data button
            document.getElementById('exportDataBtn').addEventListener('click', function() {
                showToast('Data export feature coming soon!', 'info');
            });
            
            // Delete account modal buttons
            document.getElementById('closeDeleteModal').addEventListener('click', function() {
                closeModal('deleteAccountModal');
            });
            
            document.getElementById('cancelDeleteBtn').addEventListener('click', function() {
                closeModal('deleteAccountModal');
                document.getElementById('confirmDeletePassword').value = '';
            });
            
            document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
                deleteAccount();
            });
            
            // View public profile button
            document.getElementById('viewProfileBtn').addEventListener('click', function() {
                showToast('Public profile view coming soon!', 'info');
            });
            
            // Warn user before leaving with unsaved changes
            window.addEventListener('beforeunload', function(e) {
                if (hasPersonalChanges()) {
                    e.preventDefault();
                    e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                }
            });
        });
    </script>
</body>
</html>