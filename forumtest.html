<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Forum | Palm Aegis</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/homepage.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="stylesheet" href="css/forumtest.css">
</head>
<body>
    <div class="dashboard-container">
        <div id="sidebarPlaceholder"></div>
        <script src="js/sidebar-loader.js"></script>

        <main class="main-content">
            <div class="top-header">
                <div class="header-left">
                    <h1>Community Forum</h1>
                </div>
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search discussions..." id="searchInput">
                </div>
            </div>

            <div class="container">
                <div class="page-header">
                    <h2 class="page-title">Forum Discussions</h2>
                    <div class="page-actions">
                        <button class="btn btn-secondary" id="filterBtn">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                        <button class="btn btn-primary" id="newPostBtn">
                            <i class="fas fa-plus"></i> New Post
                        </button>
                    </div>
                </div>

                <div class="forum-content">
                    <div class="forum-sidebar">
                        <div class="sidebar-section">
                            <h3>Categories</h3>
                            <ul class="category-list">
                                <li class="category-item active" data-category="all">
                                    <i class="fas fa-comments"></i> All Discussions
                                </li>
                                <li class="category-item" data-category="diseases">
                                    <i class="fas fa-leaf"></i> Diseases
                                </li>
                                <li class="category-item" data-category="treatments">
                                    <i class="fas fa-stethoscope"></i> Treatments
                                </li>
                                <li class="category-item" data-category="farming">
                                    <i class="fas fa-tractor"></i> General Farming
                                </li>
                            </ul>
                        </div>
                        
                        <div class="sidebar-section">
                            <h3>Popular Tags</h3>
                            <div class="tag-cloud">
                                <span class="tag">Ganoderma</span>
                                <span class="tag">Black Spot</span>
                                <span class="tag">Fertilizer</span>
                                <span class="tag">Irrigation</span>
                                <span class="tag">Pruning</span>
                                <span class="tag">Pests</span>
                            </div>
                        </div>
                        
                        <div class="sidebar-section">
                            <h3>Top Experts</h3>
                            <div class="experts-list">
                                <div class="expert-item">
                                    <img src="images/default-avatar.png" alt="Expert" class="expert-avatar">
                                    <div class="expert-info">
                                        <div class="expert-name">Dr. Jane Smith</div>
                                        <div class="expert-specialty">Plant Pathologist</div>
                                    </div>
                                </div>
                                <div class="expert-item">
                                    <img src="images/default-avatar.png" alt="Expert" class="expert-avatar">
                                    <div class="expert-info">
                                        <div class="expert-name">Prof. John Doe</div>
                                        <div class="expert-specialty">Agronomist</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="forum-main">
                        <div class="posts-container" id="postsContainer">
                            <div class="loading">
                                <div class="spinner"></div>
                                <p>Loading discussions...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Create Post Modal -->
    <div class="modal" id="createPostModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create New Post</h2>
                <button class="close-modal" id="closeCreatePostBtn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createPostForm">
                    <div class="form-group">
                        <label for="postTitle">Title</label>
                        <input type="text" id="postTitle" required placeholder="Enter a descriptive title">
                    </div>
                    
                    <div class="form-group">
                        <label for="postCategory">Category</label>
                        <select id="postCategory" required>
                            <option value="">Select a category</option>
                            <option value="diseases">Diseases</option>
                            <option value="treatments">Treatments</option>
                            <option value="farming">General Farming</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="postContent">Content</label>
                        <textarea id="postContent" rows="8" required placeholder="Describe your question or topic..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="postTags">Tags (comma separated)</label>
                        <input type="text" id="postTags" placeholder="e.g., Ganoderma, Fertilizer, Irrigation">
                    </div>
                    
                    <div class="form-group">
                        <label for="tagExpert">Tag Expert (optional)</label>
                        <select id="tagExpert">
                            <option value="">Select an expert</option>
                            <option value="expert1">Dr. Jane Smith</option>
                            <option value="expert2">Prof. John Doe</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button class="btn btn-outline" id="cancelPostBtn">Cancel</button>
                <button class="btn btn-primary" id="submitPostBtn">Create Post</button>
            </div>
        </div>
    </div>

    <!-- Post Details Modal -->
    <div class="modal" id="postDetailsModal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2 class="modal-title" id="postDetailsTitle">Post Details</h2>
                <button class="close-modal" id="closePostDetailsBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="post-details" id="postDetailsContent">
                    <!-- Post details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Modal -->
    <div class="modal" id="filterModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Filter Discussions</h2>
                <button class="close-modal" id="closeFilterBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="filter-options">
                    <div class="filter-group">
                        <label class="filter-label">Category</label>
                        <select class="filter-select" id="categoryFilter">
                            <option value="all">All Categories</option>
                            <option value="diseases">Diseases</option>
                            <option value="treatments">Treatments</option>
                            <option value="farming">General Farming</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Sort By</label>
                        <select class="filter-select" id="sortFilter">
                            <option value="newest">Newest First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="popular">Most Popular</option>
                            <option value="replies">Most Replies</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Time Range</label>
                        <select class="filter-select" id="timeFilter">
                            <option value="all">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">Past Week</option>
                            <option value="month">Past Month</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-outline" id="clearFiltersBtn">Clear Filters</button>
                <button class="btn btn-primary" id="applyFiltersBtn">Apply Filters</button>
            </div>
        </div>
    </div>

    <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js'; 
    import { getFirestore, doc, getDoc, collection, getDocs, addDoc, updateDoc, deleteDoc, query, where, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js';

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAf-wtZpl8wVjCymdLlC-YGlv7xn0yEMMU",
        authDomain: "palmaegis-setup.firebaseapp.com",
        projectId: "palmaegis-setup",
        storageBucket: "palmaegis-setup.firebasestorage.app",
        messagingSenderId: "445887502374",
        appId: "1:445887502374:web:a5f6ecaa90b88447626ee7"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Global variables for filtering and state
    let currentFilters = {
        category: 'all',
        sort: 'newest',
        timeRange: 'all'
    };
    let currentCategory = 'all';
    let currentUser = null;

    // Check authentication state
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            console.log('User is signed in:', user.email);
            window.currentUser = user;
            currentUser = user;
            
            try {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    window.userData = userData;
                    updateUserProfile(user, userData);
                } else {
                    updateUserProfile(user, {});
                }
                
                // Load forum posts
                await loadForumPosts();
            } catch (error) {
                console.error('Error loading user data:', error);
                updateUserProfile(user, {});
                showError("Failed to load user data. Please try again.");
            }
        } else {
            console.log('User is not signed in');
            window.location.href = 'signin.html';
        }
    });

    function updateUserProfile(user, userData) {
        const userNameElement = document.querySelector('.user-name');
        const userRoleElement = document.querySelector('.user-role');

        const displayName = userData.firstName && userData.lastName 
            ? `${userData.firstName} ${userData.lastName}`
            : userData.username 
            ? userData.username
            : userData.displayName || user.displayName || user.email.split('@')[0] || 'User';

        if (userNameElement) userNameElement.textContent = displayName;
        if (userRoleElement) userRoleElement.textContent = userData.bio || 'Farmer';

        // set avatar(s) safely (use base64/photoURL/picture or fall back to default)
        const avatarSrc = userData.imageBase64 || userData.picture || userData.photoURL || 'images/user-avatar.jpg';
        const avatars = document.querySelectorAll('.user-avatar');
        avatars.forEach(img => {
            if (img) {
                img.src = avatarSrc;
                img.onerror = () => { img.src = 'images/default-avatar.png'; };
            }
        });

        // store for later in case sidebar is loaded after profile
        window.userData = userData;
    }

    // If sidebar is loaded after user data, re-apply avatar when sidebar is inserted
    if (window.__sidebarLoaded) {
        // sidebar might already be present
        if (window.userData) updateUserProfile(window.currentUser, window.userData);
    } else {
        window.addEventListener('sidebar:loaded', () => {
            if (window.currentUser) updateUserProfile(window.currentUser, window.userData || {});
        }, { once: true });
    }

    // Show error message
    function showError(message) {
        const postsContainer = document.getElementById('postsContainer');
        postsContainer.innerHTML = `
            <div class="error-message">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Error Loading Discussions</h3>
                <p>${message}</p>
                <button class="btn btn-primary" id="retryBtn" style="margin-top: 15px;">
                    <i class="fas fa-redo"></i> Try Again
                </button>
            </div>
        `;
        
        document.getElementById('retryBtn').addEventListener('click', () => {
            loadForumPosts();
        });
    }

    // Show no data message
    function showNoData() {
        const postsContainer = document.getElementById('postsContainer');
        postsContainer.innerHTML = `
            <div class="no-data">
                <i class="fas fa-comments"></i>
                <h3>No Discussions Available</h3>
                <p>Be the first to start a discussion in the community forum.</p>
                <button class="btn btn-primary" id="createFirstPostBtn" style="margin-top: 15px;">
                    <i class="fas fa-plus"></i> Create First Post
                </button>
            </div>
        `;
        
        document.getElementById('createFirstPostBtn').addEventListener('click', openCreatePostModal);
    }

    // Load forum posts from Firebase
    async function loadForumPosts() {
        try {
            const postsContainer = document.getElementById('postsContainer');
            postsContainer.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading discussions...</p>
                </div>
            `;

            console.log("Loading forum posts...");
            
            const postsRef = collection(db, "forum_posts");
            
            // Try different query approaches
            let querySnapshot;
            try {
                // Query with ordering by timestamp
                let q;
                if (currentFilters.sort === 'newest') {
                    q = query(postsRef, orderBy("timestamp", "desc"));
                } else if (currentFilters.sort === 'oldest') {
                    q = query(postsRef, orderBy("timestamp", "asc"));
                } else if (currentFilters.sort === 'popular') {
                    q = query(postsRef, orderBy("votes", "desc"));
                } else if (currentFilters.sort === 'replies') {
                    q = query(postsRef, orderBy("replyCount", "desc"));
                } else {
                    q = query(postsRef, orderBy("timestamp", "desc"));
                }
                
                querySnapshot = await getDocs(q);
            } catch (queryError) {
                console.log("Query failed, trying without ordering:", queryError);
                
                // Try without ordering
                try {
                    const q = query(postsRef);
                    querySnapshot = await getDocs(q);
                } catch (secondError) {
                    console.log("Second query failed:", secondError);
                    throw secondError;
                }
            }
            
            console.log("Found posts:", querySnapshot.size);
            
            if (querySnapshot.empty) {
                showNoData();
                return;
            }
            
            postsContainer.innerHTML = '';
            
            const allPosts = [];
            querySnapshot.forEach((doc) => {
                const post = doc.data();
                allPosts.push({post, docId: doc.id});
            });
            
            // Store all posts for filtering
            window.allPosts = allPosts;
            
            // Apply any existing filters
            applyFilters();
            
        } catch (error) {
            console.error("Error loading forum posts: ", error);
            
            // More specific error messages
            if (error.code === 'permission-denied') {
                showError("Database permission denied. Please contact support.");
            } else if (error.code === 'unavailable') {
                showError("Network error. Please check your internet connection.");
            } else {
                showError("Unable to load forum data. Please try again later.");
            }
        }
    }

    // Apply filters to posts
    function applyFilters() {
        const postsContainer = document.getElementById('postsContainer');
        postsContainer.innerHTML = '';
        
        if (!window.allPosts || window.allPosts.length === 0) {
            showNoData();
            return;
        }
        
        const filteredPosts = window.allPosts.filter(({post, docId}) => {
            // Category filter
            if (currentCategory !== 'all' && post.category !== currentCategory) {
                return false;
            }
            
            // Time range filter
            if (currentFilters.timeRange !== 'all') {
                const postDate = post.timestamp ? new Date(post.timestamp.toDate()) : new Date();
                const now = new Date();
                const diffTime = Math.abs(now - postDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (currentFilters.timeRange === 'today' && diffDays > 1) {
                    return false;
                } else if (currentFilters.timeRange === 'week' && diffDays > 7) {
                    return false;
                } else if (currentFilters.timeRange === 'month' && diffDays > 30) {
                    return false;
                }
            }
            
            return true;
        });
        
        if (filteredPosts.length === 0) {
            postsContainer.innerHTML = `
                <div class="no-data">
                    <i class="fas fa-filter"></i>
                    <h3>No Discussions Match Your Filters</h3>
                    <p>Try adjusting your filter criteria to see more results.</p>
                    <button class="btn btn-primary" id="clearFilterResultsBtn" style="margin-top: 15px;">
                        <i class="fas fa-times"></i> Clear Filters
                    </button>
                </div>
            `;
            
            document.getElementById('clearFilterResultsBtn').addEventListener('click', clearFilters);
        } else {
            filteredPosts.forEach(({post, docId}) => {
                createPostCard(post, docId);
            });
        }
    }

    // Create a post card for each forum post
    function createPostCard(post, docId) {
        const postsContainer = document.getElementById('postsContainer');
        
        // Format date safely
        let postDate = 'Not specified';
        try {
            if (post.timestamp) {
                postDate = new Date(post.timestamp.toDate()).toLocaleDateString();
            } else if (post.date) {
                postDate = new Date(post.date).toLocaleDateString();
            }
        } catch (dateError) {
            console.log("Date parsing error:", dateError);
        }
        
        // Get category icon
        let categoryIcon = 'fa-comments';
        if (post.category === 'diseases') categoryIcon = 'fa-leaf';
        if (post.category === 'treatments') categoryIcon = 'fa-stethoscope';
        if (post.category === 'farming') categoryIcon = 'fa-tractor';
        
        const postCard = document.createElement('div');
        postCard.className = 'post-card';
        postCard.setAttribute('data-id', docId);
        
        postCard.innerHTML = `
            <div class="post-header">
                <div class="post-category">
                    <i class="fas ${categoryIcon}"></i> ${post.category || 'General'}
                </div>
                <div class="post-date">${postDate}</div>
            </div>
            <div class="post-body">
                <h3 class="post-title">${post.title || 'Untitled'}</h3>
                <p class="post-excerpt">${post.content ? (post.content.substring(0, 150) + '...') : 'No content'}</p>
                
                <div class="post-tags">
                    ${post.tags && post.tags.length > 0 ? 
                        post.tags.map(tag => `<span class="tag">${tag}</span>`).join('') : 
                        ''
                    }
                </div>
                
                <div class="post-author">
                    <img src="${post.authorAvatar || 'images/default-avatar.png'}" alt="Author" class="author-avatar">
                    <div class="author-info">
                        <div class="author-name">${post.authorName || 'Anonymous'}</div>
                        <div class="post-stats">
                            <span><i class="fas fa-comment"></i> ${post.replyCount || 0}</span>
                            <span><i class="fas fa-thumbs-up"></i> ${post.votes || 0}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="post-footer">
                <div class="post-actions">
                    <button class="action-btn view-post" title="View Post">
                        <i class="fas fa-eye"></i> View
                    </button>
                    ${post.authorId === currentUser.uid ? `
                        <button class="action-btn edit-post" title="Edit Post">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="action-btn delete-post" title="Delete Post">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    ` : ''}
                    <button class="action-btn upvote-post" title="Upvote">
                        <i class="fas fa-thumbs-up"></i> ${post.votes || 0}
                    </button>
                </div>
            </div>
        `;
        
        postsContainer.appendChild(postCard);
        
        // Add event listeners
        const viewBtn = postCard.querySelector('.view-post');
        viewBtn.addEventListener('click', () => {
            showPostDetails(post, docId);
        });
        
        if (post.authorId === currentUser.uid) {
            const editBtn = postCard.querySelector('.edit-post');
            editBtn.addEventListener('click', () => {
                editPost(post, docId);
            });
            
            const deleteBtn = postCard.querySelector('.delete-post');
            deleteBtn.addEventListener('click', () => {
                deletePost(docId);
            });
        }
        
        const upvoteBtn = postCard.querySelector('.upvote-post');
        upvoteBtn.addEventListener('click', () => {
            upvotePost(docId, post);
        });
    }

    // Show post details in modal
    function showPostDetails(post, docId) {
        const modal = document.getElementById('postDetailsModal');
        const content = document.getElementById('postDetailsContent');
        
        // Format date safely
        let postDate = 'Not specified';
        try {
            if (post.timestamp) {
                postDate = new Date(post.timestamp.toDate()).toLocaleDateString();
            } else if (post.date) {
                postDate = new Date(post.date).toLocaleDateString();
            }
        } catch (dateError) {
            console.log("Date parsing error:", dateError);
        }
        
        // Get category icon
        let categoryIcon = 'fa-comments';
        if (post.category === 'diseases') categoryIcon = 'fa-leaf';
        if (post.category === 'treatments') categoryIcon = 'fa-stethoscope';
        if (post.category === 'farming') categoryIcon = 'fa-tractor';
        
        content.innerHTML = `
            <div class="post-detail-header">
                <div class="post-detail-category">
                    <i class="fas ${categoryIcon}"></i> ${post.category || 'General'}
                </div>
                <div class="post-detail-date">Posted on ${postDate}</div>
            </div>
            
            <h1 class="post-detail-title">${post.title || 'Untitled'}</h1>
            
            <div class="post-detail-author">
                <img src="${post.authorAvatar || 'images/default-avatar.png'}" alt="Author" class="author-avatar">
                <div class="author-detail-info">
                    <div class="author-detail-name">${post.authorName || 'Anonymous'}</div>
                    <div class="author-detail-role">${post.authorRole || 'Farmer'}</div>
                </div>
            </div>
            
            <div class="post-detail-content">
                ${post.content || 'No content available.'}
            </div>
            
            <div class="post-detail-tags">
                ${post.tags && post.tags.length > 0 ? 
                    post.tags.map(tag => `<span class="tag">${tag}</span>`).join('') : 
                    '<span class="no-tags">No tags</span>'
                }
            </div>
            
            <div class="post-detail-actions">
                <button class="btn btn-outline" id="replyToPostBtn">
                    <i class="fas fa-reply"></i> Reply
                </button>
                <button class="btn btn-outline" id="upvoteDetailBtn">
                    <i class="fas fa-thumbs-up"></i> Upvote (${post.votes || 0})
                </button>
                ${post.authorId === currentUser.uid ? `
                    <button class="btn btn-outline" id="editDetailBtn">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn btn-outline" id="deleteDetailBtn">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                ` : ''}
            </div>
            
            <div class="replies-section">
                <h3 class="replies-title">Replies (${post.replyCount || 0})</h3>
                <div class="replies-list" id="repliesList">
                    <div class="no-replies">No replies yet. Be the first to reply!</div>
                </div>
                
                <div class="reply-form" id="replyForm">
                    <h4>Post a Reply</h4>
                    <textarea id="replyContent" placeholder="Write your reply..."></textarea>
                    <div class="reply-actions">
                        <button class="btn btn-primary" id="submitReplyBtn">Post Reply</button>
                    </div>
                </div>
            </div>
        `;
        
        // Set modal title
        document.getElementById('postDetailsTitle').textContent = post.title || 'Post Details';
        
        // Show modal
        modal.style.display = 'flex';
        
        // Add event listeners for detail actions
        document.getElementById('upvoteDetailBtn').addEventListener('click', () => {
            upvotePost(docId, post);
            modal.style.display = 'none';
        });
        
        if (post.authorId === currentUser.uid) {
            document.getElementById('editDetailBtn').addEventListener('click', () => {
                modal.style.display = 'none';
                editPost(post, docId);
            });
            
            document.getElementById('deleteDetailBtn').addEventListener('click', () => {
                modal.style.display = 'none';
                deletePost(docId);
            });
        }
        
        document.getElementById('replyToPostBtn').addEventListener('click', () => {
            document.getElementById('replyForm').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('replyContent').focus();
        });
        
        document.getElementById('submitReplyBtn').addEventListener('click', () => {
            submitReply(docId);
        });
        
        // Load replies
        loadReplies(docId);
    }

    // Load replies for a post
    async function loadReplies(postId) {
        try {
            const repliesList = document.getElementById('repliesList');
            repliesList.innerHTML = '<div class="loading-replies">Loading replies...</div>';
            
            const repliesRef = collection(db, "forum_posts", postId, "replies");
            const q = query(repliesRef, orderBy("timestamp", "asc"));
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
                repliesList.innerHTML = '<div class="no-replies">No replies yet. Be the first to reply!</div>';
                return;
            }
            
            repliesList.innerHTML = '';
            
            querySnapshot.forEach((doc) => {
                const reply = doc.data();
                createReplyElement(reply, doc.id);
            });
        } catch (error) {
            console.error("Error loading replies: ", error);
            document.getElementById('repliesList').innerHTML = '<div class="error-replies">Error loading replies</div>';
        }
    }

    // Create a reply element
    function createReplyElement(reply, replyId) {
        const repliesList = document.getElementById('repliesList');
        
        // Format date safely
        let replyDate = 'Not specified';
        try {
            if (reply.timestamp) {
                replyDate = new Date(reply.timestamp.toDate()).toLocaleDateString();
            }
        } catch (dateError) {
            console.log("Date parsing error:", dateError);
        }
        
        const replyElement = document.createElement('div');
        replyElement.className = 'reply-item';
        replyElement.innerHTML = `
            <div class="reply-header">
                <div class="reply-author">
                    <img src="${reply.authorAvatar || 'images/default-avatar.png'}" alt="Author" class="author-avatar">
                    <div class="author-info">
                        <div class="author-name">${reply.authorName || 'Anonymous'}</div>
                        <div class="reply-date">${replyDate}</div>
                    </div>
                </div>
                ${reply.authorId === currentUser.uid ? `
                    <div class="reply-actions">
                        <button class="action-btn edit-reply" data-replyid="${replyId}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete-reply" data-replyid="${replyId}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                ` : ''}
            </div>
            <div class="reply-content">${reply.content || ''}</div>
            <div class="reply-footer">
                <button class="action-btn upvote-reply" data-replyid="${replyId}">
                    <i class="fas fa-thumbs-up"></i> ${reply.votes || 0}
                </button>
            </div>
        `;
        
        repliesList.appendChild(replyElement);
        
        // Add event listeners for reply actions
        if (reply.authorId === currentUser.uid) {
            const editBtn = replyElement.querySelector('.edit-reply');
            editBtn.addEventListener('click', (e) => {
                const replyId = e.target.closest('button').getAttribute('data-replyid');
                editReply(replyId, reply);
            });
            
            const deleteBtn = replyElement.querySelector('.delete-reply');
            deleteBtn.addEventListener('click', (e) => {
                const replyId = e.target.closest('button').getAttribute('data-replyid');
                deleteReply(replyId);
            });
        }
        
        const upvoteBtn = replyElement.querySelector('.upvote-reply');
        upvoteBtn.addEventListener('click', (e) => {
            const replyId = e.target.closest('button').getAttribute('data-replyid');
            upvoteReply(replyId, reply);
        });
    }

    // Submit a new reply
    async function submitReply(postId) {
        const replyContent = document.getElementById('replyContent').value.trim();
        
        if (!replyContent) {
            alert('Please enter a reply');
            return;
        }
        
        try {
            const user = currentUser;
            const userDoc = await getDoc(doc(db, "users", user.uid));
            let userData = {};
            if (userDoc.exists()) {
                userData = userDoc.data();
            }
            
            const replyData = {
                content: replyContent,
                authorId: user.uid,
                authorName: userData.firstName && userData.lastName 
                    ? `${userData.firstName} ${userData.lastName}`
                    : userData.username || user.displayName || user.email.split('@')[0] || 'Anonymous',
                authorAvatar: userData.imageBase64 || userData.picture || userData.photoURL || 'images/default-avatar.png',
                timestamp: serverTimestamp(),
                votes: 0
            };
            
            // Add reply to subcollection
            const repliesRef = collection(db, "forum_posts", postId, "replies");
            await addDoc(repliesRef, replyData);
            
            // Update reply count in the post
            const postRef = doc(db, "forum_posts", postId);
            const postDoc = await getDoc(postRef);
            if (postDoc.exists()) {
                const postData = postDoc.data();
                const newReplyCount = (postData.replyCount || 0) + 1;
                await updateDoc(postRef, { replyCount: newReplyCount });
            }
            
            // Clear form and reload replies
            document.getElementById('replyContent').value = '';
            loadReplies(postId);
            
        } catch (error) {
            console.error("Error submitting reply: ", error);
            alert('Error posting reply. Please try again.');
        }
    }

    // Upvote a post
    async function upvotePost(postId, post) {
        try {
            const postRef = doc(db, "forum_posts", postId);
            const newVotes = (post.votes || 0) + 1;
            await updateDoc(postRef, { votes: newVotes });
            
            // Reload posts to reflect the change
            loadForumPosts();
        } catch (error) {
            console.error("Error upvoting post: ", error);
        }
    }

    // Upvote a reply
    async function upvoteReply(replyId, reply) {
        try {
            // This would require knowing the post ID, which we don't have in this context
            // In a real implementation, you'd need to pass the post ID or restructure the data
            console.log("Upvoting reply:", replyId);
            // Implementation would depend on your data structure
        } catch (error) {
            console.error("Error upvoting reply: ", error);
        }
    }

    // Edit a post
    function editPost(post, postId) {
        // Populate the create post form with existing data
        document.getElementById('postTitle').value = post.title || '';
        document.getElementById('postCategory').value = post.category || '';
        document.getElementById('postContent').value = post.content || '';
        document.getElementById('postTags').value = post.tags ? post.tags.join(', ') : '';
        
        // Change modal to edit mode
        document.getElementById('createPostModal').style.display = 'flex';
        document.querySelector('.modal-title').textContent = 'Edit Post';
        document.getElementById('submitPostBtn').textContent = 'Update Post';
        
        // Store the post ID for updating
        window.editingPostId = postId;
    }

    // Delete a post
    async function deletePost(postId) {
        if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
            return;
        }
        
        try {
            await deleteDoc(doc(db, "forum_posts", postId));
            // Reload posts to reflect the change
            loadForumPosts();
        } catch (error) {
            console.error("Error deleting post: ", error);
            alert('Error deleting post. Please try again.');
        }
    }

    // Edit a reply
    function editReply(replyId, reply) {
        // Implementation for editing a reply
        console.log("Editing reply:", replyId);
        // This would open a modal or inline editor for the reply
    }

    // Delete a reply
    async function deleteReply(replyId) {
        if (!confirm('Are you sure you want to delete this reply?')) {
            return;
        }
        
        try {
            // This would require knowing the post ID, which we don't have in this context
            // In a real implementation, you'd need to pass the post ID
            console.log("Deleting reply:", replyId);
            // Implementation would depend on your data structure
        } catch (error) {
            console.error("Error deleting reply: ", error);
        }
    }

    // Open create post modal
    function openCreatePostModal() {
        // Reset form
        document.getElementById('createPostForm').reset();
        document.querySelector('.modal-title').textContent = 'Create New Post';
        document.getElementById('submitPostBtn').textContent = 'Create Post';
        window.editingPostId = null;
        
        document.getElementById('createPostModal').style.display = 'flex';
    }

    // Close create post modal
    function closeCreatePostModal() {
        document.getElementById('createPostModal').style.display = 'none';
    }

    // Submit a new post
    async function submitPost() {
        const title = document.getElementById('postTitle').value.trim();
        const category = document.getElementById('postCategory').value;
        const content = document.getElementById('postContent').value.trim();
        const tags = document.getElementById('postTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
        
        if (!title || !category || !content) {
            alert('Please fill in all required fields');
            return;
        }
        
        try {
            const user = currentUser;
            const userDoc = await getDoc(doc(db, "users", user.uid));
            let userData = {};
            if (userDoc.exists()) {
                userData = userDoc.data();
            }
            
            const postData = {
                title,
                category,
                content,
                tags,
                authorId: user.uid,
                authorName: userData.firstName && userData.lastName 
                    ? `${userData.firstName} ${userData.lastName}`
                    : userData.username || user.displayName || user.email.split('@')[0] || 'Anonymous',
                authorAvatar: userData.imageBase64 || userData.picture || userData.photoURL || 'images/default-avatar.png',
                authorRole: userData.bio || 'Farmer',
                timestamp: serverTimestamp(),
                votes: 0,
                replyCount: 0
            };
            
            if (window.editingPostId) {
                // Update existing post
                const postRef = doc(db, "forum_posts", window.editingPostId);
                await updateDoc(postRef, postData);
            } else {
                // Create new post
                await addDoc(collection(db, "forum_posts"), postData);
            }
            
            // Close modal and reload posts
            closeCreatePostModal();
            loadForumPosts();
            
        } catch (error) {
            console.error("Error submitting post: ", error);
            alert('Error creating post. Please try again.');
        }
    }

    // Open filter modal
    function openFilterModal() {
        document.getElementById('filterModal').style.display = 'flex';
    }

    // Close filter modal
    function closeFilterModal() {
        document.getElementById('filterModal').style.display = 'none';
    }

    // Clear all filters
    function clearFilters() {
        currentFilters = {
            category: 'all',
            sort: 'newest',
            timeRange: 'all'
        };
        currentCategory = 'all';
        
        // Reset filter inputs
        document.getElementById('categoryFilter').value = 'all';
        document.getElementById('sortFilter').value = 'newest';
        document.getElementById('timeFilter').value = 'all';
        
        // Reset category list
        document.querySelectorAll('.category-item').forEach(item => {
            item.classList.remove('active');
        });
        document.querySelector('.category-item[data-category="all"]').classList.add('active');
        
        applyFilters();
        closeFilterModal();
    }

    // Event Listeners
    document.getElementById('newPostBtn').addEventListener('click', openCreatePostModal);
    document.getElementById('closeCreatePostBtn').addEventListener('click', closeCreatePostModal);
    document.getElementById('cancelPostBtn').addEventListener('click', closeCreatePostModal);
    document.getElementById('submitPostBtn').addEventListener('click', submitPost);
    
    document.getElementById('filterBtn').addEventListener('click', openFilterModal);
    document.getElementById('closeFilterBtn').addEventListener('click', closeFilterModal);
    document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
    
    document.getElementById('applyFiltersBtn').addEventListener('click', () => {
        currentFilters.category = document.getElementById('categoryFilter').value;
        currentFilters.sort = document.getElementById('sortFilter').value;
        currentFilters.timeRange = document.getElementById('timeFilter').value;
        
        applyFilters();
        closeFilterModal();
    });

    // Close post details modal
    document.getElementById('closePostDetailsBtn').addEventListener('click', () => {
        document.getElementById('postDetailsModal').style.display = 'none';
    });

    // Category selection
    document.querySelectorAll('.category-item').forEach(item => {
        item.addEventListener('click', () => {
            document.querySelectorAll('.category-item').forEach(i => i.classList.remove('active'));
            item.classList.add('active');
            currentCategory = item.getAttribute('data-category');
            applyFilters();
        });
    });

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const postCards = document.querySelectorAll('.post-card');
        
        postCards.forEach(card => {
            const title = card.querySelector('.post-title').textContent.toLowerCase();
            const excerpt = card.querySelector('.post-excerpt').textContent.toLowerCase();
            const tags = card.querySelector('.post-tags').textContent.toLowerCase();
            
            if (title.includes(searchTerm) || excerpt.includes(searchTerm) || tags.includes(searchTerm)) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    });

    // Close modals when clicking outside
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    });

    // Logout functionality
    document.getElementById('logoutBtn').addEventListener('click', function(e) {
        e.preventDefault();
        signOut(auth).then(() => {
            window.location.href = 'signin.html';
        }).catch((error) => {
            console.error('Logout error:', error);
        });
    });
</script>
</body>
</html>